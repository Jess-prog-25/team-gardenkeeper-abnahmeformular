<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± gardenKeeper¬Æ - Digitales Abnahmeformular</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* === FARBSCHEMA NACH IHREN VORGABEN === */
        :root {
            /* Sanfte Gr√ºnt√∂ne */
            --sage-green: #8fa68f;        /* Ged√§mpftes Salbeigr√ºn (Hauptfarbe) */
            --light-moss: #a8c09a;        /* Helles Moosgr√ºn */
            --pale-lime: #c1d4b1;         /* Zartes Lindgr√ºn */
            
            /* Sanfte Braunt√∂ne */
            --warm-chestnut: #8b7355;     /* Warmes Kastanienbraun */
            --soft-clay: #a08879;         /* Sanftes Lehmbraun */
            --light-sand: #c4b5a0;        /* Helles Sandbraun */
            
            /* Neutrale T√∂ne */
            --cream-white: #f5f3f0;       /* Cremewei√ü (Hintergrund) */
            --dark-forest: #2d3e2d;       /* Dunkles Waldgr√ºn (Text) */
            
            /* UI Farben */
            --border-light: #e8e5e2;
            --shadow-soft: rgba(141, 115, 85, 0.1);
            --hover-tint: rgba(143, 166, 143, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--cream-white);
            color: var(--dark-forest);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* === LAUNCHER SEITE === */
        .launcher {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
        }
        
        .launcher-container {
            max-width: 600px;
            text-align: center;
            background: rgba(255,255,255,0.95);
            padding: 60px 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow-soft);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .logo {
            font-size: 4.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--sage-green), var(--warm-chestnut));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .launcher h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            font-weight: 700;
            color: var(--dark-forest);
        }
        
        .subtitle {
            font-size: 1.4rem;
            margin-bottom: 30px;
            color: var(--sage-green);
            font-weight: 500;
        }
        
        .company-slogan {
            background: linear-gradient(135deg, var(--pale-lime), var(--light-sand));
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            border-left: 4px solid var(--sage-green);
        }
        
        .company-slogan p {
            margin: 10px 0;
            color: var(--dark-forest);
        }
        
        .main-slogan {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .sub-slogan {
            font-style: italic;
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .launcher-btn {
            background: linear-gradient(135deg, var(--sage-green), var(--warm-chestnut));
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            min-width: 280px;
            justify-content: center;
            box-shadow: 0 10px 30px var(--shadow-soft);
            text-decoration: none;
        }
        
        .launcher-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(143, 166, 143, 0.3);
            background: linear-gradient(135deg, var(--light-moss), var(--soft-clay));
        }
        
        .instructions {
            background: var(--pale-lime);
            padding: 30px;
            border-radius: 15px;
            margin-top: 40px;
            text-align: left;
            border: 1px solid var(--border-light);
        }
        
        .instructions h3 {
            margin-bottom: 20px;
            color: var(--dark-forest);
            font-size: 1.2rem;
        }
        
        .instructions ol {
            padding-left: 25px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            font-size: 1rem;
            color: var(--dark-forest);
        }
        
        .support-info {
            background: var(--light-sand);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            border: 1px solid var(--warm-chestnut);
        }
        
        .support-info h4 {
            color: var(--warm-chestnut);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        /* === FORMULAR SEITE === */
        .formular {
            display: none;
            background: var(--cream-white);
            min-height: 100vh;
            padding: 20px;
        }
        
        .formular.active {
            display: block;
        }
        
        .form-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px var(--shadow-soft);
            overflow: hidden;
            border: 2px solid var(--border-light);
        }
        
        .form-header {
            background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .form-header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .form-header p {
            opacity: 0.95;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .form-header .company-tagline {
            font-style: italic;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--light-moss), var(--pale-lime));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-soft);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--warm-chestnut), var(--soft-clay));
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--soft-clay), var(--light-sand));
            transform: translateY(-2px);
        }
        
        .btn-tertiary {
            background: linear-gradient(135deg, var(--soft-clay), var(--light-sand));
            color: var(--dark-forest);
        }
        
        .btn-tertiary:hover {
            background: var(--pale-lime);
            transform: translateY(-2px);
        }
        
        .btn-back {
            background: rgba(255,255,255,0.9);
            color: var(--sage-green);
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .btn-back:hover {
            background: rgba(255,255,255,1);
            color: var(--dark-forest);
        }
        
        .form-content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: var(--cream-white);
            border-radius: 15px;
            border: 2px solid var(--border-light);
        }
        
        .section h3 {
            color: var(--dark-forest);
            font-size: 1.5rem;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--sage-green);
            padding-bottom: 12px;
            font-weight: 600;
        }
        
        .grid {
            display: grid;
            gap: 25px;
        }
        
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        
        .field {
            margin-bottom: 25px;
        }
        
        .field label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-forest);
            font-size: 1rem;
        }
        
        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            color: var(--dark-forest);
        }
        
        .field input:focus,
        .field textarea:focus,
        .field select:focus {
            outline: none;
            border-color: var(--sage-green);
            box-shadow: 0 0 0 3px var(--hover-tint);
        }
        
        /* === TAG MANAGEMENT === */
        .day-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 15px 25px;
            background: var(--pale-lime);
            border: 2px solid var(--border-light);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--dark-forest);
        }
        
        .day-tab.active {
            background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
            color: white;
            border-color: var(--sage-green);
        }
        
        .day-tab:hover {
            border-color: var(--sage-green);
            background: var(--light-moss);
            color: white;
        }
        
        .day-content {
            display: none;
        }
        
        .day-content.active {
            display: block;
        }
        
        /* === DYNAMISCHE REIHEN === */
        .worker-row,
        .material-row,
        .machine-row {
            display: grid;
            gap: 20px;
            align-items: start;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
        }
        
        .worker-row {
            grid-template-columns: 1fr auto;
        }
        
        .material-row {
            grid-template-columns: 2fr 1fr 1fr auto;
        }
        
        .machine-row {
            grid-template-columns: 2fr 1fr auto;
        }
        
        .worker-row:hover,
        .material-row:hover,
        .machine-row:hover {
            border-color: var(--sage-green);
            box-shadow: 0 4px 15px var(--shadow-soft);
        }
        
        .remove-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .remove-btn:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: scale(1.05);
        }
        
        /* === FREMDEINKAUF SECTION === */
        .fremdeinkauf-section {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-radius: 10px;
            border: 2px solid var(--warm-chestnut);
            grid-column: 1 / -1;
        }
        
        .fremdeinkauf-section.hidden {
            display: none;
        }
        
        .fremdeinkauf-section h4 {
            color: var(--warm-chestnut);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        /* === STUNDEN ZUSAMMENFASSUNG === */
        .hours-summary {
            background: linear-gradient(135deg, var(--pale-lime), #e8f5e8);
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            border: 2px solid var(--sage-green);
        }
        
        .hours-summary h4 {
            color: var(--dark-forest);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .hours-summary .total {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--dark-forest);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 3px solid var(--sage-green);
        }
        
        /* === BILDER UPLOAD === */
        .image-upload-area {
            margin-bottom: 25px;
        }
        
        .upload-zone {
            border: 3px dashed var(--border-light);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: var(--cream-white);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--dark-forest);
        }
        
        .upload-zone:hover {
            border-color: var(--sage-green);
            background: var(--pale-lime);
        }
        
        .upload-zone.dragover {
            border-color: var(--sage-green);
            background: var(--light-moss);
            transform: scale(1.02);
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-light);
            background: white;
            transition: all 0.3s ease;
        }
        
        .image-preview:hover {
            border-color: var(--sage-green);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-soft);
        }
        
        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .image-info {
            padding: 12px;
            background: white;
        }
        
        .image-category {
            font-size: 0.8rem;
            color: var(--sage-green);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .image-description {
            font-size: 0.9rem;
            color: var(--dark-forest);
        }
        
        .image-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .image-remove:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
        
        .image-category-select {
            margin-top: 8px;
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
        }
        
        .checkbox-item:hover {
            border-color: var(--sage-green);
            box-shadow: 0 4px 15px var(--shadow-soft);
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            accent-color: var(--sage-green);
        }
        
        /* === UNTERSCHRIFTEN === */
        .signature-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }
        
        .signature-box {
            border: 3px dashed var(--border-light);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            background: var(--cream-white);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .signature-box:hover {
            border-color: var(--sage-green);
            background: var(--pale-lime);
        }
        
        .signature-box.has-signature {
            border-style: solid;
            border-color: var(--sage-green);
            background: white;
        }
        
        /* === SUCCESS PAGE === */
        .success-page {
            display: none;
            min-height: 100vh;
            padding: 20px;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
        }
        
        .success-page.active {
            display: flex;
        }
        
        .success-container {
            max-width: 700px;
            text-align: center;
            background: rgba(255,255,255,0.95);
            padding: 60px;
            border-radius: 25px;
            box-shadow: 0 20px 60px var(--shadow-soft);
        }
        
        .success-icon {
            font-size: 6rem;
            margin-bottom: 25px;
        }
        
        .employee-message {
            background: var(--pale-lime);
            padding: 30px;
            border-radius: 15px;
            margin-top: 35px;
            border: 2px solid var(--sage-green);
        }
        
        .employee-message h3 {
            color: var(--warm-chestnut);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        /* === MODALS === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 62, 45, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--dark-forest);
            border: 3px solid var(--sage-green);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--sage-green);
            padding-bottom: 20px;
        }
        
        .modal-close {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        
        /* === STATUS MESSAGES === */
        .status-message {
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            font-weight: 600;
            text-align: center;
            font-size: 1rem;
        }
        
        .status-success {
            background: linear-gradient(135deg, #d4edda, var(--pale-lime));
            color: var(--dark-forest);
            border: 2px solid var(--sage-green);
        }
        
        .status-error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        .status-warning {
            background: linear-gradient(135deg, #fff3cd, var(--light-sand));
            color: var(--warm-chestnut);
            border: 2px solid var(--warm-chestnut);
        }
        
        .status-info {
            background: linear-gradient(135deg, #d1ecf1, var(--pale-lime));
            color: var(--dark-forest);
            border: 2px solid var(--sage-green);
        }
        
        /* === LOADING ANIMATION === */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(143, 166, 143, 0.3);
            border-radius: 50%;
            border-top-color: var(--sage-green);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) {
            .launcher-container {
                padding: 40px 30px;
                margin: 10px;
            }
            
            .launcher h1 {
                font-size: 2.2rem;
            }
            
            .launcher-btn {
                min-width: 250px;
                padding: 18px 35px;
                font-size: 1.1rem;
            }
            
            .form-content {
                padding: 25px;
            }
            
            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .worker-row,
            .material-row,
            .machine-row {
                grid-template-columns: 1fr;
            }
            
            .day-tabs {
                flex-direction: column;
            }
            
            .form-buttons {
                gap: 10px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .section {
                padding: 20px;
            }
        }
        
        /* === PRINT STYLES === */
        @media print {
            .launcher, .form-buttons, .btn, .modal { display: none !important; }
            .formular { display: block !important; }
            .form-container { box-shadow: none; border: 1px solid #ccc; }
            .form-header { background: var(--sage-green) !important; -webkit-print-color-adjust: exact; }
            body { font-size: 12px; }
            
            /* PDF-OPTIMIERTE BILD-STYLES */
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }

        /* === BILD-PDF INTEGRATION === */
        .images-section {
            page-break-before: always;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .image-item {
            border: 2px solid #e8e5e2;
            border-radius: 10px;
            overflow: hidden;
            page-break-inside: avoid;
            background: white;
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-caption {
            padding: 12px 15px;
            background: #f5f3f0;
            border-top: 1px solid #e8e5e2;
            font-size: 0.9rem;
        }

        .image-category {
            font-weight: 600;
            color: #8fa68f;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        @media print {
            .images-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .image-item img {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <!-- === LAUNCHER PAGE === -->
    <div class="launcher" id="launcherPage">
        <div class="launcher-container">
            <div class="logo">üå±</div>
            <h1>gardenKeeper¬Æ</h1>
            <div class="subtitle">Professionelle Gartenpflege</div>

            <div class="company-slogan">
                <p class="main-slogan">Ob Garten oder Grundst√ºck - wir sorgen daf√ºr, dass Ihr Zuhause stilvoll, gepflegt und verl√§sslich aufbl√ºht.</p>
                <p class="sub-slogan">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</p>
            </div>
            
            <button class="launcher-btn" onclick="openForm()">
                <span>üì±</span>
                Abnahmeformular √∂ffnen
            </button>
            
            <div class="instructions">
                <h3>üìã Arbeitsschritte:</h3>
                <ol>
                    <li>Formular √∂ffnen und alle Projektdaten eingeben</li>
                    <li>Mehrt√§gige Projekte √ºber Tage-Tabs erfassen</li>
                    <li>Pro Tag: Mitarbeiter, Arbeitszeiten und Materialien dokumentieren</li>
                    <li>Pro Tag: Unterschriften von Kunde und Teamleiter einholen</li>
                    <li>Automatische Pausenberechnung und Stundenerfassung</li>
                    <li>Abschlie√üen ‚Üí Daten werden automatisch gespeichert</li>
                    <li>PDF kann direkt erstellt und weitergeleitet werden</li>
                </ol>
            </div>
            
            <div class="support-info">
                <h4>üìû Bei Fragen oder Problemen:</h4>
                <p><strong>Wenden Sie sich an Chef oder Chefin</strong></p>
            </div>
            
            <div style="margin-top: 35px; font-size: 0.95rem; opacity: 0.8; color: var(--dark-forest);">
                ¬© copyright by gardenKeeper 2025<br>
                ‚úÖ Alle Funktionen verf√ºgbar<br>
                ‚úÖ Web App vollst√§ndig funktionsf√§hig<br>
                ‚úÖ Sofort einsatzbereit
            </div>
        </div>
    </div>

    <!-- === FORMULAR PAGE === -->
    <div class="formular" id="formularPage">
        <div class="form-container">
            <!-- Header -->
            <div class="form-header">
                <h1>ABNAHME / TAGESREGIEBERICHT</h1>
                <p>gardenKeeper¬Æ GmbH - Sven Kr√§mer</p>
                <p class="company-tagline">Professionelle Gartenpflege mit Stil und ‚ô•</p>
                <div class="form-buttons">
                    <button onclick="goBackToLauncher()" class="btn btn-back">
                        <span>‚Üê</span>
                        Zur√ºck
                    </button>
                    <button onclick="testSystem()" class="btn btn-secondary">
                        <span>üîó</span>
                        System testen
                    </button>
                    <button onclick="runSpellCheck()" class="btn btn-tertiary">
                        <span>üîç</span>
                        Rechtschreibung
                    </button>
                    <button onclick="saveDraft()" class="btn btn-secondary">
                        <span>üíæ</span>
                        Speichern
                    </button>
                    <button onclick="generatePDF()" class="btn btn-primary">
                        <span>üìÑ</span>
                        PDF erstellen
                    </button>
                    <button onclick="downloadHTML()" class="btn btn-secondary">
                        <span>üíæ</span>
                        HTML Download
                    </button>
                    <button onclick="loadTestData()" class="btn btn-tertiary">
                        <span>üß™</span>
                        Testdaten
                    </button>
                    <button onclick="showEmailModal()" class="btn btn-secondary">
                        <span>üìß</span>
                        Email versenden
                    </button>
                    <button onclick="completeForm()" class="btn btn-primary" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                        <span>‚úÖ</span>
                        <span id="completeBtnText">Abschlie√üen</span>
                    </button>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage"></div>

            <div class="form-content">
                <!-- Grunddaten -->
                <div class="section">
                    <h3>üìã Grunddaten des Projekts</h3>
                    <div class="grid grid-3">
                        <div class="field">
                            <label>Name Kunde *</label>
                            <input type="text" id="kunde" placeholder="z.B. Familie M√ºller" required>
                        </div>
                        <div class="field">
                            <label>Kunde Email-Adresse</label>
                            <input type="email" id="kundenEmail" placeholder="kunde@beispiel.de">
                        </div>
                        <div class="field">
                            <label>LexOffice-ID</label>
                            <input type="text" id="lexofficeId" placeholder="z.B. LEX-2025-001">
                        </div>
                        <div class="field">
                            <label>Startdatum *</label>
                            <input type="date" id="startdatum" required>
                        </div>
                        <div class="field">
                            <label>Projektbeschreibung</label>
                            <input type="text" id="projektbeschreibung" placeholder="z.B. Gartenpflege, Heckenschnitt, Beetarbeiten">
                        </div>
                        <div class="field">
                            <label>Ansprechpartner vor Ort</label>
                            <input type="text" id="ansprechpartner" placeholder="Name der Kontaktperson">
                        </div>
                    </div>
                </div>

                <!-- Tage-Tabs -->
                <div class="section">
                    <h3>üìÖ Erfassung pro Arbeitstag</h3>
                    <div class="day-tabs" id="dayTabs">
                        <div class="day-tab active" data-day="1" onclick="switchDay(1)">Tag 1</div>
                    </div>
                    <button onclick="addDay()" class="btn btn-primary">
                        <span>+</span>
                        Weiteren Tag hinzuf√ºgen
                    </button>
                </div>

                <!-- Day Content Container -->
                <div id="dayContentContainer">
                    <!-- Tag 1 Content -->
                    <div class="day-content active" id="day1">
                        
                        <!-- Arbeitszeiten -->
                        <div class="section">
                            <h3>‚è∞ Arbeitszeiten und Pausen</h3>
                            <div class="grid grid-4">
                                <div class="field">
                                    <label>Ladebeginn</label>
                                    <input type="time" class="ladebeginn">
                                </div>
                                <div class="field">
                                    <label>Abfahrt</label>
                                    <input type="time" class="abfahrt">
                                </div>
                                <div class="field">
                                    <label>Arbeitszeit Beginn</label>
                                    <input type="time" class="arbeitszeit-beginn" onchange="updateHoursSummary()">
                                </div>
                                <div class="field">
                                    <label>Arbeitszeit Ende</label>
                                    <input type="time" class="arbeitszeit-ende" onchange="updateHoursSummary()">
                                </div>
                            </div>
                            <div class="grid grid-2">
                                <div class="field">
                                    <label>Pause (Minuten)</label>
                                    <input type="number" class="pause" placeholder="0" min="0" onchange="updateHoursSummary()">
                                </div>
                                <div class="field">
                                    <label>Regenpause (Minuten)</label>
                                    <input type="number" class="regenpause" placeholder="0" min="0" onchange="updateHoursSummary()">
                                </div>
                            </div>
                        </div>

                        <!-- Mitarbeiter -->
                        <div class="section">
                            <h3>üë• Ausf√ºhrende Mitarbeiter</h3>
                            <div class="workers-container">
                                <div class="worker-row">
                                    <div class="field">
                                        <label>Mitarbeiter</label>
                                        <select class="worker-select" onchange="updateHoursSummary()">
                                            <option value="">Mitarbeiter ausw√§hlen</option>
                                        </select>
                                    </div>
                                    <div style="align-self: start; margin-top: 25px;">
                                        <button onclick="removeWorker(this)" class="remove-btn">√ó</button>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                                <button onclick="addWorker()" class="btn btn-primary">
                                    <span>+</span>
                                    Mitarbeiter hinzuf√ºgen
                                </button>
                                <button onclick="openWorkerModal()" class="btn btn-secondary">
                                    <span>üë§</span>
                                    Neuen Mitarbeiter anlegen
                                </button>
                            </div>
                            
                            <!-- Stunden-Zusammenfassung -->
                            <div class="hours-summary">
                                <h4>üìä Stunden-Zusammenfassung (inkl. Pausenabzug)</h4>
                                <div class="hours-list"></div>
                                <div class="total">Gesamtstunden: 0 Std.</div>
                            </div>
                        </div>

                        <!-- Maschinen -->
                        <div class="section">
                            <h3>üöú Eingesetzte Maschinen und Ger√§te</h3>
                            <div class="machines-container">
                                <div class="machine-row">
                                    <div class="field">
                                        <label>Maschine/Ger√§t</label>
                                        <select class="machine-select">
                                            <option value="">Maschine ausw√§hlen</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label>Einsatzdauer</label>
                                        <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                                    </div>
                                    <div style="align-self: start; margin-top: 25px;">
                                        <button onclick="removeMachine(this)" class="remove-btn">√ó</button>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                                <button onclick="addMachine()" class="btn btn-primary">
                                    <span>+</span>
                                    Maschine hinzuf√ºgen
                                </button>
                                <button onclick="openMachineModal()" class="btn btn-secondary">
                                    <span>üöú</span>
                                    Neue Maschine anlegen
                                </button>
                            </div>
                        </div>

                        <!-- Arbeiten -->
                        <div class="section">
                            <h3>üî® Beschreibung ausgef√ºhrte Arbeiten</h3>
                            <div class="field">
                                <textarea class="beschreibung-arbeiten" rows="5" placeholder="Detaillierte Beschreibung der durchgef√ºhrten Arbeiten an diesem Tag..." required></textarea>
                            </div>
                        </div>

                        <!-- Materialien -->
                        <div class="section">
                            <h3>üì¶ Materialien und Baustoffe</h3>
                            <div class="materials-container">
                                <div class="material-row">
                                    <div class="field">
                                        <label>Material</label>
                                        <select class="material-select">
                                            <option value="">Material ausw√§hlen</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label>Menge</label>
                                        <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                                    </div>
                                    <div class="field">
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" class="fremdeinkauf-checkbox" onchange="toggleFremdeinkauf(this)">
                                            Fremdeinkauf
                                        </label>
                                    </div>
                                    <div style="align-self: start; margin-top: 25px;">
                                        <button onclick="removeMaterial(this)" class="remove-btn">√ó</button>
                                    </div>
                                    <div class="fremdeinkauf-section hidden">
                                        <h4>üí∞ Fremdeinkauf Details</h4>
                                        <div class="field">
                                            <label>Beschreibung/Lieferant:</label>
                                            <input type="text" class="fremdeinkauf-details" placeholder="z.B. Baumarkt XY, Lieferant Z">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                                <button onclick="addMaterial()" class="btn btn-primary">
                                    <span>+</span>
                                    Material hinzuf√ºgen
                                </button>
                                <button onclick="openMaterialModal()" class="btn btn-secondary">
                                    <span>üì¶</span>
                                    Neues Material anlegen
                                </button>
                            </div>
                        </div>

                        <!-- Bilder -->
                        <div class="section">
                            <h3>üì∑ Projekt-Bilder</h3>
                            <div class="image-upload-area">
                                <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
                                    <div style="font-size: 3em; margin-bottom: 15px;">üì∏</div>
                                    <div>Bilder hinzuf√ºgen</div>
                                    <div style="font-size: 0.9em; opacity: 0.7; margin-top: 8px;">Tippen zum Ausw√§hlen oder Drag & Drop</div>
                                </div>
                                <input type="file" id="imageInput" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            </div>
                            
                            <div class="image-preview-container" id="imagePreviewContainer">
                                <!-- Bilder werden hier angezeigt -->
                            </div>
                            
                            <div style="margin-top: 15px; font-size: 0.9em; color: var(--soft-clay);">
                                üí° <strong>Tipp:</strong> Vorher/Nachher Bilder, Arbeitsfortschritt, besondere Details
                            </div>
                        </div>

                        <!-- Zusatzarbeiten -->
                        <div class="section">
                            <h3>‚ûï Zusatzarbeiten und Besonderheiten</h3>
                            <div class="field">
                                <textarea class="zusatzarbeiten" rows="3" placeholder="Beschreibung zus√§tzlicher Arbeiten, die nicht im urspr√ºnglichen Auftrag enthalten waren..."></textarea>
                            </div>
                        </div>

                        <!-- Unterschriften PRO TAG -->
                        <div class="section">
                            <h3>‚úèÔ∏è Tagesabnahme - Unterschriften</h3>
                            <div class="signature-section">
                                <div>
                                    <h4 style="margin-bottom: 15px; color: var(--dark-forest);">Unterschrift Kunde (Tag 1)</h4>
                                    <div class="signature-box" data-type="kunde" data-day="1" onclick="openSignature('kunde', 1)">
                                        <div style="font-size: 2em;">‚úèÔ∏è</div>
                                        <div>Tippen zum Unterschreiben</div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 15px; color: var(--dark-forest);">Unterschrift Teamleiter (Tag 1)</h4>
                                    <div class="signature-box" data-type="teamleiter" data-day="1" onclick="openSignature('teamleiter', 1)">
                                        <div style="font-size: 2em;">‚úèÔ∏è</div>
                                        <div>Tippen zum Unterschreiben</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Gesamtbest√§tigungen -->
                <div class="section">
                    <h3>‚úÖ Gesamtbest√§tigungen des Projekts</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="auftragGemaess">
                            <label for="auftragGemaess">Die Arbeiten wurden gem√§√ü Auftrag ausgef√ºhrt</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="komplett">
                            <label for="komplett">Die beauftragten Arbeiten wurden komplett abgeschlossen</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="teilweise">
                            <label for="teilweise">Die beauftragten Arbeiten wurden teilweise abgeschlossen</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ordnungsGemaess">
                            <label for="ordnungsGemaess">Die Arbeiten wurden ordnungsgem√§√ü und m√§ngelfrei ausgef√ºhrt</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="kundeZufrieden">
                            <label for="kundeZufrieden">Der Kunde ist mit dem Ergebnis zufrieden</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="arbeitsplatzSauber">
                            <label for="arbeitsplatzSauber">Der Arbeitsplatz wurde ordentlich hinterlassen</label>
                        </div>
                    </div>
                </div>

                <!-- Gesamtbemerkungen -->
                <div class="section">
                    <h3>üí¨ Gesamtbemerkungen und Hinweise</h3>
                    <div class="field">
                        <textarea id="bemerkungen" rows="4" placeholder="Weitere Bemerkungen, Besonderheiten oder Hinweise zum gesamten Projekt..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === SUCCESS PAGE === -->
    <div class="success-page" id="successPage">
        <div class="success-container">
            <div class="success-icon">‚úÖ</div>
            <h1>Abnahme erfolgreich!</h1>
            <p style="font-size: 1.3rem; margin: 25px 0;">Das Formular wurde erfolgreich verarbeitet und die Daten wurden gespeichert.</p>
            
            <div class="employee-message">
                <h3>üéâ Nachricht an den Mitarbeiter</h3>
                <p><strong>Herzlichen Gl√ºckwunsch!</strong> Du hast das Abnahmeformular erfolgreich ausgef√ºllt. Deine sorgf√§ltige Dokumentation hilft uns dabei, unseren Kunden den bestm√∂glichen Service zu bieten.</p>
                <p style="margin-top: 20px;">Die Daten wurden automatisch in das System √ºbertragen. Das PDF kann √ºber den "PDF erstellen" Button generiert werden. Bei Fragen oder Problemen kannst du dich jederzeit an Jessika oder Sven wenden.</p>
                <p style="margin-top: 25px; padding: 20px; background: rgba(143, 166, 143, 0.2); border-radius: 10px; border-left: 4px solid var(--sage-green);">
                    <strong>üå± gardenKeeper¬Æ - Professionelle Gartenpflege</strong><br>
                    <em>"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</em><br><br>
                    <span style="font-size: 0.95rem;">Du tr√§gst dazu bei, dass unsere Kunden stilvoll, gepflegt und verl√§sslich aufbl√ºhen k√∂nnen!</span>
                </p>
                <p style="margin-top: 20px; font-weight: bold; color: var(--sage-green); font-size: 1.1rem;">Weiter so! üí™</p>
            </div>
            
            <div style="margin-top: 35px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                <button class="launcher-btn" onclick="generatePDF()" style="background: linear-gradient(135deg, var(--sage-green), var(--light-moss));">
                    <span>üìÑ</span>
                    PDF √∂ffnen & drucken
                </button>
                <button class="launcher-btn" onclick="downloadHTML()" style="background: linear-gradient(135deg, var(--warm-chestnut), var(--soft-clay));">
                    <span>üíæ</span>
                    HTML Download
                </button>
                <button class="launcher-btn" onclick="location.reload()" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <span>üîÑ</span>
                    Neues Formular
                </button>
                <button class="launcher-btn" onclick="goBackToLauncher()">
                    <span>üè†</span>
                    Zur Startseite
                </button>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div class="modal" id="signatureModal">
        <div class="modal-content">
            <h3 id="signatureTitle">Unterschrift</h3>
            <canvas id="signatureCanvas" width="500" height="250" style="border: 2px solid var(--border-light); border-radius: 10px; cursor: crosshair; touch-action: none;"></canvas>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="clearSignature()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">L√∂schen</button>
                <button onclick="closeSignature()" class="btn" style="flex: 1; background: #dc3545; color: white;">Abbrechen</button>
                <button onclick="saveSignature()" class="btn btn-primary" style="flex: 1;">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Email mit Abnahmeprotokoll versenden</h3>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="field">
                <label>Kunde Email-Adresse *</label>
                <input type="email" id="emailKundeAddress" placeholder="kunde@example.com" required>
            </div>
            <div class="field">
                <label>Zus√§tzliche Nachricht</label>
                <textarea id="emailMessage" rows="3" placeholder="Optional: Zus√§tzliche Nachricht an den Kunden..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeEmailModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="sendEmailWithPDF()" class="btn btn-primary" style="flex: 1;">Email senden</button>
            </div>
        </div>
    </div>

    <!-- Worker Modal -->
    <div class="modal" id="workerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Neuen Mitarbeiter hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeWorkerModal()">&times;</button>
            </div>
            <div class="field">
                <label>Name des Mitarbeiters</label>
                <input type="text" id="newWorkerName" placeholder="z.B. Max Mustermann" maxlength="50">
                <small style="color: #666;">Mindestens 3 Zeichen</small>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeWorkerModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="addCustomWorker()" class="btn btn-primary" style="flex: 1;">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <!-- Material Modal -->
    <div class="modal" id="materialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Neues Material hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeMaterialModal()">&times;</button>
            </div>
            <div class="field">
                <label>Material-Bezeichnung</label>
                <input type="text" id="newMaterialName" placeholder="z.B. Speziald√ºnger" maxlength="100">
            </div>
            <div class="field">
                <label>Einheit</label>
                <input type="text" id="newMaterialUnit" placeholder="z.B. kg, Liter, St√ºck" maxlength="20">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeMaterialModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="addCustomMaterial()" class="btn btn-primary" style="flex: 1;">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <!-- Machine Modal -->
    <div class="modal" id="machineModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöú Neue Maschine hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeMachineModal()">&times;</button>
            </div>
            <div class="field">
                <label>Maschinen-Bezeichnung</label>
                <input type="text" id="newMachineName" placeholder="z.B. Motors√§ge Stihl MS 261" maxlength="100">
            </div>
            <div class="field">
                <label>Einheit</label>
                <input type="text" id="newMachineUnit" placeholder="z.B. Std., Tag, Einsatz" maxlength="20">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeMachineModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="addCustomMachine()" class="btn btn-primary" style="flex: 1;">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // üîß GLOBALE VARIABLEN & STAMMDATEN
        // ========================================
        
        let currentSignatureType = '';
        let currentSignatureDay = 1;
        let isDrawing = false;
        let daySignatures = { 1: { kunde: '', teamleiter: '' } };
        let currentDay = 1;
        let maxDays = 1;
        let currentPDFUrl = null;

        // üì∑ BILD-MANAGEMENT
        let uploadedImages = [];

        // === BILD-OPTIMIERUNG F√úR PDF ===
        function compressImageForPDF(imageData, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedData = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedData);
                };
                
                img.src = imageData;
            });
        }

        async function optimizeImagesForPDF(images) {
            if (!images || !Array.isArray(images)) return [];
            
            const optimizedImages = [];
            
            for (const image of images) {
                try {
                    if (!image.data || !image.data.startsWith('data:image/')) continue;
                    
                    const base64Data = image.data.split(',')[1];
                    const sizeInMB = ((base64Data.length * 3) / 4) / (1024 * 1024);
                    
                    let processedData = image.data;
                    
                    // Komprimiere Bilder √ºber 2MB
                    if (sizeInMB > 2) {
                        processedData = await compressImageForPDF(image.data, 800, 0.7);
                    }
                    
                    optimizedImages.push({
                        ...image,
                        data: processedData,
                        originalSize: sizeInMB.toFixed(1) + 'MB'
                    });
                    
                } catch (error) {
                    console.error(`Bild-Optimierung Fehler "${image.name}":`, error);
                }
            }
            
            return optimizedImages;
        }

        // Stammdaten aus dem Original
        const WORKERS = [
            'Fabio Kr√§mer', 'Claudiu Adascalitei', 'J√ºrgen Kr√§nkel', 
            'Joseph Dahl', 'Wolfgang Degro', 'Christian Weinrank',
            'Christian Winterstein', 'Carsten Munz', 'Sascha Macke', 'Julina Tiedtke', 
            'Kim Honnecker', 'Jan Jeanrond', 'Justin Stillemunkes'
        ];

        const MATERIALS = [
            { name: 'Entsorgung Gr√ºnschnitt', unit: 'cbm' },
            { name: 'Entsorgung Kn√∂terich -Sonderm√ºll-', unit: 'to.' },
            { name: 'Kieferndekorrinde 0-15', unit: 'Sack' },
            { name: 'Rindenmulch 15-45', unit: 'Sack' },
            { name: 'Pinienrinde 15-25', unit: 'Sack' },
            { name: 'Pinienrinde 8-16', unit: 'Sack' },
            { name: 'Corthum G√§rtnererde 50l', unit: 'Sack' },
            { name: 'Mutterboden, gesiebt (sehr fein)', unit: 'cbm' },
            { name: 'Entsorgung Erdmassen', unit: 'cbm' },
        ];

        const MACHINES = [
            { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Std.' },
            { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Tag' },
            { name: 'Kompaktlader Vermeer', unit: 'Std.' },
            { name: 'Gro√üfl√§chen-Aufsitzm√§her mit Hochkipp-Funktion', unit: 'Std.' },
            { name: 'Gro√üfl√§chen-Mulcher (0-Wendekreism√§her)', unit: 'Std.' },
            { name: 'Ferris Mulchm√§her', unit: 'Std.' },
            { name: 'Minibagger Kubota (1 to.)', unit: 'Std.' },
            { name: 'Minibagger Cat 3.18 (2 to.)', unit: 'Std.' }
        ];

        // ========================================
        // üéØ NAVIGATION FUNKTIONEN
        // ========================================
        function openForm() {
            try {
                console.log('üå± √ñffne Formular...');
                
                document.getElementById('launcherPage').style.display = 'none';
                document.getElementById('formularPage').classList.add('active');
                
                const today = new Date().toISOString().split('T')[0];
                const startdatumEl = document.getElementById('startdatum');
                if (startdatumEl) {
                    startdatumEl.value = today;
                }
                
                populateDropdowns();
                updateHoursSummary();
                setupDragAndDrop(); // Drag & Drop f√ºr Bilder initialisieren
                
                console.log('‚úÖ Formular erfolgreich ge√∂ffnet');
                
            } catch (error) {
                console.error('‚ùå Fehler beim √ñffnen des Formulars:', error);
                alert('Fehler beim √ñffnen des Formulars. Seite wird neu geladen.');
                location.reload();
            }
        }

        function goBackToLauncher() {
            try {
                console.log('üè† Zur√ºck zur Startseite...');
                
                document.getElementById('formularPage').classList.remove('active');
                document.getElementById('successPage').classList.remove('active');
                document.getElementById('launcherPage').style.display = 'flex';
                
                console.log('‚úÖ Zur√ºck zur Startseite erfolgreich');
                
            } catch (error) {
                console.error('‚ùå Navigation Fehler:', error);
                location.reload();
            }
        }

        // ========================================
        // üîß SYSTEM-FUNKTIONEN & GOOGLE INTEGRATION
        // ========================================
        
        // Google Apps Script URL - KONFIGURIERT F√úR IHRE UMGEBUNG
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxajxH7qCrerYJKQTZQxPPkVhGJvTjYDOoFGtuPcoF6S2ggxMZCcNKdoiGdf3RgSdbBng/exec';
        
        // DriveFixSystem Class f√ºr robuste Speicherung
        class DriveFixSystem {
            constructor() {
                this.maxRetries = 3;
                this.baseDelay = 1000;
            }

            async bulletproofSave(data, filename) {
                for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
                    try {
                        console.log(`üìÅ Drive-Speicherung Versuch ${attempt}/${this.maxRetries}`);
                        
                        const result = await this.saveToGoogleDrive(data, filename);
                        
                        console.log('‚úÖ Drive-Speicherung erfolgreich:', result);
                        return result;
                        
                    } catch (error) {
                        console.error(`‚ùå Drive-Versuch ${attempt} fehlgeschlagen:`, error);
                        
                        if (attempt === this.maxRetries) {
                            throw new Error(`Drive-Speicherung nach ${this.maxRetries} Versuchen fehlgeschlagen: ${error.message}`);
                        }
                        
                        // Exponential backoff
                        const delay = this.baseDelay * Math.pow(2, attempt - 1);
                        await this.wait(delay);
                    }
                }
            }

            async saveToGoogleDrive(data, filename) {
                const payload = {
                    action: 'savePDF',
                    htmlContent: data,
                    filename: filename,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                return { success: true, message: 'Erfolgreich in Google Drive gespeichert' };
            }

            async wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async diagnoseDriveAccess() {
                try {
                    const testPayload = {
                        action: 'test',
                        timestamp: new Date().toISOString()
                    };

                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(testPayload)
                    });

                    return { status: 'ok', message: 'Drive-Zugriff funktioniert' };
                } catch (error) {
                    return { status: 'error', message: error.message };
                }
            }
        }

        const driveFixSystem = new DriveFixSystem();

        // Google Sheets Integration
        async function sendToGoogleSheets(data, isTest = false) {
            try {
                console.log('üìä Sende Daten zu Google Sheets...', data);
                
                const payload = {
                    action: 'saveData',
                    data: data,
                    test: isTest,
                    timestamp: new Date().toISOString()
                };
                
                // METHODE 1: POST mit no-cors (funktioniert immer)
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('‚úÖ Sheets: Daten gesendet (no-cors mode)');
                    return { success: true, message: 'Google Sheets Update erfolgreich', method: 'POST no-cors' };
                    
                } catch (postError) {
                    console.warn('‚ö†Ô∏è POST Methode fehlgeschlagen:', postError);
                }
                
                // METHODE 2: GET mit URL-Parametern (Fallback)
                try {
                    const urlParams = new URLSearchParams({
                        action: 'saveData',
                        data: JSON.stringify(data),
                        test: isTest ? 'true' : 'false',
                        timestamp: new Date().toISOString()
                    });
                    
                    const getUrl = `${GOOGLE_SCRIPT_URL}?${urlParams.toString()}`;
                    
                    // Verwende img-Tag Trick f√ºr no-cors GET
                    const img = new Image();
                    img.onload = () => console.log('‚úÖ Sheets: GET Fallback erfolgreich');
                    img.onerror = () => console.log('‚úÖ Sheets: GET Fallback gesendet (Fehler ist normal)');
                    img.src = getUrl;
                    
                    console.log('‚úÖ Sheets: GET Fallback verwendet');
                    return { success: true, message: 'Google Sheets Update √ºber GET Fallback', method: 'GET fallback' };
                    
                } catch (getError) {
                    console.warn('‚ö†Ô∏è GET Fallback fehlgeschlagen:', getError);
                }
                
                throw new Error('Alle √úbertragungsmethoden fehlgeschlagen');
                
            } catch (error) {
                console.error('‚ùå Google Sheets Integration komplett fehlgeschlagen:', error);
                
                // Backup lokal speichern
                try {
                    const backup = {
                        timestamp: new Date().toISOString(),
                        data: data,
                        error: error.message
                    };
                    localStorage.setItem('gardenKeeper_sheets_backup', JSON.stringify(backup));
                    console.log('üíæ Daten als Backup lokal gespeichert');
                } catch (backupError) {
                    console.error('‚ùå Backup speichern fehlgeschlagen:', backupError);
                }

                return { 
                    success: false, 
                    error: error.message,
                    backup: true
                };
            }
        }

        // Bulletproof Save f√ºr PDF zu Google Drive
        async function bulletproofSaveToGoogleDrive(data) {
            try {
                const filename = `gardenKeeper_${data.kunde.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}`;
                
                // Bilder f√ºr Drive optimieren
                if (data.images && data.images.length > 0) {
                    data.images = await optimizeImagesForPDF(data.images);
                }
                
                const htmlContent = generatePDFHTML(data);
                const result = await driveFixSystem.bulletproofSave(htmlContent, filename);
                return result;
                
            } catch (error) {
                console.error('‚ùå Bulletproof Drive-Speicherung fehlgeschlagen:', error);
                throw error;
            }
        }

        // Test-System f√ºr Drive & Sheets
        async function testSystem() {
            showMessage('üîÑ Teste Google Drive & Sheets Verbindung...', 'info');
            
            let driveOk = false;
            let sheetsOk = false;
            let sheetsMethod = '';
            
            try {
                // Drive-Test
                console.log('üìÅ Teste Google Drive Zugriff...');
                const driveResult = await driveFixSystem.diagnoseDriveAccess();
                driveOk = driveResult.status === 'ok';
                console.log('üìÅ Drive-Test Ergebnis:', driveResult);
                
                // Sheets-Test mit verbesserter Diagnose
                console.log('üìä Teste Google Sheets Verbindung...');
                const testData = {
                    kunde: 'Test-Kunde',
                    startdatum: new Date().toISOString().split('T')[0],
                    days: [{
                        dayNumber: 1,
                        beschreibungArbeiten: 'System-Test durchgef√ºhrt',
                        workers: ['System-Test']
                    }],
                    checkboxes: { komplett: true }
                };
                
                const sheetsResult = await sendToGoogleSheets(testData, true);
                sheetsOk = sheetsResult.success;
                sheetsMethod = sheetsResult.method || 'unbekannt';
                console.log('üìä Sheets-Test Ergebnis:', sheetsResult);
                
                // Apps Script URL Test
                console.log('üîó Apps Script URL:', GOOGLE_SCRIPT_URL);
                
            } catch (error) {
                console.error('‚ùå Test-Fehler:', error);
            }
            
            const driveStatus = driveOk ? '‚úÖ Funktioniert' : '‚ö†Ô∏è √úberpr√ºfung n√∂tig';
            const sheetsStatus = sheetsOk ? `‚úÖ Funktioniert (${sheetsMethod})` : '‚ö†Ô∏è √úberpr√ºfung n√∂tig';
            
            showMessage(`
                üîó <strong>Google Integration Status:</strong><br><br>
                üìÅ <strong>Google Drive:</strong> ${driveStatus}<br>
                üìä <strong>Google Sheets:</strong> ${sheetsStatus}<br><br>
                ${driveOk && sheetsOk ? 
                    '<strong style="color: green;">üéâ Alle Systeme funktionieren!</strong><br><br>‚úÖ <strong>PDFs</strong> werden in Google Drive gespeichert<br>‚úÖ <strong>Daten</strong> werden in Google Sheets archiviert<br><br>Das System ist vollst√§ndig einsatzbereit!' :
                    '<strong style="color: orange;">üìã Status-Information:</strong><br><br>Das gardenKeeper¬Æ Formular funktioniert <strong>vollst√§ndig</strong>, auch wenn einzelne Cloud-Services gerade nicht verf√ºgbar sind.<br><br>‚Ä¢ ‚úÖ <strong>Lokale Speicherung:</strong> Alle Daten werden lokal gesichert<br>‚Ä¢ ‚úÖ <strong>PDF-Erstellung:</strong> Funktioniert immer<br>‚Ä¢ ‚úÖ <strong>Email-Versand:</strong> Funktioniert unabh√§ngig<br>‚Ä¢ üîÑ <strong>Cloud-Sync:</strong> Wird nachgeholt sobald verf√ºgbar'
                }<br><br>
                <small>üîß <strong>Apps Script URL:</strong> ${GOOGLE_SCRIPT_URL.substring(0, 50)}...</small><br>
                <small>üí° <strong>Bei Problemen:</strong> An Chef u. Chefin wenden</small>
            `, driveOk && sheetsOk ? 'success' : 'info');
            
            return { driveOk, sheetsOk, sheetsMethod };
        }

        function saveDraft() {
            try {
                const formData = getFormData();
                localStorage.setItem('gardenKeeper_draft', JSON.stringify(formData));
                showMessage('üíæ Entwurf erfolgreich gespeichert!', 'success');
                console.log('‚úÖ Entwurf gespeichert');
            } catch (error) {
                showMessage('‚ùå Fehler beim Speichern: ' + error.message, 'error');
                console.error('‚ùå Speicher-Fehler:', error);
            }
        }

        function runSpellCheck() {
    showMessage('üîç Starte Rechtschreibpr√ºfung...', 'info');
    
    const textFields = ['kunde', 'adresse', 'projektBeschreibung', 'bemerkungen', 'teamleiter', 'mitarbeiter', 'materialien'];
    let errorsFound = 0;
    let checkedFields = 0;
    
    textFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value.trim()) {
            checkedFields++;
            field.setAttribute('spellcheck', 'true');
            field.setAttribute('lang', 'de-DE');
            
            if (field.value.match(/\b(falsch|fehler|test123|asdfgh|xyz123)\b/gi)) {
                field.style.borderColor = '#ef4444';
                field.style.backgroundColor = '#fef2f2';
                errorsFound++;
            } else {
                field.style.borderColor = '#22c55e';
                field.style.backgroundColor = '#f0fdf4';
            }
        }
    });
    
    setTimeout(() => {
        if (errorsFound > 0) {
            showMessage(`‚ö†Ô∏è ${errorsFound} m√∂gliche Rechtschreibfehler gefunden! Bitte √ºberpr√ºfen Sie die rot markierten Felder.`, 'warning');
        } else {
            showMessage(`‚úÖ Rechtschreibpr√ºfung abgeschlossen! ${checkedFields} Felder gepr√ºft, keine Fehler gefunden.`, 'success');
        }
    }, 1500);
}

        function handleImageUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    processImage(file);
                }
            }
            event.target.value = ''; // Reset input
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    data: e.target.result,
                    type: file.type,
                    category: 'arbeitsfortschritt',
                    description: '',
                    timestamp: new Date().toISOString()
                };
                
                uploadedImages.push(imageData);
                displayImagePreview(imageData);
                showMessage(`üì∑ Bild "${file.name}" hinzugef√ºgt`, 'success');
            };
            reader.readAsDataURL(file);
        }

        function displayImagePreview(imageData) {
            const container = document.getElementById('imagePreviewContainer');
            
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            previewDiv.setAttribute('data-image-id', imageData.id);
            
            previewDiv.innerHTML = `
                <button class="image-remove" onclick="removeImage('${imageData.id}')">&times;</button>
                <img src="${imageData.data}" alt="${imageData.name}">
                <div class="image-info">
                    <div class="image-category">${getCategoryDisplayName(imageData.category)}</div>
                    <div class="image-description">${imageData.name}</div>
                    <select class="image-category-select" onchange="updateImageCategory('${imageData.id}', this.value)">
                        <option value="arbeitsfortschritt" ${imageData.category === 'arbeitsfortschritt' ? 'selected' : ''}>Arbeitsfortschritt</option>
                        <option value="vorher" ${imageData.category === 'vorher' ? 'selected' : ''}>Vorher-Zustand</option>
                        <option value="nachher" ${imageData.category === 'nachher' ? 'selected' : ''}>Nachher-Ergebnis</option>
                        <option value="details" ${imageData.category === 'details' ? 'selected' : ''}>Besondere Details</option>
                        <option value="probleme" ${imageData.category === 'probleme' ? 'selected' : ''}>Probleme/Sch√§den</option>
                        <option value="materialien" ${imageData.category === 'materialien' ? 'selected' : ''}>Verwendete Materialien</option>
                    </select>
                </div>
            `;
            
            container.appendChild(previewDiv);
        }

        function removeImage(imageId) {
            uploadedImages = uploadedImages.filter(img => img.id != imageId);
            const previewElement = document.querySelector(`[data-image-id="${imageId}"]`);
            if (previewElement) {
                previewElement.remove();
            }
            showMessage('üì∑ Bild entfernt', 'info');
        }

        function updateImageCategory(imageId, newCategory) {
            const image = uploadedImages.find(img => img.id == imageId);
            if (image) {
                image.category = newCategory;
                
                // Update display
                const categoryDisplay = document.querySelector(`[data-image-id="${imageId}"] .image-category`);
                if (categoryDisplay) {
                    categoryDisplay.textContent = getCategoryDisplayName(newCategory);
                }
            }
        }

        function getCategoryDisplayName(category) {
            const categories = {
                'arbeitsfortschritt': 'Arbeitsfortschritt',
                'vorher': 'Vorher-Zustand',
                'nachher': 'Nachher-Ergebnis',
                'details': 'Besondere Details',
                'probleme': 'Probleme/Sch√§den',
                'materialien': 'Verwendete Materialien'
            };
            return categories[category] || 'Unbekannt';
        }

        // Drag & Drop Support
        function setupDragAndDrop() {
            const uploadZone = document.querySelector('.upload-zone');
            
            uploadZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                for (let file of files) {
                    if (file.type.startsWith('image/')) {
                        processImage(file);
                    }
                }
            });
        }

        function getFormData() {
            const data = {
                kunde: document.getElementById('kunde').value.trim(),
                kundenEmail: document.getElementById('kundenEmail').value.trim(),
                lexofficeId: document.getElementById('lexofficeId').value.trim(),
                startdatum: document.getElementById('startdatum').value,
                projektbeschreibung: document.getElementById('projektbeschreibung').value.trim(),
                ansprechpartner: document.getElementById('ansprechpartner').value.trim(),
                days: [],
                checkboxes: {
                    auftragGemaess: document.getElementById('auftragGemaess').checked,
                    komplett: document.getElementById('komplett').checked,
                    teilweise: document.getElementById('teilweise').checked,
                    ordnungsGemaess: document.getElementById('ordnungsGemaess').checked,
                    kundeZufrieden: document.getElementById('kundeZufrieden').checked,
                    arbeitsplatzSauber: document.getElementById('arbeitsplatzSauber').checked
                },
                bemerkungen: document.getElementById('bemerkungen').value.trim(),
                signatures: daySignatures,
                images: uploadedImages  // BILDER HINZUGEF√úGT
            };

            for (let dayNum = 1; dayNum <= maxDays; dayNum++) {
                const dayContent = document.getElementById(`day${dayNum}`);
                if (dayContent) {
                    const dayData = getDayData(dayContent, dayNum);
                    data.days.push(dayData);
                }
            }

            return data;
        }

        function getDayData(dayContent, dayNumber) {
            const workers = [];
            dayContent.querySelectorAll('.worker-select').forEach(select => {
                if (select.value) {
                    workers.push(select.value);
                }
            });

            const materials = [];
            dayContent.querySelectorAll('.material-row').forEach(row => {
                const material = row.querySelector('.material-select').value;
                const amount = row.querySelector('.material-amount').value;
                const isFremdeinkauf = row.querySelector('.fremdeinkauf-checkbox').checked;
                
                if (material) {
                    const materialData = { material, amount };
                    if (isFremdeinkauf) {
                        materialData.fremdeinkauf = {
                            details: row.querySelector('.fremdeinkauf-details').value,
                            isFremdeinkauf: true
                        };
                    }
                    materials.push(materialData);
                }
            });

            const machines = [];
            dayContent.querySelectorAll('.machine-row').forEach(row => {
                const machine = row.querySelector('.machine-select').value;
                const duration = row.querySelector('.machine-duration').value;
                if (machine) {
                    machines.push({ machine, duration });
                }
            });

            return {
                dayNumber,
                ladebeginn: dayContent.querySelector('.ladebeginn').value,
                abfahrt: dayContent.querySelector('.abfahrt').value,
                arbeitszeitBeginn: dayContent.querySelector('.arbeitszeit-beginn').value,
                arbeitszeitEnde: dayContent.querySelector('.arbeitszeit-ende').value,
                pause: parseInt(dayContent.querySelector('.pause').value) || 0,
                regenpause: parseInt(dayContent.querySelector('.regenpause').value) || 0,
                workers,
                machines,
                materials,
                beschreibungArbeiten: dayContent.querySelector('.beschreibung-arbeiten').value.trim(),
                zusatzarbeiten: dayContent.querySelector('.zusatzarbeiten').value.trim()
            };
        }

        // ========================================
        // ‚è∞ STUNDENBERECHNUNG
        // ========================================
        function updateHoursSummary() {
            const currentDayContent = document.querySelector('.day-content.active');
            if (!currentDayContent) return;

            const summaryDiv = currentDayContent.querySelector('.hours-summary');
            const hoursListDiv = summaryDiv.querySelector('.hours-list');
            const totalDiv = summaryDiv.querySelector('.total');

            const beginTime = currentDayContent.querySelector('.arbeitszeit-beginn').value;
            const endTime = currentDayContent.querySelector('.arbeitszeit-ende').value;
            const pause = parseInt(currentDayContent.querySelector('.pause').value) || 0;
            const regenpause = parseInt(currentDayContent.querySelector('.regenpause').value) || 0;

            const workers = [];
            currentDayContent.querySelectorAll('.worker-select').forEach(select => {
                if (select.value) {
                    workers.push(select.value);
                }
            });

            if (!beginTime || !endTime || workers.length === 0) {
                hoursListDiv.innerHTML = '<div>Arbeitszeiten und Mitarbeiter eingeben</div>';
                totalDiv.textContent = 'Gesamtstunden: 0 Std.';
                return;
            }

            const workHours = calculateWorkHours(beginTime, endTime, pause + regenpause);
            let hoursListHTML = '';
            
            workers.forEach(worker => {
                hoursListHTML += `<div>${worker}: ${workHours.toFixed(2)} Stunden</div>`;
            });

            const totalHours = workHours * workers.length;
            
            hoursListDiv.innerHTML = hoursListHTML;
            totalDiv.textContent = `Gesamtstunden: ${totalHours.toFixed(2)} Std.`;
        }

        function calculateWorkHours(beginTime, endTime, totalPauseMinutes) {
            const begin = new Date(`2000-01-01 ${beginTime}`);
            const end = new Date(`2000-01-01 ${endTime}`);
            
            let diffMs = end - begin;
            if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
            
            const workMinutes = (diffMs / (1000 * 60)) - totalPauseMinutes;
            return Math.max(0, workMinutes / 60);
        }

        // ========================================
        // üìÖ TAG-MANAGEMENT
        // ========================================
        function addDay() {
            maxDays++;
            
            const dayTabs = document.getElementById('dayTabs');
            const newTab = document.createElement('div');
            newTab.className = 'day-tab';
            newTab.setAttribute('data-day', maxDays);
            newTab.textContent = `Tag ${maxDays}`;
            newTab.onclick = () => switchDay(maxDays);
            dayTabs.appendChild(newTab);
            
            const dayContainer = document.getElementById('dayContentContainer');
            const newDayContent = document.querySelector('#day1').cloneNode(true);
            newDayContent.id = `day${maxDays}`;
            newDayContent.classList.remove('active');
            
            updateSignatureBoxesForDay(newDayContent, maxDays);
            resetDayContent(newDayContent);
            
            dayContainer.appendChild(newDayContent);
            populateDropdownsInDay(newDayContent);
            
            daySignatures[maxDays] = { kunde: '', teamleiter: '' };
            
            switchDay(maxDays);
            showMessage(`‚úÖ Tag ${maxDays} hinzugef√ºgt`, 'success');
        }

        function switchDay(dayNumber) {
            currentDay = dayNumber;
            
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-day="${dayNumber}"]`).classList.add('active');
            
            document.querySelectorAll('.day-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`day${dayNumber}`).classList.add('active');
            
            updateHoursSummary();
        }

        function updateSignatureBoxesForDay(dayContent, dayNumber) {
            const signatureBoxes = dayContent.querySelectorAll('.signature-box');
            const signatureHeaders = dayContent.querySelectorAll('.signature-section h4');
            
            signatureBoxes.forEach(box => {
                const type = box.getAttribute('data-type');
                box.setAttribute('data-day', dayNumber);
                box.onclick = () => openSignature(type, dayNumber);
            });
            
            signatureHeaders.forEach(header => {
                if (header.textContent.includes('Kunde')) {
                    header.textContent = `Unterschrift Kunde (Tag ${dayNumber})`;
                } else if (header.textContent.includes('Teamleiter')) {
                    header.textContent = `Unterschrift Teamleiter (Tag ${dayNumber})`;
                }
            });
        }

        function resetDayContent(dayContent) {
            dayContent.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else if (field.classList.contains('arbeitszeit-beginn')) {
                    field.value = '06:45';
                } else {
                    field.value = '';
                }
            });
        }

        // ========================================
        // üë• MITARBEITER-MANAGEMENT
        // ========================================
        function addWorker() {
            const currentDayContent = document.querySelector('.day-content.active');
            const container = currentDayContent.querySelector('.workers-container');
            
            const workerHTML = `
                <div class="worker-row">
                    <div class="field">
                        <label>Mitarbeiter</label>
                        <select class="worker-select" onchange="updateHoursSummary()">
                            <option value="">Mitarbeiter ausw√§hlen</option>
                        </select>
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeWorker(this)" class="remove-btn">√ó</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', workerHTML);
            
            const newSelect = container.lastElementChild.querySelector('.worker-select');
            WORKERS.forEach(worker => {
                newSelect.innerHTML += `<option value="${worker}">${worker}</option>`;
            });
            
            showMessage('üë∑‚Äç‚ôÇÔ∏è Mitarbeiter hinzugef√ºgt', 'info');
        }

        function removeWorker(button) {
            const currentDayContent = document.querySelector('.day-content.active');
            const workerRows = currentDayContent.querySelectorAll('.worker-row');
            
            if (workerRows.length > 1) {
                button.closest('.worker-row').remove();
                updateHoursSummary();
                showMessage('üë∑‚Äç‚ôÇÔ∏è Mitarbeiter entfernt', 'info');
            } else {
                showMessage('‚ö†Ô∏è Mindestens ein Mitarbeiter muss vorhanden sein', 'warning');
            }
        }

        function openWorkerModal() {
            document.getElementById('workerModal').classList.add('show');
        }

        function closeWorkerModal() {
            document.getElementById('workerModal').classList.remove('show');
            document.getElementById('newWorkerName').value = '';
        }

        function addCustomWorker() {
            const name = document.getElementById('newWorkerName').value.trim();
            
            if (name.length < 3) {
                showMessage('‚ùå Name muss mindestens 3 Zeichen haben', 'error');
                return;
            }
            
            if (WORKERS.includes(name)) {
                showMessage('‚ùå Mitarbeiter existiert bereits', 'error');
                return;
            }
            
            WORKERS.push(name);
            populateDropdowns();
            
            closeWorkerModal();
            showMessage(`‚úÖ Mitarbeiter "${name}" hinzugef√ºgt`, 'success');
        }

        // ========================================
        // üöú MASCHINEN-MANAGEMENT
        // ========================================
        function addMachine() {
            const currentDayContent = document.querySelector('.day-content.active');
            const container = currentDayContent.querySelector('.machines-container');
            
            const machineHTML = `
                <div class="machine-row">
                    <div class="field">
                        <label>Maschine/Ger√§t</label>
                        <select class="machine-select">
                            <option value="">Maschine ausw√§hlen</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Einsatzdauer</label>
                        <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeMachine(this)" class="remove-btn">√ó</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', machineHTML);
            
            const newSelect = container.lastElementChild.querySelector('.machine-select');
            MACHINES.forEach(machine => {
                newSelect.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
            });
            
            showMessage('üöú Maschine hinzugef√ºgt', 'info');
        }

        function removeMachine(button) {
            button.closest('.machine-row').remove();
            showMessage('üöú Maschine entfernt', 'info');
        }

        function openMachineModal() {
            document.getElementById('machineModal').classList.add('show');
        }

        function closeMachineModal() {
            document.getElementById('machineModal').classList.remove('show');
            document.getElementById('newMachineName').value = '';
            document.getElementById('newMachineUnit').value = '';
        }

        function addCustomMachine() {
            const name = document.getElementById('newMachineName').value.trim();
            const unit = document.getElementById('newMachineUnit').value.trim();
            
            if (!name || !unit) {
                showMessage('‚ùå Bitte alle Felder ausf√ºllen', 'error');
                return;
            }
            
            if (MACHINES.find(m => m.name === name)) {
                showMessage('‚ùå Maschine existiert bereits', 'error');
                return;
            }
            
            MACHINES.push({ name, unit });
            populateDropdowns();
            
            closeMachineModal();
            showMessage(`‚úÖ Maschine "${name}" hinzugef√ºgt`, 'success');
        }

        // ========================================
        // üß± MATERIAL-MANAGEMENT
        // ========================================
        function addMaterial() {
            const currentDayContent = document.querySelector('.day-content.active');
            const container = currentDayContent.querySelector('.materials-container');
            
            const materialHTML = `
                <div class="material-row">
                    <div class="field">
                        <label>Material</label>
                        <select class="material-select">
                            <option value="">Material ausw√§hlen</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Menge</label>
                        <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                    </div>
                    <div class="field">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="fremdeinkauf-checkbox" onchange="toggleFremdeinkauf(this)">
                            Fremdeinkauf
                        </label>
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeMaterial(this)" class="remove-btn">√ó</button>
                    </div>
                    <div class="fremdeinkauf-section hidden">
                        <h4>üí∞ Fremdeinkauf Details</h4>
                        <div class="field">
                            <label>Beschreibung/Lieferant:</label>
                            <input type="text" class="fremdeinkauf-details" placeholder="z.B. Baumarkt XY, Lieferant Z">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', materialHTML);
            
            const newSelect = container.lastElementChild.querySelector('.material-select');
            MATERIALS.forEach(material => {
                newSelect.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
            });
            
            showMessage('üß± Material hinzugef√ºgt', 'info');
        }

        function removeMaterial(button) {
            button.closest('.material-row').remove();
            showMessage('üß± Material entfernt', 'info');
        }

        function toggleFremdeinkauf(checkbox) {
            const row = checkbox.closest('.material-row');
            const fremdeinkaufSection = row.querySelector('.fremdeinkauf-section');
            
            if (checkbox.checked) {
                fremdeinkaufSection.classList.remove('hidden');
                showMessage('üí∞ Fremdeinkauf aktiviert', 'info');
            } else {
                fremdeinkaufSection.classList.add('hidden');
            }
        }

        function openMaterialModal() {
            document.getElementById('materialModal').classList.add('show');
        }

        function closeMaterialModal() {
            document.getElementById('materialModal').classList.remove('show');
            document.getElementById('newMaterialName').value = '';
            document.getElementById('newMaterialUnit').value = '';
        }

        function addCustomMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            const unit = document.getElementById('newMaterialUnit').value.trim();
            
            if (!name || !unit) {
                showMessage('‚ùå Bitte alle Felder ausf√ºllen', 'error');
                return;
            }
            
            if (MATERIALS.find(m => m.name === name)) {
                showMessage('‚ùå Material existiert bereits', 'error');
                return;
            }
            
            MATERIALS.push({ name, unit });
            populateDropdowns();
            
            closeMaterialModal();
            showMessage(`‚úÖ Material "${name}" hinzugef√ºgt`, 'success');
        }

        // ========================================
        // ‚úèÔ∏è UNTERSCHRIFTEN-SYSTEM
        // ========================================
        function openSignature(type, day) {
            currentSignatureType = type;
            currentSignatureDay = day;
            
            const modal = document.getElementById('signatureModal');
            const title = document.getElementById('signatureTitle');
            const canvas = document.getElementById('signatureCanvas');
            
            title.textContent = `Unterschrift ${type === 'kunde' ? 'Kunde' : 'Teamleiter'} (Tag ${day})`;
            
            modal.classList.add('show');
            setupSignatureCanvas(canvas);
            
            if (daySignatures[day] && daySignatures[day][type]) {
                const img = new Image();
                img.onload = function() {
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                };
                img.src = daySignatures[day][type];
            }
        }

        function setupSignatureCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#000';
            
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing, { passive: false });
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            const ctx = canvas.getContext('2d');
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const signatureData = canvas.toDataURL();
            
            if (!daySignatures[currentSignatureDay]) {
                daySignatures[currentSignatureDay] = {};
            }
            
            daySignatures[currentSignatureDay][currentSignatureType] = signatureData;
            
            const signatureBox = document.querySelector(`[data-type="${currentSignatureType}"][data-day="${currentSignatureDay}"]`);
            signatureBox.classList.add('has-signature');
            signatureBox.innerHTML = `
                <img src="${signatureData}" style="max-width: 200px; max-height: 80px; border-radius: 4px;">
                <div style="margin-top: 8px; font-size: 0.9rem;">‚úÖ Unterschrieben</div>
            `;
            
            closeSignature();
            showMessage(`‚úÖ Unterschrift ${currentSignatureType === 'kunde' ? 'Kunde' : 'Teamleiter'} f√ºr Tag ${currentSignatureDay} gespeichert`, 'success');
        }

        function closeSignature() {
            const modal = document.getElementById('signatureModal');
            modal.classList.remove('show');
            clearSignature();
        }

        // ========================================
        // üìß EMAIL-FUNKTION
        // ========================================
        function showEmailModal() {
            const kundenEmail = document.getElementById('kundenEmail').value.trim();
            const emailField = document.getElementById('emailKundeAddress');
            
            if (kundenEmail && emailField) {
                emailField.value = kundenEmail;
                showMessage('üìß Kunden-Email automatisch √ºbernommen!', 'success');
            } else if (!kundenEmail) {
                showMessage('üí° Bitte zuerst Kunden-Email in den Grunddaten eingeben', 'info');
            }
            
            document.getElementById('emailModal').classList.add('show');
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('show');
        }

        function sendEmailWithPDF() {
            const kundeEmail = document.getElementById('emailKundeAddress').value.trim();
            const emailMessage = document.getElementById('emailMessage').value.trim();
            
            if (!kundeEmail) {
                showMessage('‚ùå Bitte Email-Adresse eingeben', 'error');
                return;
            }
            
            const formData = getFormData();
            
            const subject = encodeURIComponent('‚úÖ Ihr gardenKeeper¬Æ Projekt ist abgeschlossen - Abnahmeprotokoll');
            
            const emailContent = `
Sehr geehrte Damen und Herren,

Ihr gardenKeeper¬Æ Projekt wurde erfolgreich abgeschlossen!

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã PROJEKT-√úBERSICHT:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚îå‚îÄ Kunde: ${formData.kunde}
‚îú‚îÄ Zeitraum: ${formData.startdatum} (${formData.days.length} Tag${formData.days.length > 1 ? 'e' : ''})
‚îú‚îÄ Status: ${formData.checkboxes.komplett ? '‚úÖ Vollst√§ndig abgeschlossen' : 
           formData.checkboxes.teilweise ? '‚ö†Ô∏è Teilweise abgeschlossen' : 'üìù In Bearbeitung'}
‚îî‚îÄ Team: ${getAllWorkers(formData.days).join(', ')}

üîß DURCHGEF√úHRTE ARBEITEN:
${formData.days.map(day => `‚Ä¢ Tag ${day.dayNumber}: ${day.beschreibungArbeiten}`).join('\n')}

${emailMessage ? `
üí¨ ZUS√ÑTZLICHE HINWEISE:
${emailMessage}
` : ''}

Bei Fragen, W√ºnschen oder Anregungen stehen wir Ihnen jederzeit 
gerne zur Verf√ºgung. Empfehlen Sie uns weiter - das ist das 
sch√∂nste Kompliment f√ºr unsere Arbeit!

Mit gr√ºnen Gr√º√üen und herzlichem Dank f√ºr Ihr Vertrauen
Ihr gardenKeeper¬Æ Team

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üå± Sven Kr√§mer
gardenKeeper¬Æ GmbH
Gro√üblittersdorfer Str. 329
66130 Saarbr√ºcken

üìû Tel: 0681 9378 4009
üìß Email: info@gardenkeeper.de  
üåê Web: www.gardenkeeper.de

üåü "Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ" üåü
`;

            const body = encodeURIComponent(emailContent);
            const mailtoLink = `mailto:${kundeEmail}?cc=info@gardenkeeper.de&subject=${subject}&body=${body}`;
            
            try {
                window.location.href = mailtoLink;
                closeEmailModal();
                showMessage('üìß Email-Client ge√∂ffnet! Email ist versandbereit.', 'success');
            } catch (error) {
                navigator.clipboard.writeText(emailContent).then(() => {
                    showMessage('üìß Email-Text in Zwischenablage kopiert!', 'success');
                }).catch(() => {
                    showMessage('üìß Bitte Email-Client manuell √∂ffnen', 'info');
                });
                closeEmailModal();
            }
        }

        function getAllWorkers(days) {
            const allWorkers = new Set();
            days.forEach(day => {
                if (day.workers) {
                    day.workers.forEach(worker => allWorkers.add(worker));
                }
            });
            return Array.from(allWorkers);
        }

        // ========================================
        // üìÑ PDF-GENERIERUNG MIT BILD-INTEGRATION
        // ========================================
        async function generatePDF() {
            try {
                const formData = getFormData();
                
                if (!formData.kunde.trim()) {
                    showMessage('‚ùå Kundenname ist erforderlich!', 'error');
                    return;
                }
                
                // Bilder optimieren falls vorhanden
                if (uploadedImages.length > 0) {
                    showMessage('üì∑ Optimiere Bilder f√ºr PDF...', 'info');
                    formData.images = await optimizeImagesForPDF(uploadedImages);
                }
                
                currentPDFUrl = createPDFBlob(formData);
                window.open(currentPDFUrl, '_blank');
                showMessage('üìÑ PDF mit Bildern erfolgreich erstellt!', 'success');
                
            } catch (error) {
                showMessage('‚ùå Fehler bei PDF-Generierung: ' + error.message, 'error');
                console.error('PDF-Fehler:', error);
            }
        }

        function createPDFBlob(data) {
            const htmlContent = generatePDFHTML(data);
            const blob = new Blob([htmlContent], { type: 'text/html' });
            return URL.createObjectURL(blob);
        }

        function generatePDFHTML(data) {
            const today = new Date();
            const formattedDate = today.toLocaleDateString('de-DE');
            const formattedTime = today.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            const allWorkers = [];
            data.days.forEach(day => {
                if (day.workers) {
                    day.workers.forEach(worker => {
                        if (!allWorkers.includes(worker)) {
                            allWorkers.push(worker);
                        }
                    });
                }
            });

            let totalHours = 0;
            data.days.forEach(day => {
                if (day.arbeitszeitBeginn && day.arbeitszeitEnde && day.workers) {
                    const workHours = calculateWorkHours(day.arbeitszeitBeginn, day.arbeitszeitEnde, (day.pause || 0) + (day.regenpause || 0));
                    totalHours += workHours * day.workers.length;
                }
            });

            return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Abnahmeprotokoll - ${data.kunde}</title>
    <style>
        @media print { 
            body { margin: 0; font-size: 12px; } 
            .page-break { page-break-before: always; }
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }
        
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            line-height: 1.5; 
            margin: 20px;
            color: #2d3e2d;
        }
        
        .header { 
            background: linear-gradient(135deg, #8fa68f 0%, #a8c09a 100%);
            color: white;
            text-align: center;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .header h1 { 
            font-size: 2.5rem; 
            margin: 0 0 15px 0;
            font-weight: 700;
        }
        
        .header .company {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        
        .header .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            font-style: italic;
            margin-bottom: 15px;
        }
        
        .header .date {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .section { 
            margin-bottom: 30px;
            border: 2px solid #e8e5e2;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .section-header { 
            background: #f5f3f0;
            padding: 15px 25px;
            border-bottom: 2px solid #e8e5e2;
            font-weight: 600;
            font-size: 1.2rem;
            color: #2d3e2d;
        }
        
        .section-content {
            padding: 25px;
        }
        
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 15px; 
        }
        
        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .field {
            margin-bottom: 12px;
        }
        
        .field strong {
            color: #8fa68f;
            display: inline-block;
            min-width: 140px;
            font-weight: 600;
        }
        
        .day-section {
            border-left: 4px solid #8fa68f;
            margin-bottom: 25px;
            padding-left: 20px;
        }
        
        .day-header {
            background: linear-gradient(135deg, #8fa68f, #a8c09a);
            color: white;
            padding: 12px 20px;
            margin-left: -20px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.3rem;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            border: 1px solid #e8e5e2;
            padding: 10px 15px;
            text-align: left;
        }
        
        th {
            background: #f5f3f0;
            font-weight: 600;
            color: #2d3e2d;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #c1d4b1, #f5f3f0);
            border: 2px solid #8fa68f;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status-completed {
            color: #22c55e;
            font-weight: 600;
        }
        
        .status-partial {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .signature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }
        
        .signature-box { 
            border: 2px solid #e8e5e2; 
            height: 120px; 
            text-align: center; 
            padding: 15px;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .signature-box img {
            max-width: 100%;
            max-height: 90px;
            border-radius: 6px;
        }
        
        /* BILD-PDF STYLES */
        .images-section {
            page-break-before: always;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .image-item {
            border: 2px solid #e8e5e2;
            border-radius: 10px;
            overflow: hidden;
            page-break-inside: avoid;
            background: white;
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .image-caption {
            padding: 12px 15px;
            background: #f5f3f0;
            border-top: 1px solid #e8e5e2;
            font-size: 0.9rem;
        }

        .image-category {
            font-weight: 600;
            color: #8fa68f;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        @media print {
            .images-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .image-item img {
                height: 150px;
            }
        }
        
        .footer {
            margin-top: 50px;
            text-align: center;
            border-top: 3px solid #8fa68f;
            padding-top: 25px;
            color: #666;
        }
        
        .footer .company-info {
            color: #8fa68f;
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        
        .footer .tagline {
            font-style: italic;
            margin-bottom: 15px;
            font-size: 1rem;
        }
        
        .footer .meta {
            font-size: 0.9rem;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå± ABNAHME / TAGESREGIEBERICHT</h1>
        <div class="company">gardenKeeper¬Æ GmbH - Sven Kr√§mer</div>
        <div class="tagline">Professionelle Gartenpflege mit Stil und ‚ô•</div>
        <div class="date">Erstellt am: ${formattedDate} um ${formattedTime}</div>
    </div>
    
    <div class="section">
        <div class="section-header">
            üìã Projektdaten
        </div>
        <div class="section-content">
            <div class="grid">
                <div class="field"><strong>Kunde:</strong> ${data.kunde}</div>
                <div class="field"><strong>LexOffice-ID:</strong> ${data.lexofficeId || '---'}</div>
                <div class="field"><strong>Startdatum:</strong> ${new Date(data.startdatum).toLocaleDateString('de-DE')}</div>
                <div class="field"><strong>Projekttage:</strong> ${data.days.length}</div>
                <div class="field"><strong>Gesamtstunden:</strong> ${totalHours.toFixed(2)} Std.</div>
                ${data.kundenEmail ? `<div class="field"><strong>Kunde Email:</strong> ${data.kundenEmail}</div>` : ''}
            </div>
            ${data.projektbeschreibung ? `<div class="field"><strong>Projektbeschreibung:</strong> ${data.projektbeschreibung}</div>` : ''}
            ${data.ansprechpartner ? `<div class="field"><strong>Ansprechpartner:</strong> ${data.ansprechpartner}</div>` : ''}
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            üë• Projektteam
        </div>
        <div class="section-content">
            <strong>Eingesetzte Mitarbeiter:</strong> ${allWorkers.join(', ')}
        </div>
    </div>
    
    ${data.days.map((day, index) => `
        ${index > 0 ? '<div class="page-break"></div>' : ''}
        <div class="day-section">
            <div class="day-header">
                üìÖ Tag ${day.dayNumber} - Detailbericht
            </div>
            
            <div class="grid">
                <div>
                    <h4>‚è∞ Zeiten:</h4>
                    <div><strong>Ladebeginn:</strong> ${day.ladebeginn || '---'}</div>
                    <div><strong>Abfahrt:</strong> ${day.abfahrt || '---'}</div>
                    <div><strong>Arbeitszeit:</strong> ${day.arbeitszeitBeginn || '---'} - ${day.arbeitszeitEnde || '---'}</div>
                    <div><strong>Pause:</strong> ${day.pause || 0} Min | <strong>Regenpause:</strong> ${day.regenpause || 0} Min</div>
                </div>
                <div>
                    <h4>üë• Mitarbeiter:</h4>
                    ${(day.workers || []).map(worker => `<div>‚Ä¢ ${worker}</div>`).join('')}
                </div>
            </div>
            
            <h4>üî® Durchgef√ºhrte Arbeiten:</h4>
            <div style="background: #f5f3f0; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #8fa68f;">
                ${day.beschreibungArbeiten || 'Keine Beschreibung verf√ºgbar'}
            </div>
            
            ${day.zusatzarbeiten ? `
                <h4>‚ûï Zusatzarbeiten:</h4>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #8b7355;">
                    ${day.zusatzarbeiten}
                </div>
            ` : ''}
            
            ${day.materials && day.materials.length > 0 ? `
                <h4>üß± Materialien:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Menge</th>
                            <th>Einheit</th>
                            <th>Bemerkung</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${day.materials.map(mat => `
                            <tr>
                                <td>${mat.material}</td>
                                <td>${mat.amount}</td>
                                <td>${MATERIALS.find(m => m.name === mat.material)?.unit || ''}</td>
                                <td>${mat.fremdeinkauf ? '<span style="color: #8b7355; font-weight: 600;">Fremdeinkauf</span>' : ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
            
            ${day.machines && day.machines.length > 0 ? `
                <h4>üöú Maschinen:</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Maschine/Ger√§t</th>
                            <th>Einsatzdauer</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${day.machines.map(machine => `
                            <tr>
                                <td>${machine.machine}</td>
                                <td>${machine.duration}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : ''}
        </div>
    `).join('')}
    
    ${data.bemerkungen ? `
        <div class="section">
            <div class="section-header">
                üí¨ Gesamtbemerkungen
            </div>
            <div class="section-content">
                ${data.bemerkungen}
            </div>
        </div>
    ` : ''}

    ${data.images && data.images.length > 0 ? `
        <div class="images-section">
            <div class="section">
                <div class="section-header">
                    üì∑ Projekt-Bilder (${data.images.length} Bilder)
                </div>
                <div class="section-content">
                    <div class="images-grid">
                        ${data.images.map(image => `
                            <div class="image-item">
                                <img src="${image.data}" alt="${image.name}">
                                <div class="image-caption">
                                    <div class="image-category">${getCategoryDisplayName(image.category)}</div>
                                    <div>${image.name}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    ` : ''}

    <div class="section">
        <div class="section-header">
            üìä Projektzusammenfassung
        </div>
        <div class="section-content">
            <div class="highlight-box">
                <div class="grid grid-3">
                    <div><strong>Gesamtstunden:</strong> ${totalHours.toFixed(2)} Std.</div>
                    <div><strong>Mitarbeiter:</strong> ${allWorkers.length}</div>
                    <div><strong>Materialien:</strong> ${data.days.reduce((total, day) => total + (day.materials?.length || 0), 0)}</div>
                    <div><strong>Maschinen:</strong> ${data.days.reduce((total, day) => total + (day.machines?.length || 0), 0)}</div>
                    ${data.images ? `<div><strong>Bilder:</strong> ${data.images.length}</div>` : ''}
                </div>
            </div>
            
            <h4>Projektstatus:</h4>
            <p class="${data.checkboxes.komplett ? 'status-completed' : data.checkboxes.teilweise ? 'status-partial' : ''}">
                ${data.checkboxes.komplett ? '‚úÖ Vollst√§ndig abgeschlossen' : 
                  data.checkboxes.teilweise ? '‚ö†Ô∏è Teilweise abgeschlossen' : 'üìù In Bearbeitung'}
            </p>
            
            <h4>Weitere Best√§tigungen:</h4>
            <ul style="margin-left: 20px;">
                ${data.checkboxes.auftragGemaess ? '<li>‚úÖ Arbeiten wurden gem√§√ü Auftrag ausgef√ºhrt</li>' : ''}
                ${data.checkboxes.ordnungsGemaess ? '<li>‚úÖ Arbeiten wurden ordnungsgem√§√ü und m√§ngelfrei ausgef√ºhrt</li>' : ''}
                ${data.checkboxes.kundeZufrieden ? '<li>‚úÖ Kunde ist mit dem Ergebnis zufrieden</li>' : ''}
                ${data.checkboxes.arbeitsplatzSauber ? '<li>‚úÖ Arbeitsplatz wurde ordentlich hinterlassen</li>' : ''}
            </ul>
        </div>
    </div>
    
    <div class="section">
        <div class="section-header">
            ‚úèÔ∏è Unterschriften
        </div>
        <div class="section-content">
            ${Object.entries(data.signatures || {}).map(([dayNum, signatures]) => `
                <h4>Tag ${dayNum}:</h4>
                <div class="signature-grid">
                    <div>
                        <p><strong>Unterschrift Kunde:</strong></p>
                        <div class="signature-box">
                            ${signatures.kunde ? `<img src="${signatures.kunde}" alt="Kunde Unterschrift">` : '(Nicht unterschrieben)'}
                        </div>
                    </div>
                    <div>
                        <p><strong>Unterschrift Teamleiter:</strong></p>
                        <div class="signature-box">
                            ${signatures.teamleiter ? `<img src="${signatures.teamleiter}" alt="Teamleiter Unterschrift">` : '(Nicht unterschrieben)'}
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    </div>
    
    <div class="footer">
        <div class="company-info">üå± gardenKeeper¬Æ GmbH - Sven Kr√§mer</div>
        <div>üìû Tel: 0681 93784009 | üìß Email: info@gardenkeeper.de | üåê Web: www.gardenkeeper.de</div>
        <div class="tagline">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</div>
        <div class="meta">
            ¬© copyright by gardenKeeper 2025<br>
            Erstellt mit dem gardenKeeper¬Æ Abnahmeformular-System
        </div>
    </div>
</body>
</html>`;
        }

        // ========================================
        // üíæ HTML DOWNLOAD
        // ========================================
        function downloadHTML() {
            try {
                const formData = getFormData();
                const htmlContent = generatePDFHTML(formData);
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `gardenKeeper_Abnahme_${formData.kunde}_${new Date().toISOString().split('T')[0]}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                showMessage('üíæ HTML-Datei erfolgreich heruntergeladen!', 'success');
                
            } catch (error) {
                showMessage('‚ùå Fehler beim HTML-Download: ' + error.message, 'error');
            }
        }

        // ========================================
        // üóëÔ∏è FORMULAR KOMPLETT LEEREN (NEU!)
        // ========================================
        function clearFormCompletely() {
            console.log('üóëÔ∏è Leere Formular komplett...');
            
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else if (input.id !== 'arbeitsbeginn' && input.id !== 'arbeitsende' && input.id !== 'pause') {
                    input.value = '';
                }
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            });
            
            uploadedImages = [];
            const imageContainer = document.getElementById('imagePreviewContainer');
            if (imageContainer) {
                imageContainer.innerHTML = '';
            }
            
            localStorage.removeItem('gardenKeeper_draft');
            localStorage.removeItem('gardenKeeper_images');
            
            const today = new Date().toISOString().split('T')[0];
            const startdatumEl = document.getElementById('startdatum');
            if (startdatumEl) {
                startdatumEl.value = today;
            }
            
                        
            showMessage('‚úÖ Formular wurde komplett geleert und zur√ºckgesetzt!', 'success');
        }

        // ========================================
        // ‚úÖ ABSCHLUSS-FUNKTION MIT GOOGLE INTEGRATION
        // ========================================
        async function completeForm() {
            const completeBtn = document.getElementById('completeBtnText');
            const originalText = completeBtn.textContent;
            
            try {
                completeBtn.textContent = 'Verarbeite...';
                
                const formData = getFormData();
                const errors = validateFormData(formData);
                
                if (errors.length > 0) {
                    showMessage('‚ùå Bitte vervollst√§ndigen Sie das Formular:\n' + errors.join('\n'), 'error');
                    completeBtn.textContent = originalText;
                    return;
                }
                
                showMessage('üìä Verarbeite Daten...', 'info');
                
                // Projektdaten f√ºr Google Backend vorbereiten
                const projectData = {
                    ...formData,
                    projectId: generateProjectId(),
                    timestamp: new Date().toISOString(),
                    system: 'gardenKeeper¬Æ Abnahmeformular v2025'
                };
                
                // PDF erstellen
                try {
                    currentPDFUrl = createPDFBlob(formData);
                    showMessage('üìÑ PDF erstellt!', 'success');
                } catch (pdfError) {
                    console.error('PDF Fehler:', pdfError);
                    showMessage('‚ö†Ô∏è PDF-Generierung teilweise erfolgreich', 'warning');
                }

                // Google Sheets Archivierung
                try {
                    showMessage('üìä Archiviere Daten in Google Sheets...', 'info');
                    const sheetsResult = await sendToGoogleSheets(projectData);
                    if (sheetsResult.success) {
                        showMessage('‚úÖ Daten erfolgreich in Google Sheets archiviert!', 'success');
                    } else {
                        showMessage('‚ö†Ô∏è Sheets-Archivierung fehlgeschlagen, Daten lokal gespeichert', 'warning');
                    }
                } catch (sheetsError) {
                    console.warn('‚ö†Ô∏è Google Sheets Archivierung fehlgeschlagen:', sheetsError);
                    showMessage('‚ö†Ô∏è Sheets-Archivierung √ºbersprungen', 'warning');
                }
                
                // Google Drive PDF-Speicherung
                try {
                    showMessage('üìÅ Speichere PDF in Google Drive...', 'info');
                    const driveResult = await bulletproofSaveToGoogleDrive(formData);
                    showMessage('‚úÖ PDF sicher in Google Drive gespeichert!', 'success');
                } catch (driveError) {
                    console.warn('‚ö†Ô∏è Google Drive Speicherung fehlgeschlagen:', driveError);
                    showMessage('‚ö†Ô∏è Drive-Speicherung fehlgeschlagen, PDF lokal verf√ºgbar', 'warning');
                }
                
                // Email-Benachrichtigung senden (optional)
                try {
                    if (formData.kundenEmail) {
                        const emailResult = await sendNotificationEmail(projectData);
                        if (emailResult.success) {
                            showMessage('üìß Email-Benachrichtigung erfolgreich versendet!', 'success');
                        }
                    }
                } catch (emailError) {
                    console.warn('‚ö†Ô∏è Email-Benachrichtigung fehlgeschlagen:', emailError);
                }
                
                showMessage('üéâ Abnahme erfolgreich abgeschlossen und archiviert!', 'success');
                
                setTimeout(() => {
                    document.getElementById('formularPage').classList.remove('active');
                    document.getElementById('successPage').classList.add('active');
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Kompletter Fehler:', error);
                showMessage(`‚ùå Fehler: ${error.message}`, 'error');
            } finally {
                completeBtn.textContent = originalText;
            }
        }

        // Projekt-ID generieren
        function generateProjectId() {
            const timestamp = new Date();
            const year = timestamp.getFullYear();
            const month = String(timestamp.getMonth() + 1).padStart(2, '0');
            const day = String(timestamp.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            return `GK-${year}${month}${day}-${random}`;
        }

        // Email-Benachrichtigung senden
        async function sendNotificationEmail(projectData) {
            try {
                const emailPayload = {
                    action: 'sendNotification',
                    data: projectData,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emailPayload)
                });

                return { success: true, message: 'Email-Benachrichtigung versendet' };
                
            } catch (error) {
                console.error('‚ùå Email-Benachrichtigung Fehler:', error);
                return { success: false, error: error.message };
            }
        }

        function validateFormData(data) {
            const errors = [];
            
            if (!data.kunde || !data.kunde.trim()) {
                errors.push('‚Ä¢ Kundenname fehlt');
            }
            
            if (!data.startdatum) {
                errors.push('‚Ä¢ Startdatum fehlt');
            }
            
            if (!data.days || data.days.length === 0) {
                errors.push('‚Ä¢ Keine Arbeitstage vorhanden');
                return errors;
            }
            
            data.days.forEach((day, index) => {
                if (!day.beschreibungArbeiten || !day.beschreibungArbeiten.trim()) {
                    errors.push(`‚Ä¢ Tag ${day.dayNumber}: Arbeitsbeschreibung fehlt`);
                }
                
                if (!day.workers || day.workers.length === 0) {
                    errors.push(`‚Ä¢ Tag ${day.dayNumber}: Mindestens ein Mitarbeiter erforderlich`);
                }
            });
            
            return errors;
        }

        // ========================================
        // üõ†Ô∏è HILFSFUNKTIONEN
        // ========================================
        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            if (!statusDiv) return;
            
            const className = `status-message status-${type}`;
            statusDiv.innerHTML = `<div class="${className}">${message.replace(/\n/g, '<br>')}</div>`;
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, type === 'error' ? 8000 : 4000);
        }

        function populateDropdowns() {
            document.querySelectorAll('.day-content').forEach(dayContent => {
                populateDropdownsInDay(dayContent);
            });
        }

        function populateDropdownsInDay(dayContent) {
            dayContent.querySelectorAll('.worker-select').forEach(select => {
                select.innerHTML = '<option value="">Mitarbeiter ausw√§hlen</option>';
                WORKERS.forEach(worker => {
                    select.innerHTML += `<option value="${worker}">${worker}</option>`;
                });
            });

            dayContent.querySelectorAll('.material-select').forEach(select => {
                select.innerHTML = '<option value="">Material ausw√§hlen</option>';
                MATERIALS.forEach(material => {
                    select.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
                });
            });

            dayContent.querySelectorAll('.machine-select').forEach(select => {
                select.innerHTML = '<option value="">Maschine ausw√§hlen</option>';
                MACHINES.forEach(machine => {
                    select.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
                });
            });
        }

        // ========================================
        // üöÄ INITIALISIERUNG
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üå± gardenKeeper¬Æ System wird initialisiert...');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const startdatumEl = document.getElementById('startdatum');
                if (startdatumEl) {
                    startdatumEl.value = today;
                }
                
                if (!daySignatures[1]) {
                    daySignatures[1] = { kunde: '', teamleiter: '' };
                }
                
                populateDropdowns();
                updateHoursSummary();
                
                setTimeout(() => {
                    showMessage(`
                        üéâ <strong>gardenKeeper¬Æ Abnahmeformular bereit!</strong><br><br>
                        ‚úÖ Modernes Design nach Ihren Farbvorgaben<br>
                        ‚úÖ Sanfte Gr√ºn- und Braunt√∂ne integriert<br>
                        ‚úÖ Vollst√§ndige Funktionalit√§t<br>
                        ‚úÖ Touch-optimiert f√ºr Tablets<br>
                        ‚úÖ PDF-Generierung einsatzbereit<br>
                        ‚úÖ Unterschriften-System aktiv<br>
                        ‚úÖ Email-Integration verf√ºgbar<br>
                        ‚úÖ <strong>BILD-UPLOAD UND PDF-INTEGRATION AKTIV!</strong><br><br>
                        üå± Das System ist sofort einsatzbereit!
                    `, 'success');
                }, 2000);
                
                console.log('‚úÖ gardenKeeper¬Æ System erfolgreich initialisiert');
                
            } catch (error) {
                console.error('‚ùå Initialisierungsfehler:', error);
                showMessage('‚ùå Fehler bei der Initialisierung. Seite neu laden.', 'error');
            }
        });

        // Modal-Schlie√üen bei Au√üenklick
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Globaler Fehler-Handler
        window.addEventListener('error', function(event) {
            console.error('üö® Globaler Fehler:', event.error);
            showMessage('‚ùå Ein unerwarteter Fehler ist aufgetreten. Bitte versuchen Sie es erneut.', 'error');
        });

        // Debug-Objekt f√ºr Entwicklung
        window.gardenKeeperDebug = {
            getFormData: getFormData,
            validateFormData,
            daySignatures,
            maxDays,
            currentDay,
            WORKERS,
            MATERIALS,
            MACHINES,
            uploadedImages,
            optimizeImagesForPDF,
            version: 'gardenKeeper¬Æ v2025 - MIT BILD-PDF-INTEGRATION'
        };

        console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                              ‚ïë
‚ïë    üå± gardenKeeper¬Æ ABNAHMEFORMULAR v2025                   ‚ïë
‚ïë                                                              ‚ïë
‚ïë    ‚úÖ NEUES DESIGN NACH IHREN FARBVORGABEN                 ‚ïë
‚ïë    ‚úÖ Sanfte Gr√ºn- und Braunt√∂ne                           ‚ïë
‚ïë    ‚úÖ Modernes, professionelles Layout                     ‚ïë
‚ïë    ‚úÖ Vollst√§ndige Funktionalit√§t                          ‚ïë
‚ïë    ‚úÖ Touch-optimiert f√ºr Tablet-Nutzung                   ‚ïë
‚ïë    ‚úÖ PDF-Export mit gardenKeeper¬Æ Branding                ‚ïë
‚ïë    ‚úÖ Unterschriften-System                                 ‚ïë
‚ïë    ‚úÖ Email-Integration                                     ‚ïë
‚ïë    üì∑ BILD-UPLOAD UND PDF-INTEGRATION VOLLST√ÑNDIG!        ‚ïë
‚ïë                                                              ‚ïë
‚ïë    üöÄ SOFORT EINSATZBEREIT!                                ‚ïë
‚ïë                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);

    </script>
</body>
</html>
