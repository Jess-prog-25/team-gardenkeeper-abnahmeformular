<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gardenKeeper¬Æ - Digitales Abnahmeformular</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #7F973B 0%, #A7B839 100%);
            color: white;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Launcher Styles */
        .launcher {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .launcher-container {
            max-width: 500px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 50px 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .launcher h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .subtitle {
            font-size: 1.3rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }
        
        .launcher-btn {
            background: white;
            color: #7F973B;
            padding: 20px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            min-width: 250px;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .launcher-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            background: #f8f9fa;
        }
        
        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-top: 40px;
            text-align: left;
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: #fff;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .support-info {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .support-info h4 {
            color: #FFE5B4;
            margin-bottom: 10px;
        }
        
        /* Formular Styles */
        .formular {
            display: none;
            background: #f9fafb;
            color: #333;
            min-height: 100vh;
        }
        
        .formular.active {
            display: block;
        }
        
        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .form-header {
            background: linear-gradient(135deg, #7F973B 0%, #A7B839 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .form-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .form-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #A7B839;
            color: white;
        }
        
        .btn-primary:hover {
            background: #7F973B;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #966D29;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7F6025;
            transform: translateY(-2px);
        }
        
        .btn-back {
            background: white;
            color: #7F973B;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .btn-back:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .form-content {
            padding: 30px;
        }
        
        .day-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .day-tab.active {
            background: #A7B839;
            color: white;
            border-color: #A7B839;
        }
        
        .day-tab:hover {
            border-color: #A7B839;
        }
        
        .day-content {
            display: none;
        }
        
        .day-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h3 {
            color: #70706B;
            font-size: 1.3rem;
            margin-bottom: 15px;
            border-bottom: 2px solid #A7B839;
            padding-bottom: 8px;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        
        .field {
            margin-bottom: 20px;
        }
        
        .field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .field input:focus,
        .field textarea:focus,
        .field select:focus {
            outline: none;
            border-color: #A7B839;
        }
        
        .worker-row,
        .material-row,
        .machine-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            align-items: start;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .material-row {
            grid-template-columns: 2fr 1fr 1fr auto;
        }
        
        .worker-row {
            grid-template-columns: 1fr auto;
        }
        
        .hours-summary {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .hours-summary h4 {
            color: #2d5a2d;
            margin-bottom: 10px;
        }
        
        .hours-summary .total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1a4a1a;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #A7B839;
        }
        
        /* Success Page Styles */
        .success-page {
            display: none;
            min-height: 100vh;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .success-page.active {
            display: flex;
        }
        
        .success-container {
            max-width: 600px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 50px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .success-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        
        .employee-message {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .employee-message h3 {
            color: #FFE5B4;
            margin-bottom: 15px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .launcher-container {
                padding: 30px 20px;
            }
            
            .launcher h1 {
                font-size: 2rem;
            }
            
            .launcher-btn {
                min-width: 200px;
                padding: 15px 30px;
                font-size: 1rem;
            }
            
            .form-content {
                padding: 20px;
            }
            
            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .worker-row,
            .material-row,
            .machine-row {
                grid-template-columns: 1fr;
            }
            
            .day-tabs {
                flex-direction: column;
            }
            
            .form-buttons {
                gap: 8px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Launcher Page -->
    <div class="launcher" id="launcherPage">
        <div class="launcher-container">
            <div class="logo">üå±</div>
            <h1>gardenKeeper¬Æ</h1>
            <div class="subtitle">Gartenpflege mit Stil und ‚ô•</div>
            
            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin: 30px 0; font-size: 1rem; line-height: 1.6;">
                <p style="margin: 10px 0; font-weight: 500;">Ob Garten oder Grundst√ºck - wir sorgen daf√ºr, dass Ihr Zuhause stilvoll, gepflegt und verl√§sslich aufbl√ºht.</p>
                <p style="margin: 10px 0; font-style: italic; opacity: 0.9;">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</p>
            </div>
            
            <button class="launcher-btn" onclick="openFormular()">
                <span>üì±</span>
                Formular √∂ffnen
            </button>
            
            <div class="instructions">
                <h3>üìã Arbeitsschritte:</h3>
                <ol>
                    <li>Formular √∂ffnen und alle Daten eingeben</li>
                    <li>Mehrt√§gige Projekte √ºber Tage-Tabs erfassen</li>
                    <li>Pro Tag: Mitarbeiter, Zeiten, Materialien</li>
                    <li>Automatische Pausenberechnung</li>
                    <li>Abschlie√üen ‚Üí PDF wird erstellt</li>
                    <li>PDF kann direkt ausgedruckt/gespeichert werden</li>
                </ol>
            </div>
            
            <div class="support-info">
                <h4>üìû Bei Problemen:</h4>
                <p><strong>Chef kontaktieren</strong></p>
            </div>
            
            <div style="margin-top: 30px; font-size: 0.9rem; opacity: 0.8;">
                Version 6.5 - Juli 2025<br>
                ‚úÖ VEREINFACHT: Fokus auf Datenerfassung<br>
                üìÑ PDF-Generation im Browser<br>
                üé® Professionelles Branding & Design
            </div>
        </div>
    </div>

    <!-- Formular Page -->
    <div class="formular" id="formularPage">
        <div style="padding: 20px;">
            <div class="form-container">
                <!-- Header -->
                <div class="form-header">
                    <h1>ABNAHME / TAGESREGIEBERICHT</h1>
                    <p>gardenKeeper¬Æ GmbH - Sven Kr√§mer</p>
                    <div class="form-buttons">
                        <button onclick="backToLauncher()" class="btn btn-back">
                            <span>‚Üê</span>
                            Zur√ºck
                        </button>
                        <button onclick="testConnections()" class="btn btn-secondary" style="background: #A7B839;">
                            <span>üîó</span>
                            Test System
                        </button>
                        <button onclick="saveDraft()" class="btn btn-secondary">
                            <span>üíæ</span>
                            Speichern
                        </button>
                        <button onclick="generatePDF()" class="btn btn-primary">
                            <span>üìÑ</span>
                            PDF
                        </button>
                        <button onclick="downloadHTML()" class="btn btn-secondary">
                            <span>üíæ</span>
                            HTML Download
                        </button>
                        <button onclick="completeForm()" class="btn btn-primary" style="background: #22c55e;">
                            <span>‚úÖ</span>
                            <span id="completeBtnText">Abschlie√üen</span>
                        </button>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage"></div>

                <div class="form-content">
                    <!-- Grunddaten -->
                    <div class="section">
                        <h3>Grunddaten</h3>
                        <div class="grid grid-3">
                            <div class="field">
                                <label>Name Kunde *</label>
                                <input type="text" id="kunde" name="kunde" placeholder="Kundenname" required>
                            </div>
                            <div class="field">
                                <label>LexOffice-ID</label>
                                <input type="text" id="lexofficeId" name="lexofficeId" placeholder="Kunden-ID aus LexOffice">
                            </div>
                            <div class="field">
                                <label>Kunde E-Mail</label>
                                <input type="email" id="kundeEmailField" name="kundeEmail" placeholder="kunde@example.com">
                            </div>
                            <div class="field">
                                <label>Datum *</label>
                                <input type="date" id="startdatum" name="startdatum" required>
                            </div>
                        </div>
                    </div>

                    <!-- Tage-Tabs -->
                    <div class="section">
                        <h3>Erfassung pro Tag</h3>
                        <div class="day-tabs" id="dayTabs">
                            <div class="day-tab active" data-day="1" onclick="switchDay(1)">Tag 1</div>
                        </div>
                        <button onclick="addDay()" class="btn btn-primary">
                            <span>+</span>
                            Tag hinzuf√ºgen
                        </button>
                    </div>

                    <!-- Day Content Container -->
                    <div id="dayContentContainer">
                        <!-- Tag 1 Content -->
                        <div class="day-content active" id="day1">
                            
                            <!-- Arbeitszeiten -->
                            <div class="section">
                                <h3>Arbeitszeiten</h3>
                                <div class="grid grid-4">
                                    <div class="field">
                                        <label>Ladebeginn</label>
                                        <input type="time" class="ladebeginn" onchange="updateHoursSummary()">
                                    </div>
                                    <div class="field">
                                        <label>Abfahrt</label>
                                        <input type="time" class="abfahrt">
                                    </div>
                                    <div class="field">
                                        <label>Arbeitszeit Beginn</label>
                                        <input type="time" class="arbeitszeit-beginn">
                                    </div>
                                    <div class="field">
                                        <label>Arbeitszeit Ende</label>
                                        <input type="time" class="arbeitszeit-ende" onchange="updateHoursSummary()">
                                    </div>
                                </div>
                                <div class="grid grid-2">
                                    <div class="field">
                                        <label>Pause (Min)</label>
                                        <input type="number" class="pause" placeholder="0" min="0" onchange="updateHoursSummary()">
                                    </div>
                                    <div class="field">
                                        <label>Regenpause (Min)</label>
                                        <input type="number" class="regenpause" placeholder="0" min="0" onchange="updateHoursSummary()">
                                    </div>
                                </div>
                            </div>

                            <!-- Mitarbeiter -->
                            <div class="section">
                                <h3>Ausf√ºhrende Mitarbeiter</h3>
                                <div class="workers-container">
                                    <div class="worker-row">
                                        <div class="field">
                                            <label>Mitarbeiter</label>
                                            <select class="worker-select" onchange="updateHoursSummary()">
                                                <option value="">Mitarbeiter ausw√§hlen</option>
                                            </select>
                                        </div>
                                        <div style="align-self: start; margin-top: 25px;">
                                            <button onclick="removeWorker(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addWorker()" class="btn btn-primary">
                                    <span>+</span>
                                    Mitarbeiter hinzuf√ºgen
                                </button>
                                
                                <!-- Stunden-Zusammenfassung -->
                                <div class="hours-summary">
                                    <h4>Stunden-Zusammenfassung (inkl. Pausenabzug)</h4>
                                    <div class="hours-list"></div>
                                    <div class="total">Gesamt: 0 Stunden</div>
                                </div>
                            </div>

                            <!-- Maschinen -->
                            <div class="section">
                                <h3>Eingesetzte Maschinen</h3>
                                <div class="machines-container">
                                    <div class="machine-row">
                                        <div class="field">
                                            <label>Maschine</label>
                                            <select class="machine-select">
                                                <option value="">Maschine ausw√§hlen</option>
                                            </select>
                                        </div>
                                        <div class="field">
                                            <label>Dauer/Menge</label>
                                            <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                                        </div>
                                        <div style="align-self: start; margin-top: 25px;">
                                            <button onclick="removeMachine(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addMachine()" class="btn btn-primary">
                                    <span>+</span>
                                    Maschine hinzuf√ºgen
                                </button>
                            </div>

                            <!-- Arbeiten -->
                            <div class="section">
                                <h3>Beschreibung ausgef√ºhrte Arbeiten</h3>
                                <div class="field">
                                    <textarea class="beschreibung-arbeiten" rows="5" placeholder="Detaillierte Beschreibung der durchgef√ºhrten Arbeiten..." required></textarea>
                                </div>
                            </div>

                            <!-- Materialien -->
                            <div class="section">
                                <h3>Materialien und Baustoffe</h3>
                                <div class="materials-container">
                                    <div class="material-row">
                                        <div class="field">
                                            <label>Material</label>
                                            <select class="material-select">
                                                <option value="">Material ausw√§hlen</option>
                                            </select>
                                        </div>
                                        <div class="field">
                                            <label>Menge</label>
                                            <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                                        </div>
                                        <div class="field">
                                            <label style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" class="fremdeinkauf-checkbox">
                                                Fremdeinkauf
                                            </label>
                                        </div>
                                        <div style="align-self: start; margin-top: 25px;">
                                            <button onclick="removeMaterial(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="addMaterial()" class="btn btn-primary">
                                    <span>+</span>
                                    Material hinzuf√ºgen
                                </button>
                            </div>

                            <!-- Zusatzarbeiten -->
                            <div class="section">
                                <h3>Zusatzarbeiten</h3>
                                <div class="field">
                                    <textarea class="zusatzarbeiten" rows="3" placeholder="Beschreibung zus√§tzlicher Arbeiten, die nicht im urspr√ºnglichen Auftrag enthalten waren..."></textarea>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Bemerkungen -->
                    <div class="section">
                        <h3>Gesamtbemerkungen</h3>
                        <div class="field">
                            <textarea id="bemerkungen" rows="4" placeholder="Weitere Bemerkungen, Besonderheiten oder Hinweise zum gesamten Projekt..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Page -->
    <div class="success-page" id="successPage">
        <div class="success-container">
            <div class="success-icon">‚úÖ</div>
            <h1>Formular erfolgreich!</h1>
            <p style="font-size: 1.2rem; margin: 20px 0;">Das Formular wurde erfolgreich verarbeitet und das PDF erstellt.</p>
            
            <div class="employee-message">
                <h3>üéâ Nachricht an den Mitarbeiter</h3>
                <p><strong>Gut gemacht!</strong> Du hast das Formular erfolgreich ausgef√ºllt. Deine sorgf√§ltige Dokumentation hilft uns dabei, unseren Kunden den bestm√∂glichen Service zu bieten.</p>
                <p style="margin-top: 15px;">Das PDF kann √ºber den "PDF" Button ausgedruckt oder gespeichert werden. Bei Fragen oder Problemen kannst du dich jederzeit an Jessika oder Sven wenden.</p>
                <p style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 8px; border-left: 4px solid #A7B839;">
                    <strong>üå± gardenKeeper¬Æ - Gartenpflege mit Stil und ‚ô•</strong><br>
                    <em>"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</em><br><br>
                    <span style="font-size: 0.9rem;">Du tr√§gst dazu bei, dass unsere Kunden stilvoll, gepflegt und verl√§sslich aufbl√ºhen k√∂nnen!</span>
                </p>
                <p style="margin-top: 15px; font-weight: bold; color: #A7B839;">Weiter so! üí™</p>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="launcher-btn" onclick="generatePDF()" style="background: #A7B839;">
                    <span>üìÑ</span>
                    PDF √∂ffnen & drucken
                </button>
                <button class="launcher-btn" onclick="downloadHTML()" style="background: #966D29;">
                    <span>üíæ</span>
                    HTML Download
                </button>
                <button class="launcher-btn" onclick="resetForm()" style="background: #22c55e;">
                    <span>üîÑ</span>
                    Neues Formular
                </button>
                <button class="launcher-btn" onclick="backToLauncher()">
                    <span>üè†</span>
                    Zur Startseite
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ERWEITERTE KONFIGURATION
        // ========================================
        const GOOGLE_APPS_SCRIPT_CONFIG = {
            // DEINE APPS SCRIPT URL HIER EINF√úGEN
            URL: 'https://script.google.com/macros/s/AKfycbxajxH7qCrerYJKQTZQxPPkVhGJvTjYDOoFGtuPcoF6S2ggxMZCcNKdoiGdf3RgSdbBng/exec',
            
            // ROBUSTE EINSTELLUNGEN
            retryAttempts: 3,
            timeout: 15000, // 15 Sekunden
            
            // CORS-UMGEHUNG
            useFormSubmission: true,
            
            // FALLBACK OPTIONS
            enableDebugMode: true
        };

        // SHEETS KONFIGURATION
        const SHEETS_CONFIG = {
            enabled: true,
            autoSend: true,
            retryOnFailure: true,
            sheetId: '1TNlZ7bt0cx0uVDml6YSqhJw2a80Vo8fdsPYBZ3-GTtw' // Deine Sheet-ID
        };

        // DRIVE KONFIGURATION  
        const DRIVE_CONFIG = {
            enabled: true,
            autoArchive: true,
            createProjectFolders: true,
            archiveImages: false, // Bilder entfernt
            mainFolderId: '1Kj9l7yifv85IJ7-b5Oje8fixWAefbkkj' // Deine Drive-Ordner-ID
        };

        // ========================================
        // STAMMDATEN
        // ========================================
        const WORKERS = [
            'Christian Weinrank', 'Fabio Kr√§mer', 'Claudiu Adascalitei', 'J√ºrgen Kr√§nkel', 
            'Joseph Dahl', 'Christian St√∂ber', 'Wolfgang Degro', 'Christian Fu√ü', 
            'Christian Winterstein', 'Carsten Munz', 'Sascha Macke', 'Julina Tiedtke', 
            'Kim Honnecker', 'Jan Jeanrond', 
        ];

        const MATERIALS = [
            { name: 'Entsorgung Gr√ºnschnitt', unit: 'cbm' },
            { name: 'Entsorgung Kn√∂terisch oder Buchsbaumz√ºnsler-Sonderm√ºll-', unit: 'to.' },
            { name: 'Entsorgung Wurzelwerk', unit: 'to.' },
            { name: 'Entsorgung Grasnarbe', unit: 'cbm' },
            { name: 'Entsorgung Erdaushub', unit: 'to.' },
            { name: 'Entsorgung Wurzelwerk', unit: 'to.' },
            { name: 'Entsorgung Betonabbruch', unit: 'to.' },
            { name: 'Entsorgung Altholz', unit: 'kg' },
            { name: 'Corthum G√§rtnererde-Pflanzerde 50l', unit: 'Sack' },
            { name: 'Corthum Intensicverde 50l', unit: 'Sack' },
            { name: 'Corthum Moorbeeterde 50l', unit: 'Sack' },
            { name: 'Corthum Rasenerde 30l', unit: 'Sack' },
            { name: 'Corthum Kieferndekormulch 0-15 70L', unit: 'Sack' },
            { name: 'Corthum Rindenmulch 15-40 70L', unit: 'Sack' },
            { name: 'Corthum Pinienrinde 8-16 70L', unit: 'Sack' },
            { name: 'Corthum Pinienrinde 15-25 70L', unit: 'Sack' },
            { name: 'Corthum Pinienrinde 40-60 70L', unit: 'Sack' },
            { name: 'Mutterboden, gesiebt (sehr fein)', unit: 'cbm' },           
        ];

        const MACHINES = [
            { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Std.' },
            { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Tag' },
            { name: 'Kompaktlader Vermeer', unit: 'Std.' },
            { name: 'Gro√üfl√§chen-Ausitzm√§her mit Hochkipp-Funktion', unit: 'Std.' },
            { name: 'Ferris Mulchm√§her', unit: 'Std.' },
            { name: 'Minibagger Kubota (1 to.)', unit: 'Std.' },
            { name: 'Minibagger Cat 3.18 (2 to.)', unit: 'Std.' },
            { name: 'Mietger√§t in Bemerkung eintragen', unit: 'Std.' },
            { name: 'Ich bin nicht in dieser Liste dann in Bemerkung eintragen', unit: 'Std.' },
        ];

        // ========================================
        // GLOBALE VARIABLEN
        // ========================================
        let formDataGlobal = {};
        let currentDay = 1;
        let maxDays = 1;

        // ========================================
        // INITIALISIERUNG
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('startdatum').value = new Date().toISOString().split('T')[0];
            populateDropdowns();
            loadDraft();
            updateHoursSummary();
            
            // URL-Parameter automatisch laden
            loadURLParameters();
        });

        // ========================================
        // URL-PARAMETER FUNKTION
        // ========================================
        function loadURLParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                
                console.log('üîó Lade URL-Parameter...');
                console.log('üìã Verf√ºgbare Parameter:', Array.from(urlParams.entries()));
                
                // Kunde aus URL-Parameter laden
                const kundeParam = urlParams.get('kunde');
                if (kundeParam) {
                    document.getElementById('kunde').value = decodeURIComponent(kundeParam);
                    console.log('‚úÖ Kunde aus URL geladen:', kundeParam);
                }
                
                // LexOffice-ID aus URL-Parameter laden
                const lexofficeParam = urlParams.get('lexofficeId') || urlParams.get('lexoffice') || urlParams.get('id');
                if (lexofficeParam) {
                    document.getElementById('lexofficeId').value = decodeURIComponent(lexofficeParam);
                    console.log('‚úÖ LexOffice-ID aus URL geladen:', lexofficeParam);
                }
                
                // Kunde E-Mail aus URL-Parameter laden
                const emailParam = urlParams.get('kundeEmail') || urlParams.get('email');
                if (emailParam) {
                    document.getElementById('kundeEmailField').value = decodeURIComponent(emailParam);
                    console.log('‚úÖ Kunde E-Mail aus URL geladen:', emailParam);
                }
                
                // Datum aus URL-Parameter laden
                const datumParam = urlParams.get('datum');
                if (datumParam) {
                    document.getElementById('startdatum').value = datumParam;
                    console.log('‚úÖ Datum aus URL geladen:', datumParam);
                }
                
                // Info-Meldung anzeigen wenn Parameter geladen wurden
                if (kundeParam || lexofficeParam || emailParam || datumParam) {
                    showMessage('üîó Kundendaten aus URL automatisch geladen!', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der URL-Parameter:', error);
            }
        }

        // ========================================
        // ERWEITERTE GOOGLE INTEGRATION
        // ========================================
        async function testConnections() {
            showMessage('üîÑ Teste Systemverbindungen...', 'info');
            
            let driveOk = false;
            let sheetsOk = false;
            
            // TEST 1: Google Apps Script Test (JSON-Format)
            try {
                console.log('üß™ Teste Drive/PDF mit JSON...');
                
                const testPayload = {
                    action: 'test',
                    timestamp: new Date().toISOString(),
                    testType: 'connection'
                };
                
                // JSON-Test
                const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testPayload)
                });
                
                driveOk = true;
                console.log('‚úÖ Drive/Apps Script: JSON-Request erfolgreich');
                
            } catch (error) {
                console.error('‚ùå Drive JSON Test Fehler:', error);
                
                // Fallback: URL √∂ffnen
                try {
                    const testWindow = window.open(GOOGLE_APPS_SCRIPT_CONFIG.URL + '?test=true', '_blank');
                    
                    if (testWindow) {
                        driveOk = true;
                        console.log('‚úÖ Drive/Apps Script: Fallback-Test erfolgreich');
                        setTimeout(() => testWindow?.close(), 3000);
                    }
                } catch (fallbackError) {
                    console.error('‚ùå Auch Fallback fehlgeschlagen:', fallbackError);
                }
            }
            
            // TEST 2: Sheets Connection (JSON-Format)
            try {
                console.log('üß™ Teste Sheets Integration...');
                
                const testData = {
                    kunde: 'TEST KUNDE',
                    startdatum: new Date().toISOString().split('T')[0],
                    days: [{
                        dayNumber: 1,
                        arbeiten: 'Test-Arbeiten',
                        workers: [{ name: 'Test-Mitarbeiter' }],
                        materials: [],
                        machines: []
                    }]
                };
                
                const success = await sendToGoogleSheets(testData, true);
                sheetsOk = success;
                
                console.log('üìä Sheets Test Result:', success);
                
            } catch (error) {
                console.error('‚ùå Sheets Test Fehler:', error);
                sheetsOk = false;
            }
            
            // Ergebnis anzeigen
            const driveStatus = driveOk ? '‚úÖ OK' : '‚ùå Fehler';
            const sheetsStatus = sheetsOk ? '‚úÖ OK' : '‚ùå Fehler';
            
            showMessage(`
                üîó <strong>System-Status (v6.5 - Vereinfacht, ohne Bilder):</strong><br><br>
                üìÅ Google Drive/PDF Speicherung: ${driveStatus}<br>
                üìä Google Sheets Archivierung: ${sheetsStatus}<br>
                üí∞ Fremdeinkauf-Tracking: ‚úÖ OK<br><br>
                ${driveOk && sheetsOk ? 
                    '<strong style="color: green;">üéâ Alle Systeme funktionieren perfekt!</strong><br><br>üìÅ <strong>Google Drive:</strong> Abnahmeprotokolle werden automatisch archiviert<br>üìÑ <strong>PDF:</strong> Browser-basierte Erstellung' :
                    '<strong style="color: orange;">‚ö†Ô∏è Einige Systeme ben√∂tigen Aufmerksamkeit</strong><br><br>Das Formular funktioniert vollst√§ndig, aber f√ºr die beste Integration sollten alle Systeme aktiv sein'
                }<br><br>
                <small>üí° Bei Problemen: Apps Script Berechtigung pr√ºfen oder Demo-Modus verwenden</small>
            `, driveOk && sheetsOk ? 'success' : 'warning');
            
            console.log('üîç Test Results:', { driveOk, sheetsOk, timestamp: new Date().toISOString() });
        }

        // VERBESSERTE SHEETS FUNKTION - JSON FORMAT
        async function sendToGoogleSheets(data, isTest = false) {
            if (!SHEETS_CONFIG.enabled && !isTest) {
                console.log('Sheets Integration deaktiviert');
                return false;
            }
            
            try {
                console.log('üìä Sende Daten zu Google Sheets...', data);
                
                const payload = {
                    action: 'saveData',
                    data: data,
                    test: isTest,
                    timestamp: new Date().toISOString()
                };
                
                // METHODE 1: JSON √ºber Fetch (bevorzugt)
                try {
                    const response = await fetch(GOOGLE_APPS_SCRIPT_CONFIG.URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('‚úÖ Sheets: JSON-Daten gesendet (no-cors mode)');
                    
                    if (!isTest) {
                        showMessage('‚úÖ Daten zu Google Sheets √ºbertragen!', 'success');
                    }
                    return true;
                    
                } catch (fetchError) {
                    console.warn('‚ö†Ô∏è Fetch failed, trying form submission:', fetchError);
                    
                    // FALLBACK: Form-Submission mit JSON
                    return await sendSheetsViaForm(payload, isTest);
                }
                
            } catch (error) {
                console.error('‚ùå Sheets Fehler:', error);
                
                if (!isTest) {
                    showMessage(`‚ö†Ô∏è Sheets-√úbertragung fehlgeschlagen: ${error.message}`, 'warning');
                }
                
                return false;
            }
        }

        // FALLBACK: Form-Submission f√ºr Sheets
        async function sendSheetsViaForm(payload, isTest) {
            return new Promise((resolve) => {
                try {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = GOOGLE_APPS_SCRIPT_CONFIG.URL;
                    form.target = isTest ? '_blank' : 'hidden_iframe';
                    form.style.display = 'none';
                    
                    // JSON als einzelnes Feld
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'jsonData';
                    input.value = JSON.stringify(payload);
                    form.appendChild(input);
                    
                    // Hidden iframe f√ºr non-test submissions
                    if (!isTest) {
                        let iframe = document.getElementById('hidden_iframe');
                        if (!iframe) {
                            iframe = document.createElement('iframe');
                            iframe.id = 'hidden_iframe';
                            iframe.name = 'hidden_iframe';
                            iframe.style.display = 'none';
                            document.body.appendChild(iframe);
                        }
                    }
                    
                    document.body.appendChild(form);
                    form.submit();
                    document.body.removeChild(form);
                    
                    console.log('‚úÖ Sheets: Form-Submission gesendet');
                    
                    if (!isTest) {
                        showMessage('‚úÖ Daten via Fallback zu Google Sheets √ºbertragen!', 'success');
                    }
                    
                    resolve(true);
                    
                } catch (error) {
                    console.error('‚ùå Form submission failed:', error);
                    resolve(false);
                }
            });
        }

        // ========================================
        // VEREINFACHTE FORMULAR ABSCHLUSS
        // ========================================
        async function completeForm() {
            const data = getFormData();
            
            // Validierung
            if (!data.kunde || !data.startdatum) {
                showMessage('‚ùå Bitte f√ºllen Sie alle Pflichtfelder aus!', 'error');
                return;
            }
            
            const hasWork = data.days.some(day => day.arbeiten.trim());
            if (!hasWork) {
                showMessage('‚ùå Bitte beschreiben Sie die durchgef√ºhrten Arbeiten!', 'error');
                return;
            }
            
            // Button-Status √§ndern
            document.getElementById('completeBtnText').textContent = 'Verarbeite...';
            
            try {
                showMessage('üîÑ Erstelle PDF und speichere Daten...', 'info');
                
                // 1. Browser-PDF f√ºr sofortigen Zugriff
                generatePDF();
                
                // 2. Apps Script nur f√ºr Sheets (JSON)
                if (GOOGLE_APPS_SCRIPT_CONFIG.URL) {
                    const payload = {
                        action: 'saveData',
                        data: data,
                        timestamp: new Date().toISOString()
                    };
                    
                    await fetch(GOOGLE_APPS_SCRIPT_CONFIG.URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
                
                // 3. Success-Meldung
                showMessage('‚úÖ Formular erfolgreich abgeschlossen!', 'success');
                
                // Clear draft
                localStorage.removeItem('gardenKeeper_draft');
                
                // Switch to success page
                setTimeout(() => {
                    document.getElementById('formularPage').classList.remove('active');
                    document.getElementById('successPage').classList.add('active');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Formular-Abschluss Fehler:', error);
                showMessage(`‚ùå Fehler beim Abschlie√üen: ${error.message}`, 'error');
            } finally {
                document.getElementById('completeBtnText').textContent = 'Abschlie√üen';
            }
        }

        // ========================================
        // TAG-MANAGEMENT
        // ========================================
        function addDay() {
            maxDays++;
            
            // Add tab
            const dayTabs = document.getElementById('dayTabs');
            const newTab = document.createElement('div');
            newTab.className = 'day-tab';
            newTab.setAttribute('data-day', maxDays);
            newTab.textContent = `Tag ${maxDays}`;
            newTab.onclick = () => switchDay(maxDays);
            dayTabs.appendChild(newTab);
            
            // Add content
            const dayContainer = document.getElementById('dayContentContainer');
            const newDayContent = document.querySelector('#day1').cloneNode(true);
            newDayContent.id = `day${maxDays}`;
            newDayContent.classList.remove('active');
            
            // Reset form values in cloned content
            resetDayContent(newDayContent);
            
            dayContainer.appendChild(newDayContent);
            
            // Populate dropdowns in new day
            populateDropdownsInDay(newDayContent);
            
            // Switch to new day
            switchDay(maxDays);
        }

        function switchDay(dayNumber) {
            currentDay = dayNumber;
            
            // Update tabs
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-day="${dayNumber}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.day-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`day${dayNumber}`).classList.add('active');
            
            // Update hours summary for current day
            updateHoursSummary();
        }

        function resetDayContent(dayContent) {
            // Reset all inputs
            dayContent.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else if (field.type === 'number') {
                    field.value = '';
                } else {
                    field.value = '';
                }
            });
            
            // Reset containers to single row
            resetContainersInDay(dayContent);
        }

        function resetContainersInDay(dayContent) {
            // Reset workers
            const workersContainer = dayContent.querySelector('.workers-container');
            workersContainer.innerHTML = `
                <div class="worker-row">
                    <div class="field">
                        <label>Mitarbeiter</label>
                        <select class="worker-select" onchange="updateHoursSummary()">
                            <option value="">Mitarbeiter ausw√§hlen</option>
                        </select>
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeWorker(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                    </div>
                </div>
            `;
        }

        // ========================================
        // DROPDOWN POPULATION
        // ========================================
        function populateDropdowns() {
            document.querySelectorAll('.day-content').forEach(dayContent => {
                populateDropdownsInDay(dayContent);
            });
        }

        function populateDropdownsInDay(dayContent) {
            // Workers
            dayContent.querySelectorAll('.worker-select').forEach(select => {
                select.innerHTML = '<option value="">Mitarbeiter ausw√§hlen</option>';
                WORKERS.forEach(worker => {
                    select.innerHTML += `<option value="${worker}">${worker}</option>`;
                });
            });

            // Materials
            dayContent.querySelectorAll('.material-select').forEach(select => {
                select.innerHTML = '<option value="">Material ausw√§hlen</option>';
                MATERIALS.forEach(material => {
                    select.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
                });
            });

            // Machines
            dayContent.querySelectorAll('.machine-select').forEach(select => {
                select.innerHTML = '<option value="">Maschine ausw√§hlen</option>';
                MACHINES.forEach(machine => {
                    select.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
                });
            });
        }

        // ========================================
        // FORM ELEMENT MANAGEMENT
        // ========================================
        function addWorker() {
            const currentDayContent = document.querySelector('.day-content.active');
            const container = currentDayContent.querySelector('.workers-container');
            const workerHTML = `
                <div class="worker-row">
                    <div class="field">
                        <label>Mitarbeiter</label>
                        <select class="worker-select" onchange="updateHoursSummary()">
                            <option value="">Mitarbeiter ausw√§hlen</option>
                        </select>
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeWorker(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', workerHTML);
            
            // Populate dropdown for new worker
            const newSelect = container.lastElementChild.querySelector('.worker-select');
            WORKERS.forEach(worker => {
                newSelect.innerHTML += `<option value="${worker}">${worker}</option>`;
            });
        }

        function removeWorker(button) {
            const currentDayContent = document.querySelector('.day-content.active');
            const workerRows = currentDayContent.querySelectorAll('.worker-row');
            if (workerRows.length > 1) {
                button.closest('.worker-row').remove();
                updateHoursSummary();
            }
        }

        function addMachine() {
            const currentDayContent = document.querySelector('.day-content.active');
            const container = currentDayContent.querySelector('.machines-container');
            const machineHTML = `
                <div class="machine-row">
                    <div class="field">
                        <label>Maschine</label>
                        <select class="machine-select">
                            <option value="">Maschine ausw√§hlen</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Dauer/Menge</label>
                        <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeMachine(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', machineHTML);
            
            // Populate dropdown for new machine
            const newSelect = container.lastElementChild.querySelector('.machine-select');
            MACHINES.forEach(machine => {
                newSelect.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
            });
        }

        function removeMachine(button) {
            const currentDayContent = document.querySelector('.day-content.active');
            const machineRows = currentDayContent.querySelectorAll('.machine-row');
            if (machineRows.length > 1) {
                button.closest('.machine-row').remove();
            }
        }

        function addMaterial() {
            const currentDayContent = document.querySelector('.day-content.active');
            const container = currentDayContent.querySelector('.materials-container');
            const materialHTML = `
                <div class="material-row">
                    <div class="field">
                        <label>Material</label>
                        <select class="material-select">
                            <option value="">Material ausw√§hlen</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Menge</label>
                        <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                    </div>
                    <div class="field">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="fremdeinkauf-checkbox">
                            Fremdeinkauf
                        </label>
                    </div>
                    <div style="align-self: start; margin-top: 25px;">
                        <button onclick="removeMaterial(this)" class="btn" style="background: #dc3545; color: white; padding: 8px 12px; font-size: 12px;">√ó</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', materialHTML);
            
            // Populate dropdown for new material
            const newSelect = container.lastElementChild.querySelector('.material-select');
            MATERIALS.forEach(material => {
                newSelect.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
            });
        }

        function removeMaterial(button) {
            const currentDayContent = document.querySelector('.day-content.active');
            const materialRows = currentDayContent.querySelectorAll('.material-row');
            if (materialRows.length > 1) {
                button.closest('.material-row').remove();
            }
        }

        // ========================================
        // STUNDEN BERECHNUNG (AB LADEBEGINN)
        // ========================================
        function updateHoursSummary() {
            const currentDayContent = document.querySelector('.day-content.active');
            if (!currentDayContent) return;
            
            const workerRows = currentDayContent.querySelectorAll('.worker-row');
            const hoursList = currentDayContent.querySelector('.hours-list');
            const totalElement = currentDayContent.querySelector('.total');
            
            let totalHours = 0;
            let summaryHTML = '';
            let workerCount = 0;
            
            // Get pause values and main work times
            const pause = parseInt(currentDayContent.querySelector('.pause').value) || 0;
            const regenpause = parseInt(currentDayContent.querySelector('.regenpause').value) || 0;
            const totalPauseHours = (pause + regenpause) / 60;
            
            // GE√ÑNDERT: Verwende Ladebeginn statt Arbeitszeit Beginn
            const ladebeginn = currentDayContent.querySelector('.ladebeginn').value;
            const arbeitszeitEnde = currentDayContent.querySelector('.arbeitszeit-ende').value;
            
            if (ladebeginn && arbeitszeitEnde) {
                workerRows.forEach(row => {
                    const workerSelect = row.querySelector('.worker-select');
                    
                    if (workerSelect.value) {
                        workerCount++;
                        const start = new Date(`2000-01-01T${ladebeginn}`);
                        const end = new Date(`2000-01-01T${arbeitszeitEnde}`);
                        const diffMs = end - start;
                        const grossHours = Math.max(0, diffMs / (1000 * 60 * 60));
                        const netHours = Math.max(0, grossHours - totalPauseHours);
                        
                        totalHours += netHours;
                        summaryHTML += `<div class="worker-hours">${workerSelect.value}: ${netHours.toFixed(2)} Std. (${grossHours.toFixed(2)} - ${totalPauseHours.toFixed(2)} Pausen)</div>`;
                    }
                });
            }
            
            if (hoursList) {
                hoursList.innerHTML = summaryHTML;
            }
            if (totalElement) {
                totalElement.innerHTML = `<strong>Gesamt: ${totalHours.toFixed(2)} Stunden</strong> (${workerCount} Mitarbeiter √ó ${((totalHours / Math.max(workerCount, 1))).toFixed(2)} Std.)`;
            }
        }

        // ========================================
        // NAVIGATION FUNKTIONEN
        // ========================================
        function openFormular() {
            document.getElementById('launcherPage').style.display = 'none';
            document.getElementById('formularPage').classList.add('active');
        }

        function backToLauncher() {
            document.getElementById('formularPage').classList.remove('active');
            document.getElementById('successPage').classList.remove('active');
            document.getElementById('launcherPage').style.display = 'flex';
        }

        // ========================================
        // PDF GENERATION
        // ========================================
        function generatePDF() {
            const data = getFormData();
            
            console.log('üìÑ Generiere PDF direkt im Browser...', data);
            
            try {
                // 1. DIREKTE BROWSER-L√ñSUNG: HTML in neuem Fenster √∂ffnen
                const pdfHTML = generateSimplePDFHTML(data);
                
                // √ñffne PDF-HTML in neuem Fenster
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfHTML);
                printWindow.document.close();
                
                // Auto-Print Dialog nach kurzer Verz√∂gerung
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
                
                showMessage('üìÑ PDF wurde ge√∂ffnet! Sie k√∂nnen es jetzt drucken oder als PDF speichern.', 'success');
                
            } catch (error) {
                console.error('‚ùå PDF-Fehler:', error);
                showMessage(`‚ùå PDF-Erstellung fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        function generateSimplePDFHTML(formData) {
            let totalHours = 0;
            
            // Berechne Gesamtstunden
            formData.days.forEach(day => {
                if (day.ladebeginn && day.arbeitszeitEnde && day.workers.length > 0) {
                    const start = new Date(`2000-01-01T${day.ladebeginn}`);
                    const end = new Date(`2000-01-01T${day.arbeitszeitEnde}`);
                    const grossHours = Math.max(0, (end - start) / (1000 * 60 * 60));
                    const pauseHours = (parseInt(day.pause || 0) + parseInt(day.regenpause || 0)) / 60;
                    const netHoursPerWorker = Math.max(0, grossHours - pauseHours);
                    totalHours += netHoursPerWorker * day.workers.length;
                }
            });
            
            // Generiere Tage-HTML
            const daysHTML = formData.days.map((day, index) => {
                const dayHours = calculateDayHours(day);
                
                return `
                    <div class="day-section" ${index > 0 ? 'style="page-break-before: always;"' : ''}>
                        <h2>üìÖ Tag ${day.dayNumber} - ${day.datum || formData.startdatum}</h2>
                        
                        <div class="section">
                            <h3>‚è∞ Arbeitszeiten</h3>
                            <table class="info-table">
                                <tr>
                                    <td><strong>Ladebeginn:</strong></td>
                                    <td>${day.ladebeginn || 'Nicht erfasst'}</td>
                                    <td><strong>Abfahrt:</strong></td>
                                    <td>${day.abfahrt || 'Nicht erfasst'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Arbeitszeit Beginn:</strong></td>
                                    <td>${day.arbeitszeitBeginn || 'Nicht erfasst'}</td>
                                    <td><strong>Arbeitszeit Ende:</strong></td>
                                    <td>${day.arbeitszeitEnde || 'Nicht erfasst'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Pause:</strong></td>
                                    <td>${day.pause || 0} Min</td>
                                    <td><strong>Regenpause:</strong></td>
                                    <td>${day.regenpause || 0} Min</td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="text-align: center; padding-top: 10px;">
                                        <strong>Tagesstunden gesamt: ${dayHours.toFixed(2)} Std.</strong>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="section">
                            <h3>üë• Mitarbeiter</h3>
                            <div class="workers-list">
                                ${day.workers.length > 0 ? 
                                    day.workers.map(w => `<div class="worker-item">‚Ä¢ ${w.name}</div>`).join('') :
                                    '<div class="no-data">Keine Mitarbeiter erfasst</div>'
                                }
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>üîß Ausgef√ºhrte Arbeiten</h3>
                            <div class="work-description">
                                ${day.arbeiten || 'Keine Arbeitsbeschreibung erfasst'}
                            </div>
                        </div>
                        
                        ${day.materials.length > 0 ? `
                        <div class="section">
                            <h3>üì¶ Materialien</h3>
                            <div class="materials-list">
                                ${day.materials.map(m => 
                                    `<div class="material-item">‚Ä¢ ${m.name}: ${m.amount} ${m.unit}${m.fremdeinkauf ? ' (Fremdeinkauf)' : ''}</div>`
                                ).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${day.machines.length > 0 ? `
                        <div class="section">
                            <h3>üöú Maschinen</h3>
                            <div class="machines-list">
                                ${day.machines.map(m => `<div class="machine-item">‚Ä¢ ${m.name}: ${m.duration}</div>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${day.zusatzarbeiten ? `
                        <div class="section">
                            <h3>‚ûï Zusatzarbeiten</h3>
                            <div class="additional-work">${day.zusatzarbeiten}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            return `
                <!DOCTYPE html>
                <html lang="de">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Abnahmeprotokoll ${formData.kunde}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        body { 
                            font-family: Arial, sans-serif; 
                            font-size: 12px; 
                            line-height: 1.4; 
                            color: #333; 
                            background: white;
                            padding: 20px;
                        }
                        
                        .header { 
                            background: #7F973B; 
                            color: white; 
                            padding: 25px; 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-radius: 8px;
                        }
                        
                        .header h1 { 
                            font-size: 24px; 
                            margin-bottom: 8px; 
                        }
                        
                        .header .subtitle { 
                            font-size: 16px; 
                            margin-bottom: 12px; 
                        }
                        
                        .header .contact { 
                            font-size: 11px; 
                            margin-top: 15px; 
                            opacity: 0.9;
                        }
                        
                        .overview { 
                            background: #f0f8e8; 
                            padding: 20px; 
                            margin-bottom: 30px; 
                            border-radius: 8px; 
                            border: 2px solid #A7B839;
                        }
                        
                        .overview h2 { 
                            color: #7F973B; 
                            font-size: 16px; 
                            margin-bottom: 15px; 
                            text-align: center;
                        }
                        
                        .overview-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                        }
                        
                        .overview-table td { 
                            padding: 8px 12px; 
                            border: 1px solid #ddd; 
                            background: white;
                        }
                        
                        .overview-table td:first-child { 
                            font-weight: bold; 
                            background: #f8f9fa; 
                            width: 25%;
                        }
                        
                        .day-section { 
                            margin-bottom: 40px; 
                            border: 1px solid #ddd; 
                            border-radius: 8px; 
                            overflow: hidden;
                        }
                        
                        .day-section h2 { 
                            background: #A7B839; 
                            color: white; 
                            padding: 15px 20px; 
                            margin: 0; 
                            font-size: 16px;
                        }
                        
                        .section { 
                            padding: 20px; 
                            border-bottom: 1px solid #eee;
                        }
                        
                        .section:last-child { 
                            border-bottom: none; 
                        }
                        
                        .section h3 { 
                            color: #7F973B; 
                            font-size: 14px; 
                            margin-bottom: 12px; 
                            border-bottom: 2px solid #A7B839; 
                            padding-bottom: 5px;
                        }
                        
                        .info-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                        }
                        
                        .info-table td { 
                            padding: 8px 12px; 
                            border: 1px solid #ddd; 
                        }
                        
                        .info-table td:nth-child(odd) { 
                            background: #f8f9fa; 
                            font-weight: bold; 
                            width: 20%;
                        }
                        
                        .workers-list, .materials-list, .machines-list { 
                            background: #f8f9fa; 
                            padding: 12px; 
                            border-radius: 5px; 
                        }
                        
                        .worker-item, .material-item, .machine-item { 
                            margin-bottom: 5px; 
                            padding: 5px 0;
                        }
                        
                        .work-description, .additional-work { 
                            background: #f8f9fa; 
                            padding: 15px; 
                            border-radius: 5px; 
                            border: 1px solid #ddd; 
                            min-height: 50px;
                            white-space: pre-line;
                        }
                        
                        .remarks { 
                            background: #f8f9fa; 
                            padding: 20px; 
                            border-radius: 8px; 
                            border-left: 4px solid #A7B839; 
                            margin-bottom: 30px;
                        }
                        
                        .remarks h2 { 
                            color: #7F973B; 
                            font-size: 16px; 
                            margin-bottom: 15px;
                        }
                        
                        .remarks-content { 
                            background: white; 
                            padding: 15px; 
                            border-radius: 5px; 
                            border: 1px solid #ddd; 
                            white-space: pre-line;
                        }
                        
                        .footer { 
                            background: #7F973B; 
                            color: white; 
                            padding: 25px; 
                            text-align: center; 
                            border-radius: 8px; 
                            margin-top: 30px;
                        }
                        
                        .footer h2 { 
                            font-size: 16px; 
                            margin-bottom: 10px;
                        }
                        
                        .footer .contact-info { 
                            font-size: 10px; 
                            margin-top: 15px; 
                            opacity: 0.9;
                        }
                        
                        .no-data { 
                            color: #999; 
                            font-style: italic; 
                            text-align: center; 
                            padding: 10px;
                        }
                        
                        @media print {
                            body { padding: 0; font-size: 11px; }
                            .header, .footer { background: #7F973B !important; -webkit-print-color-adjust: exact; }
                            .day-section h2 { background: #A7B839 !important; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üå± gardenKeeper¬Æ Abnahmeprotokoll</h1>
                        <div class="subtitle">Gartenpflege mit Stil und ‚ô•</div>
                        <div>Ob Garten oder Grundst√ºck - wir sorgen daf√ºr, dass Ihr Zuhause stilvoll, gepflegt und verl√§sslich aufbl√ºht.</div>
                        <div class="contact">
                            Sven Kr√§mer gardenKeeper¬Æ GmbH | Gro√üblittersdorfer Str. 329, 66130 Saarbr√ºcken<br>
                            üìû 0681 93784009 | üìß info@gardenkeeper.de
                        </div>
                    </div>
                    
                    <div class="overview">
                        <h2>üìã Kundendaten & Projekt√ºbersicht</h2>
                        <table class="overview-table">
                            <tr>
                                <td>Kunde:</td>
                                <td>${formData.kunde}</td>
                                <td>LexOffice-ID:</td>
                                <td>${formData.lexofficeId || 'Nicht angegeben'}</td>
                            </tr>
                            <tr>
                                <td>Kunde E-Mail:</td>
                                <td>${formData.kundeEmail || 'Nicht angegeben'}</td>
                                <td>Startdatum:</td>
                                <td>${formData.startdatum}</td>
                            </tr>
                            <tr>
                                <td>Projekttage:</td>
                                <td>${formData.days.length}</td>
                                <td>Gesamtstunden:</td>
                                <td>${totalHours.toFixed(2)} Std.</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${daysHTML}
                    
                    ${formData.bemerkungen ? `
                    <div class="remarks">
                        <h2>üí¨ Gesamtbemerkungen</h2>
                        <div class="remarks-content">${formData.bemerkungen}</div>
                    </div>
                    ` : ''}
                    
                    <div class="footer">
                        <h2>üå± gardenKeeper¬Æ - Gartenpflege mit Stil und ‚ô•</h2>
                        <div>‚ÄûWeil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</div>
                        <div style="margin: 10px 0; font-size: 11px;">
                            üåø Verl√§sslichkeit echter Gartenprofis | üèóÔ∏è Moderne Zaunbau-L√∂sungen
                        </div>
                        <div class="contact-info">
                            Sven Kr√§mer gardenKeeper¬Æ GmbH | Gro√üblittersdorfer Str. 329, 66130 Saarbr√ºcken<br>
                            üìû 0681 93784009 | üìß info@gardenkeeper.de | üåê www.gardenkeeper.de<br>
                            Erstellt am ${new Date().toLocaleDateString('de-DE')} um ${new Date().toLocaleTimeString('de-DE')} Uhr | v6.5 - Vereinfacht ohne Bilder
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        // HILFSFUNKTION: Tagesstunden berechnen
        function calculateDayHours(day) {
            if (!day.ladebeginn || !day.arbeitszeitEnde || day.workers.length === 0) {
                return 0;
            }
            
            const start = new Date(`2000-01-01T${day.ladebeginn}`);
            const end = new Date(`2000-01-01T${day.arbeitszeitEnde}`);
            const grossHours = Math.max(0, (end - start) / (1000 * 60 * 60));
            const pauseHours = (parseInt(day.pause || 0) + parseInt(day.regenpause || 0)) / 60;
            const netHoursPerWorker = Math.max(0, grossHours - pauseHours);
            
            return netHoursPerWorker * day.workers.length;
        }

        // HTML DOWNLOAD FUNKTION
        function downloadHTML() {
            const data = getFormData();
            
            try {
                const htmlContent = generateSimplePDFHTML(data);
                const filename = `Abnahmeprotokoll_${data.kunde}_${data.startdatum}.html`;
                
                // Erstelle Download-Link
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.style.display = 'none';
                
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                
                URL.revokeObjectURL(url);
                
                showMessage('üíæ HTML-Datei wurde heruntergeladen! Sie k√∂nnen sie √∂ffnen und als PDF drucken.', 'success');
                
            } catch (error) {
                console.error('‚ùå HTML Download Fehler:', error);
                showMessage(`‚ùå HTML Download fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        // ========================================
        // DATENSAMMLUNG
        // ========================================
        function getFormData() {
            const allDays = [];
            
            // Collect data from all days
            for (let dayNum = 1; dayNum <= maxDays; dayNum++) {
                const dayContent = document.getElementById(`day${dayNum}`);
                if (!dayContent) continue;
                
                const workers = [];
                dayContent.querySelectorAll('.worker-row').forEach(row => {
                    const workerSelect = row.querySelector('.worker-select');
                    
                    if (workerSelect.value) {
                        workers.push({
                            name: workerSelect.value
                        });
                    }
                });
                
                const materials = [];
                dayContent.querySelectorAll('.material-row').forEach(row => {
                    const materialSelect = row.querySelector('.material-select');
                    const amount = row.querySelector('.material-amount');
                    const fremdeinkauf = row.querySelector('.fremdeinkauf-checkbox');
                    
                    if (materialSelect.value && amount.value) {
                        const selectedOption = materialSelect.querySelector('option:checked');
                        const material = {
                            name: materialSelect.value,
                            amount: amount.value,
                            unit: selectedOption.dataset.unit || '',
                            fremdeinkauf: fremdeinkauf.checked
                        };
                        
                        materials.push(material);
                    }
                });
                
                const machines = [];
                dayContent.querySelectorAll('.machine-row').forEach(row => {
                    const machineSelect = row.querySelector('.machine-select');
                    const duration = row.querySelector('.machine-duration');
                    
                    if (machineSelect.value && duration.value) {
                        machines.push({
                            name: machineSelect.value,
                            duration: duration.value
                        });
                    }
                });
                
                const dayData = {
                    dayNumber: dayNum,
                    ladebeginn: dayContent.querySelector('.ladebeginn').value,
                    abfahrt: dayContent.querySelector('.abfahrt').value,
                    arbeitszeitBeginn: dayContent.querySelector('.arbeitszeit-beginn').value,
                    arbeitszeitEnde: dayContent.querySelector('.arbeitszeit-ende').value,
                    pause: dayContent.querySelector('.pause').value,
                    regenpause: dayContent.querySelector('.regenpause').value,
                    workers: workers,
                    machines: machines,
                    arbeiten: dayContent.querySelector('.beschreibung-arbeiten').value,
                    materials: materials,
                    zusatzarbeiten: dayContent.querySelector('.zusatzarbeiten').value
                };
                
                allDays.push(dayData);
            }

            return {
                kunde: document.getElementById('kunde').value,
                kundeEmail: document.getElementById('kundeEmailField').value,
                lexofficeId: document.getElementById('lexofficeId').value,
                startdatum: document.getElementById('startdatum').value,
                days: allDays,
                bemerkungen: document.getElementById('bemerkungen').value
            };
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.className = `status-message status-${type}`;
                statusDiv.innerHTML = message; // innerHTML f√ºr HTML-Inhalte
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, type === 'error' ? 8000 : 5000); // L√§ngere Anzeige f√ºr Fehler
            }
        }

        function saveDraft() {
            try {
                const draftData = getFormData();
                localStorage.setItem('gardenKeeper_draft', JSON.stringify(draftData));
                showMessage('üíæ Entwurf gespeichert!', 'success');
            } catch (error) {
                console.error('Draft save error:', error);
                showMessage('‚ùå Entwurf speichern fehlgeschlagen', 'error');
            }
        }

        function loadDraft() {
            try {
                const draft = localStorage.getItem('gardenKeeper_draft');
                if (draft) {
                    const draftData = JSON.parse(draft);
                    console.log('üìÑ Entwurf gefunden:', draftData);
                    // TODO: Entwurf laden (f√ºr zuk√ºnftige Version)
                }
            } catch (error) {
                console.error('Draft load error:', error);
                localStorage.removeItem('gardenKeeper_draft'); // Besch√§digten Entwurf entfernen
            }
        }

        function resetForm() {
            // Clear draft
            localStorage.removeItem('gardenKeeper_draft');
            
            // Reset global variables
            maxDays = 1;
            currentDay = 1;
            
            // Complete reset via reload
            location.reload();
        }

        // Console info for debugging
        console.log('üå± gardenKeeper¬Æ v6.5 - VEREINFACHT ohne Bilder geladen');
        console.log('üìä Sheets Integration:', SHEETS_CONFIG.enabled ? 'Aktiviert' : 'Deaktiviert');
        console.log('üìÅ Drive System:', DRIVE_CONFIG.enabled ? 'Aktiviert' : 'Deaktiviert');
        console.log('üîó Apps Script URL:', GOOGLE_APPS_SCRIPT_CONFIG.URL);
        console.log('üîß JSON-Format: Aktiviert');
        console.log('üìÑ PDF-L√∂sung: Browser-basiert');
        console.log('üîó URL-Parameter: Aktiviert');
        console.log('üí° Tipp: "Test System" Button verwenden um Verbindung zu pr√ºfen');
        console.log('');
        console.log('üéØ VEREINFACHT v6.5:');
        console.log('‚ùå E-Mail System entfernt');
        console.log('‚ùå Unterschriften entfernt');
        console.log('‚ùå Anhakpunkte entfernt');
        console.log('‚ùå Bilder entfernt');
        console.log('‚úÖ Fokus auf reine Datenerfassung');
        console.log('‚úÖ Stunden ab Ladebeginn berechnet');
        console.log('‚úÖ URL-Parameter automatisch geladen');
        console.log('');
        console.log('üîó URL-Parameter Beispiele:');
        console.log('   ?kunde=Max%20Mustermann&lexofficeId=12345');
        console.log('   ?kunde=Firma%20Schmidt&kundeEmail=info@firma.de&datum=2025-07-28');
        console.log('   Unterst√ºtzte Parameter: kunde, lexofficeId, kundeEmail, datum');
    </script>
</body>
</html>
