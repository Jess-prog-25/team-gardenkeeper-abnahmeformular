<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçÅ gardenKeeper¬Æ - üîë Abnahmeformular</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    :root {
        /* Sanfte Gr√ºnt√∂ne */
        --sage-green: #8fa68f;
        --light-moss: #a8c09a;
        --pale-lime: #c1d4b1;

        /* Sanfte Braunt√∂ne */
        --warm-chestnut: #8b7355;
        --soft-clay: #a08879;
        --light-sand: #c4b5a0;

        /* Neutrale T√∂ne */
        --cream-white: #f5f3f0;
        --dark-forest: #2d3e2d;

        /* ‚ú® T√úRKIS-FARBEN */
        --turquoise-light: #5eead4;
        --turquoise-main: #14b8a6;
        --turquoise-dark: #0d9488;
        --turquoise-darker: #0f766e;

        /* UI Farben */
        --border-light: #e8e5e2;
        --shadow-soft: rgba(141, 115, 85, 0.1);
        --hover-tint: rgba(143, 166, 143, 0.1);
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--cream-white);
        color: var(--dark-forest);
        line-height: 1.6;
        min-height: 100vh;
    }

    /* === LAUNCHER SEITE === */
    .launcher {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
    }

    .launcher-container {
        max-width: 600px;
        text-align: center;
        background: rgba(255,255,255,0.95);
        padding: 60px 50px;
        border-radius: 20px;
        box-shadow: 0 20px 60px var(--shadow-soft);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255,255,255,0.8);
    }

    .logo {
        font-size: 4.5rem;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--sage-green), var(--warm-chestnut));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .launcher h1 {
        font-size: 2.8rem;
        margin-bottom: 15px;
        font-weight: 700;
        color: var(--dark-forest);
    }

    .subtitle {
        font-size: 1.4rem;
        margin-bottom: 30px;
        color: var(--sage-green);
        font-weight: 500;
    }

    .company-slogan {
        background: linear-gradient(135deg, var(--pale-lime), var(--light-sand));
        padding: 25px;
        border-radius: 15px;
        margin: 30px 0;
        border-left: 4px solid var(--sage-green);
    }

    .company-slogan p {
        margin: 10px 0;
        color: var(--dark-forest);
    }

    .main-slogan {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .sub-slogan {
        font-style: italic;
        opacity: 0.9;
        font-size: 1rem;
    }

    .launcher-btn {
        background: linear-gradient(135deg, var(--sage-green), var(--warm-chestnut));
        color: white;
        padding: 20px 40px;
        border: none;
        border-radius: 50px;
        font-size: 1.3rem;
        font-weight: 600;
        cursor: pointer;
        margin: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 15px;
        min-width: 280px;
        justify-content: center;
        box-shadow: 0 10px 30px var(--shadow-soft);
        text-decoration: none;
    }

    .launcher-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(143, 166, 143, 0.3);
        background: linear-gradient(135deg, var(--light-moss), var(--soft-clay));
    }

    .instructions {
        background: var(--pale-lime);
        padding: 30px;
        border-radius: 15px;
        margin-top: 40px;
        text-align: left;
        border: 1px solid var(--border-light);
    }

    .instructions h3 {
        margin-bottom: 20px;
        color: var(--dark-forest);
        font-size: 1.2rem;
    }

    .instructions ol {
        padding-left: 25px;
    }

    .instructions li {
        margin-bottom: 10px;
        font-size: 1rem;
        color: var(--dark-forest);
    }

    .support-info {
        background: var(--light-sand);
        padding: 25px;
        border-radius: 15px;
        margin-top: 30px;
        border: 1px solid var(--warm-chestnut);
    }

    .support-info h4 {
        color: var(--warm-chestnut);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    /* === FORMULAR SEITE === */
    .formular {
        display: none;
        background: var(--cream-white);
        min-height: 100vh;
        padding: 20px;
    }

    .formular.active {
        display: block;
    }

    .form-container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px var(--shadow-soft);
        overflow: hidden;
        border: 2px solid var(--border-light);
    }

    .form-header {
        background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
        color: white;
        padding: 40px;
        text-align: center;
    }

    .form-header h1 {
        font-size: 2.5rem;
        margin-bottom: 15px;
        font-weight: 700;
    }

    .form-header p {
        opacity: 0.95;
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .form-header .company-tagline {
        font-style: italic;
        opacity: 0.9;
        font-size: 1.1rem;
    }

    .form-buttons {
        display: flex;
        gap: 12px;
        margin-top: 25px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* üé® T√úRKIS BUTTON STYLES */
    .btn-turquoise {
        background: linear-gradient(135deg, var(--turquoise-main), var(--turquoise-dark));
        color: white;
    }

    .btn-turquoise:hover {
        background: linear-gradient(135deg, var(--turquoise-light), var(--turquoise-main));
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(20, 184, 166, 0.4);
    }

    .btn-turquoise-light {
        background: linear-gradient(135deg, var(--turquoise-light), var(--turquoise-main));
        color: white;
    }

    .btn-turquoise-light:hover {
        background: linear-gradient(135deg, #7df3e1, var(--turquoise-light));
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(94, 234, 212, 0.4);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--light-moss), var(--pale-lime));
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--shadow-soft);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--warm-chestnut), var(--soft-clay));
        color: white;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, var(--soft-clay), var(--light-sand));
        transform: translateY(-2px);
    }

    .btn-success {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #4ade80, #22c55e);
        transform: translateY(-2px);
    }

    .btn-back {
        background: rgba(255,255,255,0.9);
        color: var(--sage-green);
        border: 2px solid rgba(255,255,255,0.8);
    }

    .btn-back:hover {
        background: rgba(255,255,255,1);
        color: var(--dark-forest);
    }

    .form-content {
        padding: 40px;
    }

    .section {
        margin-bottom: 40px;
        padding: 30px;
        background: var(--cream-white);
        border-radius: 15px;
        border: 2px solid var(--border-light);
    }

    .section h3 {
        color: var(--dark-forest);
        font-size: 1.5rem;
        margin-bottom: 25px;
        border-bottom: 3px solid var(--sage-green);
        padding-bottom: 12px;
        font-weight: 600;
    }

    .grid {
        display: grid;
        gap: 25px;
    }

    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    .field {
        margin-bottom: 25px;
    }

    .field label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--dark-forest);
        font-size: 1rem;
    }

    .field input,
    .field textarea,
    .field select {
        width: 100%;
        padding: 15px;
        border: 2px solid var(--border-light);
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
        color: var(--dark-forest);
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
        outline: none;
        border-color: var(--turquoise-main);
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    /* === TAG MANAGEMENT === */
    .day-tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .day-tab {
        padding: 15px 25px;
        background: var(--pale-lime);
        border: 2px solid var(--border-light);
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        color: var(--dark-forest);
    }

    .day-tab.active {
        background: linear-gradient(135deg, var(--turquoise-main), var(--turquoise-dark));
        color: white;
        border-color: var(--turquoise-dark);
    }

    .day-tab:hover {
        border-color: var(--turquoise-main);
        background: var(--turquoise-light);
        color: white;
    }

    .day-content {
        display: none;
    }

    .day-content.active {
        display: block;
    }

    /* === DYNAMISCHE REIHEN === */
    .worker-row,
    .material-row,
    .machine-row {
        display: grid;
        gap: 20px;
        align-items: start;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 2px solid var(--border-light);
        transition: all 0.3s ease;
    }

    .worker-row {
        grid-template-columns: 1fr auto;
    }

    .material-row {
        grid-template-columns: 2fr 1fr 1fr auto;
    }

    .machine-row {
        grid-template-columns: 2fr 1fr auto;
    }

    .worker-row:hover,
    .material-row:hover,
    .machine-row:hover {
        border-color: var(--turquoise-main);
        box-shadow: 0 4px 15px rgba(20, 184, 166, 0.2);
    }

    .remove-btn {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .remove-btn:hover {
        background: linear-gradient(135deg, #c82333, #bd2130);
        transform: scale(1.05);
    }

    /* === FREMDEINKAUF SECTION === */
    .fremdeinkauf-section {
        margin-top: 15px;
        padding: 20px;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-radius: 10px;
        border: 2px solid var(--warm-chestnut);
        grid-column: 1 / -1;
    }

    .fremdeinkauf-section.hidden {
        display: none;
    }

    .fremdeinkauf-section h4 {
        color: var(--warm-chestnut);
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    /* === STUNDEN ZUSAMMENFASSUNG === */
    .hours-summary {
        background: linear-gradient(135deg, var(--pale-lime), #e8f5e8);
        padding: 25px;
        border-radius: 12px;
        margin-top: 25px;
        border: 2px solid var(--sage-green);
    }

    .hours-summary h4 {
        color: var(--dark-forest);
        margin-bottom: 15px;
        font-size: 1.2rem;
    }

    .hours-summary .total {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--dark-forest);
        margin-top: 15px;
        padding-top: 15px;
        border-top: 3px solid var(--sage-green);
    }

    /* === BILDER UPLOAD === */
    .image-upload-area {
        margin-bottom: 25px;
    }

    .upload-zone {
        border: 3px dashed var(--border-light);
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        background: var(--cream-white);
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--dark-forest);
    }

    .upload-zone:hover {
        border-color: var(--turquoise-main);
        background: rgba(20, 184, 166, 0.05);
    }

    .upload-zone.dragover {
        border-color: var(--turquoise-main);
        background: rgba(20, 184, 166, 0.1);
        transform: scale(1.02);
    }

    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .image-preview {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid var(--border-light);
        background: white;
        transition: all 0.3s ease;
    }

    .image-preview:hover {
        border-color: var(--turquoise-main);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(20, 184, 166, 0.2);
    }

    .image-preview img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .image-info {
        padding: 12px;
        background: white;
    }

    .image-category {
        font-size: 0.8rem;
        color: var(--turquoise-main);
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .image-description {
        font-size: 0.9rem;
        color: var(--dark-forest);
    }

    .image-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .image-remove:hover {
        background: #dc3545;
        transform: scale(1.1);
    }

    .image-category-select {
        margin-top: 8px;
        width: 100%;
        padding: 6px;
        border: 1px solid var(--border-light);
        border-radius: 6px;
        font-size: 0.8rem;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }

    .checkbox-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 2px solid var(--border-light);
        transition: all 0.3s ease;
    }

    .checkbox-item:hover {
        border-color: var(--turquoise-main);
        box-shadow: 0 4px 15px rgba(20, 184, 166, 0.2);
    }

    .checkbox-item input[type="checkbox"] {
        margin-top: 3px;
        width: 20px;
        height: 20px;
        accent-color: var(--turquoise-main);
    }

    /* === UNTERSCHRIFTEN === */
    .signature-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
    }

    .signature-box {
        border: 3px dashed var(--border-light);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        background: var(--cream-white);
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .signature-box:hover {
        border-color: var(--turquoise-main);
        background: rgba(20, 184, 166, 0.05);
    }

    .signature-box.has-signature {
        border-style: solid;
        border-color: var(--turquoise-main);
        background: white;
    }

    /* === SUCCESS PAGE === */
    .success-page {
        display: none;
        min-height: 100vh;
        padding: 20px;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #9ba687 0%, #6b7456 50%, #4a4539 100%);
    }

    .success-page.active {
        display: flex;
    }

    .success-container {
        max-width: 700px;
        text-align: center;
        background: rgba(255,255,255,0.95);
        padding: 60px;
        border-radius: 25px;
        box-shadow: 0 20px 60px var(--shadow-soft);
    }

    .success-icon {
        font-size: 6rem;
        margin-bottom: 25px;
    }

    .employee-message {
        background: var(--pale-lime);
        padding: 30px;
        border-radius: 15px;
        margin-top: 35px;
        border: 2px solid var(--sage-green);
    }

    .employee-message h3 {
        color: var(--warm-chestnut);
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    /* === MODALS === */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(45, 62, 45, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        color: var(--dark-forest);
        border: 3px solid var(--turquoise-main);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 3px solid var(--turquoise-main);
        padding-bottom: 20px;
    }

    .modal-close {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
    }

    /* === EMAIL PREVIEW MODAL === */
    .email-preview {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        margin-top: 20px;
        border: 2px solid var(--border-light);
        max-height: 500px;
        overflow-y: auto;
    }

    /* === STATUS MESSAGES === */
    .status-message {
        padding: 20px;
        border-radius: 12px;
        margin: 25px 0;
        font-weight: 600;
        text-align: center;
        font-size: 1rem;
    }

    .status-success {
        background: linear-gradient(135deg, #d4edda, var(--pale-lime));
        color: var(--dark-forest);
        border: 2px solid var(--sage-green);
    }

    .status-error {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        border: 2px solid #dc3545;
    }

    .status-warning {
        background: linear-gradient(135deg, #fff3cd, var(--light-sand));
        color: var(--warm-chestnut);
        border: 2px solid var(--warm-chestnut);
    }

    .status-info {
        background: linear-gradient(135deg, #d1ecf1, rgba(20, 184, 166, 0.1));
        color: var(--dark-forest);
        border: 2px solid var(--turquoise-main);
    }

    /* === LOADING ANIMATION === */
    .loading {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(20, 184, 166, 0.3);
        border-radius: 50%;
        border-top-color: var(--turquoise-main);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* === SWIPEABLE BUTTON BAR (MOBILE) === */
    .button-bar-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        transform: translateY(0);
        transition: transform 0.3s ease-out;
    }

    .button-bar-container.hidden {
        transform: translateY(calc(100% - 40px));
    }

    .button-bar-handle {
        background: linear-gradient(135deg, var(--turquoise-main), var(--turquoise-dark));
        padding: 8px 0;
        text-align: center;
        cursor: grab;
        user-select: none;
        border-radius: 15px 15px 0 0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .button-bar-handle:active {
        cursor: grabbing;
    }

    .button-bar-handle-icon {
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 2px;
        margin: 0 auto;
    }

    .button-bar-content {
        background: linear-gradient(to bottom, rgba(245, 243, 240, 0.98) 0%, rgba(245, 243, 240, 0.95) 100%);
        backdrop-filter: blur(10px);
        padding: 15px;
        box-shadow: 0 -4px 20px rgba(45, 62, 45, 0.15);
        border-top: 2px solid var(--border-light);
    }

    .button-bar-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: space-around;
        max-width: 100%;
    }

    .button-bar-buttons .btn {
        flex: 0 0 calc(50% - 4px);
        min-width: auto;
        padding: 10px 14px;
        font-size: 13px;
        justify-content: center;
        white-space: nowrap;
        min-height: 40px;
    }

    .button-bar-buttons .btn-success {
        order: -1;
        flex: 0 0 100%;
        font-size: 15px;
        padding: 14px 20px;
    }

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
        .launcher-container {
            padding: 40px 30px;
            margin: 10px;
        }

        .launcher h1 {
            font-size: 2.2rem;
        }

        .launcher-btn {
            min-width: 250px;
            padding: 18px 35px;
            font-size: 1.1rem;
        }

        .form-content {
            padding: 25px;
            padding-bottom: 120px !important;
        }

        .grid-2,
        .grid-3,
        .grid-4 {
            grid-template-columns: 1fr;
        }

        .worker-row,
        .material-row,
        .machine-row {
            grid-template-columns: 1fr;
        }

        .day-tabs {
            flex-direction: column;
        }

        .form-buttons {
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            font-size: 14px;
        }

        .section {
            padding: 20px;
        }

        .form-header .form-buttons {
            display: none !important;
        }
    }

    @media (min-width: 769px) {
        .button-bar-container {
            display: none;
        }
    }

    /* === PRINT STYLES === */
    @media print {
        .launcher, .form-buttons, .btn, .modal { display: none !important; }
        .formular { display: block !important; }
        .form-container { box-shadow: none; border: 1px solid #ccc; }
        .form-header { background: var(--sage-green) !important; -webkit-print-color-adjust: exact; }
        body { font-size: 12px; }

        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }

    .images-section {
        page-break-before: always;
    }

    .images-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    .image-item {
        border: 2px solid #e8e5e2;
        border-radius: 10px;
        overflow: hidden;
        page-break-inside: avoid;
        background: white;
    }

    .image-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }

    .image-caption {
        padding: 12px 15px;
        background: #f5f3f0;
        border-top: 1px solid #e8e5e2;
        font-size: 0.9rem;
    }

    @media print {
        .images-grid {
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .image-item img {
            height: 150px;
        }
    }

</style>
</head>
<body>
    <!-- === LAUNCHER PAGE === -->
    <div class="launcher" id="launcherPage">
        <div class="launcher-container">
            <div class="logo">üçÅ</div>
            <h1>gardenKeeper¬Æ</h1>
            <div class="subtitle">Professionelle Gartenpflege</div>

            <div class="company-slogan">
                <p class="main-slogan">Ob Garten oder Grundst√ºck - wir sorgen daf√ºr, dass Ihr Zuhause stilvoll, gepflegt und verl√§sslich aufbl√ºht.</p>
                <p class="sub-slogan">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</p>
            </div>

            <button id="openFormBtn" class="launcher-btn" onclick="openForm()">
                <span>üì±</span>
                <span>Abnahmeformular √∂ffnen</span>
            </button>

            <div class="instructions">
                <h3>üìã Arbeitsschritte:</h3>
                <ol>
                    <li>Formular √∂ffnen und alle Projektdaten eingeben</li>
                    <li>Mehrt√§gige Projekte √ºber Tage-Tabs erfassen</li>
                    <li>Pro Tag: Mitarbeiter, Arbeitszeiten und Materialien dokumentieren</li>
                    <li>Pro Tag: Unterschriften von Kunde und Teamleiter einholen</li>
                    <li>Automatische Pausenberechnung und Stundenerfassung</li>
                    <li>Abschlie√üen ‚Üí E-Mail wird automatisch an Kunde versendet</li>
                    <li>PDF kann direkt erstellt und weitergeleitet werden</li>
                </ol>
            </div>

            <div class="support-info">
                <h4>üìû Bei Fragen oder Problemen:</h4>
                <p><strong>Wenden Sie sich an Chef oder Chefin</strong></p>
            </div>

            <div style="margin-top: 35px; font-size: 0.95rem; opacity: 0.8; color: var(--dark-forest);">
                ¬© copyright by gardenKeeper 2025<br>
                ‚úÖ Alle Funktionen verf√ºgbar<br>
                ‚úÖ Swipe-Buttons f√ºr Mobile
            </div>
        </div>
    </div>

    <!-- === FORMULAR PAGE === -->
    <div class="formular" id="formularPage">
        <div class="form-container">
            <!-- Header -->
            <div class="form-header">
                <h1>ABNAHME / TAGESREGIEBERICHT</h1>
                <p>gardenKeeper¬Æ GmbH - Sven Kr√§mer</p>
                <p class="company-tagline">Professionelle Gartenpflege mit Stil und ‚ô•</p>

                <!-- üé® ALLE BUTTONS MIT T√úRKIS-DESIGN -->
                <div class="form-buttons">
                    <button onclick="goBackToLauncher()" class="btn btn-back">
                        <span>‚Üê</span>
                        Zur√ºck
                    </button>
                    <button onclick="saveDraft()" class="btn btn-secondary">
                        <span>üíæ</span>
                        Speichern
                    </button>
                    <button onclick="generatePDF()" class="btn btn-turquoise">
                        <span>üìÑ</span>
                        PDF erstellen
                    </button>
                    <button onclick="downloadHTML()" class="btn btn-turquoise-light">
                        <span>üíæ</span>
                        HTML Download
                    </button>
                    <button onclick="openEmailModal()" class="btn btn-turquoise">
                        <span>üìß</span>
                        E-Mail senden
                    </button>
                    <button onclick="previewEmail()" class="btn btn-turquoise-light">
                        <span>üëÅÔ∏è</span>
                        E-Mail Vorschau
                    </button>
                    <button onclick="completeFormWithImages()" class="btn btn-success">
                        <span>‚úÖ</span>
                        <span id="completeBtnText">Abschlie√üen</span>
                    </button>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage"></div>

            <div class="form-content">
                <!-- Grunddaten -->
                <div class="section">
                    <h3>üìã Grunddaten des Projekts</h3>
                    <div class="grid grid-3">
                        <div class="field">
                            <label>Name Kunde *</label>
                            <input type="text" id="kunde" placeholder="z.B. Familie M√ºller" required>
                        </div>
                        <div class="field">
                            <label>Kunde Email-Adresse</label>
                            <input type="email" id="kundenEmail" placeholder="kunde@beispiel.de">
                        </div>
                        <div class="field">
                            <label>üí∞ Abrechnungsart</label>
                            <select id="abrechnungsart">
                                <option value="tagesregie">‚è±Ô∏è Tagesregie (mit Zeiterfassung)</option>
                                <option value="pauschal">üíµ Pauschal (ohne Zeitangaben f√ºr Kunde)</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>LexOffice-ID</label>
                            <input type="text" id="lexofficeId" placeholder="z.B. LEX-2025-001">
                        </div>
                        <div class="field">
                            <label>Startdatum *</label>
                            <input type="date" id="startdatum" required>
                        </div>
                        <div class="field">
                            <label>Projektbeschreibung</label>
                            <input type="text" id="projektbeschreibung" placeholder="z.B. Gartenpflege, Heckenschnitt, Beetarbeiten">
                        </div>
                        <div class="field">
                            <label>Ansprechpartner vor Ort</label>
                            <input type="text" id="ansprechpartner" placeholder="Name der Kontaktperson">
                        </div>
                    </div>
                </div>

                <!-- Tage-Tabs -->
                <div class="section">
                    <h3>üìÖ Erfassung pro Arbeitstag</h3>
                    <div class="day-tabs" id="dayTabs">
                        <div class="day-tab active" data-day="1" onclick="switchDay(1)">Tag 1</div>
                    </div>
                    <button onclick="addDay()" class="btn btn-turquoise">
                        <span>+</span>
                        Weiteren Tag hinzuf√ºgen
                    </button>
                </div>

                <!-- Day Content Container -->
                <div id="dayContentContainer">
                    <!-- Tag 1 Content -->
                    <div class="day-content active" id="day1">

                        <!-- ‚è∞ ARBEITSZEITEN - ORIGINAL MIT ALLEN 4 FELDERN!! -->
                        <div class="section">
                            <h3>‚è∞ Arbeitszeiten und Pausen</h3>
                            <div class="grid grid-4">
                                <div class="field">
                                    <label>Ladebeginn</label>
                                    <input type="time" class="ladebeginn">
                                </div>
                                <div class="field">
                                    <label>Abfahrt</label>
                                    <input type="time" class="abfahrt">
                                </div>
                                <div class="field">
                                    <label>Arbeitszeit Beginn</label>
                                    <input type="time" class="arbeitszeit-beginn" onchange="updateHoursSummary()">
                                </div>
                                <div class="field">
                                    <label>Arbeitszeit Ende</label>
                                    <input type="time" class="arbeitszeit-ende" onchange="updateHoursSummary()">
                                </div>
                            </div>
                            <div class="grid grid-2">
                                <div class="field">
                                    <label>Pause (Minuten)</label>
                                    <input type="number" class="pause" placeholder="0" min="0" onchange="updateHoursSummary()">
                                </div>
                                <div class="field">
                                    <label>Regenpause (Minuten)</label>
                                    <input type="number" class="regenpause" placeholder="0" min="0" onchange="updateHoursSummary()">
                                </div>
                            </div>
                        </div>

                        <!-- Mitarbeiter -->
                        <div class="section">
                            <h3>üë• Ausf√ºhrende Mitarbeiter</h3>
                            <div class="workers-container">
                                <div class="worker-row">
                                    <div class="field">
                                        <label>Mitarbeiter</label>
                                        <select class="worker-select" onchange="updateHoursSummary()">
                                            <option value="">Mitarbeiter ausw√§hlen</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label>Abw. Start (Min)</label>
                                        <input type="number" class="worker-deviation-start" placeholder="¬±Min" onchange="updateHoursSummary()" title="Positiv = sp√§ter angefangen, Negativ = fr√ºher angefangen" style="width: 100px;">
                                    </div>
                                    <div class="field">
                                        <label>Abw. Ende (Min)</label>
                                        <input type="number" class="worker-deviation-end" placeholder="¬±Min" onchange="updateHoursSummary()" title="Positiv = sp√§ter gegangen, Negativ = fr√ºher gegangen" style="width: 100px;">
                                    </div>
                                    <div style="align-self: start; margin-top: 25px;">
                                        <button onclick="removeWorker(this)" class="remove-btn">√ó</button>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                                <button onclick="addWorker()" class="btn btn-turquoise">
                                    <span>+</span>
                                    Mitarbeiter hinzuf√ºgen
                                </button>
                                <button onclick="openWorkerModal()" class="btn btn-secondary">
                                    <span>üë§</span>
                                    Neuen Mitarbeiter anlegen
                                </button>
                            </div>

                            <!-- Stunden-Zusammenfassung -->
                            <div class="hours-summary">
                                <h4>üìä Stunden-Zusammenfassung (inkl. Pausenabzug)</h4>
                                <div class="hours-list"></div>
                                <div class="total">Gesamtstunden: 0 Std.</div>
                            </div>
                        </div>

                        <!-- Maschinen -->
                        <div class="section">
                            <h3>üöú Eingesetzte Maschinen und Ger√§te</h3>
                            <div class="machines-container">
                                <div class="machine-row">
                                    <div class="field">
                                        <label>Maschine/Ger√§t</label>
                                        <select class="machine-select">
                                            <option value="">Maschine ausw√§hlen</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label>Einsatzdauer</label>
                                        <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                                    </div>
                                    <div style="align-self: start; margin-top: 25px;">
                                        <button onclick="removeMachine(this)" class="remove-btn">√ó</button>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                                <button onclick="addMachine()" class="btn btn-turquoise">
                                    <span>+</span>
                                    Maschine hinzuf√ºgen
                                </button>
                                <button onclick="openMachineModal()" class="btn btn-secondary">
                                    <span>üöú</span>
                                    Neue Maschine anlegen
                                </button>
                            </div>
                        </div>

                        <!-- Arbeiten -->
                        <div class="section">
                            <h3>üî® Beschreibung ausgef√ºhrte Arbeiten</h3>
                            <div class="field">
                                <textarea class="beschreibung-arbeiten" rows="5" placeholder="Detaillierte Beschreibung der durchgef√ºhrten Arbeiten an diesem Tag..." required></textarea>
                            </div>
                        </div>

                        <!-- Materialien -->
                        <div class="section">
                            <h3>üì¶ Materialien und Baustoffe</h3>
                            <div class="materials-container">
                                <div class="material-row">
                                    <div class="field">
                                        <label>Material</label>
                                        <select class="material-select">
                                            <option value="">Material ausw√§hlen</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label>Menge</label>
                                        <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                                    </div>
                                    <div class="field">
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" class="fremdeinkauf-checkbox" onchange="toggleFremdeinkauf(this)">
                                            Fremdeinkauf
                                        </label>
                                    </div>
                                    <div style="align-self: start; margin-top: 25px;">
                                        <button onclick="removeMaterial(this)" class="remove-btn">√ó</button>
                                    </div>
                                    <div class="fremdeinkauf-section hidden">
                                        <h4>üí∞ Fremdeinkauf Details</h4>
                                        <div class="field">
                                            <label>Beschreibung/Lieferant:</label>
                                            <input type="text" class="fremdeinkauf-details" placeholder="z.B. Baumarkt XY, Lieferant Z">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                                <button onclick="addMaterial()" class="btn btn-turquoise">
                                    <span>+</span>
                                    Material hinzuf√ºgen
                                </button>
                                <button onclick="openMaterialModal()" class="btn btn-secondary">
                                    <span>üì¶</span>
                                    Neues Material anlegen
                                </button>
                            </div>
                        </div>

                        <!-- Bilder -->
                        <div class="section">
                            <h3>üì∑ Projekt-Bilder</h3>
                            <div class="image-upload-area">
                                <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
                                    <div style="font-size: 3em; margin-bottom: 15px;">üì∏</div>
                                    <div>Bilder hinzuf√ºgen</div>
                                    <div style="font-size: 0.9em; opacity: 0.7; margin-top: 8px;">Tippen zum Ausw√§hlen oder Drag & Drop</div>
                                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 5px; color: var(--turquoise-main);">‚úÖ Werden automatisch mit Kundenname gespeichert</div>
                                </div>
                                <input type="file" id="imageInput" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            </div>

                            <div class="image-preview-container" id="imagePreviewContainer">
                                <!-- Bilder werden hier angezeigt -->
                            </div>

                            <div style="margin-top: 15px; font-size: 0.9em; color: var(--soft-clay);">
                                üí° <strong>Tipp:</strong> Vorher/Nachher Bilder, Arbeitsfortschritt, besondere Details
                            </div>
                        </div>

                        <!-- Zusatzarbeiten -->
                        <div class="section">
                            <h3>‚ûï Zusatzarbeiten und Besonderheiten</h3>
                            <div class="field">
                                <textarea class="zusatzarbeiten" rows="3" placeholder="Beschreibung zus√§tzlicher Arbeiten, die nicht im urspr√ºnglichen Auftrag enthalten waren..."></textarea>
                            </div>
                        </div>

                        <!-- Unterschriften PRO TAG -->
                        <div class="section">
                            <h3>‚úèÔ∏è Tagesabnahme - Unterschriften</h3>
                            <div class="signature-section">
                                <div>
                                    <h4 style="margin-bottom: 15px; color: var(--dark-forest);">Unterschrift Kunde (Tag 1)</h4>
                                    <div class="signature-box" data-type="kunde" data-day="1" onclick="openSignature('kunde', 1)">
                                        <div style="font-size: 2em;">‚úèÔ∏è</div>
                                        <div>Tippen zum Unterschreiben</div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="margin-bottom: 15px; color: var(--dark-forest);">Unterschrift Teamleiter (Tag 1)</h4>
                                    <div class="signature-box" data-type="teamleiter" data-day="1" onclick="openSignature('teamleiter', 1)">
                                        <div style="font-size: 2em;">‚úèÔ∏è</div>
                                        <div>Tippen zum Unterschreiben</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Gesamtbest√§tigungen -->
                <div class="section">
                    <h3>‚úÖ Gesamtbest√§tigungen des Projekts</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="auftragGemaess">
                            <label for="auftragGemaess">Die Arbeiten wurden gem√§√ü Auftrag ausgef√ºhrt</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="komplett">
                            <label for="komplett">Die beauftragten Arbeiten wurden komplett abgeschlossen</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="teilweise">
                            <label for="teilweise">Die beauftragten Arbeiten wurden teilweise abgeschlossen</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ordnungsGemaess">
                            <label for="ordnungsGemaess">Die Arbeiten wurden ordnungsgem√§√ü und m√§ngelfrei ausgef√ºhrt</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="kundeZufrieden">
                            <label for="kundeZufrieden">Der Kunde ist mit dem Ergebnis zufrieden</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="arbeitsplatzSauber">
                            <label for="arbeitsplatzSauber">Der Arbeitsplatz wurde ordentlich hinterlassen</label>
                        </div>
                    </div>
                </div>

                <!-- Gesamtbemerkungen -->
                <div class="section">
                    <h3>üí¨ Gesamtbemerkungen und Hinweise</h3>
                    <div class="field">
                        <textarea id="bemerkungen" rows="4" placeholder="Weitere Bemerkungen, Besonderheiten oder Hinweise zum gesamten Projekt..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SWIPEABLE BUTTON BAR (MOBILE ONLY) -->
    <div class="button-bar-container" id="buttonBar">
        <div class="button-bar-handle" id="buttonBarHandle">
            <div class="button-bar-handle-icon"></div>
        </div>
        <div class="button-bar-content">
            <div class="button-bar-buttons">
                <button onclick="goBackToLauncher()" class="btn btn-back">
                    <span>‚Üê</span> Zur√ºck
                </button>
                <button onclick="saveDraft()" class="btn btn-secondary">
                    <span>üíæ</span> Speichern
                </button>
                <button onclick="generatePDF()" class="btn btn-turquoise">
                    <span>üìÑ</span> PDF
                </button>
                <button onclick="previewEmail()" class="btn btn-turquoise-light">
                    <span>üëÅÔ∏è</span> Vorschau
                </button>
                <button onclick="completeFormWithImages()" class="btn btn-success">
                    <span>‚úÖ</span> Abschlie√üen & E-Mail
                </button>
            </div>
        </div>
    </div>

    <!-- === SUCCESS PAGE === -->
    <div class="success-page" id="successPage">
        <div class="success-container">
            <div class="success-icon">‚úÖ</div>
            <h1>Abnahme erfolgreich!</h1>
            <p style="font-size: 1.3rem; margin: 25px 0;">Das Formular wurde erfolgreich verarbeitet und die E-Mail wurde an den Kunden versendet!</p>

            <div class="employee-message">
                <h3>üéâ Nachricht an den Mitarbeiter</h3>
                <p><strong>Herzlichen Gl√ºckwunsch!</strong> Du hast das Abnahmeformular erfolgreich ausgef√ºllt. Deine sorgf√§ltige Dokumentation hilft uns dabei, unseren Kunden den bestm√∂glichen Service zu bieten.</p>
                <p style="margin-top: 20px;">Die Daten wurden automatisch in das System √ºbertragen und die E-Mail wurde an den Kunden versendet. Das PDF kann √ºber den "PDF erstellen" Button generiert werden. Bei Fragen oder Problemen kannst du dich jederzeit an Jessika oder Sven wenden.</p>
                <p style="margin-top: 25px; padding: 20px; background: rgba(143, 166, 143, 0.2); border-radius: 10px; border-left: 4px solid var(--sage-green);">
                    <strong>üå± gardenKeeper¬Æ - Professionelle Gartenpflege</strong><br>
                    <em>"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</em><br><br>
                    <span style="font-size: 0.95rem;">Du tr√§gst dazu bei, dass unsere Kunden stilvoll, gepflegt und verl√§sslich aufbl√ºhen k√∂nnen!</span>
                </p>
                <p style="margin-top: 20px; font-weight: bold; color: var(--sage-green); font-size: 1.1rem;">Weiter so! üí™</p>
            </div>

            <div style="margin-top: 35px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                <button class="launcher-btn" onclick="generatePDF()" style="background: linear-gradient(135deg, var(--turquoise-main), var(--turquoise-dark));">
                    <span>üìÑ</span>
                    PDF √∂ffnen & drucken
                </button>
                <button class="launcher-btn" onclick="downloadHTML()" style="background: linear-gradient(135deg, var(--turquoise-light), var(--turquoise-main));">
                    <span>üíæ</span>
                    HTML Download
                </button>
                <button class="launcher-btn" onclick="location.reload()" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <span>üîÑ</span>
                    Neues Formular
                </button>
                <button class="launcher-btn" onclick="goBackToLauncher()">
                    <span>üè†</span>
                    Zur Startseite
                </button>
            </div>
        </div>
    </div>

    <!-- === MODALS === -->

    <!-- Signature Modal -->
    <div class="modal" id="signatureModal">
        <div class="modal-content">
            <h3 id="signatureTitle">Unterschrift</h3>
            <canvas id="signatureCanvas" width="500" height="250" style="border: 2px solid var(--border-light); border-radius: 10px; cursor: crosshair; touch-action: none;"></canvas>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="clearSignature()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">L√∂schen</button>
                <button onclick="closeSignature()" class="btn" style="flex: 1; background: #dc3545; color: white;">Abbrechen</button>
                <button onclick="saveSignature()" class="btn btn-turquoise" style="flex: 1;">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Email mit Abnahmeprotokoll versenden</h3>
                <button class="modal-close" onclick="closeEmailModal()">&times;</button>
            </div>
            <div class="field">
                <label>Kunde Email-Adresse *</label>
                <input type="email" id="emailKundeAddress" placeholder="kunde@example.com" required>
            </div>
            <div class="field">
                <label>Zus√§tzliche Nachricht</label>
                <textarea id="emailMessage" rows="3" placeholder="Optional: Zus√§tzliche Nachricht an den Kunden..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeEmailModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="sendEmailWithPDF()" class="btn btn-turquoise" style="flex: 1;">Email senden</button>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div class="modal" id="emailPreviewModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üëÅÔ∏è E-Mail Vorschau</h3>
                <button class="modal-close" onclick="closeEmailPreview()">&times;</button>
            </div>
            <div class="email-preview" id="emailPreviewContent">
                <!-- E-Mail Vorschau wird hier eingef√ºgt -->
            </div>
        </div>
    </div>

    <!-- Worker Modal -->
    <div class="modal" id="workerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Neuen Mitarbeiter hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeWorkerModal()">&times;</button>
            </div>
            <div class="field">
                <label>Name des Mitarbeiters</label>
                <input type="text" id="newWorkerName" placeholder="z.B. Max Mustermann" maxlength="50">
                <small style="color: #666;">Mindestens 3 Zeichen</small>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeWorkerModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="addCustomWorker()" class="btn btn-turquoise" style="flex: 1;">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <!-- Material Modal -->
    <div class="modal" id="materialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Neues Material hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeMaterialModal()">&times;</button>
            </div>
            <div class="field">
                <label>Material-Bezeichnung</label>
                <input type="text" id="newMaterialName" placeholder="z.B. Speziald√ºnger" maxlength="100">
            </div>
            <div class="field">
                <label>Einheit</label>
                <input type="text" id="newMaterialUnit" placeholder="z.B. kg, Liter, St√ºck" maxlength="20">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeMaterialModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="addCustomMaterial()" class="btn btn-turquoise" style="flex: 1;">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <!-- Machine Modal -->
    <div class="modal" id="machineModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöú Neue Maschine hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeMachineModal()">&times;</button>
            </div>
            <div class="field">
                <label>Maschinen-Bezeichnung</label>
                <input type="text" id="newMachineName" placeholder="z.B. Motors√§ge Stihl MS 261" maxlength="100">
            </div>
            <div class="field">
                <label>Einheit</label>
                <input type="text" id="newMachineUnit" placeholder="z.B. Std., Tag, Einsatz" maxlength="20">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 25px;">
                <button onclick="closeMachineModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
                <button onclick="addCustomMachine()" class="btn btn-turquoise" style="flex: 1;">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

<script>
// ========================================
// üîß GLOBALE VARIABLEN & STAMMDATEN
// ========================================

let currentSignatureType = '';
let currentSignatureDay = 1;
let isDrawing = false;
let daySignatures = { 1: { kunde: '', teamleiter: '' } };
let currentDay = 1;
let maxDays = 1;
let currentPDFUrl = null;
let uploadedImages = [];

// Stammdaten
const WORKERS = [
    'Fabio Kr√§mer', 'Claudiu Adascalitei', 'J√ºrgen Kr√§nkel',
    'Joseph Dahl', 'Wolfgang Degro', 'Christian Weinrank',
    'Christian Winterstein', 'Carsten Munz', 'Sascha Macke', 'Julina Tiedtke',
    'Kim Honnecker', 'Jan Jeanrond', 'Justin Stillemunkes'
];

const MATERIALS = [
    { name: 'Entsorgung Gr√ºnschnitt', unit: 'cbm' },
    { name: 'Entsorgung Kn√∂terich -Sonderm√ºll-', unit: 'to.' },
    { name: 'Kieferndekorrinde 0-15', unit: 'Sack' },
    { name: 'Rindenmulch 15-45', unit: 'Sack' },
    { name: 'Pinienrinde 15-25', unit: 'Sack' },
    { name: 'Pinienrinde 8-16', unit: 'Sack' },
    { name: 'Corthum G√§rtnererde 50l', unit: 'Sack' },
    { name: 'Mutterboden, gesiebt (sehr fein)', unit: 'cbm' },
    { name: 'Entsorgung Erdmassen', unit: 'cbm' },
];

const MACHINES = [
    { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Std.' },
    { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Tag' },
    { name: 'Kompaktlader Vermeer', unit: 'Std.' },
    { name: 'Gro√üfl√§chen-Aufsitzm√§her mit Hochkipp-Funktion', unit: 'Std.' },
    { name: 'Gro√üfl√§chen-Mulcher (0-Wendekreism√§her)', unit: 'Std.' },
    { name: 'Ferris Mulchm√§her', unit: 'Std.' },
    { name: 'Minibagger Kubota (1 to.)', unit: 'Std.' },
    { name: 'Minibagger Cat 3.18 (2 to.)', unit: 'Std.' }
];

const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxajxH7qCrerYJKQTZQxPPkVhGJvTjYDOoFGtuPcoF6S2ggxMZCcNKdoiGdf3RgSdbBng/exec';

// ========================================
// üíæ GOOGLE DRIVE & SHEETS INTEGRATION
// ========================================

// DriveFixSystem Class f√ºr robuste Speicherung
class DriveFixSystem {
    constructor() {
        this.maxRetries = 3;
        this.baseDelay = 1000;
    }

    async bulletproofSave(data, filename) {
        for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
            try {
                console.log(`üìÅ Drive-Speicherung Versuch ${attempt}/${this.maxRetries}`);

                const result = await this.saveToGoogleDrive(data, filename);

                console.log('‚úÖ Drive-Speicherung erfolgreich:', result);
                return result;

            } catch (error) {
                console.error(`‚ùå Drive-Versuch ${attempt} fehlgeschlagen:`, error);

                if (attempt === this.maxRetries) {
                    throw new Error(`Drive-Speicherung nach ${this.maxRetries} Versuchen fehlgeschlagen: ${error.message}`);
                }

                // Exponential backoff
                const delay = this.baseDelay * Math.pow(2, attempt - 1);
                await this.wait(delay);
            }
        }
    }

    async saveToGoogleDrive(data, filename) {
        const payload = {
            action: 'savePDF',
            htmlContent: data,
            filename: filename,
            timestamp: new Date().toISOString()
        };

        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: JSON.stringify(payload)
        });

        return { success: true, message: 'Erfolgreich in Google Drive gespeichert' };
    }

    async wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async diagnoseDriveAccess() {
        try {
            const testPayload = {
                action: 'test',
                timestamp: new Date().toISOString()
            };

            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(testPayload)
            });

            return { status: 'ok', message: 'Drive-Zugriff funktioniert' };
        } catch (error) {
            return { status: 'error', message: error.message };
        }
    }
}

const driveFixSystem = new DriveFixSystem();

// Google Sheets Integration
async function sendToGoogleSheets(data, isTest = false) {
    try {
        console.log('üìä Sende Daten zu Google Sheets...', data);

        const payload = {
            action: 'saveData',
            data: data,
            test: isTest,
            timestamp: new Date().toISOString()
        };

        // METHODE 1: POST mit no-cors (funktioniert immer)
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: JSON.stringify(payload)
            });

            console.log('‚úÖ Sheets: Daten gesendet (no-cors mode)');
            return { success: true, message: 'Google Sheets Update erfolgreich', method: 'POST no-cors' };

        } catch (postError) {
            console.warn('‚ö†Ô∏è POST Methode fehlgeschlagen:', postError);
        }

        // METHODE 2: GET mit URL-Parametern (Fallback)
        try {
            const urlParams = new URLSearchParams({
                action: 'saveData',
                data: JSON.stringify(data),
                test: isTest ? 'true' : 'false',
                timestamp: new Date().toISOString()
            });

            const getUrl = `${GOOGLE_SCRIPT_URL}?${urlParams.toString()}`;

            // Verwende img-Tag Trick f√ºr no-cors GET
            const img = new Image();
            img.onload = () => console.log('‚úÖ Sheets: GET Fallback erfolgreich');
            img.onerror = () => console.log('‚úÖ Sheets: GET Fallback gesendet (Fehler ist normal)');
            img.src = getUrl;

            console.log('‚úÖ Sheets: GET Fallback verwendet');
            return { success: true, message: 'Google Sheets Update √ºber GET Fallback', method: 'GET fallback' };

        } catch (getError) {
            console.warn('‚ö†Ô∏è GET Fallback fehlgeschlagen:', getError);
        }

        throw new Error('Alle √úbertragungsmethoden fehlgeschlagen');

    } catch (error) {
        console.error('‚ùå Google Sheets Integration komplett fehlgeschlagen:', error);

        // Backup lokal speichern
        try {
            const backup = {
                timestamp: new Date().toISOString(),
                data: data,
                error: error.message
            };
            localStorage.setItem('gardenKeeper_sheets_backup', JSON.stringify(backup));
            console.log('üíæ Daten als Backup lokal gespeichert');
        } catch (backupError) {
            console.error('‚ùå Backup speichern fehlgeschlagen:', backupError);
        }

        return {
            success: false,
            error: error.message,
            backup: true
        };
    }
}

// Bulletproof Save f√ºr PDF zu Google Drive
async function bulletproofSaveToGoogleDrive(data) {
    try {
        const filename = `gardenKeeper_${data.kunde.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}`;

        // Bilder f√ºr Drive optimieren
        if (data.images && data.images.length > 0) {
            data.images = await optimizeImagesForPDF(data.images);
        }

        const htmlContent = generatePDFHTML(data);
        const result = await driveFixSystem.bulletproofSave(htmlContent, filename);
        return result;

    } catch (error) {
        console.error('‚ùå Bulletproof Drive-Speicherung fehlgeschlagen:', error);
        throw error;
    }
}

// Bild-Komprimierung f√ºr PDF
function compressImageForPDF(imageData, maxWidth = 800, quality = 0.8) {
    return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = function() {
            let { width, height } = img;

            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);

            const compressedData = canvas.toDataURL('image/jpeg', quality);
            resolve(compressedData);
        };

        img.src = imageData;
    });
}

// Bild-Optimierung f√ºr PDF
async function optimizeImagesForPDF(images) {
    if (!images || !Array.isArray(images)) return [];

    const optimizedImages = [];

    for (const image of images) {
        try {
            if (!image.data || !image.data.startsWith('data:image/')) continue;

            const base64Data = image.data.split(',')[1];
            const sizeInMB = ((base64Data.length * 3) / 4) / (1024 * 1024);

            let processedData = image.data;

            // Komprimiere Bilder √ºber 2MB
            if (sizeInMB > 2) {
                processedData = await compressImageForPDF(image.data, 800, 0.7);
            }

            optimizedImages.push({
                ...image,
                data: processedData,
                originalSize: sizeInMB.toFixed(1) + 'MB'
            });

        } catch (error) {
            console.error(`Bild-Optimierung Fehler "${image.name}":`, error);
        }
    }

    return optimizedImages;
}

// Placeholder f√ºr generatePDFHTML - wird von generatePDF() Funktion unten definiert
function generatePDFHTML(data) {
    // Diese Funktion sollte weiter unten in der Datei bereits existieren
    // Falls nicht, hier eine einfache Version:
    return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Abnahmeprotokoll - ${data.kunde}</title>
</head>
<body>
    <h1>gardenKeeper¬Æ Abnahmeprotokoll</h1>
    <h2>Kunde: ${data.kunde}</h2>
    <p>Datum: ${new Date().toLocaleDateString('de-DE')}</p>
    <!-- Vollst√§ndige PDF-Generierung erfolgt in der generatePDF() Funktion -->
</body>
</html>`;
}

// ========================================
// üìß BILDER-UPLOAD MIT KUNDENNAME
// ========================================

function handleImageUpload(event) {
    const files = event.target.files;
    const kundenName = document.getElementById('kunde').value.trim() || 'Kunde';

    for (let file of files) {
        if (file.type.startsWith('image/')) {
            processImage(file, kundenName);
        }
    }
    event.target.value = '';
}

function processImage(file, kundenName) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const timestamp = new Date().toISOString().split('T')[0];
        const cleanName = kundenName.replace(/[^a-zA-Z0-9]/g, '_');

        const imageData = {
            id: Date.now() + Math.random(),
            originalName: file.name,
            name: `${cleanName}_${timestamp}_${file.name}`,
            data: e.target.result,
            type: file.type,
            category: 'arbeitsfortschritt',
            description: '',
            customerName: kundenName,
            timestamp: new Date().toISOString()
        };

        uploadedImages.push(imageData);
        displayImagePreview(imageData);
        showMessage(`üì∑ Bild "${file.name}" mit Kundenname "${kundenName}" gespeichert!`, 'success');
    };
    reader.readAsDataURL(file);
}

function displayImagePreview(imageData) {
    const container = document.getElementById('imagePreviewContainer');

    const previewDiv = document.createElement('div');
    previewDiv.className = 'image-preview';
    previewDiv.setAttribute('data-image-id', imageData.id);

    previewDiv.innerHTML = `
        <button class="image-remove" onclick="removeImage('${imageData.id}')">&times;</button>
        <img src="${imageData.data}" alt="${imageData.name}">
        <div class="image-info">
            <div class="image-category">${imageData.category}</div>
            <div class="image-description" style="font-size: 0.85rem; margin-top: 5px;">${imageData.name}</div>
        </div>
    `;

    container.appendChild(previewDiv);
}

function removeImage(imageId) {
    uploadedImages = uploadedImages.filter(img => img.id != imageId);
    const previewElement = document.querySelector(`[data-image-id="${imageId}"]`);
    if (previewElement) {
        previewElement.remove();
    }
    showMessage('üì∑ Bild entfernt', 'info');
}

function setupDragAndDrop() {
    const uploadZone = document.querySelector('.upload-zone');
    if (!uploadZone) return;

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');

        const kundenName = document.getElementById('kunde').value.trim() || 'Kunde';
        const files = e.dataTransfer.files;
        for (let file of files) {
            if (file.type.startsWith('image/')) {
                processImage(file, kundenName);
            }
        }
    });
}

// ========================================
// üìß E-MAIL FUNKTIONEN (VOLLST√ÑNDIG)
// ========================================

function generateCustomerEmail(formData) {
    const kunde = formData.kunde || 'Kunde';
    const istPauschal = formData.istPauschal;

    // Bilder HTML mit neuer Farbpalette
    let imagesHTML = '';
    if (formData.images && formData.images.length > 0) {
        imagesHTML = `
            <div style="margin: 30px 0;">
                <h3 style="color: #6b7456; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 3px solid #9ba687;">üì∑ Projekt-Bilder (${formData.images.length})</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    ${formData.images.map(img => `
                        <div style="border: 2px solid #9ba687; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 12px rgba(107, 116, 86, 0.2);">
                            <img src="${img.data}" style="width: 100%; height: 200px; object-fit: cover; display: block;">
                            <div style="padding: 10px; background: linear-gradient(135deg, rgba(155, 166, 135, 0.2), rgba(245, 243, 240, 0.8)); font-size: 0.9rem; color: #4a4539; font-weight: 600;">
                                ${img.name}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    // Tage-Details mit neuer Farbpalette
    let daysHTML = '';
    if (formData.days && formData.days.length > 0) {
        daysHTML = formData.days.map((day, index) => {
            let dayContent = `
                <div style="background: linear-gradient(135deg, rgba(155, 166, 135, 0.15), rgba(245, 243, 240, 0.9)); padding: 25px; margin: 20px 0; border-radius: 12px; border-left: 5px solid #6b7456; box-shadow: 0 4px 15px rgba(107, 116, 86, 0.15);">
                    <h4 style="color: #4a4539; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; padding-bottom: 10px; border-bottom: 2px solid #9ba687;">üìÖ Tag ${day.dayNumber}</h4>
            `;

            // TAGESREGIE: Zeige Zeiten und Stunden
            if (!istPauschal && day.arbeitszeitBeginn && day.arbeitszeitEnde) {
                const baseWorkHours = calculateWorkHours(
                    day.arbeitszeitBeginn,
                    day.arbeitszeitEnde,
                    (day.pause || 0) + (day.regenpause || 0)
                );

                // Berechne Gesamtstunden mit individuellen Abweichungen
                let totalHours = 0;
                if (day.workers && day.workers.length > 0) {
                    day.workers.forEach(worker => {
                        const workerObj = typeof worker === 'string' ? { name: worker, deviationStart: 0, deviationEnd: 0 } : worker;
                        const individualHours = baseWorkHours - (workerObj.deviationStart / 60) + (workerObj.deviationEnd / 60);
                        totalHours += Math.max(0, individualHours);
                    });
                }

                dayContent += `
                    <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #c1d4b1; box-shadow: 0 2px 8px rgba(155, 166, 135, 0.1);">
                        <strong style="color: #5a5045; font-size: 1.05em;">‚è∞ Arbeitszeiten:</strong><br>
                        <div style="margin-top: 10px; line-height: 1.8; color: #4a4539;">
                            ${day.ladebeginn ? `<span style="display: inline-block; margin-right: 20px;">üì¶ Ladebeginn: <strong>${day.ladebeginn}</strong></span>` : ''}
                            ${day.abfahrt ? `<span style="display: inline-block;">üöó Abfahrt: <strong>${day.abfahrt}</strong></span><br>` : ''}
                            <span style="display: inline-block; margin-right: 20px;">üïê Arbeit: <strong>${day.arbeitszeitBeginn} - ${day.arbeitszeitEnde}</strong></span><br>
                            ${day.pause ? `<span style="display: inline-block; margin-right: 20px;">‚òï Pause: ${day.pause} Min</span>` : ''}
                            ${day.regenpause ? `<span style="display: inline-block;">üåßÔ∏è Regenpause: ${day.regenpause} Min</span><br>` : ''}
                        </div>
                        <div style="background: linear-gradient(135deg, #6b7456, #8a9876); color: white; padding: 12px 15px; border-radius: 8px; margin-top: 15px; font-size: 1.1em; font-weight: bold;">
                            üìä Gesamtstunden: ${totalHours.toFixed(2)} Std.
                        </div>
                    </div>
                `;
            }

            // IMMER: Mitarbeiter anzeigen
            if (day.workers && day.workers.length > 0) {
                const baseWorkHours = day.arbeitszeitBeginn && day.arbeitszeitEnde ?
                    calculateWorkHours(day.arbeitszeitBeginn, day.arbeitszeitEnde, (day.pause || 0) + (day.regenpause || 0)) : 0;

                dayContent += `
                    <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #c1d4b1; box-shadow: 0 2px 8px rgba(155, 166, 135, 0.1);">
                        <strong style="color: #5a5045; font-size: 1.05em;">üë• Mitarbeiter:</strong>
                        <div style="margin-top: 10px; line-height: 1.8; color: #4a4539;">
                            ${day.workers.map(w => {
                                const workerObj = typeof w === 'string' ? { name: w, deviationStart: 0, deviationEnd: 0 } : w;
                                const workerName = workerObj.name;

                                let deviationInfo = '';
                                let hoursInfo = '';

                                if (!istPauschal && baseWorkHours > 0) {
                                    const individualHours = baseWorkHours - (workerObj.deviationStart / 60) + (workerObj.deviationEnd / 60);
                                    const actualHours = Math.max(0, individualHours);
                                    hoursInfo = ` <span style="color: #6b7456; font-weight: bold;">(${actualHours.toFixed(2)} Std.)</span>`;

                                    if (workerObj.deviationStart !== 0 || workerObj.deviationEnd !== 0) {
                                        const deviationParts = [];
                                        if (workerObj.deviationStart > 0) deviationParts.push(`+${workerObj.deviationStart}Min Start`);
                                        if (workerObj.deviationStart < 0) deviationParts.push(`${workerObj.deviationStart}Min Start`);
                                        if (workerObj.deviationEnd > 0) deviationParts.push(`+${workerObj.deviationEnd}Min Ende`);
                                        if (workerObj.deviationEnd < 0) deviationParts.push(`${workerObj.deviationEnd}Min Ende`);
                                        deviationInfo = `<br><span style="font-size: 0.85em; color: #8a9876; font-style: italic;">‚Üí ${deviationParts.join(', ')}</span>`;
                                    }
                                }

                                return `<div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">‚úì ${workerName}${hoursInfo}${deviationInfo}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // IMMER: Arbeiten anzeigen
            if (day.beschreibungArbeiten) {
                dayContent += `
                    <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #c1d4b1; box-shadow: 0 2px 8px rgba(155, 166, 135, 0.1);">
                        <strong style="color: #5a5045; font-size: 1.05em;">üî® Ausgef√ºhrte Arbeiten:</strong>
                        <div style="margin-top: 10px; line-height: 1.7; color: #4a4539; background: linear-gradient(135deg, rgba(155, 166, 135, 0.08), transparent); padding: 12px; border-radius: 6px;">
                            ${day.beschreibungArbeiten}
                        </div>
                    </div>
                `;
            }

            // IMMER: Materialien anzeigen
            if (day.materials && day.materials.length > 0) {
                dayContent += `
                    <div style="background: white; padding: 18px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #c1d4b1; box-shadow: 0 2px 8px rgba(155, 166, 135, 0.1);">
                        <strong style="color: #5a5045; font-size: 1.05em;">üì¶ Verwendete Materialien:</strong>
                        <div style="margin-top: 10px; line-height: 1.8; color: #4a4539;">
                            ${day.materials.map(m => `<div style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">‚ñ™ ${m.material}: <strong>${m.amount}</strong></div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // IMMER: Maschinen anzeigen
            if (day.machines && day.machines.length > 0) {
                dayContent += `
                    <div style="background: white; padding: 18px; border-radius: 10px; border: 2px solid #c1d4b1; box-shadow: 0 2px 8px rgba(155, 166, 135, 0.1);">
                        <strong style="color: #5a5045; font-size: 1.05em;">üöú Eingesetzte Maschinen:</strong>
                        <div style="margin-top: 10px; line-height: 1.8; color: #4a4539;">
                            ${day.machines.map(m => `<div style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">‚ñ™ ${m.machine}: <strong>${m.duration}</strong></div>`).join('')}
                        </div>
                    </div>
                `;
            }

            dayContent += `</div>`;
            return dayContent;
        }).join('');
    }

    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body {
                    font-family: 'Segoe UI', Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                    background: linear-gradient(135deg, #9ba687 0%, #6b7456 50%, #4a4539 100%);
                    -webkit-font-smoothing: antialiased;
                }
            </style>
        </head>
        <body>
            <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; background: white;">
                <div style="background: linear-gradient(135deg, #9ba687 0%, #6b7456 50%, #4a4539 100%); color: white; padding: 40px 30px; text-align: center; box-shadow: 0 4px 20px rgba(107, 116, 86, 0.3);">
                    <h1 style="margin: 0; font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); letter-spacing: 0.5px;">üå± gardenKeeper¬Æ</h1>
                    <div style="width: 60px; height: 3px; background: white; margin: 15px auto; opacity: 0.8;"></div>
                    <p style="margin: 15px 0 0 0; opacity: 0.95; font-size: 20px; font-weight: 600;">Abnahmeprotokoll</p>
                    <p style="margin: 8px 0 0 0; opacity: 0.85; font-size: 16px; font-style: italic;">Professionelle Gartenpflege</p>
                </div>

                <div style="padding: 35px 30px; background: #faf8f5;">
                    <h2 style="color: #4a4539; font-size: 24px; margin-bottom: 15px;">Sehr geehrte/r ${kunde},</h2>
                    <p style="font-size: 17px; line-height: 1.7; color: #5a5045;">Ihr gardenKeeper¬Æ Projekt wurde erfolgreich abgeschlossen! Wir bedanken uns f√ºr Ihr Vertrauen und hoffen, dass Sie mit dem Ergebnis zufrieden sind.</p>

                    <div style="background: white; padding: 25px; border-radius: 12px; margin: 30px 0; border-left: 5px solid #6b7456; box-shadow: 0 4px 15px rgba(107, 116, 86, 0.15);">
                        <h3 style="color: #6b7456; margin-top: 0; font-size: 20px; padding-bottom: 12px; border-bottom: 2px solid #9ba687;">üìã Projekt-Details</h3>
                        <div style="margin-top: 15px; line-height: 2; color: #4a4539;">
                            <p style="margin: 8px 0;"><strong style="color: #5a5045;">üìÖ Startdatum:</strong> ${new Date(formData.startdatum).toLocaleDateString('de-DE')}</p>
                            <p style="margin: 8px 0;"><strong style="color: #5a5045;">üìä Anzahl Tage:</strong> ${formData.days?.length || 0}</p>
                            <p style="margin: 8px 0;"><strong style="color: #5a5045;">üí∞ Abrechnungsart:</strong> ${istPauschal ? 'üíµ Pauschal' : '‚è±Ô∏è Tagesregie'}</p>
                            <p style="margin: 8px 0;"><strong style="color: #5a5045;">‚úì Status:</strong> ${formData.checkboxes?.komplett ? '<span style="color: #28a745; font-weight: bold;">‚úÖ Vollst√§ndig abgeschlossen</span>' : '<span style="color: #dc3545;">‚ö†Ô∏è Teilweise abgeschlossen</span>'}</p>
                        </div>
                    </div>

                    ${daysHTML}

                    ${imagesHTML}

                    ${formData.bemerkungen ? `
                        <div style="background: white; padding: 25px; border-radius: 12px; margin: 25px 0; border-left: 5px solid #8a9876; box-shadow: 0 4px 15px rgba(138, 152, 118, 0.15);">
                            <h3 style="color: #6b7456; margin-top: 0; font-size: 20px; padding-bottom: 12px; border-bottom: 2px solid #9ba687;">üí¨ Bemerkungen</h3>
                            <p style="margin-top: 15px; line-height: 1.7; color: #4a4539;">${formData.bemerkungen}</p>
                        </div>
                    ` : ''}

                    <div style="background: linear-gradient(135deg, rgba(155, 166, 135, 0.3), rgba(193, 212, 177, 0.5)); padding: 30px; border-radius: 12px; margin: 30px 0; text-align: center; border: 2px solid #9ba687; box-shadow: 0 4px 15px rgba(107, 116, 86, 0.2);">
                        <h3 style="color: #4a4539; margin: 0 0 15px 0; font-size: 22px;">üåü Vielen Dank f√ºr Ihr Vertrauen!</h3>
                        <p style="margin: 0; line-height: 1.6; color: #5a5045; font-size: 16px;">Bei Fragen oder weiteren W√ºnschen stehen wir Ihnen gerne zur Verf√ºgung. Wir freuen uns auf die weitere Zusammenarbeit!</p>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #4a4539, #3a3530); color: white; padding: 30px; text-align: center; box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);">
                    <p style="margin: 0; font-size: 22px; font-weight: bold; letter-spacing: 0.5px;">üå± gardenKeeper¬Æ GmbH</p>
                    <div style="width: 60px; height: 2px; background: rgba(255,255,255,0.5); margin: 12px auto;"></div>
                    <p style="margin: 12px 0 0 0; opacity: 0.95; font-size: 17px;">Sven Kr√§mer</p>
                    <p style="margin: 10px 0 0 0; opacity: 0.85; font-size: 15px;">üìû 0681 99191820 | üìß info@gardenkeeper.de</p>
                    <p style="margin: 15px 0 0 0; font-style: italic; opacity: 0.9; font-size: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</p>
                </div>
            </div>
        </body>
        </html>
    `;
}

async function sendEmailToCustomer(formData) {
    try {
        const emailHTML = generateCustomerEmail(formData);

        const emailData = {
            action: 'sendEmail',
            to: formData.kundenEmail,
            subject: `gardenKeeper¬Æ Abnahmeprotokoll - ${formData.kunde}`,
            htmlBody: emailHTML,
            customerName: formData.kunde,
            projectDate: formData.startdatum,
            images: formData.images || []
        };

        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(emailData)
        });

        console.log('E-Mail an Kunde gesendet:', formData.kundenEmail);
        return true;

    } catch (error) {
        console.error('E-Mail Fehler:', error);
        throw error;
    }
}

function openEmailModal() {
    const kundenEmail = document.getElementById('kundenEmail').value;
    document.getElementById('emailKundeAddress').value = kundenEmail;
    document.getElementById('emailModal').classList.add('show');
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.remove('show');
}

async function sendEmailWithPDF() {
    const emailAddress = document.getElementById('emailKundeAddress').value;

    if (!emailAddress) {
        showMessage('‚ùå Bitte E-Mail-Adresse eingeben', 'error');
        return;
    }

    try {
        showMessage('üìß Sende E-Mail...', 'info');

        const formData = getFormData();
        await sendEmailToCustomer(formData);

        closeEmailModal();
        showMessage('‚úÖ E-Mail erfolgreich versendet!', 'success');

    } catch (error) {
        showMessage('‚ùå Fehler beim E-Mail-Versand: ' + error.message, 'error');
    }
}

function previewEmail() {
    const formData = getFormData();

    if (!formData.kunde.trim()) {
        showMessage('‚ùå Bitte zuerst Kundenname eingeben', 'error');
        return;
    }

    const emailHTML = generateCustomerEmail(formData);
    const previewContainer = document.getElementById('emailPreviewContent');
    previewContainer.innerHTML = emailHTML;

    document.getElementById('emailPreviewModal').classList.add('show');
}

function closeEmailPreview() {
    document.getElementById('emailPreviewModal').classList.remove('show');
}

async function completeFormWithImages() {
    const completeBtn = document.getElementById('completeBtnText');
    const originalText = completeBtn.textContent;

    try {
        completeBtn.textContent = 'Verarbeite...';

        const formData = getFormData();

        if (!formData.kunde.trim()) {
            showMessage('‚ùå Kundenname ist erforderlich!', 'error');
            completeBtn.textContent = originalText;
            return;
        }

        if (!formData.kundenEmail.trim()) {
            showMessage('‚ùå Kunden E-Mail-Adresse ist erforderlich!', 'error');
            completeBtn.textContent = originalText;
            return;
        }

        // Schritt 1: Daten zu Google Sheets speichern
        showMessage('üíæ Speichere Daten zu Google Sheets...', 'info');
        try {
            const sheetsResult = await sendToGoogleSheets(formData);
            console.log('‚úÖ Google Sheets Speicherung:', sheetsResult);
            showMessage('‚úÖ Daten in Google Sheets gespeichert!', 'success');
        } catch (sheetsError) {
            console.warn('‚ö†Ô∏è Sheets-Speicherung fehlgeschlagen (wird lokal gesichert):', sheetsError);
            showMessage('‚ö†Ô∏è Daten lokal gesichert (Cloud-Sync sp√§ter)', 'warning');
        }

        // Schritt 2: PDF zu Google Drive speichern (optional, kann auch weggelassen werden)
        showMessage('üìÅ Speichere PDF zu Google Drive...', 'info');
        try {
            const driveResult = await bulletproofSaveToGoogleDrive(formData);
            console.log('‚úÖ Google Drive Speicherung:', driveResult);
            showMessage('‚úÖ PDF in Google Drive gespeichert!', 'success');
        } catch (driveError) {
            console.warn('‚ö†Ô∏è Drive-Speicherung fehlgeschlagen:', driveError);
            // Nicht kritisch, weitermachen
        }

        // Schritt 3: E-Mail an Kunden senden
        showMessage('üìß Sende E-Mail an Kunde...', 'info');
        await sendEmailToCustomer(formData);
        showMessage('‚úÖ E-Mail erfolgreich versendet!', 'success');

        // Zur Success-Seite
        setTimeout(() => {
            document.getElementById('formularPage').classList.remove('active');
            document.getElementById('successPage').classList.add('active');
        }, 1500);

    } catch (error) {
        console.error('‚ùå Fehler:', error);
        showMessage(`‚ùå Fehler: ${error.message}`, 'error');
        completeBtn.textContent = originalText;
    }
}

// [WEITER MIT ALLEN ORIGINAL FUNKTIONEN...]
// ========================================
// üéØ DATEN SAMMELN
// ========================================

function getFormData() {
    const data = {
        kunde: document.getElementById('kunde').value.trim(),
        kundenEmail: document.getElementById('kundenEmail').value.trim(),
        istPauschal: document.getElementById('abrechnungsart')?.value === 'pauschal',
        lexofficeId: document.getElementById('lexofficeId').value.trim(),
        startdatum: document.getElementById('startdatum').value,
        projektbeschreibung: document.getElementById('projektbeschreibung').value.trim(),
        ansprechpartner: document.getElementById('ansprechpartner').value.trim(),
        days: [],
        checkboxes: {
            auftragGemaess: document.getElementById('auftragGemaess').checked,
            komplett: document.getElementById('komplett').checked,
            teilweise: document.getElementById('teilweise').checked,
            ordnungsGemaess: document.getElementById('ordnungsGemaess').checked,
            kundeZufrieden: document.getElementById('kundeZufrieden').checked,
            arbeitsplatzSauber: document.getElementById('arbeitsplatzSauber').checked
        },
        bemerkungen: document.getElementById('bemerkungen').value.trim(),
        signatures: daySignatures,
        images: uploadedImages
    };

    for (let dayNum = 1; dayNum <= maxDays; dayNum++) {
        const dayContent = document.getElementById(`day${dayNum}`);
        if (dayContent) {
            const dayData = getDayData(dayContent, dayNum);
            data.days.push(dayData);
        }
    }

    return data;
}

function getDayData(dayContent, dayNumber) {
    const workers = [];
    dayContent.querySelectorAll('.worker-row').forEach(row => {
        const select = row.querySelector('.worker-select');
        if (select && select.value) {
            const deviationStart = parseInt(row.querySelector('.worker-deviation-start')?.value) || 0;
            const deviationEnd = parseInt(row.querySelector('.worker-deviation-end')?.value) || 0;
            workers.push({
                name: select.value,
                deviationStart: deviationStart,
                deviationEnd: deviationEnd
            });
        }
    });

    const materials = [];
    dayContent.querySelectorAll('.material-row').forEach(row => {
        const material = row.querySelector('.material-select').value;
        const amount = row.querySelector('.material-amount').value;
        const isFremdeinkauf = row.querySelector('.fremdeinkauf-checkbox').checked;

        if (material) {
            const materialData = { material, amount };
            if (isFremdeinkauf) {
                materialData.fremdeinkauf = {
                    details: row.querySelector('.fremdeinkauf-details').value,
                    isFremdeinkauf: true
                };
            }
            materials.push(materialData);
        }
    });

    const machines = [];
    dayContent.querySelectorAll('.machine-row').forEach(row => {
        const machine = row.querySelector('.machine-select').value;
        const duration = row.querySelector('.machine-duration').value;
        if (machine) {
            machines.push({ machine, duration });
        }
    });

    return {
        dayNumber,
        ladebeginn: dayContent.querySelector('.ladebeginn').value,
        abfahrt: dayContent.querySelector('.abfahrt').value,
        arbeitszeitBeginn: dayContent.querySelector('.arbeitszeit-beginn').value,
        arbeitszeitEnde: dayContent.querySelector('.arbeitszeit-ende').value,
        pause: parseInt(dayContent.querySelector('.pause').value) || 0,
        regenpause: parseInt(dayContent.querySelector('.regenpause').value) || 0,
        workers,
        machines,
        materials,
        beschreibungArbeiten: dayContent.querySelector('.beschreibung-arbeiten').value.trim(),
        zusatzarbeiten: dayContent.querySelector('.zusatzarbeiten').value.trim()
    };
}

// ‚è∞ STUNDENBERECHNUNG
function updateHoursSummary() {
    const currentDayContent = document.querySelector('.day-content.active');
    if (!currentDayContent) return;

    const summaryDiv = currentDayContent.querySelector('.hours-summary');
    const hoursListDiv = summaryDiv.querySelector('.hours-list');
    const totalDiv = summaryDiv.querySelector('.total');

    const beginTime = currentDayContent.querySelector('.arbeitszeit-beginn').value;
    const endTime = currentDayContent.querySelector('.arbeitszeit-ende').value;
    const pause = parseInt(currentDayContent.querySelector('.pause').value) || 0;
    const regenpause = parseInt(currentDayContent.querySelector('.regenpause').value) || 0;

    const workerRows = currentDayContent.querySelectorAll('.worker-row');
    const workers = [];

    workerRows.forEach(row => {
        const select = row.querySelector('.worker-select');
        if (select && select.value) {
            const deviationStart = parseInt(row.querySelector('.worker-deviation-start')?.value) || 0;
            const deviationEnd = parseInt(row.querySelector('.worker-deviation-end')?.value) || 0;
            workers.push({
                name: select.value,
                deviationStart: deviationStart,
                deviationEnd: deviationEnd
            });
        }
    });

    if (!beginTime || !endTime || workers.length === 0) {
        hoursListDiv.innerHTML = '<div>Arbeitszeiten und Mitarbeiter eingeben</div>';
        totalDiv.textContent = 'Gesamtstunden: 0 Std.';
        return;
    }

    const baseWorkHours = calculateWorkHours(beginTime, endTime, pause + regenpause);
    let hoursListHTML = '';
    let totalHours = 0;

    workers.forEach(worker => {
        // Berechne individuelle Stunden: Basis - Abweichung Start + Abweichung Ende
        // Start-Abweichung positiv = sp√§ter gekommen = weniger Stunden
        // Ende-Abweichung negativ = fr√ºher gegangen = weniger Stunden
        const individualHours = baseWorkHours - (worker.deviationStart / 60) + (worker.deviationEnd / 60);
        const actualHours = Math.max(0, individualHours);

        let deviationText = '';
        if (worker.deviationStart !== 0 || worker.deviationEnd !== 0) {
            const deviationParts = [];
            if (worker.deviationStart > 0) deviationParts.push(`+${worker.deviationStart}Min Start`);
            if (worker.deviationStart < 0) deviationParts.push(`${worker.deviationStart}Min Start`);
            if (worker.deviationEnd > 0) deviationParts.push(`+${worker.deviationEnd}Min Ende`);
            if (worker.deviationEnd < 0) deviationParts.push(`${worker.deviationEnd}Min Ende`);
            deviationText = ` <span style="color: #6b7456; font-size: 0.9em;">(${deviationParts.join(', ')})</span>`;
        }

        hoursListHTML += `<div>${worker.name}: ${actualHours.toFixed(2)} Std.${deviationText}</div>`;
        totalHours += actualHours;
    });

    hoursListDiv.innerHTML = hoursListHTML;
    totalDiv.textContent = `Gesamtstunden: ${totalHours.toFixed(2)} Std.`;
}

function calculateWorkHours(beginTime, endTime, totalPauseMinutes) {
    const begin = new Date(`2000-01-01 ${beginTime}`);
    const end = new Date(`2000-01-01 ${endTime}`);

    let diffMs = end - begin;
    if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;

    const workMinutes = (diffMs / (1000 * 60)) - totalPauseMinutes;
    return Math.max(0, workMinutes / 60);
}

// TAG-MANAGEMENT
function addDay() {
    maxDays++;

    const dayTabs = document.getElementById('dayTabs');
    const newTab = document.createElement('div');
    newTab.className = 'day-tab';
    newTab.setAttribute('data-day', maxDays);
    newTab.textContent = `Tag ${maxDays}`;
    newTab.onclick = () => switchDay(maxDays);
    dayTabs.appendChild(newTab);

    const dayContainer = document.getElementById('dayContentContainer');
    const newDayContent = document.querySelector('#day1').cloneNode(true);
    newDayContent.id = `day${maxDays}`;
    newDayContent.classList.remove('active');

    updateSignatureBoxesForDay(newDayContent, maxDays);
    resetDayContent(newDayContent);

    dayContainer.appendChild(newDayContent);
    populateDropdownsInDay(newDayContent);

    daySignatures[maxDays] = { kunde: '', teamleiter: '' };

    switchDay(maxDays);
    showMessage(`‚úÖ Tag ${maxDays} hinzugef√ºgt`, 'success');
}

function switchDay(dayNumber) {
    currentDay = dayNumber;

    document.querySelectorAll('.day-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-day="${dayNumber}"]`).classList.add('active');

    document.querySelectorAll('.day-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`day${dayNumber}`).classList.add('active');

    updateHoursSummary();
}

function updateSignatureBoxesForDay(dayContent, dayNumber) {
    const signatureBoxes = dayContent.querySelectorAll('.signature-box');
    const signatureHeaders = dayContent.querySelectorAll('.signature-section h4');

    signatureBoxes.forEach(box => {
        const type = box.getAttribute('data-type');
        box.setAttribute('data-day', dayNumber);
        box.onclick = () => openSignature(type, dayNumber);
    });

    signatureHeaders.forEach(header => {
        if (header.textContent.includes('Kunde')) {
            header.textContent = `Unterschrift Kunde (Tag ${dayNumber})`;
        } else if (header.textContent.includes('Teamleiter')) {
            header.textContent = `Unterschrift Teamleiter (Tag ${dayNumber})`;
        }
    });
}

function resetDayContent(dayContent) {
    dayContent.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.type === 'checkbox') {
            field.checked = false;
        } else if (field.classList.contains('arbeitszeit-beginn')) {
            field.value = '06:45';
        } else {
            field.value = '';
        }
    });
}

// MITARBEITER-MANAGEMENT
function addWorker() {
    const currentDayContent = document.querySelector('.day-content.active');
    const container = currentDayContent.querySelector('.workers-container');

    const workerHTML = `
        <div class="worker-row">
            <div class="field">
                <label>Mitarbeiter</label>
                <select class="worker-select" onchange="updateHoursSummary()">
                    <option value="">Mitarbeiter ausw√§hlen</option>
                </select>
            </div>
            <div class="field">
                <label>Abw. Start (Min)</label>
                <input type="number" class="worker-deviation-start" placeholder="¬±Min" onchange="updateHoursSummary()" title="Positiv = sp√§ter angefangen, Negativ = fr√ºher angefangen" style="width: 100px;">
            </div>
            <div class="field">
                <label>Abw. Ende (Min)</label>
                <input type="number" class="worker-deviation-end" placeholder="¬±Min" onchange="updateHoursSummary()" title="Positiv = sp√§ter gegangen, Negativ = fr√ºher gegangen" style="width: 100px;">
            </div>
            <div style="align-self: start; margin-top: 25px;">
                <button onclick="removeWorker(this)" class="remove-btn">√ó</button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', workerHTML);

    const newSelect = container.lastElementChild.querySelector('.worker-select');
    WORKERS.forEach(worker => {
        newSelect.innerHTML += `<option value="${worker}">${worker}</option>`;
    });

    showMessage('üë∑‚Äç‚ôÇÔ∏è Mitarbeiter hinzugef√ºgt', 'info');
}

function removeWorker(button) {
    const currentDayContent = document.querySelector('.day-content.active');
    const workerRows = currentDayContent.querySelectorAll('.worker-row');

    if (workerRows.length > 1) {
        button.closest('.worker-row').remove();
        updateHoursSummary();
        showMessage('üë∑‚Äç‚ôÇÔ∏è Mitarbeiter entfernt', 'info');
    } else {
        showMessage('‚ö†Ô∏è Mindestens ein Mitarbeiter muss vorhanden sein', 'warning');
    }
}

function openWorkerModal() {
    document.getElementById('workerModal').classList.add('show');
}

function closeWorkerModal() {
    document.getElementById('workerModal').classList.remove('show');
    document.getElementById('newWorkerName').value = '';
}

function addCustomWorker() {
    const name = document.getElementById('newWorkerName').value.trim();

    if (name.length < 3) {
        showMessage('‚ùå Name muss mindestens 3 Zeichen haben', 'error');
        return;
    }

    if (WORKERS.includes(name)) {
        showMessage('‚ùå Mitarbeiter existiert bereits', 'error');
        return;
    }

    WORKERS.push(name);
    populateDropdowns();

    closeWorkerModal();
    showMessage(`‚úÖ Mitarbeiter "${name}" hinzugef√ºgt`, 'success');
}

// MASCHINEN-MANAGEMENT
function addMachine() {
    const currentDayContent = document.querySelector('.day-content.active');
    const container = currentDayContent.querySelector('.machines-container');

    const machineHTML = `
        <div class="machine-row">
            <div class="field">
                <label>Maschine/Ger√§t</label>
                <select class="machine-select">
                    <option value="">Maschine ausw√§hlen</option>
                </select>
            </div>
            <div class="field">
                <label>Einsatzdauer</label>
                <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
            </div>
            <div style="align-self: start; margin-top: 25px;">
                <button onclick="removeMachine(this)" class="remove-btn">√ó</button>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', machineHTML);

    const newSelect = container.lastElementChild.querySelector('.machine-select');
    MACHINES.forEach(machine => {
        newSelect.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
    });

    showMessage('üöú Maschine hinzugef√ºgt', 'info');
}

function removeMachine(button) {
    button.closest('.machine-row').remove();
    showMessage('üöú Maschine entfernt', 'info');
}

function openMachineModal() {
    document.getElementById('machineModal').classList.add('show');
}

function closeMachineModal() {
    document.getElementById('machineModal').classList.remove('show');
    document.getElementById('newMachineName').value = '';
    document.getElementById('newMachineUnit').value = '';
}

function addCustomMachine() {
    const name = document.getElementById('newMachineName').value.trim();
    const unit = document.getElementById('newMachineUnit').value.trim();

    if (!name || !unit) {
        showMessage('‚ùå Bitte alle Felder ausf√ºllen', 'error');
        return;
    }

    if (MACHINES.find(m => m.name === name)) {
        showMessage('‚ùå Maschine existiert bereits', 'error');
        return;
    }

    MACHINES.push({ name, unit });
    populateDropdowns();

    closeMachineModal();
    showMessage(`‚úÖ Maschine "${name}" hinzugef√ºgt`, 'success');
}

// MATERIAL-MANAGEMENT
function addMaterial() {
    const currentDayContent = document.querySelector('.day-content.active');
    const container = currentDayContent.querySelector('.materials-container');

    const materialHTML = `
        <div class="material-row">
            <div class="field">
                <label>Material</label>
                <select class="material-select">
                    <option value="">Material ausw√§hlen</option>
                </select>
            </div>
            <div class="field">
                <label>Menge</label>
                <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
            </div>
            <div class="field">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" class="fremdeinkauf-checkbox" onchange="toggleFremdeinkauf(this)">
                    Fremdeinkauf
                </label>
            </div>
            <div style="align-self: start; margin-top: 25px;">
                <button onclick="removeMaterial(this)" class="remove-btn">√ó</button>
            </div>
            <div class="fremdeinkauf-section hidden">
                <h4>üí∞ Fremdeinkauf Details</h4>
                <div class="field">
                    <label>Beschreibung/Lieferant:</label>
                    <input type="text" class="fremdeinkauf-details" placeholder="z.B. Baumarkt XY, Lieferant Z">
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', materialHTML);

    const newSelect = container.lastElementChild.querySelector('.material-select');
    MATERIALS.forEach(material => {
        newSelect.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
    });

    showMessage('üß± Material hinzugef√ºgt', 'info');
}

function removeMaterial(button) {
    button.closest('.material-row').remove();
    showMessage('üß± Material entfernt', 'info');
}

function toggleFremdeinkauf(checkbox) {
    const row = checkbox.closest('.material-row');
    const fremdeinkaufSection = row.querySelector('.fremdeinkauf-section');

    if (checkbox.checked) {
        fremdeinkaufSection.classList.remove('hidden');
        showMessage('üí∞ Fremdeinkauf aktiviert', 'info');
    } else {
        fremdeinkaufSection.classList.add('hidden');
    }
}

function openMaterialModal() {
    document.getElementById('materialModal').classList.add('show');
}

function closeMaterialModal() {
    document.getElementById('materialModal').classList.remove('show');
    document.getElementById('newMaterialName').value = '';
    document.getElementById('newMaterialUnit').value = '';
}

function addCustomMaterial() {
    const name = document.getElementById('newMaterialName').value.trim();
    const unit = document.getElementById('newMaterialUnit').value.trim();

    if (!name || !unit) {
        showMessage('‚ùå Bitte alle Felder ausf√ºllen', 'error');
        return;
    }

    if (MATERIALS.find(m => m.name === name)) {
        showMessage('‚ùå Material existiert bereits', 'error');
        return;
    }

    MATERIALS.push({ name, unit });
    populateDropdowns();

    closeMaterialModal();
    showMessage(`‚úÖ Material "${name}" hinzugef√ºgt`, 'success');
}

// UNTERSCHRIFTEN-SYSTEM
function openSignature(type, day) {
    currentSignatureType = type;
    currentSignatureDay = day;

    const modal = document.getElementById('signatureModal');
    const title = document.getElementById('signatureTitle');
    const canvas = document.getElementById('signatureCanvas');

    title.textContent = `Unterschrift ${type === 'kunde' ? 'Kunde' : 'Teamleiter'} (Tag ${day})`;

    modal.classList.add('show');
    setupSignatureCanvas(canvas);

    if (daySignatures[day] && daySignatures[day][type]) {
        const img = new Image();
        img.onload = function() {
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
        };
        img.src = daySignatures[day][type];
    }
}

function setupSignatureCanvas(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';

    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing, { passive: false });

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
}

function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;

    const canvas = e.target;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    const x = clientX - rect.left;
    const y = clientY - rect.top;

    const ctx = canvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();

    const canvas = e.target;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    const x = clientX - rect.left;
    const y = clientY - rect.top;

    const ctx = canvas.getContext('2d');
    ctx.lineTo(x, y);
    ctx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function saveSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const signatureData = canvas.toDataURL();

    if (!daySignatures[currentSignatureDay]) {
        daySignatures[currentSignatureDay] = {};
    }

    daySignatures[currentSignatureDay][currentSignatureType] = signatureData;

    const signatureBox = document.querySelector(`[data-type="${currentSignatureType}"][data-day="${currentSignatureDay}"]`);
    signatureBox.classList.add('has-signature');
    signatureBox.innerHTML = `
        <img src="${signatureData}" style="max-width: 200px; max-height: 80px; border-radius: 4px;">
        <div style="margin-top: 8px; font-size: 0.9rem;">‚úÖ Unterschrieben</div>
    `;

    closeSignature();
    showMessage(`‚úÖ Unterschrift ${currentSignatureType === 'kunde' ? 'Kunde' : 'Teamleiter'} f√ºr Tag ${currentSignatureDay} gespeichert`, 'success');
}

function closeSignature() {
    const modal = document.getElementById('signatureModal');
    modal.classList.remove('show');
    clearSignature();
}

// PDF-GENERIERUNG
function generatePDF() {
    try {
        const formData = getFormData();

        if (!formData.kunde.trim()) {
            showMessage('‚ùå Kundenname ist erforderlich!', 'error');
            return;
        }

        const pdfHTML = generateCustomerEmail(formData);
        const blob = new Blob([pdfHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);

        window.open(url, '_blank');
        showMessage('üìÑ PDF erfolgreich erstellt!', 'success');

    } catch (error) {
        showMessage('‚ùå Fehler bei PDF-Generierung: ' + error.message, 'error');
    }
}

function downloadHTML() {
    try {
        const formData = getFormData();
        const htmlContent = generateCustomerEmail(formData);

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `gardenKeeper_Abnahme_${formData.kunde}_${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
        showMessage('üíæ HTML-Datei erfolgreich heruntergeladen!', 'success');

    } catch (error) {
        showMessage('‚ùå Fehler beim HTML-Download: ' + error.message, 'error');
    }
}

// HILFSFUNKTIONEN
function showMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    if (!statusDiv) return;

    const className = `status-message status-${type}`;
    statusDiv.innerHTML = `<div class="${className}">${message.replace(/\n/g, '<br>')}</div>`;

    setTimeout(() => {
        statusDiv.innerHTML = '';
    }, type === 'error' ? 8000 : 4000);
}

function populateDropdowns() {
    document.querySelectorAll('.day-content').forEach(dayContent => {
        populateDropdownsInDay(dayContent);
    });
}

function populateDropdownsInDay(dayContent) {
    dayContent.querySelectorAll('.worker-select').forEach(select => {
        select.innerHTML = '<option value="">Mitarbeiter ausw√§hlen</option>';
        WORKERS.forEach(worker => {
            select.innerHTML += `<option value="${worker}">${worker}</option>`;
        });
    });

    dayContent.querySelectorAll('.material-select').forEach(select => {
        select.innerHTML = '<option value="">Material ausw√§hlen</option>';
        MATERIALS.forEach(material => {
            select.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
        });
    });

    dayContent.querySelectorAll('.machine-select').forEach(select => {
        select.innerHTML = '<option value="">Maschine ausw√§hlen</option>';
        MACHINES.forEach(machine => {
            select.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
        });
    });
}

function saveDraft() {
    try {
        const formData = getFormData();
        localStorage.setItem('gardenKeeper_draft', JSON.stringify(formData));
        showMessage('üíæ Entwurf erfolgreich gespeichert!', 'success');
    } catch (error) {
        showMessage('‚ùå Fehler beim Speichern: ' + error.message, 'error');
    }
}

function openForm() {
    document.getElementById('launcherPage').style.display = 'none';
    document.getElementById('formularPage').classList.add('active');

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startdatum').value = today;

    populateDropdowns();
    updateHoursSummary();
    setupDragAndDrop();
}

function goBackToLauncher() {
    document.getElementById('formularPage').classList.remove('active');
    document.getElementById('successPage').classList.remove('active');
    document.getElementById('launcherPage').style.display = 'flex';
}

// === SWIPE BUTTON BAR FUNKTIONALIT√ÑT ===
function initButtonBarSwipe() {
    const buttonBar = document.getElementById('buttonBar');
    const handle = document.getElementById('buttonBarHandle');

    if (!buttonBar || !handle) return;

    let startY = 0;
    let currentY = 0;
    let isDragging = false;
    let isHidden = false;

    // Touch Start
    handle.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
        isDragging = true;
        buttonBar.style.transition = 'none';
    }, { passive: true });

    // Touch Move
    handle.addEventListener('touchmove', function(e) {
        if (!isDragging) return;

        currentY = e.touches[0].clientY;
        const deltaY = currentY - startY;

        if ((!isHidden && deltaY > 0) || (isHidden && deltaY < 0)) {
            const translateY = isHidden ? Math.min(0, deltaY) : Math.max(0, deltaY);
            buttonBar.style.transform = `translateY(${translateY}px)`;
        }
    }, { passive: true });

    // Touch End
    handle.addEventListener('touchend', function(e) {
        if (!isDragging) return;

        isDragging = false;
        buttonBar.style.transition = 'transform 0.3s ease-out';

        const deltaY = currentY - startY;
        const threshold = 50;

        if (!isHidden && deltaY > threshold) {
            buttonBar.classList.add('hidden');
            isHidden = true;
        } else if (isHidden && deltaY < -threshold) {
            buttonBar.classList.remove('hidden');
            isHidden = false;
        } else {
            if (isHidden) {
                buttonBar.style.transform = 'translateY(calc(100% - 40px))';
            } else {
                buttonBar.style.transform = 'translateY(0)';
            }
        }

        startY = 0;
        currentY = 0;
    }, { passive: true });

    // Click auf Handle zum Toggle
    handle.addEventListener('click', function() {
        if (isHidden) {
            buttonBar.classList.remove('hidden');
            isHidden = false;
        } else {
            buttonBar.classList.add('hidden');
            isHidden = true;
        }
    });
}

// INITIALISIERUNG
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé® gardenKeeper¬Æ System wird initialisiert...');

    try {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startdatum').value = today;

        if (!daySignatures[1]) {
            daySignatures[1] = { kunde: '', teamleiter: '' };
        }

        populateDropdowns();
        updateHoursSummary();

        // Button Bar nur bei Mobile zeigen/aktivieren
        if (window.innerWidth <= 768) {
            initButtonBarSwipe();
        }

        setTimeout(() => {
            showMessage(`
                üéâ <strong>gardenKeeper¬Æ Abnahmeformular bereit!</strong><br><br>
                ‚úÖ Alle 4 Zeitfelder vorhanden<br>
                ‚úÖ Swipe-Buttons f√ºr Mobile<br>
                ‚úÖ Bilder mit Kundenname<br>
                ‚úÖ E-Mail beim Abschlie√üen<br>
                ‚úÖ Tagesregie/Pauschal richtig<br><br>
                üí° <strong>Klicken Sie auf "Abnahmeformular √∂ffnen"</strong>
            `, 'success');
        }, 1500);

        console.log('‚úÖ System erfolgreich initialisiert');

    } catch (error) {
        console.error('‚ùå Initialisierungsfehler:', error);
        showMessage('‚ùå Fehler bei der Initialisierung. Seite neu laden.', 'error');
    }
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});

console.log('üå± gardenKeeper¬Æ System mit Swipe-Buttons geladen!');
</script>
</body>
</html>
