<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçÅ gardenKeeper¬Æ - üß© Digitales üîë Abnahmeformular</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    /* === FARBSCHEMA NACH IHREN VORGABEN === */
    :root {
        /* Sanfte Gr√ºnt√∂ne */
        --sage-green: #8a9876;        /* Ged√§mpftes Salbeigr√ºn (Hauptfarbe) */
        --light-moss: #9ba687;        /* Helles Moosgr√ºn */
        --pale-lime: #9ba687;         /* Zartes Lindgr√ºn */

        /* Sanfte Braunt√∂ne */
        --warm-chestnut: #5a5045;     /* Warmes Kastanienbraun */
        --soft-clay: #6b7456;         /* Sanftes Lehmbraun */
        --light-sand: #c4b5a0;        /* Helles Sandbraun */
        --olive-brown: #9ba687;       /* Olive-Braun (f√ºr Gradients) */
        --mid-brown: #6b7456;         /* Mittleres Braun */
        --dark-brown: #4a4539;        /* Dunkles Braun */

        /* T√ºrkis-T√∂ne */
        --teal-button: #00b4b4;       /* T√ºrkis (Primary Button) */
        --teal-light: #00d4d4;        /* Helles T√ºrkis (Hover) */
        --teal-dark: #008b8b;         /* Dunkles T√ºrkis */
        --success-green: #28a745;     /* Success Gr√ºn f√ºr Gradients */

        /* Neutrale T√∂ne */
        --cream-white: #f5f3f0;       /* Cremewei√ü (Hintergrund) */
        --dark-forest: #2d3e2d;       /* Dunkles Waldgr√ºn (Text) */

        /* UI Farben */
        --border-light: #e8e5e2;
        --border-gray: #d1d5db;
        --shadow-soft: rgba(141, 115, 85, 0.1);
        --hover-tint: rgba(143, 166, 143, 0.1);
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--cream-white);
        color: var(--dark-forest);
        line-height: 1.6;
        min-height: 100vh;
    }

    /* === LAUNCHER SEITE === */
    .launcher {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
    }
    
    .launcher-container {
        max-width: 600px;
        text-align: center;
        background: rgba(255,255,255,0.95);
        padding: 60px 50px;
        border-radius: 20px;
        box-shadow: 0 20px 60px var(--shadow-soft);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255,255,255,0.8);
    }
    
    .logo {
        font-size: 4.5rem;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--sage-green), var(--warm-chestnut));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .launcher h1 {
        font-size: 2.8rem;
        margin-bottom: 15px;
        font-weight: 700;
        color: var(--dark-forest);
    }
    
    .subtitle {
        font-size: 1.4rem;
        margin-bottom: 30px;
        color: var(--sage-green);
        font-weight: 500;
    }

    .company-slogan {
        background: linear-gradient(135deg, var(--pale-lime), var(--light-sand));
        padding: 25px;
        border-radius: 15px;
        margin: 30px 0;
        border-left: 4px solid var(--sage-green);
    }
    
    .company-slogan p {
        margin: 10px 0;
        color: var(--dark-forest);
    }
    
    .main-slogan {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .sub-slogan {
        font-style: italic;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .launcher-btn {
        background: linear-gradient(135deg, var(--sage-green), var(--warm-chestnut));
        color: white;
        padding: 20px 40px;
        border: none;
        border-radius: 50px;
        font-size: 1.3rem;
        font-weight: 600;
        cursor: pointer;
        margin: 15px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 15px;
        min-width: 280px;
        justify-content: center;
        box-shadow: 0 10px 30px var(--shadow-soft);
        text-decoration: none;
    }
    
    .launcher-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(143, 166, 143, 0.3);
        background: linear-gradient(135deg, var(--light-moss), var(--soft-clay));
    }
    
    .instructions {
        background: var(--pale-lime);
        padding: 30px;
        border-radius: 15px;
        margin-top: 40px;
        text-align: left;
        border: 1px solid var(--border-light);
    }
    
    .instructions h3 {
        margin-bottom: 20px;
        color: var(--dark-forest);
        font-size: 1.2rem;
    }
    
    .instructions ol {
        padding-left: 25px;
    }
    
    .instructions li {
        margin-bottom: 10px;
        font-size: 1rem;
        color: var(--dark-forest);
    }
    
    .support-info {
        background: var(--light-sand);
        padding: 25px;
        border-radius: 15px;
        margin-top: 30px;
        border: 1px solid var(--warm-chestnut);
    }
    
    .support-info h4 {
        color: var(--warm-chestnut);
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    /* === FORMULAR SEITE === */
    .formular {
        display: none;
        background: var(--cream-white);
        min-height: 100vh;
        padding: 20px;
    }
    
    .formular.active {
        display: block;
    }
    
    .form-container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px var(--shadow-soft);
        overflow: hidden;
        border: 2px solid var(--border-light);
    }
    
    .form-header {
        background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
        color: white;
        padding: 40px;
        text-align: center;
    }
    
    .form-header h1 {
        font-size: 2.5rem;
        margin-bottom: 15px;
        font-weight: 700;
    }
    
    .form-header p {
        opacity: 0.95;
        font-size: 1.2rem;
        margin-bottom: 10px;
    }
    
    .form-header .company-tagline {
        font-style: italic;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .form-buttons {
        display: flex;
        gap: 12px;
        margin-top: 25px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        text-decoration: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--olive-brown) 0%, var(--mid-brown) 50%, var(--dark-brown) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--mid-brown) 0%, var(--olive-brown) 50%, var(--sage-green) 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    /* T√ºrkis Buttons f√ºr wichtige Aktionen */
    .btn-teal {
        background: linear-gradient(135deg, var(--teal-button), var(--teal-light)) !important;
        color: white !important;
        box-shadow: 0 6px 25px rgba(0, 180, 180, 0.2) !important;
    }

    .btn-teal:hover {
        background: linear-gradient(135deg, var(--teal-light), var(--teal-button)) !important;
        transform: translateY(-3px) !important;
        box-shadow: 0 8px 30px rgba(0, 180, 180, 0.25) !important;
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, var(--warm-chestnut), var(--soft-clay));
        color: white;
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, var(--soft-clay), var(--light-sand));
        transform: translateY(-2px);
    }
    
    .btn-tertiary {
        background: linear-gradient(135deg, var(--soft-clay), var(--light-sand));
        color: var(--dark-forest);
    }
    
    .btn-tertiary:hover {
        background: var(--pale-lime);
        transform: translateY(-2px);
    }
    
    .btn-back {
        background: rgba(255,255,255,0.9);
        color: var(--sage-green);
        border: 2px solid rgba(255,255,255,0.8);
    }

    .btn-back:hover {
        background: rgba(255,255,255,1);
        color: var(--dark-forest);
    }

    /* Progress Bar mit Animation */
    .progress-bar {
        width: 100%;
        height: 14px;
        background: var(--border-gray);
        border-radius: 7px;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress {
        height: 100%;
        background: linear-gradient(90deg, var(--teal-button), var(--success-green), var(--teal-light));
        width: 75%;
        transition: width 0.8s ease;
        border-radius: 7px;
        position: relative;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    /* Animierter Shine-Effekt */
    .progress::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
        animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    .form-content {
        padding: 40px;
    }
    
    .section {
        margin-bottom: 40px;
        padding: 30px;
        background: var(--cream-white);
        border-radius: 15px;
        border: 2px solid var(--border-light);
    }
    
    .section h3 {
        color: var(--dark-forest);
        font-size: 1.5rem;
        margin-bottom: 25px;
        border-bottom: 3px solid var(--sage-green);
        padding-bottom: 12px;
        font-weight: 600;
    }
    
    .grid {
        display: grid;
        gap: 25px;
    }
    
    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    
    .field {
        margin-bottom: 25px;
    }
    
    .field label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--dark-forest);
        font-size: 1rem;
    }
    
    .field input,
    .field textarea,
    .field select {
        width: 100%;
        padding: 15px;
        border: 2px solid var(--border-light);
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
        color: var(--dark-forest);
    }
    
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
        outline: none;
        border-color: var(--sage-green);
        box-shadow: 0 0 0 3px var(--hover-tint);
    }

    /* === CHECKBOX GROUPS FOR GOOGLE DOC POSITIONS === */
    .checkbox-group {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border: 2px solid var(--border-light);
        margin-bottom: 20px;
    }

    .checkbox-group h5 {
        color: var(--dark-forest);
        margin-bottom: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        border-bottom: 2px solid var(--border-light);
        padding-bottom: 10px;
    }

    .form-check {
        padding-left: 0;
    }

    .form-check-input {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
        accent-color: var(--sage-green);
    }

    .form-check-label {
        cursor: pointer;
        font-size: 1rem;
        color: var(--dark-forest);
    }

    .quantity-input-group {
        margin-top: 10px;
        padding-left: 30px;
    }

    .input-group {
        display: flex;
    }

    .input-group .form-control {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid var(--border-light);
        border-radius: 8px 0 0 8px;
        font-size: 0.95rem;
    }

    .input-group-text {
        padding: 8px 12px;
        background: var(--pale-lime);
        border: 2px solid var(--border-light);
        border-left: none;
        border-radius: 0 8px 8px 0;
        font-size: 0.95rem;
        color: var(--dark-forest);
    }

    .mb-2 {
        margin-bottom: 0.5rem;
    }

    .mb-3 {
        margin-bottom: 1rem;
    }

    .mb-4 {
        margin-bottom: 1.5rem;
    }

    .mt-2 {
        margin-top: 0.5rem;
    }

    .mt-3 {
        margin-top: 1rem;
    }

    .ms-4 {
        margin-left: 1.5rem;
    }

    .me-2 {
        margin-right: 0.5rem;
    }

    .d-flex {
        display: flex;
    }

    .align-items-center {
        align-items: center;
    }

    .text-muted {
        color: #666;
        font-style: italic;
    }

    /* === TAG MANAGEMENT === */
    .day-tabs {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .day-tab {
        padding: 15px 25px;
        background: var(--pale-lime);
        border: 2px solid var(--border-light);
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        color: var(--dark-forest);
    }
    
    .day-tab.active {
        background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
        color: white;
        border-color: var(--sage-green);
    }

    .day-tab:hover {
        border-color: var(--sage-green);
        background: var(--light-moss);
        color: white;
    }
    
    .day-content {
        display: none;
    }
    
    .day-content.active {
        display: block;
    }
    
    /* === DYNAMISCHE REIHEN === */
    .worker-row,
    .material-row,
    .machine-row {
        display: grid;
        gap: 20px;
        align-items: start;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 2px solid var(--border-light);
        transition: all 0.3s ease;
    }
    
    .worker-row {
        grid-template-columns: 1fr auto;
    }
    
    .material-row {
        grid-template-columns: 2fr 1fr 1fr auto;
    }
    
    .machine-row {
        grid-template-columns: 2fr 1fr auto;
    }
    
    .worker-row:hover,
    .material-row:hover,
    .machine-row:hover {
        border-color: var(--sage-green);
        box-shadow: 0 4px 15px var(--shadow-soft);
    }
    
    .remove-btn {
        background: linear-gradient(135deg, #00b4b4, #00d4d4);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 12px rgba(0, 180, 180, 0.4);
        transition: all 0.3s ease;
    }

    .remove-btn:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 16px rgba(0, 180, 180, 0.6);
    }
    
    /* === FREMDEINKAUF SECTION === */
    .fremdeinkauf-section {
        margin-top: 15px;
        padding: 20px;
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-radius: 10px;
        border: 2px solid var(--warm-chestnut);
        grid-column: 1 / -1;
    }
    
    .fremdeinkauf-section.hidden {
        display: none;
    }
    
    .fremdeinkauf-section h4 {
        color: var(--warm-chestnut);
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
    
    /* === STUNDEN ZUSAMMENFASSUNG === */
    .hours-summary {
        background: linear-gradient(135deg, var(--pale-lime), #e8f5e8);
        padding: 25px;
        border-radius: 12px;
        margin-top: 25px;
        border: 2px solid var(--sage-green);
    }
    
    .hours-summary h4 {
        color: var(--dark-forest);
        margin-bottom: 15px;
        font-size: 1.2rem;
    }
    
    .hours-summary .total {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--dark-forest);
        margin-top: 15px;
        padding-top: 15px;
        border-top: 3px solid var(--sage-green);
    }
    
    /* === BILDER UPLOAD === */
    .image-upload-area {
        margin-bottom: 25px;
    }
    
    .upload-zone {
        border: 3px dashed var(--border-light);
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        background: var(--cream-white);
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--dark-forest);
    }
    
    .upload-zone:hover {
        border-color: var(--sage-green);
        background: var(--pale-lime);
    }

    .upload-zone.dragover {
        border-color: var(--sage-green);
        background: var(--light-moss);
        transform: scale(1.02);
    }
    
    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .image-preview {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid var(--border-light);
        background: white;
        transition: all 0.3s ease;
    }
    
    .image-preview:hover {
        border-color: var(--sage-green);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px var(--shadow-soft);
    }
    
    .image-preview img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    
    .image-info {
        padding: 12px;
        background: white;
    }
    
    .image-category {
        font-size: 0.8rem;
        color: var(--sage-green);
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    
    .image-description {
        font-size: 0.9rem;
        color: var(--dark-forest);
    }
    
    .image-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .image-remove:hover {
        background: #dc3545;
        transform: scale(1.1);
    }
    
    .image-category-select {
        margin-top: 12px;
        width: 100%;
        padding: 12px;
        border: 2px solid #00b4b4;  /* T√ºrkis Border f√ºr Sichtbarkeit! */
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        background: white;
        color: #3a3530;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .image-category-select:focus {
        outline: none;
        border-color: #00d4d4;
        box-shadow: 0 0 0 3px rgba(0, 180, 180, 0.1);
        background: #f5f3f0;
    }

    .image-category-select:hover {
        border-color: #00d4d4;
        background: #faf8f5;
    }
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }
    
    .checkbox-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        border: 2px solid var(--border-light);
        transition: all 0.3s ease;
    }
    
    .checkbox-item:hover {
        border-color: var(--sage-green);
        box-shadow: 0 4px 15px var(--shadow-soft);
    }
    
    .checkbox-item input[type="checkbox"] {
        margin-top: 3px;
        width: 20px;
        height: 20px;
        accent-color: var(--sage-green);
    }
    
    /* === UNTERSCHRIFTEN === */
    .signature-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
    }
    
    .signature-box {
        border: 3px dashed var(--border-light);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        background: var(--cream-white);
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .signature-box:hover {
        border-color: var(--sage-green);
        background: var(--pale-lime);
    }

    .signature-box.has-signature {
        border-style: solid;
        border-color: var(--sage-green);
        background: white;
    }
    
    /* === SUCCESS PAGE === */
    .success-page {
        display: none;
        min-height: 100vh;
        padding: 20px;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--sage-green) 0%, var(--light-moss) 100%);
    }
    
    .success-page.active {
        display: flex;
    }
    
    .success-container {
        max-width: 700px;
        text-align: center;
        background: rgba(255,255,255,0.95);
        padding: 60px;
        border-radius: 25px;
        box-shadow: 0 20px 60px var(--shadow-soft);
    }
    
    .success-icon {
        font-size: 6rem;
        margin-bottom: 25px;
    }
    
    .employee-message {
        background: var(--pale-lime);
        padding: 30px;
        border-radius: 15px;
        margin-top: 35px;
        border: 2px solid var(--sage-green);
    }
    
    .employee-message h3 {
        color: var(--warm-chestnut);
        margin-bottom: 20px;
        font-size: 1.3rem;
    }
    
    /* === MODALS === */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(45, 62, 45, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    
    .modal.show {
        display: flex;
    }
    
    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        color: var(--dark-forest);
        border: 3px solid var(--sage-green);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 3px solid var(--sage-green);
        padding-bottom: 20px;
    }
    
    .modal-close {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
    }
    
    /* === STATUS MESSAGES === */
    .status-message {
        padding: 20px;
        border-radius: 12px;
        margin: 25px 0;
        font-weight: 600;
        text-align: center;
        font-size: 1rem;
    }
    
    .status-success {
        background: linear-gradient(135deg, #d4edda, var(--pale-lime));
        color: var(--dark-forest);
        border: 2px solid var(--sage-green);
    }
    
    .status-error {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        border: 2px solid #dc3545;
    }
    
    .status-warning {
        background: linear-gradient(135deg, #fff3cd, var(--light-sand));
        color: var(--warm-chestnut);
        border: 2px solid var(--warm-chestnut);
    }
    
    .status-info {
        background: linear-gradient(135deg, #d1ecf1, var(--pale-lime));
        color: var(--dark-forest);
        border: 2px solid var(--sage-green);
    }
    
    /* === LOADING ANIMATION === */
    .loading {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid rgba(143, 166, 143, 0.3);
        border-radius: 50%;
        border-top-color: var(--sage-green);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
        .launcher-container {
            padding: 40px 30px;
            margin: 10px;
        }
        
        .launcher h1 {
            font-size: 2.2rem;
        }
        
        .launcher-btn {
            min-width: 250px;
            padding: 18px 35px;
            font-size: 1.1rem;
        }
        
        .form-content {
            padding: 25px;
        }
        
        .grid-2,
        .grid-3,
        .grid-4 {
            grid-template-columns: 1fr;
        }
        
        .worker-row,
        .material-row,
        .machine-row {
            grid-template-columns: 1fr;
        }
        
        .day-tabs {
            flex-direction: column;
        }
        
        .form-buttons {
            gap: 10px;
        }
        
        .btn {
            padding: 12px 20px;
            font-size: 14px;
        }
        
        .section {
            padding: 20px;
        }
    }
    
    /* === PRINT STYLES === */
    @media print {
        .launcher, .form-buttons, .btn, .modal { display: none !important; }
        .formular { display: block !important; }
        .form-container { box-shadow: none; border: 1px solid #ccc; }
        .form-header { background: var(--sage-green) !important; -webkit-print-color-adjust: exact; }
        body { font-size: 12px; }
        
        /* PDF-OPTIMIERTE BILD-STYLES */
        * { 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
        }
    }

    /* === BILD-PDF INTEGRATION === */
    .images-section {
        page-break-before: always;
    }

    .images-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    .image-item {
        border: 2px solid #e8e5e2;
        border-radius: 10px;
        overflow: hidden;
        page-break-inside: avoid;
        background: white;
    }

    .image-item img {
        width: 100%;
        height: 180px;  /* Optimiert f√ºr A4 */
        object-fit: cover;
        display: block;
        object-fit: cover;
        display: block;
    }

    .image-caption {
        padding: 12px 15px;
        background: #f5f3f0;
        border-top: 1px solid #e8e5e2;
        font-size: 0.9rem;
    }

    .image-category {
        font-weight: 600;
        color: #8a9876;
        font-size: 0.8rem;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    @media print {
        .images-grid {
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .image-item img {
            height: 150px;
        }
    }
    /*
* &#127793; gardenKeeper¬Æ - MOBILE STICKY BUTTONS FIX
* 
 * Diese CSS-Regeln einfach NACH dem bestehenden CSS einf√ºgen
* (vor dem schlie√üenden style Tag)
* 
 * &#9989; Macht die Action-Buttons auf Mobile "sticky" (bleiben unten)
* &#9989; Buttons sind immer erreichbar ohne Scrollen
*/

/* ===== STICKY ACTION BAR F√úR MOBILE ===== */

/* Wrapper f√ºr die Action-Buttons */
.form-buttons {
    display: flex;
    gap: 12px;
    margin-top: 25px;
    flex-wrap: wrap;
    justify-content: center;
}

/* Mobile: Sticky Bottom Bar */
@media (max-width: 768px) {
    
    /* Sticky Container f√ºr Buttons */
    .form-buttons.sticky-mobile {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(245, 243, 240, 0.98) 0%, rgba(245, 243, 240, 0.95) 100%);
        backdrop-filter: blur(10px);
        padding: 15px;
        margin: 0;
        box-shadow: 0 -4px 20px rgba(45, 62, 45, 0.15);
        z-index: 1000;
        flex-wrap: nowrap;
        justify-content: space-around;
        border-top: 2px solid var(--border-light);
    }
    
    /* Platz am Ende des Inhalts schaffen */
    .form-content.has-sticky-buttons {
        padding-bottom: 100px !important;
    }
    
    /* Buttons auf Mobile kleiner und gestapelt */
    .form-buttons.sticky-mobile .btn {
        flex: 1;
        min-width: auto;
        padding: 12px 16px;
        font-size: 14px;
        justify-content: center;
        white-space: nowrap;
    }
    
    /* Icons auf Mobile kleiner */
    .form-buttons.sticky-mobile .btn svg,
    .form-buttons.sticky-mobile .btn::before {
        font-size: 16px;
    }
    
    /* Bei mehr als 2 Buttons: 2 Zeilen */
    .form-buttons.sticky-mobile {
        flex-wrap: wrap;
    }
    
    .form-buttons.sticky-mobile .btn {
        flex: 0 0 calc(50% - 6px);
    }
    
    /* Hauptbutton hervorheben */
    .form-buttons.sticky-mobile .btn-primary {
        order: -1; /* Immer als erstes */
        flex: 0 0 100%;
        font-size: 15px;
        padding: 14px 20px;
    }
}

/* Tablet: Leicht angepasst */
@media (min-width: 769px) and (max-width: 1024px) {
    .form-buttons {
        gap: 15px;
    }
    
    .btn {
        padding: 13px 26px;
        font-size: 14px;
    }
}

/* ===== ALTERNATIVE: Floating Action Button ===== */
/* Falls Sie lieber einen einzelnen FAB m√∂chten */

.fab-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
    color: white;
    border: none;
    box-shadow: 0 4px 20px rgba(143, 166, 143, 0.4);
    cursor: pointer;
    display: none; /* Standardm√§√üig versteckt */
    align-items: center;
    justify-content: center;
    font-size: 24px;
    z-index: 999;
    transition: all 0.3s ease;
}

.fab-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(143, 166, 143, 0.6);
}

@media (max-width: 768px) {
    .fab-button {
        display: flex;
    }
}

/* ===== SCROLL INDICATOR ===== */
/* Zeigt an, dass man scrollen kann */

.scroll-indicator {
    display: none;
    position: fixed;
    bottom: 110px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(143, 166, 143, 0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 998;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateX(-50%) translateY(0);
    }
    40% {
        transform: translateX(-50%) translateY(-10px);
    }
    60% {
        transform: translateX(-50%) translateY(-5px);
    }
}

@media (max-width: 768px) {
    .scroll-indicator.show {
        display: block;
    }
}

/* ===== VERBESSERUNGEN F√úR TOUCH-GER√ÑTE ===== */

@media (max-width: 768px) {
    /* Gr√∂√üere Touch-Targets */
    .btn {
        min-height: 44px; /* Apple's empfohlene Mindestgr√∂√üe */
    }
    
    /* Besseres Spacing */
    .form-section {
        padding: 20px 15px;
        margin-bottom: 20px;
    }
    
    /* Vereinfachte Header auf Mobile */
    .form-header {
        padding: 25px 20px;
    }
    
    .form-header h1 {
        font-size: 1.8rem;
    }
    
    /* Modal auf Mobile fullscreen */
    .modal-content {
        max-width: 95%;
        margin: 10px;
    }
}

/* ===== üéØ AUTO-HIDE BUTTONS F√úR MOBILE ===== */
/* Buttons erscheinen beim Hoch-Wischen, verschwinden nach 3 Sekunden */

@media (max-width: 768px) {
    
    /* Auto-Hide: Buttons sind standardm√§√üig ausgeblendet */
    .form-buttons.sticky-mobile {
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Buttons sind sichtbar wenn .visible Klasse gesetzt */
    .form-buttons.sticky-mobile.visible {
        transform: translateY(0);
    }
    
    /* Kompaktere Button-Bar */
    .form-buttons.sticky-mobile {
        padding: 10px;
        gap: 8px;
    }
    
    /* Buttons kleiner und kompakter */
    .form-buttons.sticky-mobile .btn {
        padding: 10px 14px;
        font-size: 13px;
        min-height: 40px;
    }
    
    /* Icon-Gr√∂√üe reduziert */
    .form-buttons.sticky-mobile .btn span:first-child {
        font-size: 16px;
    }
    
    /* Platz am Ende reduziert da Buttons ausgeblendet sind */
    .form-content.has-sticky-buttons {
        padding-bottom: 40px !important;
    }
}

/* ===== SWIPE-UP INDICATOR ===== */
/* Zeigt dem User dass er nach oben wischen kann */

.swipe-indicator {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 999;
    display: none;
    animation: pulse-subtle 2s infinite;
    box-shadow: 0 4px 15px rgba(143, 166, 143, 0.4);
}

@media (max-width: 768px) {
    .swipe-indicator.show {
        display: block;
    }
}

@keyframes pulse-subtle {
    0%, 100% {
        transform: translateX(-50%) translateY(0);
        opacity: 0.9;
    }
    50% {
        transform: translateX(-50%) translateY(-5px);
        opacity: 1;
    }
}


    /* NEUE PROJEKTZUSAMMENFASSUNG */
    .summary-box {
        background: linear-gradient(135deg, rgba(155, 166, 135, 0.2) 0%, rgba(138, 152, 118, 0.2) 100%);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border: 2px solid #8a9876;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .summary-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 15px;
    }
    
    .summary-main {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #6b7456;
    }
    
    .summary-main h3 {
        color: #6b7456;
        font-size: 14pt;
        margin-bottom: 10px;
        border-bottom: 1px solid #8a9876;
        padding-bottom: 6px;
    }
    
    .summary-list {
        list-style: none;
        padding: 0;
    }
    
    .summary-list li {
        padding: 6px 0;
        font-size: 10pt;
        color: #555;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .summary-list li:last-child {
        border-bottom: none;
    }
    
    .summary-list li strong {
        color: #6b7456;
        display: inline-block;
        min-width: 130px;
    }
    
    .summary-highlight {
        background: white;
        padding: 15px;
        border-radius: 6px;
    }
    
    .summary-highlight h3 {
        color: #6b7456;
        font-size: 11pt;
        margin-bottom: 10px;
        border-bottom: 1px solid #8a9876;
        padding-bottom: 6px;
    }
    
    .summary-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .stat-item {
        background: #faf8f5;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e5e5e5;
    }
    
    .stat-item strong {
        display: block;
        font-size: 8pt;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    
    .stat-item .value {
        font-size: 18pt;
        color: #6b7456;
        font-weight: 700;
    }
    
    .stat-item .unit {
        font-size: 9pt;
        color: #999;
    }

    /* ARBEITEN-BOXEN */
    .arbeiten-box {
        background: linear-gradient(135deg, rgba(155, 166, 135, 0.15) 0%, rgba(138, 152, 118, 0.15) 100%);
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 3px solid #8a9876;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .arbeiten-box strong {
        display: block;
        color: #6b7456;
        margin-bottom: 6px;
        font-size: 10pt;
    }
/* üì± MOBILE OPTIMIERUNG - HANDY-FREUNDLICH */
/* Diese CSS-Regeln in Ihre HTML einf√ºgen! */

/* ========================================
   üéØ UNTERSCHRIFTEN - KOMPAKTER
   ======================================== */

/* Unterschriften-Container kleiner machen */
#signatureCanvas {
    width: 100% !important;
    height: 150px !important;  /* Vorher: 250px - JETZT KLEINER */
    max-height: 150px !important;
    border: 2px solid var(--border-light) !important;
    border-radius: 8px !important;
    touch-action: none;
}

.signature-box {
    margin: 15px 0 !important;  /* Weniger Abstand */
    padding: 15px !important;   /* Weniger Padding */
}

.signature-box h4 {
    font-size: 1rem !important;  /* Kleinere √úberschrift */
    margin-bottom: 10px !important;
}

/* ========================================
   ‚úÖ CHECKBOXEN - KOMPAKTER
   ======================================== */

.checkbox-group {
    padding: 15px !important;  /* Vorher: 25px */
    margin: 10px 0 !important;
}

.checkbox-item {
    padding: 12px 15px !important;  /* Vorher: 20px */
    margin: 8px 0 !important;       /* Weniger Abstand */
    font-size: 0.95rem !important;  /* Etwas kleiner */
    line-height: 1.4 !important;
}

.checkbox-item input[type="checkbox"] {
    width: 22px !important;   /* Vorher: 28px */
    height: 22px !important;
    min-width: 22px !important;
    margin-right: 12px !important;
}

.checkbox-item label {
    font-size: 0.95rem !important;
    line-height: 1.4 !important;
}

/* ========================================
   üìù TEXTFELDER & INPUTS - KOMPAKTER
   ======================================== */

input[type="text"],
input[type="email"],
input[type="date"],
input[type="time"],
input[type="number"],
textarea,
select {
    padding: 10px 12px !important;  /* Vorher: 15px */
    font-size: 0.95rem !important;
    height: auto !important;
    min-height: 42px !important;    /* Vorher: 50px */
}

textarea {
    min-height: 80px !important;    /* Vorher: 120px */
}

/* ========================================
   üîº BUTTONS - KOMPAKTER
   ======================================== */

.button,
button {
    padding: 12px 20px !important;  /* Vorher: 15px 30px */
    font-size: 0.95rem !important;
    min-height: 44px !important;    /* Touch-freundlich */
}

.icon-button {
    width: 40px !important;   /* Vorher: 50px */
    height: 40px !important;
    min-width: 40px !important;
}

/* ========================================
   üì¶ SECTIONS & BOXES - KOMPAKTER
   ======================================== */

.section {
    padding: 20px 15px !important;  /* Vorher: 30px */
    margin-bottom: 20px !important;
}

.box,
.info-box {
    padding: 15px !important;       /* Vorher: 25px */
    margin: 15px 0 !important;
}

.form-group {
    margin-bottom: 15px !important; /* Vorher: 25px */
}

/* ========================================
   üìè √úBERSCHRIFTEN - KOMPAKTER
   ======================================== */

h2 {
    font-size: 1.4rem !important;   /* Vorher: 1.8rem */
    margin-bottom: 15px !important;
}

h3 {
    font-size: 1.2rem !important;   /* Vorher: 1.5rem */
    margin: 15px 0 10px 0 !important;
}

h4 {
    font-size: 1.05rem !important;  /* Vorher: 1.2rem */
    margin: 12px 0 8px 0 !important;
}

/* ========================================
   üì∏ BILDER-GRID - KOMPAKTER
   ======================================== */

.images-grid {
    grid-template-columns: 1fr !important;  /* 1 Spalte statt 2 */
    gap: 15px !important;
}

.image-preview {
    max-height: 200px !important;  /* Vorher: 300px */
}

.image-item {
    padding: 12px !important;
}

/* ========================================
   üë• MITARBEITER-LISTE - KOMPAKTER
   ======================================== */

.worker-item {
    padding: 12px !important;      /* Vorher: 20px */
    margin: 8px 0 !important;
}

.time-inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 8px !important;
}

.time-inputs input {
    flex: 1;
    min-width: 100px;
}

/* ========================================
   üé® MATERIALS & MACHINES - KOMPAKTER
   ======================================== */

.material-row,
.machine-row {
    padding: 10px !important;      /* Vorher: 15px */
    margin: 8px 0 !important;
}

/* ========================================
   üì± SPEZIELLE MOBILE ANPASSUNGEN
   ======================================== */

@media (max-width: 768px) {
    
    /* Noch kleinere Schrift auf kleinen Displays */
    body {
        font-size: 14px !important;
    }
    
    /* Container volle Breite nutzen */
    .container {
        padding: 10px !important;
    }
    
    /* Header kompakter */
    .page-header {
        padding: 20px 15px !important;
    }
    
    .page-header h1 {
        font-size: 1.5rem !important;
    }
    
    /* Tages-Cards kompakter */
    .day-card {
        padding: 15px !important;
        margin: 15px 0 !important;
    }
    
    /* Button-Groups untereinander */
    .button-group {
        flex-direction: column !important;
        gap: 10px !important;
    }
    
    .button-group button {
        width: 100% !important;
    }
    
    /* Signature noch kleiner auf sehr kleinen Displays */
    #signatureCanvas {
        height: 120px !important;
    }
    
    /* Weniger Padding √ºberall */
    * {
        padding-top: calc(padding-top * 0.8);
        padding-bottom: calc(padding-bottom * 0.8);
    }
}

/* ========================================
   üîº "NACH OBEN" BUTTON VERSTECKEN
   ======================================== */

/* Der st√∂rende "Nach oben wischen" Button */
.scroll-to-top,
.sticky-button {
    display: none !important;  /* Komplett ausblenden */
}

/* Falls er anders hei√üt: */
[class*="scroll"][class*="top"],
[class*="back"][class*="top"] {
    display: none !important;
}

/* ========================================
   ‚úÖ ERFOLGS-SEITE - KOMPAKTER
   ======================================== */

#successPage {
    padding: 20px 15px !important;
}

.success-box {
    padding: 20px !important;
}

.success-box h2 {
    font-size: 1.6rem !important;
}

/* ========================================
   üìã ZUSAMMENFASSUNG - KOMPAKTER
   ======================================== */

.summary-section {
    padding: 15px !important;
}

.summary-item {
    padding: 10px !important;
    margin: 8px 0 !important;
}

/* ========================================
   üéØ WICHTIGE ELEMENTE HERVORHEBEN
   ======================================== */

/* Wichtige Buttons gr√∂√üer lassen */
.complete-button,
.submit-button,
.primary-button {
    min-height: 50px !important;  /* Diese BLEIBEN gro√ü */
    font-size: 1.05rem !important;
}

/* Zur√ºck-Button klein halten */
.back-button,
.secondary-button {
    min-height: 40px !important;
    padding: 10px 15px !important;
}

/* ========================================
   üí° WEITERE OPTIMIERUNGEN
   ======================================== */

/* Zeilen-H√∂he global reduzieren */
* {
    line-height: 1.4 !important;
}

/* Weniger Schatten (Performance) */
.box,
.card,
.section {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
}

/* Animationen auf Mobile reduzieren */
@media (max-width: 768px) {
    * {
        transition: none !important;
        animation: none !important;
    }
}

/* ========================================
   üé® ALLGEMEINE MOBILE VERBESSERUNGEN
   ======================================== */

/* Touch-Targets mindestens 44x44px */
button,
input,
select,
textarea,
a,
.clickable {
    min-height: 44px !important;
    min-width: 44px !important;
}

/* Scrollbar verstecken auf Mobile */
::-webkit-scrollbar {
    width: 0px;
    display: none;
}

/* Smooth Scrolling */
html {
    scroll-behavior: smooth;
}

/* Zoom-Verhalten verbessern */
input,
select,
textarea {
    font-size: 16px !important;  /* Verhindert Auto-Zoom auf iOS */
}
</style>
</head>
<body>
    <!-- === LOADING INDICATOR === -->
    <div id="loading-indicator" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #00b4b4, #28a745); color: white; padding: 15px 30px; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; font-weight: bold; animation: pulse 1.5s infinite;">
        ‚è≥ Lade Event-Daten...
    </div>

    <!-- === LAUNCHER PAGE === -->
    <div class="launcher" id="launcherPage">
        <div class="launcher-container">
            <div class="logo">üçÅ</div>
            <h1>gardenKeeper¬Æ</h1>
            <div class="subtitle">Professionelle Gartenpflege</div>
        <div class="company-slogan">
            <p class="main-slogan">Ob Garten oder Grundst√ºck - wir sorgen daf√ºr, dass Ihr Zuhause stilvoll, gepflegt und verl√§sslich aufbl√ºht.</p>
            <p class="sub-slogan">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</p>
        </div>
        
        <button id="openFormBtn" class="launcher-btn">
            <span>üì±</span>
            <span>Abnahmeformular √∂ffnen</span>
        </button>
        
        <div class="instructions">
            <h3>&#128203; Arbeitsschritte:</h3>
            <ol>
                <li>Formular √∂ffnen und alle Projektdaten eingeben</li>
                <li>Mehrt√§gige Projekte √ºber Tage-Tabs erfassen</li>
                <li>Pro Tag: Mitarbeiter, Arbeitszeiten und Materialien dokumentieren</li>
                <li>Pro Tag: Unterschriften von Kunde und Teamleiter einholen</li>
                <li>Automatische Pausenberechnung und Stundenerfassung</li>
                <li>Abschlie√üen ‚Üí Kein Internet Pdf Speichern und sp√§ter absenden ‚Üí Daten werden automatisch gespeichert</li>
                <li>PDF kann direkt erstellt und weitergeleitet werden</li>
            </ol>
        </div>
        
        <div class="support-info">
            <h4>&#128222; Bei Fragen oder Problemen:</h4>
            <p><strong>Wenden Sie sich an die Chefin</strong></p>
        </div>
        
        <div style="margin-top: 35px; font-size: 0.95rem; opacity: 0.8; color: var(--dark-forest);">
            ¬© copyright by gardenKeeper 2025<br>
            &#9989; Alle Funktionen verf√ºgbar<br>
            &#9989; Web App vollst√§ndig funktionsf√§hig<br>
            &#9989; Sofort einsatzbereit
        </div>
    </div>
</div>

<!-- === FORMULAR PAGE === -->
<div class="formular" id="formularPage">
    <div class="form-container">
        <!-- Header -->
        <div class="form-header">
            <h1>ABNAHME / TAGESREGIEBERICHT</h1>
            <p>gardenKeeper¬Æ GmbH - Sven Kr√§mer</p>
            <p class="company-tagline">Professionelle Gartenpflege mit Stil und ‚ô•</p>
            <div class="form-buttons">
                <button onclick="goBackToLauncher()" class="btn btn-back">
                    <span>‚Üê</span>
                    Zur√ºck
                </button>
                <button onclick="saveDraft()" class="btn btn-secondary">
                    <span>üíæ</span>
                    Speichern
                </button>
                <button onclick="generatePDF()" class="btn btn-primary btn-teal">
                    <span>üìÑ</span>
                    PDF erstellen
                </button>
                <button onclick="downloadHTML()" class="btn btn-secondary">
                    <span>üíæ</span>
                    HTML Download
                </button>
                <!-- &#9989; T√ºrkiser Button f√ºr finale Aktion -->
                <button onclick="completeFormWithImages()" class="btn btn-primary btn-teal">
                    <span>&#9989;</span>
                    <span id="completeBtnText">Abschlie√üen & E-Mail senden</span>
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage"></div>

        <div class="form-content">
            <!-- Grunddaten -->
            <div class="section">
                <h3>&#128203; Grunddaten des Projekts</h3>
                <div class="grid grid-3">
                    <div class="field">
                        <label>Anrede *</label>
                        <select id="anrede" required style="width: 100%; padding: 15px; border: 2px solid var(--border-light); border-radius: 10px; font-size: 16px;">
                            <option value="">Bitte w√§hlen...</option>
                            <option value="Liebe Frau">Liebe Frau</option>
                            <option value="Lieber Herr">Lieber Herr</option>
                            <option value="Guten Tag">Guten Tag (neutral)</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Vorname / Nachname *</label>
                        <input type="text" id="kunde" placeholder="z.B.Max Mustermann" required>
                    </div>
                    <div class="field">
                        <label>Firma </label>
                        <input type="text" id="firma" placeholder="z.B. Deine Firma oder WEG" required>
                    </div>
                    <div class="field">
                        <label>Kunde Email-Adresse</label>
                        <input type="email" id="kundenEmail" placeholder="kunde@beispiel.de">
                    </div>
                    <div class="form-group">
    <label for="abrechnungsart" style="font-size: 16px; font-weight: 600;">
        üí∞ Abrechnungsart
    </label>
    <select id="abrechnungsart" style="width: 100%; padding: 12px; border: 2px solid var(--border-light); border-radius: 10px; font-size: 15px;">
        <option value="tagesregie">&#9201; Tagesregie (mit Zeiterfassung)</option>
        <option value="pauschal">&#128181; Pauschal (ohne Zeitangaben f√ºr Kunde)</option>
    </select>
    <small style="color: var(--soft-clay); font-style: italic;">
        Bei Pauschal-Projekten werden Zeiten nur intern erfasst
    </small>
</div>
                    <div class="field">
                        <label>LexOffice-ID</label>
                        <input type="text" id="lexofficeId" placeholder="z.B. AB-20262000">
                    </div>
                    <div class="field">
                        <label>Startdatum *</label>
                        <input type="date" id="startdatum" required>
                    </div>
                </div>
             </div>

            <!-- Tage-Tabs -->
            <div class="section">
                <h3>&#128197; Erfassung pro Arbeitstag</h3>
                <div class="day-tabs" id="dayTabs">
                    <div class="day-tab active" data-day="1" onclick="switchDay(1)">Tag 1</div>
                </div>
                <button onclick="addDay()" class="btn btn-primary">
                    <span>+</span>
                    Weiteren Tag hinzuf√ºgen
                </button>
            </div>

            <!-- Day Content Container -->
            <div id="dayContentContainer">
                <!-- Tag 1 Content -->
                <div class="day-content active" id="day1">
                    
                    <!-- Arbeitszeiten -->
                    <div class="section">
                        <h3>&#9200; Arbeitszeiten und Pausen</h3>
                        <div class="grid grid-4">
                            <div class="field">
                                <label>Ladebeginn</label>
                                <input type="time" class="ladebeginn">
                            </div>
                            <div class="field">
                                <label>Abfahrt</label>
                                <input type="time" class="abfahrt">
                            </div>
                            <div class="field">
                                <label>Arbeitszeit Beginn</label>
                                <input type="time" class="arbeitszeit-beginn" onchange="updateHoursSummary()">
                            </div>
                            <div class="field">
                                <label>Arbeitszeit Ende</label>
                                <input type="time" class="arbeitszeit-ende" onchange="updateHoursSummary()">
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <div class="field">
                                <label>Pause (Minuten)</label>
                                <input type="number" class="pause" placeholder="0" min="0" onchange="updateHoursSummary()">
                            </div>
                            <div class="field">
                                <label>Regenpause (Minuten)</label>
                                <input type="number" class="regenpause" placeholder="0" min="0" onchange="updateHoursSummary()">
                            </div>
                        </div>
                    </div>

                    <!-- Mitarbeiter -->
                    <div class="section">
                        <h3>&#128101; Ausf√ºhrende Mitarbeiter</h3>
                        <div class="workers-container">
                            <div class="worker-row">
                                <div class="field">
                                    <label>Mitarbeiter</label>
                                    <select class="worker-select" onchange="updateHoursSummary()">
                                        <option value="">Mitarbeiter ausw√§hlen</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>‚è∞ Sp√§ter angefangen</label>
                                    <input type="time" class="worker-start-time" onchange="updateHoursSummary()" placeholder="Optional">
                                    <small style="color: #666; font-size: 0.85em;">Optional: Falls sp√§ter als Team-Zeit</small>
                                </div>
                                <div class="field">
                                    <label>üèÅ Fr√ºher gegangen</label>
                                    <input type="time" class="worker-end-time" onchange="updateHoursSummary()" placeholder="Optional">
                                    <small style="color: #666; font-size: 0.85em;">Optional: Falls fr√ºher als Team-Zeit</small>
                                </div>
                                <div style="align-self: start; margin-top: 25px;">
                                    <button onclick="removeWorker(this)" class="remove-btn">√ó</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                            <button onclick="addWorker()" class="btn btn-primary">
                                <span>+</span>
                                Mitarbeiter hinzuf√ºgen
                            </button>
                            <button onclick="openWorkerModal()" class="btn btn-secondary">
                                <span>üë§</span>
                                Neuen Mitarbeiter anlegen
                            </button>
                        </div>
                        
                        <!-- Stunden-Zusammenfassung -->
                        <div class="hours-summary">
                            <h4>üìä Stunden-Zusammenfassung (inkl. Pausenabzug)</h4>
                            <div class="hours-list"></div>
                            <div class="total">Gesamtstunden: 0 Std.</div>
                        </div>
                    </div>

                    <!-- Maschinen -->
                    <div class="section">
                        <h3>&#128668; Eingesetzte Maschinen und Ger√§te</h3>
                        <div class="machines-container">
                            <div class="machine-row">
                                <div class="field">
                                    <label>Maschine/Ger√§t</label>
                                    <select class="machine-select">
                                        <option value="">Maschine ausw√§hlen</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>Einsatzdauer</label>
                                    <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                                </div>
                                <div style="align-self: start; margin-top: 25px;">
                                    <button onclick="removeMachine(this)" class="remove-btn">√ó</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                            <button onclick="addMachine()" class="btn btn-primary">
                                <span>+</span>
                                Maschine hinzuf√ºgen
                            </button>
                            <button onclick="openMachineModal()" class="btn btn-secondary">
                                <span>&#128668;</span>
                                Neue Maschine anlegen
                            </button>
                        </div>
                    </div>

                    <!-- Arbeiten -->
                    <div class="section">
                        <h3>&#128296; Beschreibung ausgef√ºhrte Arbeiten</h3>

                        <!-- Dynamic positions from Google Doc -->
                        <div id="positions-container" style="margin-bottom: 20px;">
                            <p style="color: #666; font-style: italic;">Google Doc wird geladen...</p>
                        </div>

                        <!-- Manual override button -->
                        <div style="margin-bottom: 15px;">
                            <button type="button" class="btn" onclick="toggleManualDescription()" style="background: var(--soft-clay); color: white; font-size: 0.9rem; padding: 8px 16px;">
                                &#9999; Manuell beschreiben
                            </button>
                        </div>

                        <!-- Manual textarea (hidden by default when positions are loaded) -->
                        <div class="field">
                            <textarea class="beschreibung-arbeiten" rows="5" placeholder="Detaillierte Beschreibung der durchgef√ºhrten Arbeiten an diesem Tag..." style="display:none;"></textarea>
                        </div>
                    </div>

                    <!-- Materialien -->
                    <div class="section">
                        <h3>&#128230; Materialien und Baustoffe</h3>
                        <div class="materials-container">
                            <div class="material-row">
                                <div class="field">
                                    <label>Material</label>
                                    <select class="material-select">
                                        <option value="">Material ausw√§hlen</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>Menge</label>
                                    <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                                </div>
                                <div class="field">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" class="fremdeinkauf-checkbox" onchange="toggleFremdeinkauf(this)">
                                        Fremdeinkauf
                                    </label>
                                </div>
                                <div style="align-self: start; margin-top: 25px;">
                                    <button onclick="removeMaterial(this)" class="remove-btn">√ó</button>
                                </div>
                                <div class="fremdeinkauf-section hidden">
                                    <h4>üí∞ Fremdeinkauf Details</h4>
                                    <div class="field">
                                        <label>Beschreibung/Lieferant:</label>
                                        <input type="text" class="fremdeinkauf-details" placeholder="z.B. Baumarkt XY, Lieferant Z">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px;">
                            <button onclick="addMaterial()" class="btn btn-primary">
                                <span>+</span>
                                Material hinzuf√ºgen
                            </button>
                            <button onclick="openMaterialModal()" class="btn btn-secondary">
                                <span>&#128230;</span>
                                Neues Material anlegen
                            </button>
                        </div>
                    </div>

                    <!-- Bilder -->
                    <div class="section">
                        <h3>&#128247; Projekt-Bilder</h3>
                        <div class="image-upload-area">
                            <div class="upload-zone" onclick="document.getElementById('imageInput').click()">
                                <div style="font-size: 3em; margin-bottom: 15px;">üì∏</div>
                                <div>Bilder hinzuf√ºgen</div>
                                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 8px;">Tippen zum Ausw√§hlen oder Drag & Drop</div>
                            </div>
                            <input type="file" id="imageInput" multiple accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        </div>
                        
                        <div class="image-preview-container" id="imagePreviewContainer">
                            <!-- Bilder werden hier angezeigt -->
                        </div>
                        
                        <div style="margin-top: 15px; font-size: 0.9em; color: var(--soft-clay);">
                            üí° <strong>Tipp:</strong> Vorher/Nachher Bilder, Arbeitsfortschritt, besondere Details
                        </div>
                    </div>

                    <!-- Zusatzarbeiten -->
                    <div class="section">
                        <h3>‚ûï Zusatzarbeiten und Besonderheiten</h3>
                        <div class="field">
                            <textarea class="zusatzarbeiten" rows="3" placeholder="Beschreibung zus√§tzlicher Arbeiten, die nicht im urspr√ºnglichen Auftrag enthalten waren..."></textarea>
                        </div>
                    </div>

                    <!-- Unterschriften PRO TAG -->
                    <div class="section">
                        <h3>‚úèÔ∏è Tagesabnahme - Unterschriften</h3>
                        <div class="signature-section">
                            <div>
                                <h4 style="margin-bottom: 15px; color: var(--dark-forest);">Unterschrift Kunde (Tag 1)</h4>
                                <div class="signature-box" data-type="kunde" data-day="1" onclick="openSignature('kunde', 1)">
                                    <div style="font-size: 2em;">‚úèÔ∏è</div>
                                    <div>Tippen zum Unterschreiben</div>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 15px; color: var(--dark-forest);">Unterschrift Teamleiter (Tag 1)</h4>
                                <div class="signature-box" data-type="teamleiter" data-day="1" onclick="openSignature('teamleiter', 1)">
                                    <div style="font-size: 2em;">‚úèÔ∏è</div>
                                    <div>Tippen zum Unterschreiben</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Gesamtbest√§tigungen -->
            <div class="section">
                <h3>&#9989; Gesamtbest√§tigungen des Projekts</h3>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="auftragGemaess">
                        <label for="auftragGemaess">Die Arbeiten wurden gem√§√ü Auftrag ausgef√ºhrt</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="komplett">
                        <label for="komplett">Die beauftragten Arbeiten wurden komplett abgeschlossen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="teilweise">
                        <label for="teilweise">Die beauftragten Arbeiten wurden teilweise abgeschlossen</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="ordnungsGemaess">
                        <label for="ordnungsGemaess">Die Arbeiten wurden ordnungsgem√§√ü und m√§ngelfrei ausgef√ºhrt</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="kundeZufrieden">
                        <label for="kundeZufrieden">Der Kunde ist mit dem Ergebnis zufrieden</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="arbeitsplatzSauber">
                        <label for="arbeitsplatzSauber">Der Arbeitsplatz wurde ordentlich hinterlassen</label>
                    </div>
                </div>
            </div>

            <!-- Gesamtbemerkungen -->
            <div class="section">
                <h3>üí¨ Gesamtbemerkungen und Hinweise</h3>
                <div class="field">
                    <textarea id="bemerkungen" rows="4" placeholder="Weitere Bemerkungen, Besonderheiten oder Hinweise zum gesamten Projekt..."></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- === SUCCESS PAGE === -->
<div class="success-page" id="successPage">
    <div class="success-container">
        <div class="success-icon">&#9989;</div>
        <h1>Abnahme erfolgreich!</h1>
        <p style="font-size: 1.3rem; margin: 25px 0;">Das Formular wurde erfolgreich verarbeitet und die Daten wurden gespeichert.</p>
        
        <div class="employee-message">
            <h3>üéâ Nachricht an den Mitarbeiter</h3>
            <p><strong>Herzlichen Gl√ºckwunsch!</strong> Du hast das Abnahmeformular erfolgreich ausgef√ºllt. Deine sorgf√§ltige Dokumentation hilft uns dabei, unseren Kunden den bestm√∂glichen Service zu bieten.</p>
            <p style="margin-top: 20px;">Die Daten wurden automatisch in das System √ºbertragen. Das PDF kann √ºber den "PDF erstellen" Button generiert werden. Bei Fragen oder Problemen kannst du dich jederzeit an Jessika oder Sven wenden.</p>
            <p style="margin-top: 25px; padding: 20px; background: rgba(143, 166, 143, 0.2); border-radius: 10px; border-left: 4px solid var(--sage-green);">
                <strong>&#127793; gardenKeeper¬Æ - Professionelle Gartenpflege</strong><br>
                <em>"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</em><br><br>
                <span style="font-size: 0.95rem;">Du tr√§gst dazu bei, dass unsere Kunden stilvoll, gepflegt und verl√§sslich aufbl√ºhen k√∂nnen!</span>
            </p>
            <p style="margin-top: 20px; font-weight: bold; color: var(--sage-green); font-size: 1.1rem;">Weiter so! üí™</p>
        </div>
        
        <div style="margin-top: 35px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
            <button class="launcher-btn" onclick="generatePDF()" style="background: linear-gradient(135deg, var(--sage-green), var(--light-moss));">
                <span>üìÑ</span>
                PDF √∂ffnen & drucken
            </button>
            <button class="launcher-btn" onclick="downloadHTML()" style="background: linear-gradient(135deg, var(--warm-chestnut), var(--soft-clay));">
                <span>üíæ</span>
                HTML Download
            </button>
            <button class="launcher-btn" onclick="location.reload()" style="background: linear-gradient(135deg, #22c55e, #28a745);">
                <span>üîÑ</span>
                Neues Formular
            </button>
            <button class="launcher-btn" onclick="goBackToLauncher()">
                <span>üè†</span>
                Zur Startseite
            </button>
        </div>
    </div>
</div>

<!-- Signature Modal -->
<div class="modal" id="signatureModal">
    <div class="modal-content">
        <h3 id="signatureTitle">Unterschrift</h3>
        <canvas id="signatureCanvas" width="500" height="250" style="border: 2px solid var(--border-light); border-radius: 10px; cursor: crosshair; touch-action: none;"></canvas>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
            <button onclick="clearSignature()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">L√∂schen</button>
            <button onclick="closeSignature()" class="btn" style="flex: 1; background: #dc3545; color: white;">Abbrechen</button>
            <button onclick="saveSignature()" class="btn btn-primary" style="flex: 1;">Speichern</button>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal" id="emailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>&#128231; Email mit Abnahmeprotokoll versenden</h3>
            <button class="modal-close" onclick="closeEmailModal()">&times;</button>
        </div>
        <div class="field">
            <label>Kunde Email-Adresse *</label>
            <input type="email" id="emailKundeAddress" placeholder="kunde@example.com" required>
        </div>
        <div class="field">
            <label>Zus√§tzliche Nachricht</label>
            <textarea id="emailMessage" rows="3" placeholder="Optional: Zus√§tzliche Nachricht an den Kunden..."></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
            <button onclick="closeEmailModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
            <button onclick="sendEmailWithPDF()" class="btn btn-primary" style="flex: 1;">Email senden</button>
        </div>
    </div>
</div>

<!-- Worker Modal -->
<div class="modal" id="workerModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üë§ Neuen Mitarbeiter hinzuf√ºgen</h3>
            <button class="modal-close" onclick="closeWorkerModal()">&times;</button>
        </div>
        <div class="field">
            <label>Name des Mitarbeiters</label>
            <input type="text" id="newWorkerName" placeholder="z.B. Max Mustermann" maxlength="50">
            <small style="color: #666;">Mindestens 3 Zeichen</small>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
            <button onclick="closeWorkerModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
            <button onclick="addCustomWorker()" class="btn btn-primary" style="flex: 1;">Hinzuf√ºgen</button>
        </div>
    </div>
</div>

<!-- Material Modal -->
<div class="modal" id="materialModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>&#128230; Neues Material hinzuf√ºgen</h3>
            <button class="modal-close" onclick="closeMaterialModal()">&times;</button>
        </div>
        <div class="field">
            <label>Material-Bezeichnung</label>
            <input type="text" id="newMaterialName" placeholder="z.B. Speziald√ºnger" maxlength="100">
        </div>
        <div class="field">
            <label>Einheit</label>
            <input type="text" id="newMaterialUnit" placeholder="z.B. kg, Liter, St√ºck" maxlength="20">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
            <button onclick="closeMaterialModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
            <button onclick="addCustomMaterial()" class="btn btn-primary" style="flex: 1;">Hinzuf√ºgen</button>
        </div>
    </div>
</div>

<!-- Machine Modal -->
<div class="modal" id="machineModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>&#128668; Neue Maschine hinzuf√ºgen</h3>
            <button class="modal-close" onclick="closeMachineModal()">&times;</button>
        </div>
        <div class="field">
            <label>Maschinen-Bezeichnung</label>
            <input type="text" id="newMachineName" placeholder="z.B. Motors√§ge Stihl MS 261" maxlength="100">
        </div>
        <div class="field">
            <label>Einheit</label>
            <input type="text" id="newMachineUnit" placeholder="z.B. Std., Tag, Einsatz" maxlength="20">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
            <button onclick="closeMachineModal()" class="btn" style="flex: 1; background: var(--soft-clay); color: white;">Abbrechen</button>
            <button onclick="addCustomMachine()" class="btn btn-primary" style="flex: 1;">Hinzuf√ºgen</button>
        </div>
    </div>
</div>

<script>
    // ========================================
    // üîß GLOBALE VARIABLEN & STAMMDATEN
    // ========================================
    
    let currentSignatureType = '';
    let currentSignatureDay = 1;
    let isDrawing = false;
    let daySignatures = { 1: { kunde: '', teamleiter: '' } };
    let currentDay = 1;
    let maxDays = 1;
    let currentPDFUrl = null;

    // &#128247; BILD-MANAGEMENT
    let uploadedImages = [];

    // ========================================
    // üíæ BILD-SPEICHERUNG MIT LOCALSTORAGE BACKUP
    // ========================================

    /**
     * Speichert Bilder in localStorage als Backup
     * Achtung: Nur Metadaten, keine vollen Base64 (zu gro√ü)
     */
    function saveImagesToLocalStorage() {
        try {
            // Nur Metadaten speichern, nicht die Base64-Daten (zu gro√ü!)
            const imagesMetadata = uploadedImages.map(img => ({
                id: img.id,
                name: img.name,
                originalName: img.originalName,
                category: img.category,
                description: img.description,
                timestamp: img.timestamp,
                customerName: img.customerName,
                type: img.type
            }));

            localStorage.setItem('abnahme_images_metadata', JSON.stringify(imagesMetadata));
            localStorage.setItem('abnahme_images_timestamp', new Date().toISOString());
            console.log(`üíæ ${imagesMetadata.length} Bild-Metadaten gespeichert`);
        } catch (error) {
            console.warn('&#9888; Konnte Bilder nicht in localStorage speichern:', error);
        }
    }

    /**
     * Warnt Nutzer bei Seitenreload wenn ungespeicherte Bilder vorhanden
     */
    function setupUnloadWarning() {
        window.addEventListener('beforeunload', function(e) {
            if (uploadedImages.length > 0) {
                const message = 'Sie haben hochgeladene Bilder! Diese gehen verloren, wenn Sie die Seite verlassen.';
                e.preventDefault();
                e.returnValue = message;
                return message;
            }
        });
    }

    /**
     * L√∂scht localStorage nach erfolgreichem Upload
     */
    function clearLocalStorageImages() {
        localStorage.removeItem('abnahme_images_metadata');
        localStorage.removeItem('abnahme_images_timestamp');
        console.log('üóëÔ∏è localStorage Bilder-Backup gel√∂scht');
    }

    // ========================================
    // &#128247; NEUE BILD-UPLOAD FIX FUNKTIONEN
    // ========================================

    /**
     * Komprimiert ein Bild auf maximal 800KB
     * Bilder √ºber 2MB werden auf 50% Qualit√§t reduziert
     */
    async function compressImageForUpload(imageData, maxSizeKB = 800) {
        return new Promise((resolve) => {
            const img = new Image();
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Berechne neue Dimensionen (max 1200px Breite)
                let width = img.width;
                let height = img.height;
                const maxWidth = 1200;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Zeichne Bild
                ctx.drawImage(img, 0, 0, width, height);
                
                // Konvertiere zu JPEG mit Qualit√§tsreduzierung
                let quality = 0.8;
                let compressedData = canvas.toDataURL('image/jpeg', quality);
                
                // Wenn immer noch zu gro√ü, reduziere Qualit√§t weiter
                while (compressedData.length > maxSizeKB * 1024 && quality > 0.3) {
                    quality -= 0.1;
                    compressedData = canvas.toDataURL('image/jpeg', quality);
                }
                
                resolve(compressedData);
            };
            
            img.src = imageData;
        });
    }

    /**
     * L√§dt Bilder in kleineren Paketen zu Google Drive hoch
     * Sendet maximal 3 Bilder pro Request
     */
    async function uploadImagesToGoogleDrive(images, projectId) {
        if (!images || images.length === 0) {
            return { success: true, images: [], message: 'Keine Bilder vorhanden' };
        }
        
        showMessage(`&#128247; Komprimiere ${images.length} Bilder...`, 'info');
        
        // SCHRITT 1: Bilder komprimieren
        const compressedImages = [];
        for (let i = 0; i < images.length; i++) {
            try {
                const compressed = await compressImageForUpload(images[i].data);
                compressedImages.push({
                    ...images[i],
                    data: compressed,
                    originalName: images[i].name
                });
                
                showMessage(`&#128247; Bild ${i + 1}/${images.length} komprimiert...`, 'info');
            } catch (error) {
                console.error(`Fehler beim Komprimieren von Bild ${i + 1}:`, error);
            }
        }
        
        showMessage('üì§ Lade Bilder zu Google Drive hoch...', 'info');
        
        // SCHRITT 2: Bilder in Paketen hochladen (3 Bilder pro Request)
        const uploadedImages = [];
        const batchSize = 3;
        
        for (let i = 0; i < compressedImages.length; i += batchSize) {
            const batch = compressedImages.slice(i, i + batchSize);
            
            try {
                const payload = {
                    action: 'saveImages',
                    projectId: projectId,
                    customerName: batch[0]?.customerName || 'Kunde',  // &#9989; Kundenname f√ºr Ordner
                    images: batch.map(img => ({
                        name: img.name,  // &#9989; Intelligenter Name (Mueller_2025-11-05_Vorher_001.jpg)
                        originalName: img.originalName,  // Original-Name als Backup
                        data: img.data,
                        category: img.category,
                        description: img.description,
                        mimeType: 'image/jpeg'
                    })),
                    timestamp: new Date().toISOString()
                };
                
                // Sende zu Google Apps Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify(payload)
                });
                
                // Da no-cors, k√∂nnen wir Response nicht lesen, aber Request wurde gesendet
                console.log(`&#9989; Batch ${Math.floor(i / batchSize) + 1} gesendet (${batch.length} Bilder)`);
                
                uploadedImages.push(...batch);
                
                showMessage(`üì§ ${uploadedImages.length}/${compressedImages.length} Bilder hochgeladen...`, 'info');
                
                // Kleine Pause zwischen Batches
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                console.error(`Fehler beim Upload von Batch ${i / batchSize}:`, error);
            }
        }
        
        return {
            success: true,
            uploadedCount: uploadedImages.length,
            totalCount: images.length,
            images: uploadedImages,
            message: `${uploadedImages.length} Bilder hochgeladen`
        };
    }

    /**
     * Generiert E-Mail-HTML mit eingebetteten Bildern
     */
    function generateEmailWithImages(projectData, imageLinks) {
        const kunde = projectData.kunde || 'Kunde';
        const istTagesregie = projectData.abrechnungsart !== 'pauschal';

        // Lexoffice-Nummer
        const lexofficeHTML = projectData.lexofficeId ? `
            <p style="margin: 8px 0;"><strong>Lageso-/Lexoffice-Nr.:</strong> ${projectData.lexofficeId}</p>
        ` : '';

        // TAGESDETAILS (nur bei Tagesregie)
        let tagesDetails = '';
        if (istTagesregie && projectData.days && projectData.days.length > 0) {
            tagesDetails = `
                <div style="margin: 30px 0;">
                    <h3 style="color: #4a4539; margin-bottom: 20px; border-bottom: 3px solid #00b4b4; padding-bottom: 10px;">
                        &#128197; T√§gliche Arbeitsnachweise
                    </h3>
                    ${projectData.days.map((day, index) => {
                        // Arbeitszeit berechnen
                        let arbeitsstunden = 0;
                        if (day.LadeBeginn && day.arbeitszeitEnde) {
                            const [startH, startM] = day.ladeBeginn.split(':').map(Number);
                            const [endH, endM] = day.arbeitszeitEnde.split(':').map(Number);
                            const totalMinutes = (endH * 60 + endM) - (startH * 60 + startM) - (day.pause || 0) - (day.regenpause || 0);
                            arbeitsstunden = (totalMinutes / 60).toFixed(2);
                        }

                        return `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #00b4b4;">
                            <h4 style="color: #00b4b4; margin: 0 0 15px 0; font-size: 18px;">
                                Tag ${day.dayNumber} ${new Date(projectData.startdatum).toLocaleDateString('de-DE')}
                            </h4>

                            <div style="background: #f5f3f0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 5px 0;"><strong>&#9200; Arbeitszeit:</strong> ${day.ladeBeginn} - ${day.arbeitszeitEnde} Uhr</p>
                                <p style="margin: 5px 0;"><strong>&#9201; Netto-Stunden:</strong> ${arbeitsstunden} Std. (Pausen: ${day.pause || 0} Min.)</p>
                                ${day.regenpause ? `<p style="margin: 5px 0;"><strong>&#127783; Regenpause:</strong> ${day.regenpause} Min.</p>` : ''}
                            </div>

                            ${day.workers && day.workers.length > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #4a4539;">&#128101; Eingesetzte Mitarbeiter:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; color: #666;">
                                        ${day.workers.map(w => {
                                            // w kann String oder Objekt sein (f√ºr Kompatibilit√§t)
                                            if (typeof w === 'string') {
                                                return `<li>${w}</li>`;
                                            } else {
                                                const actualStart = w.startTime || day.ladeBeginn;
                                                const actualEnd = w.endTime || day.arbeitszeitEnde;
                                                const timeInfo = ' <small>(' + actualStart + ' - ' + actualEnd + ')</small>';
                                                return `<li>${w.name}${timeInfo}</li>`;
                                            }
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${day.beschreibungArbeiten ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #4a4539;">&#128296; Durchgef√ºhrte Arbeiten:</strong>
                                    <p style="margin: 8px 0 0 0; padding: 12px; background: #faf8f5; border-radius: 6px; color: #333; line-height: 1.6;">
                                        ${day.beschreibungArbeiten.replace(/\n/g, '<br>')}
                                    </p>
                                </div>
                            ` : ''}

                            ${day.materials && day.materials.length > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #4a4539;">&#128230; Verwendetes Material:</strong>
                                    <table style="width: 100%; margin-top: 8px; border-collapse: collapse;">
                                        ${day.materials.map(mat => `
                                            <tr style="border-bottom: 1px solid #e8e5e2;">
                                                <td style="padding: 8px; color: #666;">${mat.material}</td>
                                                <td style="padding: 8px; text-align: right; color: #333; font-weight: 600;">${mat.amount}</td>
                                            </tr>
                                        `).join('')}
                                    </table>
                                </div>
                            ` : ''}

                            ${day.machines && day.machines.length > 0 ? `
                                <div>
                                    <strong style="color: #4a4539;">&#128668; Eingesetzte Maschinen:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; color: #666;">
                                        ${day.machines.map(m => `<li>${m.machine} (${m.duration})</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // BILDER
        let imagesHTML = '';
        if (imageLinks && imageLinks.length > 0) {
            imagesHTML = `
                <div style="margin: 30px 0; background: linear-gradient(135deg, #e8f5e8, #f5f3f0); padding: 25px; border-radius: 12px; border: 2px solid #00b4b4;">
                    <h3 style="color: #2d3e2d; margin-top: 0; margin-bottom: 15px;">&#128247; Ihre Projekt-Bilder</h3>
                    <p style="margin: 0; font-size: 16px;">
                        <strong>${imageLinks.length} Bilder</strong> wurden dokumentiert und befinden sich im <strong>angeh√§ngten PDF-Protokoll</strong>.
                    </p>
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                        ${imageLinks.map((img, idx) => `
                            <div style="padding: 12px; margin-bottom: 8px; background: #faf8f5; border-radius: 6px; border-left: 3px solid #00b4b4;">
                                <div style="margin-bottom: 5px;">
                                    <strong style="color: #00b4b4;">Bild ${idx + 1}:</strong>
                                    <span style="color: #666;">${getCategoryDisplayName(img.category)}</span>
                                </div>
                                ${img.description ? `
                                    <div style="font-size: 14px; color: #666; font-style: italic; margin-top: 5px;">
                                        "${img.description}"
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        return `
            <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
                <div style="background: linear-gradient(135deg, #9ba687, #6b7456); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
                    <h1 style="margin: 0; font-size: 24px;">&#127793; gardenKeeper¬Æ Abnahmeprotokoll</h1>
                    <p style="margin: 10px 0 0 0; opacity: 0.9;">Professionelle Gartenpflege</p>
                </div>

                <div style="padding: 30px; background: #f5f3f0;">
                    <h2 style="color: #2d3e2d;">
                        ${projectData.anrede || 'Guten Tag'} ${projectData.nachname || kunde},
                    </h2>
                    <p style="font-size: 16px; line-height: 1.6;">
                        vielen Dank f√ºr Ihr Vertrauen! Ihr gardenKeeper¬Æ Projekt wurde erfolgreich abgeschlossen.
                        Im Anhang finden Sie das <strong>vollst√§ndige Abnahmeprotokoll als PDF</strong> mit allen Details und Bildern.
                    </p>

                    <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #00b4b4;">
                        <h3 style="color: #00b4b4; margin-top: 0;">&#128203; Projekt-√úbersicht</h3>
                        <p style="margin: 8px 0;"><strong>Startdatum:</strong> ${new Date(projectData.startdatum).toLocaleDateString('de-DE')}</p>
                        <p style="margin: 8px 0;"><strong>Anzahl Arbeitstage:</strong> ${projectData.days?.length || 0}</p>
                        <p style="margin: 8px 0;"><strong>Abrechnungsart:</strong> ${istTagesregie ? '&#9201; Tagesregie' : '&#128181; Pauschal'}</p>
                        ${lexofficeHTML}
                        <p style="margin: 8px 0;"><strong>Status:</strong> ${projectData.checkboxes?.komplett ? '&#9989; Vollst√§ndig abgeschlossen' : '&#9888; Teilweise abgeschlossen'}</p>
                    </div>

                    ${tagesDetails}
                    ${imagesHTML}
                    
                    <div style="background: linear-gradient(135deg, #9ba687, #f5f3f0); padding: 25px; border-radius: 10px; margin: 25px 0; text-align: center; border: 2px solid #9ba687;">
                        <h3 style="color: #2d3e2d; margin: 0 0 15px 0; font-size: 20px;">&#127775; Vielen Dank f√ºr Ihr Vertrauen!</h3>
                        <p style="margin: 0 0 15px 0; line-height: 1.6; font-size: 15px;">
                            Bei Fragen oder weiteren W√ºnschen stehen wir Ihnen gerne zur Verf√ºgung:
                        </p>
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <p style="margin: 5px 0; color: #2d3e2d;">
                                <strong>&#128222; Telefon:</strong> 0681 9389 4009
                            </p>
                            <p style="margin: 5px 0; color: #2d3e2d;">
                                <strong>&#128231; E-Mail:</strong> <a href="mailto:info@gardenkeeper.de" style="color: #00b4b4; text-decoration: none;">info@gardenkeeper.de</a>
                            </p>
                            <p style="margin: 5px 0; color: #2d3e2d;">
                                <strong>&#127760; Web:</strong> <a href="https://www.gardenkeeper.de" style="color: #00b4b4; text-decoration: none;">www.gardenkeeper.de</a>
                            </p>
                        </div>
                        <p style="margin: 15px 0 0 0; font-size: 14px; color: #666; font-style: italic;">
                            &#9989; Einfach auf diese E-Mail antworten oder uns anrufen
                        </p>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #4a4539, #3a3530); color: white; padding: 20px; text-align: center; border-radius: 0 0 10px 10px;">
                    <p style="margin: 0; font-size: 16px; font-weight: bold;">&#127793; gardenKeeper¬Æ GmbH</p>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Sven Kr√§mer</p>
                    <p style="margin: 5px 0 0 0; opacity: 0.8;">&#128222; 0681 9378 4009 | &#128231; info@gardenkeeper.de</p>
                    <p style="margin: 10px 0 0 0; font-style: italic; opacity: 0.9;">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</p>
                </div>
            </div>
        `;
    }

    /**
     * HAUPTFUNKTION: Formular mit Bildern abschlie√üen
     */
    async function completeFormWithImages() {
        const completeBtn = document.getElementById('completeBtnText');
        const originalText = completeBtn.textContent;
    // ========================================
    // OFFLINE-CHECK: Pr√ºfe Internetverbindung
    // ========================================
    if (!navigator.onLine) {
        const offlineConfirm = confirm(
            '‚ùå KEINE INTERNETVERBINDUNG!\n\n' +
            'Das Formular kann ohne Internet NICHT abgesendet werden.\n\n' +
            '‚úÖ IHRE DATEN BLEIBEN ERHALTEN!\n\n' +
            'M√∂chten Sie:\n' +
            '‚Ä¢ PDF lokal speichern? (OK dr√ºcken)\n' +
            '‚Ä¢ Abbrechen und sp√§ter absenden? (Abbrechen dr√ºcken)'
        );
        
        if (offlineConfirm) {
            try {
                const formData = getFormData();
                const pdfHTML = generatePDFHTML(formData);
                const printWindow = window.open('', '_blank');
                if (printWindow) {
                    printWindow.document.write(pdfHTML);
                    printWindow.document.close();
                    showMessage('üìÑ PDF wurde ge√∂ffnet. Bitte speichern Sie es manuell!', 'info');
                }
            } catch (error) {
                showMessage('‚ùå Fehler beim Erstellen des PDFs: ' + error.message, 'error');
            }
        }
        completeBtn.textContent = originalText;
        return;
    }    
        try {
            completeBtn.textContent = 'Verarbeite...';
            
            const formData = getFormData();
            // Bilder mit Kundenname f√ºr E-Mail vorbereiten
formData.images = uploadedImages.map((img, index) => ({
    data: img.data,
    mimeType: img.type || 'image/jpeg',
    filename: img.name,
    dayNumber: img.dayNumber || 1,
    description: img.description || `Bild ${index + 1}`,
    customerName: formData.kunde
}));
            const errors = validateFormData(formData);
            
            if (errors.length > 0) {
                showMessage('‚ùå Bitte vervollst√§ndigen Sie das Formular:\n' + errors.join('\n'), 'error');
                completeBtn.textContent = originalText;
                return;
            }
            
            // Projekt-ID generieren
            const projectId = generateProjectId();
            
            // SCHRITT 1: Bilder zu Google Drive hochladen
            let uploadResult = null;
            if (uploadedImages && uploadedImages.length > 0) {
                try {
                    showMessage(`&#128247; Verarbeite ${uploadedImages.length} Bilder...`, 'info');
                    uploadResult = await uploadImagesToGoogleDrive(uploadedImages, projectId);

                    if (uploadResult.success) {
                        showMessage(`&#9989; ${uploadResult.uploadedCount} Bilder erfolgreich hochgeladen!`, 'success');
                    } else {
                        showMessage('&#9888; Einige Bilder konnten nicht hochgeladen werden', 'warning');
                    }
                } catch (uploadError) {
                    console.error('&#9888; Bild-Upload Fehler:', uploadError);
                    showMessage('&#9888; Bild-Upload hatte Probleme - Formular wird trotzdem fortgesetzt', 'warning');
                }
            }
            
            // SCHRITT 2: Projektdaten mit Bild-Links vorbereiten
            const projectData = {
                ...formData,
                projectId: projectId,
                timestamp: new Date().toISOString(),
                images: uploadResult ? uploadResult.images : [],
                imageFolderUrl: uploadResult ? `https://drive.google.com/drive/folders/${projectId}` : null
            };
            
            // SCHRITT 3: PDF-HTML erstellen (mit Bildern)
            showMessage('üìÑ Erstelle PDF-HTML mit Bildern...', 'info');
            const pdfHTML = generatePDFHTML(projectData);
            // currentPDFUrl = createPDFBlob(projectData); // &#9888; DEAKTIVIERT - Funktion fehlt und wird nicht verwendet

            // SCHRITT 4: Daten zu Google Sheets
            try {
                showMessage('üìä Archiviere Daten in Google Sheets...', 'info');
                const sheetsResult = await sendToGoogleSheets(projectData, false);
                if (sheetsResult.success) {
                    console.log('&#9989; Google Sheets Update erfolgreich');
                } else {
                    console.warn('&#9888; Google Sheets Update hatte Probleme:', sheetsResult);
                }
            } catch (sheetsError) {
                console.error('&#9888; Google Sheets Fehler:', sheetsError);
                showMessage('&#9888; Archivierung hatte Probleme - Daten wurden lokal gesichert', 'warning');
            }

            // SCHRITT 5: E-Mail mit PDF an Kunde + CC an info@gardenkeeper.de
            if (projectData.kundenEmail) {
                try {
                    showMessage('&#128231; Sende E-Mail mit PDF an Kunde und gardenKeeper...', 'info');

                    const emailHTML = generateEmailWithImages(projectData, uploadResult?.images || []);

                    // &#9989; NEU: PDF-HTML direkt an Apps Script senden f√ºr PDF-Generierung
                    const emailResponse = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain'
                        },
                        body: JSON.stringify({
                            action: 'sendEmailWithPDF',  // &#9989; Neue Action f√ºr PDF-Generierung
                            to: projectData.kundenEmail,
                            cc: 'info@gardenkeeper.de',  // &#9989; CC an gardenKeeper
                            subject: `&#9989; Ihr gardenKeeper¬Æ Projekt ist abgeschlossen - Abnahmeprotokoll`,
                            projectData: projectData,
                            emailHTML: emailHTML,  // E-Mail-Body
                            pdfHTML: pdfHTML,  // &#9989; HTML-Content f√ºr PDF-Generierung
                            pdfFilename: `Abnahmeprotokoll_${projectData.kunde.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
                            abrechnungsart: projectData.abrechnungsart,
                            timestamp: new Date().toISOString()
                        })
                    });

                    showMessage('&#9989; E-Mail mit PDF wurde versendet an Kunde + gardenKeeper!', 'success');
                    console.log('&#9989; Email-Request erfolgreich gesendet');
                } catch (emailError) {
                    console.error('&#9888; Email-Versand Fehler:', emailError);
                    showMessage('&#9888; Email konnte nicht versendet werden. Daten wurden aber gespeichert.', 'warning');
                }
            } else {
                showMessage('‚ÑπÔ∏è Keine Kunden-Email angegeben - nur archiviert', 'info');
            }
            
            // SCHRITT 6: localStorage l√∂schen (Bilder erfolgreich hochgeladen)
            clearLocalStorageImages();

            // SCHRITT 7: Erfolgsseite anzeigen
            showMessage('üéâ Abnahme erfolgreich abgeschlossen!', 'success');

            setTimeout(() => {
                document.getElementById('formularPage').classList.remove('active');
                document.getElementById('successPage').classList.add('active');
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå Fehler:', error);
            showMessage(`‚ùå Fehler: ${error.message}`, 'error');
        } finally {
            completeBtn.textContent = originalText;
        }
    }

    // ========================================
    // üîß RESTLICHE ORIGINAL-FUNKTIONEN
    // ========================================

    // === BILD-OPTIMIERUNG F√úR PDF ===
    function compressImageForPDF(imageData, maxWidth = 800, quality = 0.8) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                let { width, height } = img;
                
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const compressedData = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedData);
            };
            
            img.src = imageData;
        });
    }

    async function optimizeImagesForPDF(images) {
        if (!images || !Array.isArray(images)) return [];
        
        const optimizedImages = [];
        
        for (const image of images) {
            try {
                if (!image.data || !image.data.startsWith('data:image/')) continue;
                
                const base64Data = image.data.split(',')[1];
                const sizeInMB = ((base64Data.length * 3) / 4) / (1024 * 1024);
                
                let processedData = image.data;
                
                // Komprimiere Bilder √ºber 2MB
                if (sizeInMB > 2) {
                    processedData = await compressImageForPDF(image.data, 800, 0.7);
                }
                
                optimizedImages.push({
                    ...image,
                    data: processedData,
                    originalSize: sizeInMB.toFixed(1) + 'MB'
                });
                
            } catch (error) {
                console.error(`Bild-Optimierung Fehler "${image.name}":`, error);
            }
        }
        
        return optimizedImages;
    }

    // Stammdaten aus dem Original
    const WORKERS = [
        'Fabio Kr√§mer', 'Claudiu Adascalitei', 'J√ºrgen Kr√§nkel', 
        'Joseph Dahl', 'Wolfgang Degro', 'Luca Kr√§mer',
        'Christian Winterstein', 'Carsten Munz', 'Sascha Macke', 'Julina Tiedtke', 
        'Kim Honnecker', 'Jan Jeanrond', 'Justin Stillemunkes'
    ];

    const MATERIALS = [
        { name: 'Entsorgung Gr√ºnschnitt', unit: 'cbm' },
        { name: 'Entsorgung Kn√∂terich -Sonderm√ºll-', unit: 'to.' },
        { name: 'Kieferndekorrinde 0-15', unit: 'Sack' },
        { name: 'Rindenmulch 15-45', unit: 'Sack' },
        { name: 'Pinienrinde 15-25', unit: 'Sack' },
        { name: 'Pinienrinde 8-16', unit: 'Sack' },
        { name: 'Corthum G√§rtnererde 50l', unit: 'Sack' },
        { name: 'Mutterboden, gesiebt (sehr fein)', unit: 'cbm' },
        { name: 'Entsorgung Erdmassen', unit: 'cbm' },
    ];

    const MACHINES = [
        { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Std.' },
        { name: 'H√§cksler mit eigenem Motor (bis 20cm Durchlass)', unit: 'Tag' },
        { name: 'Kompaktlader Vermeer', unit: 'Std.' },
        { name: 'Gro√üfl√§chen-Aufsitzm√§her mit Hochkipp-Funktion', unit: 'Std.' },
        { name: 'Gro√üfl√§chen-Mulcher (0-Wendekreism√§her)', unit: 'Std.' },
        { name: 'Ferris Mulchm√§her', unit: 'Std.' },
        { name: 'Minibagger Kubota (1 to.)', unit: 'Std.' },
        { name: 'Minibagger Cat 3.18 (2 to.)', unit: 'Std.' }
    ];

    // ========================================
    // üéØ NAVIGATION FUNKTIONEN
    // ========================================
    function openForm() {
        try {
            console.log('&#127793; √ñffne Formular...');
            
            document.getElementById('launcherPage').style.display = 'none';
            document.getElementById('formularPage').classList.add('active');
            
            const today = new Date().toISOString().split('T')[0];
            const startdatumEl = document.getElementById('startdatum');
            if (startdatumEl) {
                startdatumEl.value = today;
            }
            
            populateDropdowns();
            updateHoursSummary();
            setupDragAndDrop(); // Drag & Drop f√ºr Bilder initialisieren
            
            console.log('&#9989; Formular erfolgreich ge√∂ffnet');
            
        } catch (error) {
            console.error('‚ùå Fehler beim √ñffnen des Formulars:', error);
            alert('Fehler beim √ñffnen des Formulars. Seite wird neu geladen.');
            location.reload();
        }
    }

    function goBackToLauncher() {
        try {
            console.log('üè† Zur√ºck zur Startseite...');
            
            document.getElementById('formularPage').classList.remove('active');
            document.getElementById('successPage').classList.remove('active');
            document.getElementById('launcherPage').style.display = 'flex';
            
            console.log('&#9989; Zur√ºck zur Startseite erfolgreich');
            
        } catch (error) {
            console.error('‚ùå Navigation Fehler:', error);
            location.reload();
        }
    }

    // ========================================
    // üîß SYSTEM-FUNKTIONEN & GOOGLE INTEGRATION
    // ========================================
    
    // Google Apps Script URL - KONFIGURIERT F√úR IHRE UMGEBUNG
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwftkyLDb4kfPovKgEDqmL7szktoEUfqOq8odBnCcLL-4DXKS0li6u4CFEe2pR8-mqAKQ/exec'
    
    // DriveFixSystem Class f√ºr robuste Speicherung
    class DriveFixSystem {
        constructor() {
            this.maxRetries = 3;
            this.baseDelay = 1000;
        }

        async bulletproofSave(data, filename) {
            for (let attempt = 1; attempt <= this.maxRetries; attempt++) {
                try {
                    console.log(`üìÅ Drive-Speicherung Versuch ${attempt}/${this.maxRetries}`);
                    
                    const result = await this.saveToGoogleDrive(data, filename);
                    
                    console.log('&#9989; Drive-Speicherung erfolgreich:', result);
                    return result;
                    
                } catch (error) {
                    console.error(`‚ùå Drive-Versuch ${attempt} fehlgeschlagen:`, error);
                    
                    if (attempt === this.maxRetries) {
                        throw new Error(`Drive-Speicherung nach ${this.maxRetries} Versuchen fehlgeschlagen: ${error.message}`);
                    }
                    
                    // Exponential backoff
                    const delay = this.baseDelay * Math.pow(2, attempt - 1);
                    await this.wait(delay);
                }
            }
        }

        async saveToGoogleDrive(data, filename) {
            const payload = {
                action: 'savePDF',
                htmlContent: data,
                filename: filename,
                timestamp: new Date().toISOString()
            };

            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                 body: JSON.stringify(data)
            });

            return { success: true, message: 'Erfolgreich in Google Drive gespeichert' };
        }

        async wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async diagnoseDriveAccess() {
            try {
                const testPayload = {
                    action: 'test',
                    timestamp: new Date().toISOString()
                };

                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(testPayload)
                });

                return { status: 'ok', message: 'Drive-Zugriff funktioniert' };
            } catch (error) {
                return { status: 'error', message: error.message };
            }
        }
    }

    const driveFixSystem = new DriveFixSystem();

    // Google Sheets Integration
    async function sendToGoogleSheets(data, isTest = false) {
        try {
            console.log('üìä Sende Daten zu Google Sheets...', data);
            
            const payload = {
                action: 'saveData',
                data: data,
                test: isTest,
                timestamp: new Date().toISOString()
            };
            
            // METHODE 1: POST mit no-cors (funktioniert immer)
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('&#9989; Sheets: Daten gesendet (no-cors mode)');
                return { success: true, message: 'Google Sheets Update erfolgreich', method: 'POST no-cors' };
                
            } catch (postError) {
                console.warn('&#9888; POST Methode fehlgeschlagen:', postError);
            }
            
            // METHODE 2: GET mit URL-Parametern (Fallback)
            try {
                const urlParams = new URLSearchParams({
                    action: 'saveData',
                    data: JSON.stringify(data),
                    test: isTest ? 'true' : 'false',
                    timestamp: new Date().toISOString()
                });
                
                const getUrl = `${GOOGLE_SCRIPT_URL}?${urlParams.toString()}`;
                
                // Verwende img-Tag Trick f√ºr no-cors GET
                const img = new Image();
                img.onload = () => console.log('&#9989; Sheets: GET Fallback erfolgreich');
                img.onerror = () => console.log('&#9989; Sheets: GET Fallback gesendet (Fehler ist normal)');
                img.src = getUrl;
                
                console.log('&#9989; Sheets: GET Fallback verwendet');
                return { success: true, message: 'Google Sheets Update √ºber GET Fallback', method: 'GET fallback' };
                
            } catch (getError) {
                console.warn('&#9888; GET Fallback fehlgeschlagen:', getError);
            }
            
            throw new Error('Alle √úbertragungsmethoden fehlgeschlagen');
            
        } catch (error) {
            console.error('‚ùå Google Sheets Integration komplett fehlgeschlagen:', error);
            
            // Backup lokal speichern
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    data: data,
                    error: error.message
                };
                localStorage.setItem('gardenKeeper_sheets_backup', JSON.stringify(backup));
                console.log('üíæ Daten als Backup lokal gespeichert');
            } catch (backupError) {
                console.error('‚ùå Backup speichern fehlgeschlagen:', backupError);
            }

            return { 
                success: false, 
                error: error.message,
                backup: true
            };
        }
    }

    // Bulletproof Save f√ºr PDF zu Google Drive
    async function bulletproofSaveToGoogleDrive(data) {
        try {
            const filename = `gardenKeeper_${data.kunde.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}`;
            
            // Bilder f√ºr Drive optimieren
            if (data.images && data.images.length > 0) {
                data.images = await optimizeImagesForPDF(data.images);
            }
            
            const htmlContent = generatePDFHTML(data);
            const result = await driveFixSystem.bulletproofSave(htmlContent, filename);
            return result;
            
        } catch (error) {
            console.error('‚ùå Bulletproof Drive-Speicherung fehlgeschlagen:', error);
            throw error;
        }
    }

    // Test-System f√ºr Drive & Sheets
    async function testSystem() {
        showMessage('üîÑ Teste Google Drive & Sheets Verbindung...', 'info');
        
        let driveOk = false;
        let sheetsOk = false;
        let sheetsMethod = '';
        
        try {
            // Drive-Test
            console.log('üìÅ Teste Google Drive Zugriff...');
            const driveResult = await driveFixSystem.diagnoseDriveAccess();
            driveOk = driveResult.status === 'ok';
            console.log('üìÅ Drive-Test Ergebnis:', driveResult);
            
            // Sheets-Test mit verbesserter Diagnose
            console.log('üìä Teste Google Sheets Verbindung...');
            const testData = {
                kunde: 'Test-Kunde',
                startdatum: new Date().toISOString().split('T')[0],
                days: [{
                    dayNumber: 1,
                    beschreibungArbeiten: 'System-Test durchgef√ºhrt',
                    workers: ['System-Test']
                }],
                checkboxes: { komplett: true }
            };
            
            const sheetsResult = await sendToGoogleSheets(testData, true);
            sheetsOk = sheetsResult.success;
            sheetsMethod = sheetsResult.method || 'unbekannt';
            console.log('üìä Sheets-Test Ergebnis:', sheetsResult);
            
            // Apps Script URL Test
            console.log('üîó Apps Script URL:', GOOGLE_SCRIPT_URL);
            
        } catch (error) {
            console.error('‚ùå Test-Fehler:', error);
        }
        
        const driveStatus = driveOk ? '&#9989; Funktioniert' : '&#9888; √úberpr√ºfung n√∂tig';
        const sheetsStatus = sheetsOk ? `&#9989; Funktioniert (${sheetsMethod})` : '&#9888; √úberpr√ºfung n√∂tig';
        
        showMessage(`
            üîó <strong>Google Integration Status:</strong><br><br>
            üìÅ <strong>Google Drive:</strong> ${driveStatus}<br>
            üìä <strong>Google Sheets:</strong> ${sheetsStatus}<br><br>
            ${driveOk && sheetsOk ? 
                '<strong style="color: green;">üéâ Alle Systeme funktionieren!</strong><br><br>&#9989; <strong>PDFs</strong> werden in Google Drive gespeichert<br>&#9989; <strong>Daten</strong> werden in Google Sheets archiviert<br><br>Das System ist vollst√§ndig einsatzbereit!' :
                '<strong style="color: orange;">&#128203; Status-Information:</strong><br><br>Das gardenKeeper¬Æ Formular funktioniert <strong>vollst√§ndig</strong>, auch wenn einzelne Cloud-Services gerade nicht verf√ºgbar sind.<br><br>‚Ä¢ &#9989; <strong>Lokale Speicherung:</strong> Alle Daten werden lokal gesichert<br>‚Ä¢ &#9989; <strong>PDF-Erstellung:</strong> Funktioniert immer<br>‚Ä¢ &#9989; <strong>Email-Versand:</strong> Funktioniert unabh√§ngig<br>‚Ä¢ üîÑ <strong>Cloud-Sync:</strong> Wird nachgeholt sobald verf√ºgbar'
            }<br><br>
            <small>üîß <strong>Apps Script URL:</strong> ${GOOGLE_SCRIPT_URL.substring(0, 50)}...</small><br>
            <small>üí° <strong>Bei Problemen:</strong> An Chef u. Chefin wenden</small>
        `, driveOk && sheetsOk ? 'success' : 'info');
        
        return { driveOk, sheetsOk, sheetsMethod };
    }

    function saveDraft() {
        try {
            const formData = getFormData();
            localStorage.setItem('gardenKeeper_draft', JSON.stringify(formData));
            showMessage('üíæ Entwurf erfolgreich gespeichert!', 'success');
            console.log('&#9989; Entwurf gespeichert');
        } catch (error) {
            showMessage('‚ùå Fehler beim Speichern: ' + error.message, 'error');
            console.error('‚ùå Speicher-Fehler:', error);
        }
    }

    function runSpellCheck() {
showMessage('üîç Starte Rechtschreibpr√ºfung...', 'info');

const textFields = ['kunde', 'adresse', 'projektBeschreibung', 'bemerkungen', 'teamleiter', 'mitarbeiter', 'materialien'];
let errorsFound = 0;
let checkedFields = 0;

textFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field && field.value.trim()) {
        checkedFields++;
        field.setAttribute('spellcheck', 'true');
        field.setAttribute('lang', 'de-DE');
        
        if (field.value.match(/\b(falsch|fehler|test123|asdfgh|xyz123)\b/gi)) {
            field.style.borderColor = '#ef4444';
            field.style.backgroundColor = '#fef2f2';
            errorsFound++;
        } else {
            field.style.borderColor = '#22c55e';
            field.style.backgroundColor = '#f0fdf4';
        }
    }
});

setTimeout(() => {
    if (errorsFound > 0) {
        showMessage(`&#9888; ${errorsFound} m√∂gliche Rechtschreibfehler gefunden! Bitte √ºberpr√ºfen Sie die rot markierten Felder.`, 'warning');
    } else {
        showMessage(`&#9989; Rechtschreibpr√ºfung abgeschlossen! ${checkedFields} Felder gepr√ºft, keine Fehler gefunden.`, 'success');
    }
}, 1500);
}
    function handleImageUpload(event) {
        const files = event.target.files;

        if (!files || files.length === 0) {
            console.log('‚ùå Keine Dateien ausgew√§hlt');
            return;
        }

        console.log(`üì∏ ${files.length} Datei(en) ausgew√§hlt`);

        // Verarbeite alle ausgew√§hlten Dateien
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                console.log(`‚úÖ Verarbeite Bild: ${file.name}`);
                processImage(file);
            } else {
                console.log(`‚ö†Ô∏è √úberspringe Nicht-Bild: ${file.name}`);
            }
        });

        // Reset input damit gleiche Datei nochmal gew√§hlt werden kann
        event.target.value = '';
    }

    /**
     * Generiert intelligenten Dateinamen f√ºr Bilder
     * Format: Kunde_Datum_Kategorie_Nr.jpg
     * Beispiel: Mueller_2025-11-05_Vorher_001.jpg
     */
    function generateSmartFilename(originalName, customerName, category, index) {
        // Kundennamen bereinigen (keine Leerzeichen, Umlaute ersetzen)
        const cleanCustomer = (customerName || 'Kunde')
            .replace(/√§/g, 'ae')
            .replace(/√∂/g, 'oe')
            .replace(/√º/g, 'ue')
            .replace(/√ü/g, 'ss')
            .replace(/\s+/g, '-')  // Leerzeichen ‚Üí Bindestrich
            .replace(/[^a-zA-Z0-9-]/g, '');  // Nur Buchstaben, Zahlen, Bindestriche

        // Datum im Format YYYY-MM-DD
        const date = new Date().toISOString().split('T')[0];

        // Kategorie-Namen verk√ºrzen
        const categoryMap = {
            'arbeitsfortschritt': 'Arbeit',
            'vorher': 'Vorher',
            'nachher': 'Nachher',
            'details': 'Details',
            'probleme': 'Problem'
        };
        const cleanCategory = categoryMap[category] || category;

        // Nummer mit f√ºhrenden Nullen (001, 002, ...)
        const number = String(index + 1).padStart(3, '0');

        // Dateiendung vom Original √ºbernehmen
        const extension = originalName.split('.').pop() || 'jpg';

        return `${cleanCustomer}_${date}_${cleanCategory}_${number}.${extension}`;
    }

    function processImage(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const customerName = document.getElementById('kunde')?.value || 'Kunde';
            const imageIndex = uploadedImages.length;  // Aktuelle Anzahl = Index f√ºr neues Bild

            // Intelligenter Dateiname
            const smartName = generateSmartFilename(
                file.name,
                customerName,
                'arbeitsfortschritt',  // Default-Kategorie
                imageIndex
            );

            const imageData = {
                id: Date.now() + Math.random(),
                name: smartName,  // &#9989; Jetzt intelligenter Name!
                originalName: file.name,  // Original f√ºr Referenz
                data: e.target.result,
                type: file.type,
                category: 'arbeitsfortschritt',
                description: '',
                timestamp: new Date().toISOString(),
                customerName: customerName
            };

            uploadedImages.push(imageData);
            displayImagePreview(imageData);
            saveImagesToLocalStorage();  // &#9989; Auto-Save zu localStorage
            showMessage(`&#128247; Bild "${smartName}" hinzugef√ºgt`, 'success');
        };
        reader.readAsDataURL(file);
    }

    function displayImagePreview(imageData) {
        const container = document.getElementById('imagePreviewContainer');
        
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        previewDiv.setAttribute('data-image-id', imageData.id);
        
        previewDiv.innerHTML = `
            <button class="image-remove" onclick="removeImage('${imageData.id}')">&times;</button>
            <img src="${imageData.data}" alt="${imageData.name}">
            <div class="image-info">
                <div class="image-category">${getCategoryDisplayName(imageData.category)}</div>
                <div class="image-description">${imageData.name}</div>
                <select class="image-category-select" onchange="updateImageCategory('${imageData.id}', this.value)">
                    <option value="arbeitsfortschritt" ${imageData.category === 'arbeitsfortschritt' ? 'selected' : ''}>Arbeitsfortschritt</option>
                    <option value="vorher" ${imageData.category === 'vorher' ? 'selected' : ''}>Vorher-Zustand</option>
                    <option value="nachher" ${imageData.category === 'nachher' ? 'selected' : ''}>Nachher-Ergebnis</option>
                    <option value="details" ${imageData.category === 'details' ? 'selected' : ''}>Besondere Details</option>
                    <option value="probleme" ${imageData.category === 'probleme' ? 'selected' : ''}>Probleme/Sch√§den</option>
                    <option value="materialien" ${imageData.category === 'materialien' ? 'selected' : ''}>Verwendete Materialien</option>
                </select>
            </div>
        `;
        
        container.appendChild(previewDiv);
    }

    function removeImage(imageId) {
        uploadedImages = uploadedImages.filter(img => img.id != imageId);
        const previewElement = document.querySelector(`[data-image-id="${imageId}"]`);
        if (previewElement) {
            previewElement.remove();
        }

        saveImagesToLocalStorage();  // &#9989; Update localStorage
        showMessage('&#128247; Bild entfernt', 'info');
    }

    function updateImageCategory(imageId, newCategory) {
        const image = uploadedImages.find(img => img.id == imageId);
        if (image) {
            const oldCategory = image.category;
            image.category = newCategory;

            // &#9989; DATEINAME NEU GENERIEREN mit neuer Kategorie!
            const imageIndex = uploadedImages.indexOf(image);
            const newFilename = generateSmartFilename(
                image.originalName || image.name,
                image.customerName || document.getElementById('kunde')?.value || 'Kunde',
                newCategory,
                imageIndex
            );

            image.name = newFilename;
            console.log(`üìù Dateiname aktualisiert: ${newFilename}`);

            // Update display
            const categoryDisplay = document.querySelector(`[data-image-id="${imageId}"] .image-category`);
            if (categoryDisplay) {
                categoryDisplay.textContent = getCategoryDisplayName(newCategory);
            }

            // Update Dateinamen-Anzeige
            const descriptionDisplay = document.querySelector(`[data-image-id="${imageId}"] .image-description`);
            if (descriptionDisplay) {
                descriptionDisplay.textContent = newFilename;
            }
        }
    }

    function getCategoryDisplayName(category) {
        const categories = {
            'arbeitsfortschritt': 'Arbeitsfortschritt',
            'vorher': 'Vorher-Zustand',
            'nachher': 'Nachher-Ergebnis',
            'details': 'Besondere Details',
            'probleme': 'Probleme/Sch√§den',
            'materialien': 'Verwendete Materialien'
        };
        return categories[category] || 'Unbekannt';
    }

    // Drag & Drop Support
    function setupDragAndDrop() {
        const uploadZone = document.querySelector('.upload-zone');

        if (!uploadZone) {
            console.warn('‚ö†Ô∏è Upload-Zone nicht gefunden');
            return;
        }

        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');

            const files = e.dataTransfer.files;
            console.log(`üì∏ ${files.length} Datei(en) per Drag & Drop`);

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    console.log(`‚úÖ Verarbeite: ${file.name}`);
                    processImage(file);
                } else {
                    console.log(`‚ö†Ô∏è √úberspringe Nicht-Bild: ${file.name}`);
                }
            });
        });

        console.log('‚úÖ Drag & Drop initialisiert');
    }

    function getFormData() {
    const data = {
        anrede: document.getElementById('anrede')?.value?.trim() || '',
        nachname: document.getElementById('kunde')?.value?.trim() || '',  // ‚úÖ FIX
        kunde: document.getElementById('kunde')?.value?.trim() || '',
        istPauschal: document.getElementById('abrechnungsart')?.value === 'pauschal',
        kundenEmail: document.getElementById('kundenEmail')?.value?.trim() || '',
        lexofficeId: document.getElementById('lexofficeId')?.value?.trim() || '',
        startdatum: document.getElementById('startdatum')?.value || '',
        projektbeschreibung: document.getElementById('projektbeschreibung')?.value?.trim() || '',
        days: [],
        checkboxes: {
            auftragGemaess: document.getElementById('auftragGemaess').checked,
            komplett: document.getElementById('komplett').checked,
            teilweise: document.getElementById('teilweise').checked,
            ordnungsGemaess: document.getElementById('ordnungsGemaess').checked,
            kundeZufrieden: document.getElementById('kundeZufrieden').checked,
            arbeitsplatzSauber: document.getElementById('arbeitsplatzSauber').checked
        },
        bemerkungen: document.getElementById('bemerkungen')?.value?.trim() || '',
        signatures: daySignatures,
        images: uploadedImages
    };

    for (let dayNum = 1; dayNum <= maxDays; dayNum++) {
        const dayContent = document.getElementById(`day${dayNum}`);
        if (dayContent) {
            const dayData = getDayData(dayContent, dayNum);
            data.days.push(dayData);
        }
    }

    return data;
}

    function getDayData(dayContent, dayNumber) {
        const workers = [];
        dayContent.querySelectorAll('.worker-row').forEach(row => {
            const select = row.querySelector('.worker-select');
            const workerStartTime = row.querySelector('.worker-start-time');
            const workerEndTime = row.querySelector('.worker-end-time');

            if (select && select.value) {
                const workerData = {
                    name: select.value
                };

                // Speichere individuelle Zeiten, falls vorhanden
                if (workerStartTime && workerStartTime.value) {
                    workerData.startTime = workerStartTime.value;
                }
                if (workerEndTime && workerEndTime.value) {
                    workerData.endTime = workerEndTime.value;
                }

                workers.push(workerData);
            }
        });

        const materials = [];
        dayContent.querySelectorAll('.material-row').forEach(row => {
            const material = row.querySelector('.material-select').value;
            const amount = row.querySelector('.material-amount').value;
            const isFremdeinkauf = row.querySelector('.fremdeinkauf-checkbox').checked;
            
            if (material) {
                const materialData = { material, amount };
                if (isFremdeinkauf) {
                    materialData.fremdeinkauf = {
                        details: row.querySelector('.fremdeinkauf-details').value,
                        isFremdeinkauf: true
                    };
                }
                materials.push(materialData);
            }
        });

        const machines = [];
        dayContent.querySelectorAll('.machine-row').forEach(row => {
            const machine = row.querySelector('.machine-select').value;
            const duration = row.querySelector('.machine-duration').value;
            if (machine) {
                machines.push({ machine, duration });
            }
        });

        return {
            dayNumber,
            ladebeginn: dayContent.querySelector('.ladebeginn').value,
            abfahrt: dayContent.querySelector('.abfahrt').value,
            arbeitszeitBeginn: dayContent.querySelector('.arbeitszeit-beginn').value,
            arbeitszeitEnde: dayContent.querySelector('.arbeitszeit-ende').value,
            pause: parseInt(dayContent.querySelector('.pause').value) || 0,
            regenpause: parseInt(dayContent.querySelector('.regenpause').value) || 0,
            workers,
            machines,
            materials,
            beschreibungArbeiten: generateDescriptionFromCheckboxes() || dayContent.querySelector('.beschreibung-arbeiten').value.trim(),
            zusatzarbeiten: dayContent.querySelector('.zusatzarbeiten').value.trim()
        };
    }

    // ========================================
    // &#9200; STUNDENBERECHNUNG
    // ========================================
    function updateHoursSummary() {
        const currentDayContent = document.querySelector('.day-content.active');
        if (!currentDayContent) return;

        const summaryDiv = currentDayContent.querySelector('.hours-summary');
        const hoursListDiv = summaryDiv.querySelector('.hours-list');
        const totalDiv = summaryDiv.querySelector('.total');

        const teamBeginTime = currentDayContent.querySelector('.ladebeginn').value;
        const teamEndTime = currentDayContent.querySelector('.arbeitszeit-ende').value;
        const pause = parseInt(currentDayContent.querySelector('.pause').value) || 0;
        const regenpause = parseInt(currentDayContent.querySelector('.regenpause').value) || 0;
        const totalPause = pause + regenpause;

        const workerRows = currentDayContent.querySelectorAll('.worker-row');
        const workers = [];

        workerRows.forEach(row => {
            const select = row.querySelector('.worker-select');
            const workerStartTime = row.querySelector('.worker-start-time');
            const workerEndTime = row.querySelector('.worker-end-time');

            if (select && select.value) {
                workers.push({
                    name: select.value,
                    startTime: workerStartTime ? workerStartTime.value : null,
                    endTime: workerEndTime ? workerEndTime.value : null
                });
            }
        });

        if (!teamBeginTime || !teamEndTime || workers.length === 0) {
            hoursListDiv.innerHTML = '<div>Arbeitszeiten und Mitarbeiter eingeben</div>';
            totalDiv.textContent = 'Gesamtstunden: 0 Std.';
            return;
        }

        let hoursListHTML = '';
        let totalHours = 0;

        workers.forEach(worker => {
            // Start-Zeit: Individuelle Zeit ODER Team-Zeit
            const actualStart = worker.startTime || teamBeginTime;
            // Ende-Zeit: Individuelle Zeit ODER Team-Zeit
            const actualEnd = worker.endTime || teamEndTime;

            const workHours = calculateWorkHours(actualStart, actualEnd, totalPause);
            totalHours += workHours;

            // Anzeige: Zeige individuelle Zeiten, falls vorhanden
            let timeInfo = '';
            if (worker.startTime || worker.endTime) {
                timeInfo = ` <small>(${actualStart} - ${actualEnd})</small>`;
            }

            hoursListHTML += `<div>${worker.name}: ${workHours.toFixed(2)} Stunden${timeInfo}</div>`;
        });

        hoursListDiv.innerHTML = hoursListHTML;
        totalDiv.textContent = `Gesamtstunden: ${totalHours.toFixed(2)} Std.`;
    }

    function calculateWorkHours(beginTime, endTime, totalPauseMinutes) {
        const begin = new Date(`2000-01-01 ${beginTime}`);
        const end = new Date(`2000-01-01 ${endTime}`);
        
        let diffMs = end - begin;
        if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
        
        const workMinutes = (diffMs / (1000 * 60)) - totalPauseMinutes;
        return Math.max(0, workMinutes / 60);
    }

    // ========================================
    // &#128197; TAG-MANAGEMENT
    // ========================================
    function addDay() {
        maxDays++;
        
        const dayTabs = document.getElementById('dayTabs');
        const newTab = document.createElement('div');
        newTab.className = 'day-tab';
        newTab.setAttribute('data-day', maxDays);
        newTab.textContent = `Tag ${maxDays}`;
        newTab.onclick = () => switchDay(maxDays);
        dayTabs.appendChild(newTab);
        
        const dayContainer = document.getElementById('dayContentContainer');
        const newDayContent = document.querySelector('#day1').cloneNode(true);
        newDayContent.id = `day${maxDays}`;
        newDayContent.classList.remove('active');
        
        updateSignatureBoxesForDay(newDayContent, maxDays);
        resetDayContent(newDayContent);
        
        dayContainer.appendChild(newDayContent);
        populateDropdownsInDay(newDayContent);
        
        daySignatures[maxDays] = { kunde: '', teamleiter: '' };
        
        switchDay(maxDays);
        showMessage(`&#9989; Tag ${maxDays} hinzugef√ºgt`, 'success');
    }

    function switchDay(dayNumber) {
        currentDay = dayNumber;
        
        document.querySelectorAll('.day-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-day="${dayNumber}"]`).classList.add('active');
        
        document.querySelectorAll('.day-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`day${dayNumber}`).classList.add('active');
        
        updateHoursSummary();
    }

    function updateSignatureBoxesForDay(dayContent, dayNumber) {
        const signatureBoxes = dayContent.querySelectorAll('.signature-box');
        const signatureHeaders = dayContent.querySelectorAll('.signature-section h4');
        
        signatureBoxes.forEach(box => {
            const type = box.getAttribute('data-type');
            box.setAttribute('data-day', dayNumber);
            box.onclick = () => openSignature(type, dayNumber);
        });
        
        signatureHeaders.forEach(header => {
            if (header.textContent.includes('Kunde')) {
                header.textContent = `Unterschrift Kunde (Tag ${dayNumber})`;
            } else if (header.textContent.includes('Teamleiter')) {
                header.textContent = `Unterschrift Teamleiter (Tag ${dayNumber})`;
            }
        });
    }

    function resetDayContent(dayContent) {
        dayContent.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.type === 'checkbox') {
                field.checked = false;
            } else if (field.classList.contains('lade-beginn')) {
                field.value = '';
            } else {
                field.value = '';
            }
        });
    }

    // ========================================
    // &#128101; MITARBEITER-MANAGEMENT
    // ========================================
    function addWorker() {
        const currentDayContent = document.querySelector('.day-content.active');
        const container = currentDayContent.querySelector('.workers-container');

        const workerHTML = `
            <div class="worker-row">
                <div class="field">
                    <label>Mitarbeiter</label>
                    <select class="worker-select" onchange="updateHoursSummary()">
                        <option value="">Mitarbeiter ausw√§hlen</option>
                    </select>
                </div>
                <div class="field">
                    <label>‚è∞ Sp√§ter angefangen</label>
                    <input type="time" class="worker-start-time" onchange="updateHoursSummary()" placeholder="Optional">
                    <small style="color: #666; font-size: 0.85em;">Optional: Falls sp√§ter als Team-Zeit</small>
                </div>
                <div class="field">
                    <label>üèÅ Fr√ºher gegangen</label>
                    <input type="time" class="worker-end-time" onchange="updateHoursSummary()" placeholder="Optional">
                    <small style="color: #666; font-size: 0.85em;">Optional: Falls fr√ºher als Team-Zeit</small>
                </div>
                <div style="align-self: start; margin-top: 25px;">
                    <button onclick="removeWorker(this)" class="remove-btn">√ó</button>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', workerHTML);

        const newSelect = container.lastElementChild.querySelector('.worker-select');
        WORKERS.forEach(worker => {
            newSelect.innerHTML += `<option value="${worker}">${worker}</option>`;
        });

        showMessage('üë∑‚Äç‚ôÇÔ∏è Mitarbeiter hinzugef√ºgt', 'info');
    }

    function removeWorker(button) {
        const currentDayContent = document.querySelector('.day-content.active');
        const workerRows = currentDayContent.querySelectorAll('.worker-row');
        
        if (workerRows.length > 1) {
            button.closest('.worker-row').remove();
            updateHoursSummary();
            showMessage('üë∑‚Äç‚ôÇÔ∏è Mitarbeiter entfernt', 'info');
        } else {
            showMessage('&#9888; Mindestens ein Mitarbeiter muss vorhanden sein', 'warning');
        }
    }

    function openWorkerModal() {
        document.getElementById('workerModal').classList.add('show');
    }

    function closeWorkerModal() {
        document.getElementById('workerModal').classList.remove('show');
        document.getElementById('newWorkerName').value = '';
    }

    function addCustomWorker() {
        const name = document.getElementById('newWorkerName').value.trim();
        
        if (name.length < 3) {
            showMessage('‚ùå Name muss mindestens 3 Zeichen haben', 'error');
            return;
        }
        
        if (WORKERS.includes(name)) {
            showMessage('‚ùå Mitarbeiter existiert bereits', 'error');
            return;
        }
        
        WORKERS.push(name);
        populateDropdowns();
        
        closeWorkerModal();
        showMessage(`&#9989; Mitarbeiter "${name}" hinzugef√ºgt`, 'success');
    }

    // ========================================
    // &#128668; MASCHINEN-MANAGEMENT
    // ========================================
    function addMachine() {
        const currentDayContent = document.querySelector('.day-content.active');
        const container = currentDayContent.querySelector('.machines-container');
        
        const machineHTML = `
            <div class="machine-row">
                <div class="field">
                    <label>Maschine/Ger√§t</label>
                    <select class="machine-select">
                        <option value="">Maschine ausw√§hlen</option>
                    </select>
                </div>
                <div class="field">
                    <label>Einsatzdauer</label>
                    <input type="text" class="machine-duration" placeholder="z.B. 4 Std., 1 Tag">
                </div>
                <div style="align-self: start; margin-top: 25px;">
                    <button onclick="removeMachine(this)" class="remove-btn">√ó</button>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', machineHTML);
        
        const newSelect = container.lastElementChild.querySelector('.machine-select');
        MACHINES.forEach(machine => {
            newSelect.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
        });
        
        showMessage('&#128668; Maschine hinzugef√ºgt', 'info');
    }

    function removeMachine(button) {
        button.closest('.machine-row').remove();
        showMessage('&#128668; Maschine entfernt', 'info');
    }

    function openMachineModal() {
        document.getElementById('machineModal').classList.add('show');
    }

    function closeMachineModal() {
        document.getElementById('machineModal').classList.remove('show');
        document.getElementById('newMachineName').value = '';
        document.getElementById('newMachineUnit').value = '';
    }

    function addCustomMachine() {
        const name = document.getElementById('newMachineName').value.trim();
        const unit = document.getElementById('newMachineUnit').value.trim();
        
        if (!name || !unit) {
            showMessage('‚ùå Bitte alle Felder ausf√ºllen', 'error');
            return;
        }
        
        if (MACHINES.find(m => m.name === name)) {
            showMessage('‚ùå Maschine existiert bereits', 'error');
            return;
        }
        
        MACHINES.push({ name, unit });
        populateDropdowns();
        
        closeMachineModal();
        showMessage(`&#9989; Maschine "${name}" hinzugef√ºgt`, 'success');
    }

    // ========================================
    // üß± MATERIAL-MANAGEMENT
    // ========================================
    function addMaterial() {
        const currentDayContent = document.querySelector('.day-content.active');
        const container = currentDayContent.querySelector('.materials-container');
        
        const materialHTML = `
            <div class="material-row">
                <div class="field">
                    <label>Material</label>
                    <select class="material-select">
                        <option value="">Material ausw√§hlen</option>
                    </select>
                </div>
                <div class="field">
                    <label>Menge</label>
                    <input type="text" class="material-amount" placeholder="z.B. 10, 5.5">
                </div>
                <div class="field">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="fremdeinkauf-checkbox" onchange="toggleFremdeinkauf(this)">
                        Fremdeinkauf
                    </label>
                </div>
                <div style="align-self: start; margin-top: 25px;">
                    <button onclick="removeMaterial(this)" class="remove-btn">√ó</button>
                </div>
                <div class="fremdeinkauf-section hidden">
                    <h4>üí∞ Fremdeinkauf Details</h4>
                    <div class="field">
                        <label>Beschreibung/Lieferant:</label>
                        <input type="text" class="fremdeinkauf-details" placeholder="z.B. Baumarkt XY, Lieferant Z">
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', materialHTML);
        
        const newSelect = container.lastElementChild.querySelector('.material-select');
        MATERIALS.forEach(material => {
            newSelect.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
        });
        
        showMessage('üß± Material hinzugef√ºgt', 'info');
    }

    function removeMaterial(button) {
        button.closest('.material-row').remove();
        showMessage('üß± Material entfernt', 'info');
    }

    function toggleFremdeinkauf(checkbox) {
        const row = checkbox.closest('.material-row');
        const fremdeinkaufSection = row.querySelector('.fremdeinkauf-section');
        
        if (checkbox.checked) {
            fremdeinkaufSection.classList.remove('hidden');
            showMessage('üí∞ Fremdeinkauf aktiviert', 'info');
        } else {
            fremdeinkaufSection.classList.add('hidden');
        }
    }

    function openMaterialModal() {
        document.getElementById('materialModal').classList.add('show');
    }

    function closeMaterialModal() {
        document.getElementById('materialModal').classList.remove('show');
        document.getElementById('newMaterialName').value = '';
        document.getElementById('newMaterialUnit').value = '';
    }

    function addCustomMaterial() {
        const name = document.getElementById('newMaterialName').value.trim();
        const unit = document.getElementById('newMaterialUnit').value.trim();
        
        if (!name || !unit) {
            showMessage('‚ùå Bitte alle Felder ausf√ºllen', 'error');
            return;
        }
        
        if (MATERIALS.find(m => m.name === name)) {
            showMessage('‚ùå Material existiert bereits', 'error');
            return;
        }
        
        MATERIALS.push({ name, unit });
        populateDropdowns();
        
        closeMaterialModal();
        showMessage(`&#9989; Material "${name}" hinzugef√ºgt`, 'success');
    }

   // ========================================
// ‚úèÔ∏è UNTERSCHRIFTEN-SYSTEM (KORRIGIERT)
// ========================================
function openSignature(type, day) {
    currentSignatureType = type;
    currentSignatureDay = day;
    
    const modal = document.getElementById('signatureModal');
    const title = document.getElementById('signatureTitle');
    const canvas = document.getElementById('signatureCanvas');
    
    // ‚úÖ KORRIGIERT: ? hinzugef√ºgt
    title.textContent = `Unterschrift ${type === 'kunde' ? 'Kunde' : 'Teamleiter'} (Tag ${day})`;
    
    modal.classList.add('show');
    setupSignatureCanvas(canvas);
    
    if (daySignatures[day] && daySignatures[day][type]) {
        const img = new Image();
        img.onload = function() {
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
        };
        img.src = daySignatures[day][type];
    }
}

function setupSignatureCanvas(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000';
    
    canvas.addEventListener('touchstart', startDrawing, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', stopDrawing, { passive: false });
    
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
}

function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    
    const canvas = e.target;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    
    const ctx = canvas.getContext('2d');
    ctx.beginPath();
    ctx.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();
    
    const canvas = e.target;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    
    const ctx = canvas.getContext('2d');
    ctx.lineTo(x, y);
    ctx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function clearSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function saveSignature() {
    const canvas = document.getElementById('signatureCanvas');
    const signatureData = canvas.toDataURL();
    
    if (!daySignatures[currentSignatureDay]) {
        daySignatures[currentSignatureDay] = {};
    }
    
    daySignatures[currentSignatureDay][currentSignatureType] = signatureData;
    
    const signatureBox = document.querySelector(`[data-type="${currentSignatureType}"][data-day="${currentSignatureDay}"]`);
    signatureBox.classList.add('has-signature');
    signatureBox.innerHTML = `
        <img src="${signatureData}" style="max-width: 200px; max-height: 80px; border-radius: 4px;">
        <div style="margin-top: 8px; font-size: 0.9rem;">‚úÖ Unterschrieben</div>
    `;
    
    closeSignature();
    // ‚úÖ KORRIGIERT: ? hinzugef√ºgt
    showMessage(`‚úÖ Unterschrift ${currentSignatureType === 'kunde' ? 'Kunde' : 'Teamleiter'} f√ºr Tag ${currentSignatureDay} gespeichert`, 'success');
}

function closeSignature() {
    const modal = document.getElementById('signatureModal');
    modal.classList.remove('show');
    clearSignature();
}

    // ========================================
    // &#128231; EMAIL-FUNKTION
    // ========================================
    function showEmailModal() {
        const kundenEmail = document.getElementById('kundenEmail').value.trim();
        const emailField = document.getElementById('emailKundeAddress');
        
        if (kundenEmail && emailField) {
            emailField.value = kundenEmail;
            showMessage('&#128231; Kunden-Email automatisch √ºbernommen!', 'success');
        } else if (!kundenEmail) {
            showMessage('üí° Bitte zuerst Kunden-Email in den Grunddaten eingeben', 'info');
        }
        
        document.getElementById('emailModal').classList.add('show');
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.remove('show');
    }

    // ========================================
    // &#128231; E-MAIL MIT PDF - GOOGLE APPS SCRIPT VERSION
    // ========================================
    // WICHTIG: F√ºr automatischen PDF-Versand muss Google Apps Script aktiviert sein!
    // Anleitung siehe: Code.gs Datei
    // ========================================
    
    function sendEmailWithPDF() {
        const kundeEmail = document.getElementById('emailKundeAddress').value.trim();
        const emailMessage = document.getElementById('emailMessage').value.trim();
        
        if (!kundeEmail) {
            showMessage('‚ùå Bitte Email-Adresse eingeben', 'error');
            return;
        }
        
        const formData = getFormData();
        
        // Pr√ºfe ob Google Apps Script verf√ºgbar ist
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            // &#9989; GOOGLE APPS SCRIPT VERSION (Automatisch)
            console.log('&#128231; Verwende Google Apps Script f√ºr automatischen PDF-Versand...');
            
            showMessage('&#128231; Erstelle PDF und versende E-Mail...', 'info');
            
            // Generiere PDF HTML
            const pdfHTML = generatePDFHTML(formData);
            
            // Sende an Google Apps Script
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showMessage('&#9989; E-Mail mit PDF erfolgreich versendet!', 'success');
                        console.log('&#9989; PDF-Link:', response.pdfUrl);
                        closeEmailModal();
                    } else {
                        showMessage('‚ùå Fehler: ' + response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('‚ùå Fehler beim Versand: ' + error.message, 'error');
                    console.error('‚ùå Fehler:', error);
                })
                .sendEmailWithPDFAttachment(kundeEmail, formData, pdfHTML);
                
        } else {
            // &#9888; FALLBACK: MAILTO VERSION (Manuell)
            console.log('&#9888; Google Apps Script nicht verf√ºgbar, verwende mailto...');
            
            const subject = encodeURIComponent('Ihr gardenKeeper Projekt ist abgeschlossen - Abnahmeprotokoll');
            
            const emailContent = `Sehr geehrte Damen und Herren,

Ihr gardenKeeper Projekt wurde erfolgreich abgeschlossen!

=========================================================
PROJEKT-UEBERSICHT:
=========================================================

Kunde: ${formData.kunde}
Zeitraum: ${formData.startdatum} (${formData.days.length} Tag${formData.days.length > 1 ? 'e' : ''})
Status: ${formData.checkboxes.komplett ? 'Vollstaendig abgeschlossen' : formData.checkboxes.teilweise ? 'Teilweise abgeschlossen' : 'In Bearbeitung'}
Team: ${getAllWorkers(formData.days).join(', ')}

DURCHGEFUEHRTE ARBEITEN:
${formData.days.map(day => `- Tag ${day.dayNumber}: ${day.beschreibungArbeiten}`).join('\n')}

${emailMessage ? `ZUSAETZLICHE HINWEISE:\n${emailMessage}\n\n` : ''}

${(() => {
    const pflegeResult = analyzePflegeanleitungen(formData.days);
    return pflegeResult.emailText || '';
})()}

WICHTIG: Bitte haengen Sie das PDF manuell an die E-Mail an!
1. Erstellen Sie zuerst das PDF (Button "PDF erstellen")
2. Speichern Sie das PDF
3. Haengen Sie es an diese E-Mail an

Bei Fragen, Wuenschen oder Anregungen stehen wir Ihnen jederzeit
gerne zur Verfuegung. Empfehlen Sie uns weiter - das ist das
schoenste Kompliment fuer unsere Arbeit!

Mit gruenen Gruessen und herzlichem Dank fuer Ihr Vertrauen
Ihr gardenKeeper Team

=========================================================
Sven Kraemer
gardenKeeper GmbH
Grossblittersdorfer Str. 329
66130 Saarbruecken

Tel: 0681 9378 4009
Email: info@gardenkeeper.de
Web: www.gardenkeeper.de

"Weil Ihr Zuhause es verdient - made by gardenKeeper"
=========================================================
`;
            const body = encodeURIComponent(emailContent);
            const mailtoLink = `mailto:${kundeEmail}?cc=info@gardenkeeper.de&subject=${subject}&body=${body}`;
            
            try {
                window.location.href = mailtoLink;
                closeEmailModal();
                showMessage('&#128231; Email-Client ge√∂ffnet! Bitte PDF manuell anh√§ngen.', 'success');
                
                // Zeige Hinweis nach 2 Sekunden
                setTimeout(() => {
                    alert('üí° WICHTIGER HINWEIS:\n\n' +
                          'Die E-Mail wurde ge√∂ffnet, aber das PDF muss noch manuell angeh√§ngt werden!\n\n' +
                          '1. Erstellen Sie das PDF (Button "PDF erstellen")\n' +
                          '2. Speichern Sie das PDF\n' +
                          '3. H√§ngen Sie es an die E-Mail an\n\n' +
                          'F√ºr automatischen PDF-Versand verwenden Sie Google Apps Script!');
                }, 2000);
            } catch (error) {
                navigator.clipboard.writeText(emailContent).then(() => {
                    showMessage('&#128231; Email-Text in Zwischenablage kopiert!', 'success');
                }).catch(() => {
                    showMessage('&#128231; Bitte Email-Client manuell √∂ffnen', 'info');
                });
                closeEmailModal();
            }
        }
    }

    function getAllWorkers(days) {
        const allWorkers = new Set();
        days.forEach(day => {
            if (day.workers) {
                day.workers.forEach(worker => {
                    // worker kann String oder Objekt sein
                    const workerName = typeof worker === 'string' ? worker : worker.name;
                    allWorkers.add(workerName);
                });
            }
        });
        return Array.from(allWorkers);
    }

    // ========================================
    // üìÑ PDF-GENERIERUNG MIT BILD-INTEGRATION
    // ========================================
    // ========================================
    // PROFESSIONELLE PDF-GENERIERUNG - WIE AUF DEM BILD
    // ========================================

    function generatePDF() {
        console.log('üìÑ generatePDFHTML...');

        const data = getFormData();

        if (!data.kunde) {
            showMessage('‚ùå Bitte Kunde eingeben!', 'error');
            return;
        }

        try {
            showMessage('üìÑ Erstelle PDF-Vorschau...', 'info');

            // Professionelles PDF-HTML generieren (wie auf dem Bild)
            const pdfHTML = generatePDFHTML(data);

            // √ñffne in neuem Fenster
            const printWindow = window.open('', '_blank', 'width=1000,height=800');

            if (!printWindow) {
                showMessage('‚ùå Popup-Blocker aktiv! Bitte erlauben Sie Popups.', 'error');
                return;
            }

            printWindow.document.write(pdfHTML);
            printWindow.document.close();
            printWindow.focus();

            // Print-Dialog nach Verz√∂gerung
            setTimeout(() => {
                printWindow.print();
            }, 800);

            showMessage('&#9989; PDF ge√∂ffnet! W√§hlen Sie "Als PDF speichern".', 'success');
            console.log('&#9989; PDF erfolgreich generiert');

        } catch (error) {
            console.error('‚ùå PDF-Fehler:', error);
            showMessage(`‚ùå PDF-Fehler: ${error.message}`, 'error');
        }
    }

    function generatePDFHTML(data) {
        const today = new Date();
        const formattedDate = today.toLocaleDateString('de-DE');
        const formattedTime = today.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

        const allWorkers = [];
        data.days.forEach(day => {
            if (day.workers) {
                day.workers.forEach(worker => {
                    // worker kann String oder Objekt sein
                    const workerName = typeof worker === 'string' ? worker : worker.name;
                    if (!allWorkers.includes(workerName)) {
                        allWorkers.push(workerName);
                    }
                });
            }
        });

        let totalHours = 0;
data.days.forEach(day => {
    if (day.workers && day.workers.length > 0) {
        day.workers.forEach(worker => {
            // ‚úÖ STANDARD: ladebeginn ‚Üí arbeitszeitEnde
            // ‚úÖ AUSNAHME: Individuelle Zeiten wenn vorhanden
            const workerStartTime = worker.startTime || day.ladebeginn;
            const workerEndTime = worker.endTime || day.arbeitszeitEnde;
            
            if (workerStartTime && workerEndTime) {
                const workHours = calculateWorkHours(
                    workerStartTime,
                    workerEndTime,
                    (day.pause || 0) + (day.regenpause || 0)
                );
                totalHours += workHours;
            }
        });
    }
});

        return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Abnahmeprotokoll - ${data.kunde}</title>
    <style>
        @media print { 
            @page { size: A4; margin: 15mm; }
            body { margin: 0; font-size: 11pt; } 
            .page-break { page-break-before: always; }
            * { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }
    body { 
        font-family: 'Segoe UI', Arial, sans-serif; 
        line-height: 1.5; 
        margin: 20px;
        color: #2d3e2d;
    }
    
    .header { 
        background: linear-gradient(135deg, #9ba687 0%, #6b7456 50%, #4a4539 100%);
        color: white;
        text-align: center;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .header h1 { 
        font-size: 2.5rem; 
        margin: 0 0 15px 0;
        font-weight: 700;
    }
    
    .header .company {
        font-size: 1.3rem;
        margin-bottom: 10px;
    }
    
    .header .tagline {
        font-size: 1.1rem;
        opacity: 0.9;
        font-style: italic;
        margin-bottom: 15px;
    }
    
    .header .date {
        font-size: 1rem;
        opacity: 0.8;
    }
    
    .section { 
        margin-bottom: 30px;
        border: 2px solid #e8e5e2;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .section-header { 
        background: #f5f3f0;
        padding: 15px 25px;
        border-bottom: 2px solid #e8e5e2;
        font-weight: 600;
        font-size: 1.2rem;
        color: #2d3e2d;
    }
    
    .section-content {
        padding: 25px;
    }
    
    .grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px; 
        margin-bottom: 15px; 
    }
    
    .grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
    }
    
    .field {
        margin-bottom: 12px;
    }
    
    .field strong {
        color: #8a9876;
        display: inline-block;
        min-width: 140px;
        font-weight: 600;
    }
    
    .day-section {
        border-left: 4px solid #8a9876;
        margin-bottom: 25px;
        padding-left: 20px;
    }
    
    .day-header {
        background: linear-gradient(135deg, #8a9876, #9ba687);
        color: white;
        padding: 12px 20px;
        margin-left: -20px;
        margin-bottom: 20px;
        font-weight: 600;
        font-size: 1.3rem;
        border-radius: 8px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    th, td {
        border: 1px solid #e8e5e2;
        padding: 10px 15px;
        text-align: left;
    }
    
    th {
        background: #f5f3f0;
        font-weight: 600;
        color: #2d3e2d;
    }
    
    .highlight-box {
        background: linear-gradient(135deg, #9ba687, #f5f3f0);
        border: 2px solid #8a9876;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .status-completed {
        color: #22c55e;
        font-weight: 600;
    }
    
    .status-partial {
        color: #f59e0b;
        font-weight: 600;
    }
    
    .signature-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
        margin-top: 20px;
    }
    
    .signature-box { 
        border: 2px solid #e8e5e2; 
        height: 120px; 
        text-align: center; 
        padding: 15px;
        border-radius: 10px;
        background: #fafafa;
    }
    
    .signature-box img {
        max-width: 100%;
        max-height: 90px;
        border-radius: 6px;
    }
    
    /* BILD-PDF STYLES */
    .images-section {
        page-break-before: always;
    }

    .images-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    .image-item {
        border: 2px solid #e8e5e2;
        border-radius: 10px;
        overflow: hidden;
        page-break-inside: avoid;
        background: white;
    }

   /* NEU: */
   .image-item img {
       width: 100%;
       max-height: 280px;
       object-fit: contain;
       display: block;
       background: #f5f3f0;
    }

    .image-caption {
        padding: 12px 15px;
        background: #f5f3f0;
        border-top: 1px solid #e8e5e2;
        font-size: 0.9rem;
    }

    .image-category {
        font-weight: 600;
        color: #8a9876;
        font-size: 0.8rem;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    @media print {
        .images-grid {
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
   .image-item img {
       max-height: 220px;
       object-fit: contain;
    }

    
    .footer {
        margin-top: 50px;
        text-align: center;
        border-top: 3px solid #8a9876;
        padding-top: 25px;
        color: #666;
    }
    
    .footer .company-info {
        color: #8a9876;
        font-weight: 600;
        font-size: 1.2rem;
        margin-bottom: 8px;
    }
    
    .footer .tagline {
        font-style: italic;
        margin-bottom: 15px;
        font-size: 1rem;
    }
    
    .footer .meta {
        font-size: 0.9rem;
        color: #888;
    }

/* ===== üéØ AUTO-HIDE BUTTONS F√úR MOBILE ===== */
/* Buttons erscheinen beim Hoch-Wischen, verschwinden nach 3 Sekunden */

@media (max-width: 768px) {
    
    /* Auto-Hide: Buttons sind standardm√§√üig ausgeblendet */
    .form-buttons.sticky-mobile {
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Buttons sind sichtbar wenn .visible Klasse gesetzt */
    .form-buttons.sticky-mobile.visible {
        transform: translateY(0);
    }
    
    /* Kompaktere Button-Bar */
    .form-buttons.sticky-mobile {
        padding: 10px;
        gap: 8px;
    }
    
    /* Buttons kleiner und kompakter */
    .form-buttons.sticky-mobile .btn {
        padding: 10px 14px;
        font-size: 13px;
        min-height: 40px;
    }
    
    /* Icon-Gr√∂√üe reduziert */
    .form-buttons.sticky-mobile .btn span:first-child {
        font-size: 16px;
    }
    
    /* Platz am Ende reduziert da Buttons ausgeblendet sind */
    .form-content.has-sticky-buttons {
        padding-bottom: 40px !important;
    }
}

/* ===== SWIPE-UP INDICATOR ===== */
/* Zeigt dem User dass er nach oben wischen kann */

.swipe-indicator {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, var(--sage-green), var(--light-moss));
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 999;
    display: none;
    animation: pulse-subtle 2s infinite;
    box-shadow: 0 4px 15px rgba(143, 166, 143, 0.4);
}

@media (max-width: 768px) {
    .swipe-indicator.show {
        display: block;
    }
}

@keyframes pulse-subtle {
    0%, 100% {
        transform: translateX(-50%) translateY(0);
        opacity: 0.9;
    }
    50% {
        transform: translateX(-50%) translateY(-5px);
        opacity: 1;
    }
}


    /* NEUE PROJEKTZUSAMMENFASSUNG */
    .summary-box {
        background: linear-gradient(135deg, rgba(155, 166, 135, 0.2) 0%, rgba(138, 152, 118, 0.2) 100%);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border: 2px solid #8a9876;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .summary-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 15px;
    }
    
    .summary-main {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #6b7456;
    }
    
    .summary-main h3 {
        color: #6b7456;
        font-size: 14pt;
        margin-bottom: 10px;
        border-bottom: 1px solid #8a9876;
        padding-bottom: 6px;
    }
    
    .summary-list {
        list-style: none;
        padding: 0;
    }
    
    .summary-list li {
        padding: 6px 0;
        font-size: 10pt;
        color: #555;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .summary-list li:last-child {
        border-bottom: none;
    }
    
    .summary-list li strong {
        color: #6b7456;
        display: inline-block;
        min-width: 130px;
    }
    
    .summary-highlight {
        background: white;
        padding: 15px;
        border-radius: 6px;
    }
    
    .summary-highlight h3 {
        color: #6b7456;
        font-size: 11pt;
        margin-bottom: 10px;
        border-bottom: 1px solid #8a9876;
        padding-bottom: 6px;
    }
    
    .summary-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .stat-item {
        background: #faf8f5;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e5e5e5;
    }
    
    .stat-item strong {
        display: block;
        font-size: 8pt;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    
    .stat-item .value {
        font-size: 18pt;
        color: #6b7456;
        font-weight: 700;
    }
    
    .stat-item .unit {
        font-size: 9pt;
        color: #999;
    }

    /* ARBEITEN-BOXEN */
    .arbeiten-box {
        background: linear-gradient(135deg, rgba(155, 166, 135, 0.15) 0%, rgba(138, 152, 118, 0.15) 100%);
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 3px solid #8a9876;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .arbeiten-box strong {
        display: block;
        color: #6b7456;
        margin-bottom: 6px;
        font-size: 10pt;
    }

</style>
</head>
<body>
    <div class="header">
        <h1>&#127793; ABNAHME / TAGESREGIEBERICHT</h1>
        <div class="company">gardenKeeper¬Æ GmbH - Sven Kr√§mer</div>
        <div class="tagline">Professionelle Gartenpflege mit Stil und ‚ô•</div>
        <div class="date">Erstellt am: ${formattedDate} um ${formattedTime}</div>
    </div>
<div class="section">
    <div class="section-header">
        &#128203; Projektdaten
    </div>
    <div class="section-content">
        <div class="grid">
            <div class="field"><strong>Kunde:</strong> ${data.kunde} ${data.nachname || ''}</div>
            <div class="field"><strong>LexOffice-ID:</strong> ${data.lexofficeId || '---'}</div>
            <div class="field"><strong>Startdatum:</strong> ${new Date(data.startdatum).toLocaleDateString('de-DE')}</div>
            <div class="field"><strong>Projekttage:</strong> ${data.days.length}</div>
            <div class="field"><strong>Gesamtstunden:</strong> ${totalHours.toFixed(2)} Std.</div>
            ${data.kundenEmail ? `<div class="field"><strong>Kunde Email:</strong> ${data.kundenEmail}</div>` : ''}
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        &#128101; Projektteam
    </div>
    <div class="section-content">
        <strong>Eingesetzte Mitarbeiter:</strong> ${allWorkers.join(', ')}
    </div>
</div>

${data.days.map((day, index) => `
    ${index > 0 ? '<div class="page-break"></div>' : ''}
    <div class="day-section">
        <div class="day-header">
            &#128197; Tag ${day.dayNumber} - Detailbericht
        </div>
        
        <div class="grid">
            <div>
                <h4>&#9200; Zeiten:</h4>
                <div><strong>Ladebeginn:</strong> ${day.ladebeginn || '---'}</div>
                <div><strong>Abfahrt:</strong> ${day.abfahrt || '---'}</div>
                <div><strong>Arbeitszeit:</strong> ${day.ankunftZeit || '---'} - ${day.arbeitszeitEnde || '---'}</div>
                <div><strong>Pause:</strong> ${day.pause || 0} Min | <strong>Regenpause:</strong> ${day.regenpause || 0} Min</div>
            </div>
            <div>
                <h4>&#128101; Mitarbeiter:</h4>
                ${(day.workers || []).map(worker => {
                    if (typeof worker === 'string') {
                        return `<div>‚Ä¢ ${worker}</div>`;
                    } else {
                        const actualStart = worker.startTime || day.ladeBeginn;
                        const actualEnd = worker.endTime || day.arbeitszeitEnde;
                        const timeInfo = ' <small>(' + actualStart + ' - ' + actualEnd + ')</small>';
                        return `<div>‚Ä¢ ${worker.name}${timeInfo}</div>`;
                    }
                }).join('')}
            </div>
        </div>
        
        <div class="arbeiten-box">
            <strong>&#128296; Durchgef√ºhrte Arbeiten:</strong>
            <p>${day.beschreibungArbeiten || 'Keine Beschreibung verf√ºgbar'}</p>
        </div>
        
        ${day.zusatzarbeiten ? `
            <h4>‚ûï Zusatzarbeiten:</h4>
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #5a5045;">
                ${day.zusatzarbeiten}
            </div>
        ` : ''}
        
        ${day.materials && day.materials.length > 0 ? `
            <h4>üß± Materialien:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Menge</th>
                        <th>Einheit</th>
                        <th>Bemerkung</th>
                    </tr>
                </thead>
                <tbody>
                    ${day.materials.map(mat => `
                        <tr>
                            <td>${mat.material}</td>
                            <td>${mat.amount}</td>
                            <td>${MATERIALS.find(m => m.name === mat.material)?.unit || ''}</td>
                            <td>${mat.fremdeinkauf ? '<span style="color: #5a5045; font-weight: 600;">Fremdeinkauf</span>' : ''}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : ''}
        
        ${day.machines && day.machines.length > 0 ? `
            <h4>&#128668; Maschinen:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Maschine/Ger√§t</th>
                        <th>Einsatzdauer</th>
                    </tr>
                </thead>
                <tbody>
                    ${day.machines.map(machine => `
                        <tr>
                            <td>${machine.machine}</td>
                            <td>${machine.duration}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : ''}
    </div>
`).join('')}

${data.bemerkungen ? `
    <div class="section">
        <div class="section-header">
            üí¨ Gesamtbemerkungen
        </div>
        <div class="section-content">
            ${data.bemerkungen}
        </div>
    </div>
` : ''}

${data.images && data.images.length > 0 ? `
    <div class="images-section">
        <div class="section">
            <div class="section-header">
                &#128247; Projekt-Bilder (${data.images.length} Bilder)
            </div>
            <div class="section-content">
                <div class="images-grid">
                    ${data.images.map(image => `
                        <div class="image-item">
                            <img src="${image.data}" alt="${image.name}">
                            <div class="image-caption">
                                <div class="image-category">${getCategoryDisplayName(image.category)}</div>
                                <div>${image.name}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    </div>
` : ''}

<div class="section">
    <div class="section-header">
        üìä Projektzusammenfassung
    </div>
    <div class="section-content">
        <div class="summary-box">
            <div class="summary-content">
                <div class="summary-main">
                    <h3>Leistungs√ºbersicht</h3>
                    <ul class="summary-list">
                        <li><strong>Gesamtstunden:</strong> ${totalHours.toFixed(2)} Std.</li>
                        <li><strong>Mitarbeiter:</strong> ${allWorkers.length}</li>
                        <li><strong>Materialien:</strong> ${data.days.reduce((total, day) => total + (day.materials?.length || 0), 0)}</li>
                        <li><strong>Maschinen:</strong> ${data.days.reduce((total, day) => total + (day.machines?.length || 0), 0)}</li>
                        ${data.images ? `<li><strong>Bilder:</strong> ${data.images.length}</li>` : ''}
                        <li><strong>Status:</strong> ${data.checkboxes.komplett ? '&#9989; Vollst√§ndig abgeschlossen' : data.checkboxes.teilweise ? '&#9888; Teilweise abgeschlossen' : 'üìù In Bearbeitung'}</li>
                    </ul>
                </div>
                
                <div class="summary-highlight">
                    <h3>Kennzahlen</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <strong>Gesamt</strong>
                            <div class="value">${totalHours.toFixed(2)}</div>
                            <div class="unit">Stunden</div>
                        </div>
                        <div class="stat-item">
                            <strong>Team</strong>
                            <div class="value">${allWorkers.length}</div>
                            <div class="unit">Mitarbeiter</div>
                        </div>
                        <div class="stat-item">
                            <strong>Material</strong>
                            <div class="value">${data.days.reduce((total, day) => total + (day.materials?.length || 0), 0)}</div>
                            <div class="unit">Positionen</div>
                        </div>
                        <div class="stat-item">
                            <strong>Maschinen</strong>
                            <div class="value">${data.days.reduce((total, day) => total + (day.machines?.length || 0), 0)}</div>
                            <div class="unit">Ger√§te</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <h4>Projektstatus:</h4>
        <p class="${data.checkboxes.komplett ? 'status-completed' : data.checkboxes.teilweise ? 'status-partial' : ''}">
            ${data.checkboxes.komplett ? '&#9989; Vollst√§ndig abgeschlossen' : 
              data.checkboxes.teilweise ? '&#9888; Teilweise abgeschlossen' : 'üìù In Bearbeitung'}
        </p>
        
        <h4>Weitere Best√§tigungen:</h4>
        <ul style="margin-left: 20px;">
            ${data.checkboxes.auftragGemaess ? '<li>&#9989; Arbeiten wurden gem√§√ü Auftrag ausgef√ºhrt</li>' : ''}
            ${data.checkboxes.ordnungsGemaess ? '<li>&#9989; Arbeiten wurden ordnungsgem√§√ü und m√§ngelfrei ausgef√ºhrt</li>' : ''}
            ${data.checkboxes.kundeZufrieden ? '<li>&#9989; Kunde ist mit dem Ergebnis zufrieden</li>' : ''}
            ${data.checkboxes.arbeitsplatzSauber ? '<li>&#9989; Arbeitsplatz wurde ordentlich hinterlassen</li>' : ''}
        </ul>
    </div>
</div>

<div class="section">
    <div class="section-header">
        ‚úèÔ∏è Unterschriften
    </div>
    <div class="section-content">
        ${Object.entries(data.signatures || {}).map(([dayNum, signatures]) => `
            <h4>Tag ${dayNum}:</h4>
            <div class="signature-grid">
                <div>
                    <p><strong>Unterschrift Kunde:</strong></p>
                    <div class="signature-box">
                        ${signatures.kunde ? `<img src="${signatures.kunde}" alt="Kunde Unterschrift">` : '(Nicht unterschrieben)'}
                    </div>
                </div>
                <div>
                    <p><strong>Unterschrift Teamleiter:</strong></p>
                    <div class="signature-box">
                        ${signatures.teamleiter ? `<img src="${signatures.teamleiter}" alt="Teamleiter Unterschrift">` : '(Nicht unterschrieben)'}
                    </div>
                </div>
            </div>
        `).join('')}
    </div>
</div>

<div class="footer">
    <div class="company-info">&#127793; gardenKeeper¬Æ GmbH - Sven Kr√§mer</div>
    <div>&#128222; Tel: 0681 9378 4009 | &#128231; Email: info@gardenkeeper.de | üåê Web: www.gardenkeeper.de</div>
    <div class="tagline">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</div>
    <div class="meta">
        ¬© copyright by gardenKeeper 2025<br>
        Erstellt mit dem gardenKeeper¬Æ Abnahmeformular-System
    </div>
</div>

<!-- === PFLEGEANLEITUNGEN (automatisch erkannt) === -->
${(() => {
    const pflegeResult = analyzePflegeanleitungen(data.days);
    return pflegeResult.pdfHTML || '';
})()}
<!-- === ENDE PFLEGEANLEITUNGEN === -->

</body>
</html>`;
    } // Ende der generatePDFHTML Funktion

    // ========================================
    // üìÑ NEUE PROFESSIONELLE PDF-FUNKTION
    // ========================================
    function generateProfessionalPDF(data) {
        const jetzt = new Date();
        const erstelltAm = `${jetzt.getDate().toString().padStart(2, '0')}.${(jetzt.getMonth() + 1).toString().padStart(2, '0')}.${jetzt.getFullYear()} um ${jetzt.getHours().toString().padStart(2, '0')}:${jetzt.getMinutes().toString().padStart(2, '0')}:${jetzt.getSeconds().toString().padStart(2, '0')}`;

        // Gesamtstunden berechnen
        let totalHours = 0;
data.days.forEach(day => {
    if (day.workers && day.workers.length > 0) {
        day.workers.forEach(worker => {
            // ‚úÖ STANDARD: ladebeginn ‚Üí arbeitszeitEnde
            // ‚úÖ AUSNAHME: Individuelle Zeiten wenn vorhanden
            const workerStartTime = worker.startTime || day.ladebeginn;
            const workerEndTime = worker.endTime || day.arbeitszeitEnde;
            
            if (workerStartTime && workerEndTime) {
                const workHours = calculateWorkHours(
                    workerStartTime,
                    workerEndTime,
                    (day.pause || 0) + (day.regenpause || 0)
                );
                totalHours += workHours;
            }
        });
    }
});

        // Alle Mitarbeiter sammeln
        const allWorkers = [];
        data.days.forEach(day => {
            if (day.workers) {
                day.workers.forEach(worker => {
                    // worker kann String oder Objekt sein
                    const workerName = typeof worker === 'string' ? worker : worker.name;
                    if (workerName && !allWorkers.includes(workerName)) {
                        allWorkers.push(workerName);
                    }
                });
            }
        });

        return `<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abnahmeprotokoll - ${data.kunde}</title>
    <style>
        /* ========================================
           PROFESSIONELLES PDF-DESIGN
           ======================================== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 12px;
            line-height: 1.6;
            color: #333;
            background: #ffffff;
            padding: 20px;
        }

        /* HEADER - Wie auf dem Bild */
        .pdf-header {
            background: linear-gradient(135deg, #7F973B 0%, #A7B839 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(127, 151, 59, 0.3);
        }

        .pdf-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .pdf-header .subtitle {
            font-size: 16px;
            font-weight: 400;
            opacity: 0.95;
            margin: 8px 0;
        }

        .pdf-header .created-at {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 12px;
        }

        /* SEKTION - Wie auf dem Bild */
        .pdf-section {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .pdf-section h2 {
            font-size: 16px;
            color: #7F973B;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #A7B839;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-section h2 .icon {
            font-size: 18px;
        }

        /* PROJEKT-DATEN GRID */
        .projekt-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .projekt-item {
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .projekt-item strong {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .projekt-item span {
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        /* TAG-DETAILS - Mit farbigem Rand wie auf dem Bild */
        .day-container {
            border-left: 4px solid #A7B839;
            padding-left: 15px;
            margin: 20px 0;
            background: #fafafa;
            padding: 15px;
            padding-left: 20px;
            border-radius: 0 8px 8px 0;
        }

        .day-container h3 {
            font-size: 15px;
            color: #7F973B;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .day-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 12px 0;
        }

        .day-info-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
        }

        .day-info-box strong {
            display: block;
            font-size: 11px;
            color: #7F973B;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .day-info-box div {
            font-size: 12px;
            color: #333;
            line-height: 1.5;
        }

        /* ARBEITEN-BOX */
        .arbeiten-box {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 3px solid #A7B839;
        }

        .arbeiten-box strong {
            display: block;
            color: #7F973B;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .arbeiten-box p {
            color: #333;
            line-height: 1.6;
        }

        /* ZUSATZARBEITEN-BOX */
        .zusatz-box {
            background: #fff9e6;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 3px solid #ffc107;
        }

        .zusatz-box strong {
            display: block;
            color: #f57c00;
            margin-bottom: 6px;
            font-size: 12px;
        }

        /* TABELLEN - Wie auf dem Bild */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .data-table thead {
            background: #7F973B;
            color: white;
        }

        .data-table th {
            padding: 10px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: #f9f9f9;
        }

        /* BEMERKUNGEN */
        .bemerkungen-box {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 3px solid #2196F3;
        }

        .bemerkungen-box strong {
            display: block;
            color: #1976D2;
            margin-bottom: 8px;
            font-size: 12px;
        }

        /* ZUSAMMENFASSUNG */
        .summary-box {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .summary-box h2 {
            color: #2E7D32;
            border-bottom-color: #4CAF50;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .summary-item strong {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .summary-item span {
            font-size: 18px;
            color: #2E7D32;
            font-weight: 700;
        }

        /* FOOTER */
        .pdf-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #A7B839;
            text-align: center;
        }

        .company-name {
            font-size: 16px;
            font-weight: 700;
            color: #7F973B;
            margin-bottom: 10px;
        }

        .contact-info {
            font-size: 11px;
            color: #666;
            line-height: 1.8;
        }

        .contact-info strong {
            color: #7F973B;
        }

        .slogan {
            font-style: italic;
            color: #999;
            margin-top: 12px;
            font-size: 12px;
        }

        .document-info {
            font-size: 10px;
            color: #999;
            margin-top: 15px;
        }

        /* &#9989; BILDER-SEKTION STYLES */
        .images-section {
            page-break-before: always;
            margin-top: 30px;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 15px;
        }

        .image-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            page-break-inside: avoid;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .image-item img {
        width: 100%;
        height: 400px;  /* Optimiert f√ºr A4 */
        object-fit: cover;
        display: block;
            object-fit: cover;
            display: block;
        }

        .image-caption {
            padding: 12px 15px;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
        }

        .image-category {
            font-weight: 600;
            color: #7F973B;
            font-size: 10px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        /* PRINT-OPTIMIERUNG */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .pdf-header {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .data-table thead {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .page-break {
                page-break-before: always;
            }

            .no-break {
                page-break-inside: avoid;
            }
        }
    
    /* NEUE PROJEKTZUSAMMENFASSUNG */
    .summary-box {
        background: linear-gradient(135deg, rgba(155, 166, 135, 0.2) 0%, rgba(138, 152, 118, 0.2) 100%);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border: 2px solid #8a9876;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .summary-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 15px;
    }
    
    .summary-main {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #6b7456;
    }
    
    .summary-main h3 {
        color: #6b7456;
        font-size: 14pt;
        margin-bottom: 10px;
        border-bottom: 1px solid #8a9876;
        padding-bottom: 6px;
    }
    
    .summary-list {
        list-style: none;
        padding: 0;
    }
    
    .summary-list li {
        padding: 6px 0;
        font-size: 10pt;
        color: #555;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .summary-list li:last-child {
        border-bottom: none;
    }
    
    .summary-list li strong {
        color: #6b7456;
        display: inline-block;
        min-width: 130px;
    }
    
    .summary-highlight {
        background: white;
        padding: 15px;
        border-radius: 6px;
    }
    
    .summary-highlight h3 {
        color: #6b7456;
        font-size: 11pt;
        margin-bottom: 10px;
        border-bottom: 1px solid #8a9876;
        padding-bottom: 6px;
    }
    
    .summary-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .stat-item {
        background: #faf8f5;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #e5e5e5;
    }
    
    .stat-item strong {
        display: block;
        font-size: 8pt;
        color: #666;
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    
    .stat-item .value {
        font-size: 18pt;
        color: #6b7456;
        font-weight: 700;
    }
    
    .stat-item .unit {
        font-size: 9pt;
        color: #999;
    }

    /* ARBEITEN-BOXEN */
    .arbeiten-box {
        background: linear-gradient(135deg, rgba(155, 166, 135, 0.15) 0%, rgba(138, 152, 118, 0.15) 100%);
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 3px solid #8a9876;
        page-break-inside: avoid;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .arbeiten-box strong {
        display: block;
        color: #6b7456;
        margin-bottom: 6px;
        font-size: 10pt;
    }

</style>
</head>
<body>
    <!-- HEADER -->
    <div class="pdf-header">
        <h1>&#127793; ABNAHME / TAGESREGIEBERICHT</h1>
        <div class="subtitle">gardenKeeper¬Æ GmbH - Sven Kr√§mer</div>
        <div class="subtitle">Professionelle Gartenpflege mit Stil und ‚ô•</div>
        <div class="created-at">Erstellt am: ${erstelltAm}</div>
    </div>

    <!-- PROJEKTDATEN -->
    <div class="pdf-section">
        <h2><span class="icon">&#128203;</span>Projektdaten</h2>
        <div class="projekt-grid">
            <div class="projekt-item">
                <strong>Kunde:</strong>
                <span>${data.kunde}</span>
            </div>
            <div class="projekt-item">
                <strong>LexOffice-ID:</strong>
                <span>${data.lexofficeId || 'LEX-' + new Date().getFullYear() + '-001'}</span>
            </div>
            <div class="projekt-item">
                <strong>Startdatum:</strong>
                <span>${data.startdatum}</span>
            </div>
            <div class="projekt-item">
                <strong>Projekttage:</strong>
                <span>${data.days.length}</span>
            </div>
            <div class="projekt-item">
                <strong>Gesamtstunden:</strong>
                <span>${totalHours.toFixed(2)} Std.</span>
            </div>
        </div>
    </div>

    <!-- PROJEKTTEAM -->
    <div class="pdf-section">
        <h2><span class="icon">&#128101;</span>Projektteam</h2>
        <div style="padding: 10px; background: #f9f9f9; border-radius: 6px;">
            <strong>Eingesetzte Mitarbeiter:</strong> ${allWorkers.join(', ')}
        </div>
    </div>

    <!-- TAGE-DETAILS -->
    ${data.days.map((day, index) => {
        return `
        <div class="day-container no-break">
            <h3>&#128197; Tag ${day.dayNumber} - Detailbericht</h3>

            <div class="day-info-grid">
                <div class="day-info-box">
                    <strong>üïê Zeiten:</strong>
                    <div>
                        Ladebeginn: ${day.ladebeginn || '07:30'}<br>
                        Abfahrt: ${day.abfahrt || '07:45'}<br>
                        Arbeitszeit: ${day.arbeitszeitBeginn || '08:00'} - ${day.arbeitszeitEnde || '16:30'}<br>
                        Pause: ${day.pause || '30'} Min | Regenpause: ${day.regenpause || '0'} Min
                    </div>
                </div>

                <div class="day-info-box">
                    <strong>&#128101; Mitarbeiter:</strong>
                    <div>${day.workers.map(w => {
                        if (typeof w === 'string') return w;
                        const timeInfo = (w.startTime || w.endTime) ? ` (${w.startTime || day.arbeitszeitBeginn} - ${w.endTime || day.arbeitszeitEnde})` : '';
                        return `${w.name}${timeInfo}`;
                    }).join(', ')}</div>
                </div>
            </div>

            ${day.beschreibungArbeiten ? `
            <div class="arbeiten-box">
                <strong>&#128296; Durchgef√ºhrte Arbeiten:</strong>
                <p>${day.beschreibungArbeiten}</p>
            </div>
            ` : ''}

            ${day.zusatzarbeiten ? `
            <div class="zusatz-box">
                <strong>‚ûï Zusatzarbeiten:</strong>
                <p>${day.zusatzarbeiten}</p>
            </div>
            ` : ''}

            ${day.materials && day.materials.length > 0 ? `
            <div style="margin-top: 15px;">
                <strong style="color: #7F973B; display: block; margin-bottom: 8px;">üß± Materialien:</strong>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Menge</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${day.materials.map(mat => `
                        <tr>
                            <td>${mat.material}</td>
                            <td>${mat.amount}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ` : ''}

            ${day.machines && day.machines.length > 0 ? `
            <div style="margin-top: 15px;">
                <strong style="color: #7F973B; display: block; margin-bottom: 8px;">&#128668; Maschinen:</strong>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Maschine</th>
                            <th>Dauer/Menge</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${day.machines.map(mach => `
                        <tr>
                            <td>${mach.machine}</td>
                            <td>${mach.duration}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ` : ''}
        </div>
        `;
    }).join('')}

    <!-- BEMERKUNGEN -->
    ${data.bemerkungen ? `
    <div class="pdf-section">
        <h2><span class="icon">üí¨</span>Bemerkungen</h2>
        <div class="bemerkungen-box">
            <p>${data.bemerkungen}</p>
        </div>
    </div>
    ` : ''}

    <!-- &#9989; BILDER-SEKTION -->
    ${data.images && data.images.length > 0 ? `
    <div class="images-section">
        <div class="pdf-section">
            <h2><span class="icon">&#128247;</span>Projekt-Bilder (${data.images.length} Bilder)</h2>
            <div class="images-grid">
                ${data.images.map((image, idx) => `
                    <div class="image-item">
                        <img src="${image.data}" alt="${image.name || `Bild ${idx + 1}`}">
                        <div class="image-caption">
                            <div class="image-category">${getCategoryDisplayName(image.category)}</div>
                            <div>${image.name || `Bild ${idx + 1}`}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    </div>
    ` : ''}

    <!-- PROJEKTZUSAMMENFASSUNG -->
    <div class="summary-box">
        <h2><span class="icon">üìä</span>Projektzusammenfassung</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <strong>Gesamtstunden:</strong>
                <span>${totalHours.toFixed(2)} Std.</span>
            </div>
            <div class="summary-item">
                <strong>Mitarbeiter:</strong>
                <span>${allWorkers.length}</span>
            </div>
            <div class="summary-item">
                <strong>Materialien:</strong>
                <span>${data.days.reduce((sum, day) => sum + (day.materials?.length || 0), 0)}</span>
            </div>
            <div class="summary-item">
                <strong>Maschinen:</strong>
                <span>${data.days.reduce((sum, day) => sum + (day.machines?.length || 0), 0)}</span>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="pdf-footer">
        <div class="company-name">&#127793; gardenKeeper¬Æ GmbH</div>
        <div class="contact-info">
            <strong>‚òé</strong> Tel: 0681 9378 4009 |
            <strong>‚úâ</strong> Email: info@gardenkeeper.de |
            <strong>üåê</strong> Web: www.gardenkeeper.de
        </div>
        <div class="slogan">"Weil Ihr Zuhause es verdient - made by gardenKeeper¬Æ"</div>
        <div class="document-info">
            Dokument erstellt mit gardenKeeper¬Æ Abnahmeformular 2026<br>
            Professionelle Dokumentation - Fokus auf die Essentials
        </div>
    </div>

    <!-- AUTO-PRINT -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                window.print();
            }, 800);
        });
    <\/script>
</body>
</html>`;
    }

    // ========================================
    // üíæ HTML DOWNLOAD
    // ========================================
    function downloadHTML() {
        try {
            const formData = getFormData();
            const htmlContent = generatePDFHTML(formData);
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `gardenKeeper_Abnahme_${formData.kunde}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showMessage('üíæ HTML-Datei erfolgreich heruntergeladen!', 'success');
            
        } catch (error) {
            showMessage('‚ùå Fehler beim HTML-Download: ' + error.message, 'error');
        }
    }

    // ========================================
    // üóëÔ∏è FORMULAR KOMPLETT LEEREN (NEU!)
    // ========================================
    function clearFormCompletely() {
        console.log('üóëÔ∏è Leere Formular komplett...');
        
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.checked = false;
            } else if (input.id !== 'ladebeginn' && input.id !== 'arbeitsende' && input.id !== 'pause') {
                input.value = '';
            }
            input.style.borderColor = '';
            input.style.backgroundColor = '';
        });
        
        uploadedImages = [];
        const imageContainer = document.getElementById('imagePreviewContainer');
        if (imageContainer) {
            imageContainer.innerHTML = '';
        }
        
        localStorage.removeItem('gardenKeeper_draft');
        localStorage.removeItem('gardenKeeper_images');
        
        const today = new Date().toISOString().split('T')[0];
        const startdatumEl = document.getElementById('startdatum');
        if (startdatumEl) {
            startdatumEl.value = today;
        }
        
                    
        showMessage('&#9989; Formular wurde komplett geleert und zur√ºckgesetzt!', 'success');
    }

    // Projekt-ID generieren
    function generateProjectId() {
        const timestamp = new Date();
        const year = timestamp.getFullYear();
        const month = String(timestamp.getMonth() + 1).padStart(2, '0');
        const day = String(timestamp.getDate()).padStart(2, '0');
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        
        return `GK-${year}${month}${day}-${random}`;
    }

    // Email-Benachrichtigung senden
    async function sendNotificationEmail(projectData) {
        try {
            const emailPayload = {
                action: 'sendNotification',
                data: projectData,
                timestamp: new Date().toISOString()
            };

            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emailPayload)
            });

            return { success: true, message: 'Email-Benachrichtigung versendet' };
            
        } catch (error) {
            console.error('‚ùå Email-Benachrichtigung Fehler:', error);
            return { success: false, error: error.message };
        }
    }

    function validateFormData(data) {
        const errors = [];
        
        if (!data.anrede || !data.anrede.trim()) {
            errors.push('‚Ä¢ Anrede fehlt (Liebe Frau / Lieber Herr)');
        }
        
        if (!data.nachname || !data.nachname.trim()) {
            errors.push('‚Ä¢ Nachname fehlt');
        }
        
        if (!data.startdatum) {
            errors.push('‚Ä¢ Startdatum fehlt');
        }
        
        if (!data.days || data.days.length === 0) {
            errors.push('‚Ä¢ Keine Arbeitstage vorhanden');
            return errors;
        }
        
        data.days.forEach((day, index) => {
            if (!day.beschreibungArbeiten || !day.beschreibungArbeiten.trim()) {
                errors.push(`‚Ä¢ Tag ${day.dayNumber}: Arbeitsbeschreibung fehlt`);
            }
            
            if (!day.workers || day.workers.length === 0) {
                errors.push(`‚Ä¢ Tag ${day.dayNumber}: Mindestens ein Mitarbeiter erforderlich`);
            }
        });
        
        return errors;
    }

    // ========================================
    // üõ†Ô∏è HILFSFUNKTIONEN
    // ========================================
    function showMessage(message, type) {
        const statusDiv = document.getElementById('statusMessage');
        if (!statusDiv) return;
        
        const className = `status-message status-${type}`;
        statusDiv.innerHTML = `<div class="${className}">${message.replace(/\n/g, '<br>')}</div>`;
        
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, type === 'error' ? 8000 : 4000);
    }

    function populateDropdowns() {
        document.querySelectorAll('.day-content').forEach(dayContent => {
            populateDropdownsInDay(dayContent);
        });
    }

    function populateDropdownsInDay(dayContent) {
        dayContent.querySelectorAll('.worker-select').forEach(select => {
            select.innerHTML = '<option value="">Mitarbeiter ausw√§hlen</option>';
            WORKERS.forEach(worker => {
                select.innerHTML += `<option value="${worker}">${worker}</option>`;
            });
        });

        dayContent.querySelectorAll('.material-select').forEach(select => {
            select.innerHTML = '<option value="">Material ausw√§hlen</option>';
            MATERIALS.forEach(material => {
                select.innerHTML += `<option value="${material.name}" data-unit="${material.unit}">${material.name} (${material.unit})</option>`;
            });
        });

        dayContent.querySelectorAll('.machine-select').forEach(select => {
            select.innerHTML = '<option value="">Maschine ausw√§hlen</option>';
            MACHINES.forEach(machine => {
                select.innerHTML += `<option value="${machine.name}" data-unit="${machine.unit}">${machine.name} (${machine.unit})</option>`;
            });
        });
    }

    // ========================================
    // üöÄ INITIALISIERUNG
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('&#127793; gardenKeeper¬Æ System wird initialisiert...');

    // &#9989; Warnung bei Seitenreload aktivieren
    setupUnloadWarning();

    try {
        // WICHTIG: Button Event Listener SOFORT hinzuf√ºgen
        const openFormBtn = document.getElementById('openFormBtn');
        if (openFormBtn) {
            // Entferne alte Event Listener
            openFormBtn.replaceWith(openFormBtn.cloneNode(true));
            const newBtn = document.getElementById('openFormBtn');
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('üéØ Button geklickt - √∂ffne Formular...');
                openForm();
            });
            
            console.log('&#9989; Button Event Listener registriert');
        } else {
            console.error('‚ùå openFormBtn nicht gefunden!');
        }
        
        const today = new Date().toISOString().split('T')[0];
        const startdatumEl = document.getElementById('startdatum');
        if (startdatumEl) {
            startdatumEl.value = today;
        }
        
        if (!daySignatures[1]) {
            daySignatures[1] = { kunde: '', teamleiter: '' };
        }
        
        populateDropdowns();
        updateHoursSummary();
        
        setTimeout(() => {
            showMessage(`
                üéâ <strong>gardenKeeper¬Æ Abnahmeformular bereit!</strong><br><br>
                &#9989; Modernes Design einfach in Anwendung<br>
                &#9989; Vollst√§ndige Funktionalit√§t<br>
                &#9989; Touch-optimiert<br>
                &#9989; <strong>BILD-UPLOAD UND PDF-INTEGRATION AKTIV!</strong><br><br>
                &#127793; Das System ist sofort einsatzbereit!<br><br>
                üí° <strong>Klicken Sie auf "Abnahmeformular √∂ffnen"</strong>
            `, 'success');
        }, 1500);
        
        console.log('&#9989; gardenKeeper¬Æ System erfolgreich initialisiert');
        
    } catch (error) {
        console.error('‚ùå Initialisierungsfehler:', error);
        showMessage('‚ùå Fehler bei der Initialisierung. Seite neu laden.', 'error');
    }
});

    // BACKUP: Falls DOMContentLoaded schon vorbei ist
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(() => {
        const openFormBtn = document.getElementById('openFormBtn');
        if (openFormBtn && !openFormBtn.onclick) {
            openFormBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('üéØ Backup Event Listener - √∂ffne Formular...');
                openForm();
            });
            console.log('&#9989; Backup Event Listener aktiviert');
        }
    }, 100);
}
    // Modal-Schlie√üen bei Au√üenklick
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('show');
        }
    });

    // Globaler Fehler-Handler
    window.addEventListener('error', function(event) {
        console.error('üö® Globaler Fehler:', event.error);
        showMessage('‚ùå Ein unerwarteter Fehler ist aufgetreten. Bitte versuchen Sie es erneut.', 'error');
    });

    // Debug-Objekt f√ºr Entwicklung
    window.gardenKeeperDebug = {
        getFormData: getFormData,
        validateFormData,
        daySignatures,
        maxDays,
        currentDay,
        WORKERS,
        MATERIALS,
        MACHINES,
        uploadedImages,
        optimizeImagesForPDF,
        version: 'gardenKeeper¬Æ v2026 - MIT BILD-PDF-INTEGRATION UND UPLOAD-FIX'
    };
    /**
     * &#127793; gardenKeeper¬Æ - MOBILE STICKY BUTTONS JAVASCRIPT
     * 
     * Diesen Code am Ende des bestehenden JavaScript einf√ºgen
     * (vor dem schlie√üenden script Tag)
     * 
     * &#9989; Aktiviert Sticky-Buttons auf Mobile
     * &#9989; Scroll-Detection
     * &#9989; Touch-optimiert
     */

    // ========================================
    // üì± MOBILE STICKY BUTTONS AKTIVIEREN
    // ========================================

    function initMobileStickyButtons() {
    // Nur auf Mobile (< 768px)
    if (window.innerWidth <= 768) {
        console.log('üì± Aktiviere Mobile Auto-Hide Buttons...');
        
        // Finde alle Button-Container im Formular
        const formButtons = document.querySelectorAll('.form-buttons');
        
        formButtons.forEach(buttonContainer => {
            // F√ºge sticky-mobile Klasse hinzu
            buttonContainer.classList.add('sticky-mobile');
            
            // F√ºge Platz am Ende des Content hinzu
            const formContent = buttonContainer.closest('.form-content');
            if (formContent) {
                formContent.classList.add('has-sticky-buttons');
            }
        });
        
        // Auto-Hide Funktionalit√§t aktivieren
        initAutoHideButtons();
        
        // Scroll-to-Top Button hinzuf√ºgen
        addScrollToTopButton();
        
        // Swipe-Indicator hinzuf√ºgen
        addSwipeIndicator();
        
        console.log('&#9989; Auto-Hide Buttons aktiviert');
    }
}

    // ========================================
    // üéØ AUTO-HIDE BUTTONS FUNKTIONALIT√ÑT
    // ========================================

    function initAutoHideButtons() {
    const buttonBar = document.querySelector('.form-buttons.sticky-mobile');
    if (!buttonBar) return;
    
    let lastScrollY = window.pageYOffset;
    let hideTimeout = null;
    let isVisible = false;
    
    function showButtons() {
        buttonBar.classList.add('visible');
        isVisible = true;

        // Verstecke Swipe-Indicator wenn Buttons sichtbar
        const indicator = document.querySelector('.swipe-indicator');
        if (indicator) indicator.classList.remove('show');

        // Automatisches Ausblenden nach 10 Sekunden (war 3)
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
            hideButtons();
        }, 10000);
    }
    
    function hideButtons() {
        buttonBar.classList.remove('visible');
        isVisible = false;
        
        // Zeige Swipe-Indicator wieder
        const indicator = document.querySelector('.swipe-indicator');
        if (indicator) indicator.classList.add('show');
    }
    
    // Touch-Events f√ºr Swipe-Up Detection
    let touchStartY = 0;
    let touchEndY = 0;
    
    document.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchend', function(e) {
        touchEndY = e.changedTouches[0].clientY;
        handleSwipe();
    }, { passive: true });
    
    function handleSwipe() {
        const swipeDistance = touchStartY - touchEndY;
        
        // Swipe-Up: Mindestens 50px nach oben gewischt
        if (swipeDistance > 50) {
            showButtons();
        }
        // Swipe-Down: Buttons ausblenden
        else if (swipeDistance < -50 && isVisible) {
            hideButtons();
        }
    }
    
    // Scroll-Detection (als Alternative zum Swipe)
    let ticking = false;
    
    window.addEventListener('scroll', function() {
        if (!ticking) {
            window.requestAnimationFrame(function() {
                const currentScrollY = window.pageYOffset;
                
                // Nach oben scrollen: Buttons zeigen
                if (lastScrollY > currentScrollY && currentScrollY > 100) {
                    showButtons();
                }
                
                lastScrollY = currentScrollY;
                ticking = false;
            });
            
            ticking = true;
        }
    }, { passive: true });
    
    // Bei Button-Klick: Nicht sofort ausblenden
    buttonBar.addEventListener('click', function() {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
            hideButtons();
        }, 15000); // 15 Sekunden nach Klick (war 5)
    });
    
    // Event-Listener f√ºr manuelles √ñffnen (vom Indicator)
    document.addEventListener('showButtonsManually', function() {
        showButtons();
    });

    // Initial: Buttons versteckt
    hideButtons();

    // Nach 2 Sekunden: Kurz einblenden als Hinweis
    setTimeout(() => {
        showButtons();
        setTimeout(() => {
            hideButtons();
        }, 3000); // 3 Sekunden f√ºr ersten Hinweis
    }, 2000);

    console.log('&#9989; Auto-Hide Buttons initialisiert (10s Sichtbarkeit)');
}

    // ========================================
    // üëÜ SWIPE-UP INDICATOR
    // ========================================

    function addSwipeIndicator() {
    // Pr√ºfe ob Indicator schon existiert
    if (document.querySelector('.swipe-indicator')) return;

    const indicator = document.createElement('div');
    indicator.className = 'swipe-indicator show';
    indicator.innerHTML = '‚Üë Nach oben wischen oder antippen';
    indicator.style.cursor = 'pointer';

    // TAP auf Indicator = Buttons zeigen!
    indicator.addEventListener('click', function() {
        const buttonBar = document.querySelector('.form-buttons.sticky-mobile');
        if (buttonBar && !buttonBar.classList.contains('visible')) {
            buttonBar.classList.add('visible');
            // Trigger die showButtons() Funktion f√ºr korrektes Timing
            if (window.initAutoHideButtons) {
                const event = new CustomEvent('showButtonsManually');
                document.dispatchEvent(event);
            }
        }
    });

    document.body.appendChild(indicator);

    // INDICATOR BLEIBT PERMANENT (kein Timeout!)
    console.log('&#9989; Permanenter Button-Trigger am unteren Rand hinzugef√ºgt');
}

    // ========================================
    // ‚¨ÜÔ∏è SCROLL-TO-TOP BUTTON
    // ========================================

    function addScrollToTopButton() {
    // Pr√ºfe ob Button schon existiert
    if (document.getElementById('scrollToTopBtn')) return;
    
    // Erstelle Button
    const scrollBtn = document.createElement('button');
    scrollBtn.id = 'scrollToTopBtn';
    scrollBtn.className = 'fab-button';
    scrollBtn.innerHTML = '‚¨ÜÔ∏è';
    scrollBtn.title = 'Nach oben scrollen';
    scrollBtn.style.display = 'none';
    
    document.body.appendChild(scrollBtn);
    
    // Event Listener
    scrollBtn.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
    
    // Zeige/Verstecke basierend auf Scroll-Position
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            scrollBtn.style.display = 'flex';
        } else {
            scrollBtn.style.display = 'none';
        }
    });
}

    // ========================================
    // üéØ SCROLL ZU BUTTONS
    // ========================================

    function scrollToActionButtons() {
    const buttons = document.querySelector('.form-buttons.sticky-mobile');
    if (buttons && window.innerWidth <= 768) {
        // Auf Mobile sind die Buttons sticky - scrollen nicht n√∂tig
        console.log('‚ÑπÔ∏è Buttons sind bereits sichtbar (sticky)');
    } else if (buttons) {
        // Auf Desktop: Scroll zu den Buttons
        buttons.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }
}

    // ========================================
    // üìê WINDOW RESIZE HANDLER
    // ========================================

    let resizeTimer;
    window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
        // Bei Gr√∂√üen√§nderung neu initialisieren
        const formButtons = document.querySelectorAll('.form-buttons');
        
        if (window.innerWidth <= 768) {
            // Mobile: Sticky aktivieren
            formButtons.forEach(btn => {
                btn.classList.add('sticky-mobile');
                const formContent = btn.closest('.form-content');
                if (formContent) {
                    formContent.classList.add('has-sticky-buttons');
                }
            });
        } else {
            // Desktop: Sticky deaktivieren
            formButtons.forEach(btn => {
                btn.classList.remove('sticky-mobile');
                const formContent = btn.closest('.form-content');
                if (formContent) {
                    formContent.classList.remove('has-sticky-buttons');
                }
            });
            
            // Scroll-to-Top Button entfernen
            const scrollBtn = document.getElementById('scrollToTopBtn');
            if (scrollBtn) {
                scrollBtn.style.display = 'none';
            }
        }
        
        console.log(`üì± Window Resize: ${window.innerWidth}px - Sticky Buttons ${window.innerWidth <= 768 ? 'aktiviert' : 'deaktiviert'}`);
    }, 250);
});

    // ========================================
    // üîÑ INITIALISIERUNG
    // ========================================

    // Bei Seitenladen
    document.addEventListener('DOMContentLoaded', function() {
    console.log('üé¨ Initialisiere Mobile Sticky Buttons...');
    
    // Kurze Verz√∂gerung, damit DOM fertig geladen ist
    setTimeout(function() {
        initMobileStickyButtons();
    }, 500);
});

    // Backup: Falls DOMContentLoaded schon vorbei ist
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(function() {
        initMobileStickyButtons();
    }, 100);
}

    // ========================================
    // üéØ HELPER: BUTTON-KLICK FEEDBACK
    // ========================================

    // Visuelles Feedback f√ºr Button-Klicks auf Touch-Ger√§ten
    function addTouchFeedback() {
    const buttons = document.querySelectorAll('.btn');
    
    buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.95)';
        });
        
        button.addEventListener('touchend', function() {
            this.style.transform = '';
        });
    });
}

    // Touch-Feedback aktivieren
    if ('ontouchstart' in window) {
    document.addEventListener('DOMContentLoaded', addTouchFeedback);
}

    // ========================================
    // üé® BUTTON ANIMATIONS
    // ========================================

    // Sanfte Pulse-Animation f√ºr wichtige Buttons
    function addPulseToMainButton() {
    const mainButtons = document.querySelectorAll('.btn-primary');
    
    mainButtons.forEach(button => {
        // F√ºge Pulse-Effekt hinzu wenn Button l√§nger als 3 Sek nicht geklickt wurde
        let pulseTimeout;
        
        button.addEventListener('mouseenter', function() {
            clearTimeout(pulseTimeout);
        });
        
        button.addEventListener('mouseleave', function() {
            pulseTimeout = setTimeout(() => {
                button.style.animation = 'pulse 2s infinite';
            }, 3000);
        });
        
        button.addEventListener('click', function() {
            clearTimeout(pulseTimeout);
            button.style.animation = 'none';
        });
    });
}

    // CSS Animation f√ºr Pulse (falls nicht vorhanden)
    const style = document.createElement('style');
    style.textContent = `
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 8px 25px rgba(143, 166, 143, 0.2);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(143, 166, 143, 0.4);
        }
    }
`;
    document.head.appendChild(style);

    // ========================================
    // üìä DEBUG INFO
    // ========================================

    // ============================================================================
    // GOOGLE DOC PARSER - Integrated from googleDocParser.js
    // ============================================================================
    // Parses job positions from Google Docs and generates dynamic form checkboxes
    // Version 1.0.0
    // ============================================================================

    /**
     * Parses Google Doc text and extracts all job positions
     */
    function parseGoogleDocPositions(docText) {
        if (!docText || typeof docText !== 'string') {
            console.error('Invalid docText provided to parseGoogleDocPositions');
            return [];
        }

        const positions = [];
        const positionRegex = /[‚ñ∂‚ñ∫]?\s*Position\s+(\d+)\s*:\s*([^\n]+)/gi;
        let match;
        const matches = [];

        while ((match = positionRegex.exec(docText)) !== null) {
            matches.push({
                index: match.index,
                id: match[1],
                title: match[2].trim(),
                fullMatch: match[0]
            });
        }

        matches.forEach((currentMatch, idx) => {
            const nextMatch = matches[idx + 1];
            const startIndex = currentMatch.index + currentMatch.fullMatch.length;
            const endIndex = nextMatch ? nextMatch.index : docText.length;

            let descriptionText = docText.substring(startIndex, endIndex).trim();
            descriptionText = descriptionText.replace(/^[:;\-\s]+/, '');

            const quantityInfo = extractQuantityAndUnit(descriptionText);
            const category = categorizePosition(currentMatch.title, descriptionText);

            const position = {
                id: currentMatch.id,
                title: currentMatch.title,
                description: descriptionText,
                category: category,
                quantity: quantityInfo.quantity,
                unit: quantityInfo.unit,
                rawText: docText.substring(currentMatch.index, endIndex).trim()
            };

            positions.push(position);
        });

        return positions.filter(pos => pos.category !== 'SKIP');
    }

    /**
     * Extracts quantity and unit from description text
     */
    function extractQuantityAndUnit(text) {
        if (!text) {
            return { quantity: null, unit: null };
        }

        const mengeRegex = /Menge\s*:\s*([\d,\.]+)\s*([^\n\r]*?)(?:\n|\r|$)/i;
        const match = text.match(mengeRegex);

        if (match) {
            const quantityStr = match[1].replace(',', '.');
            const quantity = parseFloat(quantityStr);
            let unit = match[2].trim();
            unit = unit.replace(/[,;:\.]$/, '').trim();

            return {
                quantity: isNaN(quantity) ? null : quantity,
                unit: unit || null
            };
        }

        return { quantity: null, unit: null };
    }

    /**
     * Intelligently categorizes a position
     */
    function categorizePosition(title, description) {
        if (!title) {
            return 'SKIP';
        }

        const combinedText = (title + ' ' + (description || '')).toLowerCase();

        const skipPatterns = [
            /\bstd\b/, /kostensch√§tzung/, /ar-nach-aufwand/, /frachtkosten/,
            /anfahrt/, /pauschal/, /\bkm\b/, /fahrtkosten/, /beratung/
        ];

        for (const pattern of skipPatterns) {
            if (pattern.test(combinedText)) {
                return 'SKIP';
            }
        }

        const plantPatterns = [
            /\bpflanzen\b/, /\bliefern\s+u\.?\s+.*pflanzen/, /\bliefern\s+und\s+.*pflanzen/,
            /\bst√ºck\b.*pflanzen/, /thymus/, /lavandula/, /rosa\s+/, /salvia/,
            /geranium/, /heuchera/, /hosta/, /\bstaude/, /\bgeh√∂lz/, /\bstrauch/, /\bbaum\b/
        ];

        for (const pattern of plantPatterns) {
            if (pattern.test(combinedText)) {
                return 'PLANT';
            }
        }

        const materialPatterns = [
            /\berde\b/, /\bd√ºnger/, /\bpflanzerde/, /\bsubstrat/, /\bkompost/,
            /\bmulch/, /\brindenmulch/, /\bkies\b/, /\bsand\b/, /\bsteine\b/,
            /\bpflastersteine/, /\bsack\b/, /\bcbm\b/, /\bkg\b/, /\bliter\b/,
            /\bm[¬≤2]\b/, /\bm[¬≥3]\b/, /\btonnen\b/, /\bcontainer\b/,
            /\bfolie\b/, /\bvlies\b/, /\bdrainage/, /bodenqualit√§t\s+verbessern/
        ];

        for (const pattern of materialPatterns) {
            if (pattern.test(combinedText)) {
                return 'MATERIAL';
            }
        }

        const workPatterns = [
            /\bm√§hen\b/, /\bm√§ht\b/, /\bschneiden\b/, /\bschnitt\b/, /\br√ºckschnitt/,
            /\bs√§ubern/, /\bs√§uberung/, /\bbeseitigung/, /\bentfernung/, /\bentfernen/,
            /\bunkraut/, /\blaub\b/, /\bverladen/, /\babfahren/, /\bentsorgen/,
            /\bentsorgung/, /\bgraben\b/, /\bpflege\b/, /\bwartung/, /\breinigung/,
            /\bbearbeitung/, /\bvorbereitung/, /\bnachbearbeitung/, /\bbefreien/,
            /\bj√§ten\b/, /\bhacken\b/, /\blockern\b/, /\bumgraben/, /\bfr√§sen/,
            /\bvertikutieren/, /\bbel√ºften/, /\bpsch\b/
        ];

        for (const pattern of workPatterns) {
            if (pattern.test(combinedText)) {
                return 'WORK';
            }
        }

        if (/\bst√ºck\b/i.test(combinedText)) {
            return 'PLANT';
        }

        if (/\b(sack|kg|cbm|liter|tonnen|m[¬≤¬≥23])\b/i.test(combinedText)) {
            return 'MATERIAL';
        }

        return 'WORK';
    }

    /**
     * Generates HTML for dynamic checkboxes grouped by category
     */
    function generateDynamicCheckboxes(positions) {
        if (!positions || positions.length === 0) {
            return '<p class="text-muted">Keine Positionen gefunden.</p>';
        }

        const grouped = {
            WORK: positions.filter(p => p.category === 'WORK'),
            PLANT: positions.filter(p => p.category === 'PLANT'),
            MATERIAL: positions.filter(p => p.category === 'MATERIAL')
        };

        let html = '';

        if (grouped.WORK.length > 0) {
            html += `
<div class="checkbox-group mb-4">
    <h5 class="mb-3">Durchgefuehrte Arbeiten</h5>
    <div class="work-checkboxes">
`;
            grouped.WORK.forEach(pos => {
                const checkboxId = `work_${pos.id}`;
                const sanitizedTitle = escapeHtml(pos.title);
                const sanitizedDescription = escapeHtml(pos.description.split('\n')[0]);

                html += `
        <div class="form-check mb-2">
            <input class="form-check-input position-checkbox"
                   type="checkbox"
                   id="${checkboxId}"
                   data-category="WORK"
                   data-position-id="${pos.id}"
                   data-title="${sanitizedTitle}"
                   data-description="${sanitizedDescription}">
            <label class="form-check-label" for="${checkboxId}">
                <strong>Position ${pos.id}:</strong> ${sanitizedTitle}
            </label>
        </div>
`;
            });

            html += `
    </div>
</div>
`;
        }

        if (grouped.PLANT.length > 0) {
            html += `
<div class="checkbox-group mb-4">
    <h5 class="mb-3">Gepflanzte Pflanzen</h5>
    <div class="plant-checkboxes">
`;
            grouped.PLANT.forEach(pos => {
                const checkboxId = `plant_${pos.id}`;
                const quantityId = `plant_qty_${pos.id}`;
                const sanitizedTitle = escapeHtml(pos.title);
                const defaultQty = pos.quantity || '';
                const unit = pos.unit || 'Stueck';

                html += `
        <div class="form-check mb-3">
            <input class="form-check-input position-checkbox"
                   type="checkbox"
                   id="${checkboxId}"
                   data-category="PLANT"
                   data-position-id="${pos.id}"
                   data-title="${sanitizedTitle}"
                   data-unit="${escapeHtml(unit)}"
                   data-quantity-input="${quantityId}">
            <label class="form-check-label d-flex align-items-center" for="${checkboxId}">
                <span class="me-2"><strong>Position ${pos.id}:</strong> ${sanitizedTitle}</span>
            </label>
            <div class="ms-4 mt-2 quantity-input-group" style="display: none;" data-for="${checkboxId}">
                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <input type="number"
                           class="form-control quantity-input"
                           id="${quantityId}"
                           placeholder="Menge"
                           value="${defaultQty}"
                           min="0"
                           step="0.1">
                    <span class="input-group-text">${escapeHtml(unit)}</span>
                </div>
            </div>
        </div>
`;
            });

            html += `
    </div>
</div>
`;
        }

        if (grouped.MATERIAL.length > 0) {
            html += `
<div class="checkbox-group mb-4">
    <h5 class="mb-3">Verwendete Materialien</h5>
    <div class="material-checkboxes">
`;
            grouped.MATERIAL.forEach(pos => {
                const checkboxId = `material_${pos.id}`;
                const quantityId = `material_qty_${pos.id}`;
                const sanitizedTitle = escapeHtml(pos.title);
                const defaultQty = pos.quantity || '';
                const unit = pos.unit || 'Stueck';

                html += `
        <div class="form-check mb-3">
            <input class="form-check-input position-checkbox"
                   type="checkbox"
                   id="${checkboxId}"
                   data-category="MATERIAL"
                   data-position-id="${pos.id}"
                   data-title="${sanitizedTitle}"
                   data-unit="${escapeHtml(unit)}"
                   data-quantity-input="${quantityId}">
            <label class="form-check-label d-flex align-items-center" for="${checkboxId}">
                <span class="me-2"><strong>Position ${pos.id}:</strong> ${sanitizedTitle}</span>
            </label>
            <div class="ms-4 mt-2 quantity-input-group" style="display: none;" data-for="${checkboxId}">
                <div class="input-group input-group-sm" style="max-width: 200px;">
                    <input type="number"
                           class="form-control quantity-input"
                           id="${quantityId}"
                           placeholder="Menge"
                           value="${defaultQty}"
                           min="0"
                           step="0.1">
                    <span class="input-group-text">${escapeHtml(unit)}</span>
                </div>
            </div>
        </div>
`;
            });

            html += `
    </div>
</div>
`;
        }

        return html;
    }

    /**
     * Generates formatted description text from checked checkboxes
     */
    function generateDescriptionFromCheckboxes() {
        const checkedBoxes = document.querySelectorAll('.position-checkbox:checked');

        if (checkedBoxes.length === 0) {
            return '';
        }

        const grouped = {
            WORK: [],
            PLANT: [],
            MATERIAL: []
        };

        checkedBoxes.forEach(checkbox => {
            const category = checkbox.dataset.category;
            const title = checkbox.dataset.title;
            const unit = checkbox.dataset.unit;
            const quantityInputId = checkbox.dataset.quantityInput;

            let item = { title };

            if (quantityInputId) {
                const quantityInput = document.getElementById(quantityInputId);
                if (quantityInput && quantityInput.value) {
                    item.quantity = quantityInput.value;
                    item.unit = unit;
                }
            }

            if (grouped[category]) {
                grouped[category].push(item);
            }
        });

        let description = '';

        if (grouped.WORK.length > 0) {
            description += 'Durchgefuehrte Arbeiten:\n';
            grouped.WORK.forEach(item => {
                description += `- ${item.title}\n`;
            });
            description += '\n';
        }

        if (grouped.PLANT.length > 0) {
            description += 'Gepflanzte Pflanzen:\n';
            grouped.PLANT.forEach(item => {
                if (item.quantity && item.unit) {
                    description += `- ${item.quantity} ${item.unit} ${item.title}\n`;
                } else {
                    description += `- ${item.title}\n`;
                }
            });
            description += '\n';
        }

        if (grouped.MATERIAL.length > 0) {
            description += 'Verwendete Materialien:\n';
            grouped.MATERIAL.forEach(item => {
                if (item.quantity && item.unit) {
                    description += `- ${item.quantity} ${item.unit} ${item.title}\n`;
                } else {
                    description += `- ${item.title}\n`;
                }
            });
            description += '\n';
        }

        return description.trim();
    }

    /**
     * Initializes checkbox event handlers
     */
    function initializeCheckboxHandlers() {
        document.querySelectorAll('.position-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const quantityInputId = this.dataset.quantityInput;
                if (quantityInputId) {
                    const quantityGroup = document.querySelector(`[data-for="${this.id}"]`);
                    if (quantityGroup) {
                        quantityGroup.style.display = this.checked ? 'block' : 'none';
                    }
                }
            });
        });
    }

    /**
     * Escapes HTML special characters to prevent XSS
     */
    function escapeHtml(text) {
        if (!text) return '';

        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };

        return text.replace(/[&<>"']/g, m => map[m]);
    }

    /**
     * Toggle manual description textarea visibility
     */
    function toggleManualDescription() {
        const textarea = document.querySelector('.beschreibung-arbeiten');
        if (textarea) {
            const currentDisplay = window.getComputedStyle(textarea).display;
            textarea.style.display = currentDisplay === 'none' ? 'block' : 'none';
        }
    }

    /**
     * Load Google Doc and parse positions
     */
    async function loadGoogleDocPositions(eventData) {
        try {
            const description = eventData.description || '';
            const docLinkMatch = description.match(/https:\/\/docs\.google\.com\/document\/d\/([a-zA-Z0-9_-]+)/);

            if (!docLinkMatch) {
                console.log('No Google Doc link found in event');
                return null;
            }

            const docId = docLinkMatch[1];
            console.log('Found Google Doc ID:', docId);

            const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getGoogleDoc&docId=${docId}`);
            const data = await response.json();

            if (data.success && data.docText) {
                const positions = parseGoogleDocPositions(data.docText);
                console.log('Parsed positions:', positions);

                const checkboxesHtml = generateDynamicCheckboxes(positions);

                const container = document.getElementById('positions-container');
                if (container) {
                    container.innerHTML = checkboxesHtml;
                    initializeCheckboxHandlers();
                }

                return positions;
            }
        } catch (error) {
            console.error('Error loading Google Doc:', error);
            const container = document.getElementById('positions-container');
            if (container) {
                container.innerHTML = '<p style="color: #dc3545;">Fehler beim Laden der Auftragspositionen. Bitte manuell eingeben.</p>';
            }
        }
        return null;
    }

</script>

<!-- === PFLEGEANLEITUNG-SYSTEM (Netlify gehostet) === -->
<script src="https://team-gardenkeeper-abnahmeformular.netlify.app/pflegeanleitung-system-KOMPLETT.js"></script>

<!-- === EVENT AUTO-LOADER WITH GOOGLE DOC PARSER INTEGRATION === -->
<script>
(function() {
    'use strict';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // EVENT AUTO-LOADER - Integrated and Extended with Google Doc Parser
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const CONFIG = {
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwftkyLDb4kfPovKgEDqmL7szktoEUfqOq8odBnCcLL-4DXKS0li6u4CFEe2pR8-mqAKQ/exec',
        TIMEOUT: 10000,
        DEBUG: true
    };

    function getEventIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('event');
    }

    function log(message, data) {
        if (CONFIG.DEBUG) {
            if (data !== undefined) {
                console.log('üçÅ EventLoader:', message, data);
            } else {
                console.log('üçÅ EventLoader:', message);
            }
        }
    }

    function showLoadingIndicator(message) {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
            indicator.textContent = message || '‚è≥ Lade Event-Daten...';
            indicator.style.display = 'block';
        }
    }

    function hideLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    async function loadEventData(eventId) {
        log('Lade Event-Daten f√ºr ID:', eventId);

        if (!CONFIG.APPS_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL === 'HIER_APPS_SCRIPT_URL_EINTRAGEN') {
            log('‚ùå Apps Script URL nicht konfiguriert!');
            return null;
        }

        try {
            const url = `${CONFIG.APPS_SCRIPT_URL}?action=getEventData&eventId=${encodeURIComponent(eventId)}`;

            const response = await fetch(url, {
                method: 'GET',
                redirect: 'follow'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            log('Event-Daten empfangen:', data);

            return data;

        } catch (error) {
            log('‚ùå Fehler beim Laden der Event-Daten:', error);
            return null;
        }
    }

    function fillFormFields(eventData) {
        if (!eventData || !eventData.success) {
            log('‚ùå Keine g√ºltigen Event-Daten zum Bef√ºllen');
            return;
        }

        log('F√ºlle Formular-Felder aus...');

        if (eventData.vorname) {
            const kundeField = document.getElementById('kunde');
            if (kundeField && !kundeField.value) {
                kundeField.value = eventData.vorname;
                log('‚úÖ Vorname gesetzt:', eventData.vorname);
            }
        }

        if (eventData.nachname) {
            const nachnameField = document.getElementById('nachname');
            if (nachnameField && !nachnameField.value) {
                nachnameField.value = eventData.nachname;
                log('‚úÖ Nachname gesetzt:', eventData.nachname);
            }
        }

        if (eventData.email) {
            const emailField = document.getElementById('kundenEmail');
            if (emailField && !emailField.value) {
                emailField.value = eventData.email;
                log('‚úÖ Email gesetzt:', eventData.email);
            }
        }

        if (eventData.lexofficeId) {
            const lexField = document.getElementById('lexofficeId');
            if (lexField && !lexField.value) {
                lexField.value = eventData.lexofficeId;
                log('‚úÖ LexOffice-ID gesetzt:', eventData.lexofficeId);
            }
        }

        if (eventData.eventId) {
            const eventIdField = document.getElementById('eventId');
            if (eventIdField) {
                eventIdField.value = eventData.eventId;
            }
        }
    }

    // ‚úÖ DIESE FUNKTION MUSS IM GLEICHEN SCOPE SEIN!
    async function loadGoogleDocPositions(eventData) {
        try {
            const description = eventData.description || '';
            const docLinkMatch = description.match(/https:\/\/docs\.google\.com\/document\/d\/([a-zA-Z0-9_-]+)/);

            if (!docLinkMatch) {
                console.log('No Google Doc link found in event');
                return null;
            }

            const docId = docLinkMatch[1];
            console.log('Found Google Doc ID:', docId);

            const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getGoogleDoc&docId=${docId}`);
            const data = await response.json();

            if (data.success && data.docText) {
                // ‚úÖ Diese Funktionen m√ºssen GLOBAL verf√ºgbar sein (aus dem Hauptscript)
                const positions = window.parseGoogleDocPositions(data.docText);
                console.log('Parsed positions:', positions);

                const checkboxesHtml = window.generateDynamicCheckboxes(positions);

                const container = document.getElementById('positions-container');
                if (container) {
                    container.innerHTML = checkboxesHtml;
                    window.initializeCheckboxHandlers();
                }

                return positions;
            }
        } catch (error) {
            console.error('Error loading Google Doc:', error);
            const container = document.getElementById('positions-container');
            if (container) {
                container.innerHTML = '<p style="color: #dc3545;">Fehler beim Laden der Auftragspositionen. Bitte manuell eingeben.</p>';
            }
        }
        return null;
    }

    async function initAutoLoader() {
        log('üöÄ Event Auto-Loader gestartet');

        const eventId = getEventIdFromURL();

        if (!eventId) {
            log('‚ÑπÔ∏è Keine Event-ID in URL gefunden - normaler Modus');
            const container = document.getElementById('positions-container');
            if (container) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Keine Google Doc-Positionen verf√ºgbar. Bitte manuell beschreiben.</p>';
            }
            const textarea = document.querySelector('.beschreibung-arbeiten');
            if (textarea) {
                textarea.style.display = 'block';
            }
            return;
        }

        log('Event-ID gefunden:', eventId);
        showLoadingIndicator('‚è≥ Lade Event-Daten...');

        const eventData = await loadEventData(eventId);

        if (eventData && eventData.success) {
            log('‚úÖ Event-Daten erfolgreich geladen');

            fillFormFields(eventData);

            showLoadingIndicator('‚è≥ Lade Arbeitspositionen aus Google Doc...');
            const positions = await loadGoogleDocPositions(eventData);

            if (positions && positions.length > 0) {
                log('‚úÖ Google Doc Positionen erfolgreich geladen');
            } else {
                log('‚ÑπÔ∏è Keine Positionen in Google Doc gefunden');
                const textarea = document.querySelector('.beschreibung-arbeiten');
                if (textarea) {
                    textarea.style.display = 'block';
                }
                const container = document.getElementById('positions-container');
                if (container && !container.innerHTML.includes('Fehler')) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">Keine Positionen im Google Doc gefunden.</p>';
                }
            }

            hideLoadingIndicator();

            const infoDiv = document.createElement('div');
            infoDiv.className = 'success-message';
            infoDiv.style.cssText = 'background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #28a745;';
            infoDiv.innerHTML = `
                <strong>‚úÖ Event-Daten automatisch geladen!</strong><br>
                <small>Kunde: ${eventData.vorname || ''} ${eventData.nachname || ''} | LexOffice: ${eventData.lexofficeId || '-'}</small>
            `;

            const formContent = document.querySelector('.form-content');
            if (formContent && formContent.firstChild) {
                formContent.insertBefore(infoDiv, formContent.firstChild);
            }

        } else {
            hideLoadingIndicator();
            log('‚ö†Ô∏è Event-Daten konnten nicht geladen werden');

            const textarea = document.querySelector('.beschreibung-arbeiten');
            if (textarea) {
                textarea.style.display = 'block';
            }

            const container = document.getElementById('positions-container');
            if (container) {
                container.innerHTML = '<p style="color: #666;">Event konnte nicht geladen werden.</p>';
            }

            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-message';
            warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;';
            warningDiv.innerHTML = `
                <strong>‚ö†Ô∏è Event-Daten konnten nicht geladen werden</strong><br>
                <small>Bitte Daten manuell eingeben. Event-ID: ${eventId}</small>
            `;

            const formContent = document.querySelector('.form-content');
            if (formContent && formContent.firstChild) {
                formContent.insertBefore(warningDiv, formContent.firstChild);
            }
        }
    }

    // Wait for DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAutoLoader);
    } else {
        initAutoLoader();
    }

    // ‚úÖ Export f√ºr globalen Zugriff
    window.gardenKeeperEventLoader = {
        loadEventData,
        fillFormFields,
        loadGoogleDocPositions,
        getEventIdFromURL,
        version: '2026.01.20-FIXED'
    };

    log('‚úÖ Event Auto-Loader Modul geladen (with Google Doc Parser)');

})();
</script>
